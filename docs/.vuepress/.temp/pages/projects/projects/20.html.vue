<template><div><ul>
<li><a href="https://github.com/cubxxw/iam" target="_blank" rel="noopener noreferrer">ğŸ”¥ å¼€æºåœ°å€<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬20èŠ‚-æ§åˆ¶æµ-ä¸Š-é€šè¿‡iam-apiserverè®¾è®¡-çœ‹webæœåŠ¡çš„æ„å»º" tabindex="-1"><a class="header-anchor" href="#ç¬¬20èŠ‚-æ§åˆ¶æµ-ä¸Š-é€šè¿‡iam-apiserverè®¾è®¡-çœ‹webæœåŠ¡çš„æ„å»º" aria-hidden="true">#</a> ç¬¬20èŠ‚ æ§åˆ¶æµï¼ˆä¸Šï¼‰ï¼šé€šè¿‡iam-apiserverè®¾è®¡ï¼Œçœ‹WebæœåŠ¡çš„æ„å»º</h1>
<br>
<div><a href = '19.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '21.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<nav class="table-of-contents"><ul><li><router-link to="#å¼€å§‹">å¼€å§‹</router-link></li><li><router-link to="#iam-apiserveræœåŠ¡ä»‹ç»">iam-apiserveræœåŠ¡ä»‹ç»</router-link><ul><li><router-link to="#iam-apiserveråŠŸèƒ½ä»‹ç»">iam-apiserveråŠŸèƒ½ä»‹ç»</router-link></li><li><router-link to="#iam-apiserverä½¿ç”¨æ–¹æ³•ä»‹ç»">iam-apiserverä½¿ç”¨æ–¹æ³•ä»‹ç»</router-link></li></ul></li><li><router-link to="#iam-apiserverä»£ç å®ç°">iam-apiserverä»£ç å®ç°</router-link><ul><li><router-link to="#iam-apiserveré…ç½®å¤„ç†">iam-apiserveré…ç½®å¤„ç†</router-link></li><li><router-link to="#iam-apiserverå¯åŠ¨æµç¨‹è®¾è®¡">iam-apiserverå¯åŠ¨æµç¨‹è®¾è®¡</router-link></li><li><router-link to="#iam-apiserver-çš„rest-apiè¯·æ±‚å¤„ç†æµç¨‹">iam-apiserver çš„REST APIè¯·æ±‚å¤„ç†æµç¨‹</router-link></li><li><router-link to="#iam-apiserverä»£ç æ¶æ„">iam-apiserverä»£ç æ¶æ„</router-link></li></ul></li><li><router-link to="#æ€»ç»“">æ€»ç»“</router-link></li><li><router-link to="#end-é“¾æ¥">END é“¾æ¥</router-link></li></ul></nav>
<p>[TOC]</p>
<h2 id="å¼€å§‹" tabindex="-1"><a class="header-anchor" href="#å¼€å§‹" aria-hidden="true">#</a> å¼€å§‹</h2>
<p>å‰é¢æˆ‘ä»¬è®²äº†å¾ˆå¤šå…³äºåº”ç”¨æ„å»ºçš„å†…å®¹ï¼Œä½ ä¸€å®šè¿«ä¸åŠå¾…åœ°æƒ³çœ‹ä¸‹IAMé¡¹ç›®çš„åº”ç”¨æ˜¯å¦‚ä½•æ„å»ºçš„ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘å°±è®²è§£ä¸‹IAMåº”ç”¨çš„æºç ã€‚</p>
<p>åœ¨è®²è§£è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¸ä¼šå»è®²è§£å…·ä½“å¦‚ä½•Codeï¼Œä½†ä¼šè®²è§£ä¸€äº›æ„å»ºè¿‡ç¨‹ä¸­çš„é‡ç‚¹ã€éš¾ç‚¹ï¼Œä»¥åŠCodeèƒŒåçš„è®¾è®¡æ€è·¯ã€æƒ³æ³•ã€‚æˆ‘ç›¸ä¿¡è¿™æ˜¯å¯¹ä½ æ›´æœ‰å¸®åŠ©çš„ã€‚</p>
<p>IAMé¡¹ç›®æœ‰å¾ˆå¤šç»„ä»¶ï¼Œè¿™ä¸€è®²ï¼Œæˆ‘å…ˆæ¥ä»‹ç»ä¸‹IAMé¡¹ç›®çš„é—¨é¢æœåŠ¡ï¼šiam-apiserverï¼ˆç®¡ç†æµæœåŠ¡ï¼‰ã€‚æˆ‘ä¼šå…ˆç»™ä½ ä»‹ç»ä¸‹<code v-pre>iam-apiserver</code>çš„åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ï¼Œå†ä»‹ç»ä¸‹iam-apiserverçš„ä»£ç å®ç°ã€‚</p>
<h2 id="iam-apiserveræœåŠ¡ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#iam-apiserveræœåŠ¡ä»‹ç»" aria-hidden="true">#</a> iam-apiserveræœåŠ¡ä»‹ç»</h2>
<p>iam-apiserveræ˜¯ä¸€ä¸ªWebæœåŠ¡ï¼Œé€šè¿‡ä¸€ä¸ªåä¸ºiam-apiserverçš„è¿›ç¨‹ï¼Œå¯¹å¤–æä¾›RESTful APIæ¥å£ï¼Œå®Œæˆç”¨æˆ·ã€å¯†é’¥ã€ç­–ç•¥ä¸‰ç§RESTèµ„æºçš„å¢åˆ æ”¹æŸ¥ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ä¸¤ä¸ªæ–¹é¢æ¥å…·ä½“ä»‹ç»ä¸‹ã€‚</p>
<h3 id="iam-apiserveråŠŸèƒ½ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#iam-apiserveråŠŸèƒ½ä»‹ç»" aria-hidden="true">#</a> iam-apiserveråŠŸèƒ½ä»‹ç»</h3>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡iam-apiserveræä¾›çš„RESTful APIæ¥å£ï¼Œæ¥çœ‹ä¸‹iam-apiserverå…·ä½“æä¾›çš„åŠŸèƒ½ã€‚iam-apiserveræä¾›çš„RESTful APIæ¥å£å¯ä»¥åˆ†ä¸ºå››ç±»ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<p><strong>è®¤è¯ç›¸å…³æ¥å£</strong></p>
<p><img src="http://sm.nsddd.top/sm202302271737291.jpeg" alt="å›¾ç‰‡"></p>
<p><strong>ç”¨æˆ·ç›¸å…³æ¥å£</strong></p>
<p><a href="https://static001.geekbang.org/resource/image/60/24/60f8a05f4cb43cbac84c0fb12c40c824.jpg?wh=1920x1314" target="_blank" rel="noopener noreferrer"><img src="http://sm.nsddd.top/sm202302271738769.jpeg" alt="å›¾ç‰‡"><ExternalLinkIcon/></a></p>
<p><strong>å¯†é’¥ç›¸å…³æ¥å£</strong></p>
<p><img src="http://sm.nsddd.top/sm202302271737321.jpeg" alt="å›¾ç‰‡"></p>
<p><strong>ç­–ç•¥ç›¸å…³æ¥å£</strong></p>
<p><img src="http://sm.nsddd.top/sm202302271738302.jpeg" alt="å›¾ç‰‡"></p>
<h3 id="iam-apiserverä½¿ç”¨æ–¹æ³•ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#iam-apiserverä½¿ç”¨æ–¹æ³•ä»‹ç»" aria-hidden="true">#</a> iam-apiserverä½¿ç”¨æ–¹æ³•ä»‹ç»</h3>
<p>ä¸Šé¢æˆ‘ä»‹ç»äº†iam-apiserverçš„åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥å°±ä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸åŒçš„å®¢æˆ·ç«¯æ¥è®¿é—® <code v-pre>iam-apiserver</code>ï¼Œä¾‹å¦‚å‰ç«¯ã€APIè°ƒç”¨ã€SDKã€iamctlç­‰ã€‚è¿™äº›å®¢æˆ·ç«¯æœ€ç»ˆéƒ½ä¼šæ‰§è¡ŒHTTPè¯·æ±‚ï¼Œè°ƒç”¨ <code v-pre>iam-apiserver</code> æä¾›çš„RESTful APIæ¥å£ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æœ‰ä¸€ä¸ªé¡ºæ‰‹çš„REST APIå®¢æˆ·ç«¯å·¥å…·æ¥æ‰§è¡ŒHTTPè¯·æ±‚ï¼Œå®Œæˆå¼€å‘æµ‹è¯•ã€‚</p>
<p>å› ä¸ºä¸åŒçš„å¼€å‘è€…æ‰§è¡ŒHTTPè¯·æ±‚çš„æ–¹å¼ã€ä¹ æƒ¯ä¸åŒï¼Œä¸ºäº†æ–¹ä¾¿è®²è§£ï¼Œè¿™é‡Œæˆ‘ç»Ÿä¸€é€šè¿‡cURLå·¥å…·æ¥æ‰§è¡ŒHTTPè¯·æ±‚ã€‚æ¥ä¸‹æ¥å…ˆä»‹ç»ä¸‹cURLå·¥å…·ã€‚</p>
<p>æ ‡å‡†çš„Linuxå‘è¡Œç‰ˆéƒ½å®‰è£…äº†cURLå·¥å…·ã€‚cURLå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ŒæˆRESTful APIçš„è°ƒç”¨åœºæ™¯ï¼Œæ¯”å¦‚è®¾ç½®Headerã€æŒ‡å®šHTTPè¯·æ±‚æ–¹æ³•ã€æŒ‡å®šHTTPæ¶ˆæ¯ä½“ã€æŒ‡å®šæƒé™è®¤è¯ä¿¡æ¯ç­‰ã€‚é€šè¿‡<code v-pre>-v</code>é€‰é¡¹ï¼Œä¹Ÿèƒ½è¾“å‡ºRESTè¯·æ±‚çš„æ‰€æœ‰è¿”å›ä¿¡æ¯ã€‚cURLåŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œæœ‰å¾ˆå¤šå‚æ•°ï¼Œè¿™é‡Œåˆ—å‡ºcURLå·¥å…·å¸¸ç”¨çš„å‚æ•°ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>-X/--request <span class="token punctuation">[</span>GET<span class="token operator">|</span>POST<span class="token operator">|</span>PUT<span class="token operator">|</span>DELETE<span class="token operator">|</span>â€¦<span class="token punctuation">]</span>  æŒ‡å®šè¯·æ±‚çš„ HTTP æ–¹æ³•
-H/--header                           æŒ‡å®šè¯·æ±‚çš„ HTTP Header
-d/--data                             æŒ‡å®šè¯·æ±‚çš„ HTTP æ¶ˆæ¯ä½“ï¼ˆBodyï¼‰
-v/--verbose                          è¾“å‡ºè¯¦ç»†çš„è¿”å›ä¿¡æ¯
-u/--user                             æŒ‡å®šè´¦å·ã€å¯†ç 
-b/--cookie                           è¯»å– cookie
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤å¤–ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨å¸¦UIç•Œé¢çš„å·¥å…·ï¼Œè¿™é‡Œæˆ‘æ¨èä½ ä½¿ç”¨ <code v-pre>Insomnia</code> ã€‚</p>
<p><code v-pre>Insomnia</code>æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„REST APIå®¢æˆ·ç«¯ï¼Œä¸ <code v-pre>Postman</code>ã€<code v-pre>Apifox</code>æ˜¯ä¸€ç±»å·¥å…·ï¼Œç”¨äºæ¥å£ç®¡ç†ã€æµ‹è¯•ã€‚<code v-pre>Insomnia</code>åŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li>å‘é€HTTPè¯·æ±‚ï¼›</li>
<li>åˆ›å»ºå·¥ä½œåŒºæˆ–æ–‡ä»¶å¤¹ï¼›</li>
<li>å¯¼å…¥å’Œå¯¼å‡ºæ•°æ®ï¼›</li>
<li>å¯¼å‡ºcURLæ ¼å¼çš„HTTPè¯·æ±‚å‘½ä»¤ï¼›</li>
<li>æ”¯æŒç¼–å†™swaggeræ–‡æ¡£ï¼›</li>
<li>å¿«é€Ÿåˆ‡æ¢è¯·æ±‚ï¼›</li>
<li>URLç¼–ç å’Œè§£ç ã€‚</li>
<li>â€¦</li>
</ul>
<p><code v-pre>Insomnia</code>ç•Œé¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202302271744432.png" alt="å›¾ç‰‡"></p>
<p>å½“ç„¶äº†ï¼Œä¹Ÿæœ‰å¾ˆå¤šå…¶ä»–ä¼˜ç§€çš„å¸¦UIç•Œé¢çš„REST APIå®¢æˆ·ç«¯ï¼Œä¾‹å¦‚ Postmanã€Apifoxç­‰ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦è‡ªè¡Œé€‰æ‹©ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ç”¨å¯¹secretèµ„æºçš„CURDæ“ä½œï¼Œæ¥ç»™ä½ æ¼”ç¤ºä¸‹ <strong>å¦‚ä½•ä½¿ç”¨iam-apiserverçš„åŠŸèƒ½</strong>ã€‚ä½ éœ€è¦æ‰§è¡Œ6æ­¥æ“ä½œã€‚</p>
<ol>
<li>ç™»å½•<code v-pre>iam-apiserver</code>ï¼Œè·å–tokenã€‚</li>
<li>åˆ›å»ºä¸€ä¸ªåä¸º<code v-pre>secret0</code>çš„secretã€‚</li>
<li>è·å–<code v-pre>secret0</code>çš„è¯¦ç»†ä¿¡æ¯ã€‚</li>
<li>æ›´æ–°<code v-pre>secret0</code>çš„æè¿°ã€‚</li>
<li>è·å–<code v-pre>secret</code>åˆ—è¡¨ã€‚</li>
<li>åˆ é™¤<code v-pre>secret0</code>ã€‚</li>
</ol>
<p><strong>ç™»å½•iam-apiserverï¼Œè·å–tokenï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">"Authorization: Basic <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">'admin:Admin@2021'</span><span class="token operator">|</span>base64<span class="token variable">`</span></span>"</span> http://127.0.0.1:8080/login <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> .token
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2MzUwNTk4NDIsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2MjcyODM4NDIsInN1YiI6ImFkbWluIn0.gTS0n-7njLtpCJ7mvSnct2p3TxNTUQaduNXxqqLwGfI
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œï¼Œä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œæˆ‘ä»¬å°†tokenè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token assign-left variable">TOKEN</span><span class="token operator">=</span>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2MzUwNTk4NDIsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2MjcyODM4NDIsInN1YiI6ImFkbWluIn0.gTS0n-7njLtpCJ7mvSnct2p3TxNTUQaduNXxqqLwGfI
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>åˆ›å»ºä¸€ä¸ªåä¸ºsecret0çš„secretï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-XPOST</span> <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/json"</span> -H<span class="token string">"Authorization: Bearer <span class="token variable">${TOKEN}</span>"</span> -d<span class="token string">'{"metadata":{"name":"secret0"},"expires":0,"description":"admin secret"}'</span> http://iam.api.marmotedu.com:8080/v1/secrets
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to iam.api.marmotedu.com port <span class="token number">8080</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">127.0</span>.0.1<span class="token punctuation">..</span>.
* Connected to iam.api.marmotedu.com <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span> port <span class="token number">8080</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">></span> POST /v1/secrets HTTP/1.1
<span class="token operator">></span> User-Agent: curl/7.29.0
<span class="token operator">></span> Host: iam.api.marmotedu.com:8080
<span class="token operator">></span> Accept: */*
<span class="token operator">></span> Content-Type: application/json
<span class="token operator">></span> Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2MzUwNTk4NDIsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2MjcyODM4NDIsInN1YiI6ImFkbWluIn0.gTS0n-7njLtpCJ7mvSnct2p3TxNTUQaduNXxqqLwGfI
<span class="token operator">></span> Content-Length: <span class="token number">72</span>
<span class="token operator">></span> 
* upload completely sent off: <span class="token number">72</span> out of <span class="token number">72</span> bytes
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span> OK
<span class="token operator">&lt;</span> Content-Type: application/json<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token operator">&lt;</span> X-Request-Id: ff825bea-53de-4020-8e68-4e87574bd1ba
<span class="token operator">&lt;</span> Date: Mon, <span class="token number">26</span> Jul <span class="token number">2021</span> 07:20:26 GMT
<span class="token operator">&lt;</span> Content-Length: <span class="token number">313</span>
<span class="token operator">&lt;</span> 
* Connection <span class="token comment">#0 to host iam.api.marmotedu.com left intact</span>
<span class="token punctuation">{</span><span class="token string">"metadata"</span>:<span class="token punctuation">{</span><span class="token string">"id"</span>:60,<span class="token string">"instanceID"</span><span class="token builtin class-name">:</span><span class="token string">"secret-jedr3e"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"secret0"</span>,<span class="token string">"createdAt"</span><span class="token builtin class-name">:</span><span class="token string">"2021-07-26T15:20:26.885+08:00"</span>,<span class="token string">"updatedAt"</span><span class="token builtin class-name">:</span><span class="token string">"2021-07-26T15:20:26.907+08:00"</span><span class="token punctuation">}</span>,<span class="token string">"username"</span><span class="token builtin class-name">:</span><span class="token string">"admin"</span>,<span class="token string">"secretID"</span><span class="token builtin class-name">:</span><span class="token string">"U6CxKs0YVWyOp5GrluychYIRxDmMDFd1mOOD"</span>,<span class="token string">"secretKey"</span><span class="token builtin class-name">:</span><span class="token string">"fubNIn8jLA55ktuuTpXM8Iw5ogdR2mlf"</span>,<span class="token string">"expires"</span>:0,<span class="token string">"description"</span><span class="token builtin class-name">:</span><span class="token string">"admin secret"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¯·æ±‚è¿”å›å¤´ä¸­è¿”å›äº†<code v-pre>X-Request-Id</code> Headerï¼Œ<code v-pre>X-Request-Id</code>å”¯ä¸€æ ‡è¯†è¿™æ¬¡è¯·æ±‚ã€‚å¦‚æœè¿™æ¬¡è¯·æ±‚å¤±è´¥ï¼Œå°±å¯ä»¥å°†<code v-pre>X-Request-Id</code>æä¾›ç»™è¿ç»´æˆ–è€…å¼€å‘ï¼Œé€šè¿‡<code v-pre>X-Request-Id</code>å®šä½å‡ºå¤±è´¥çš„è¯·æ±‚ï¼Œè¿›è¡Œæ’éšœã€‚å¦å¤–<code v-pre>X-Request-Id</code>åœ¨å¾®æœåŠ¡åœºæ™¯ä¸­ï¼Œä¹Ÿå¯ä»¥é€ä¼ ç»™å…¶ä»–æœåŠ¡ï¼Œä»è€Œå®ç°è¯·æ±‚è°ƒç”¨é“¾ã€‚</p>
<p><strong>è·å–secret0çš„è¯¦ç»†ä¿¡æ¯ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-XGET</span> -H<span class="token string">"Authorization: Bearer <span class="token variable">${TOKEN}</span>"</span> http://iam.api.marmotedu.com:8080/v1/secrets/secret0
<span class="token punctuation">{</span><span class="token string">"metadata"</span>:<span class="token punctuation">{</span><span class="token string">"id"</span>:60,<span class="token string">"instanceID"</span><span class="token builtin class-name">:</span><span class="token string">"secret-jedr3e"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"secret0"</span>,<span class="token string">"createdAt"</span><span class="token builtin class-name">:</span><span class="token string">"2021-07-26T15:20:26+08:00"</span>,<span class="token string">"updatedAt"</span><span class="token builtin class-name">:</span><span class="token string">"2021-07-26T15:20:26+08:00"</span><span class="token punctuation">}</span>,<span class="token string">"username"</span><span class="token builtin class-name">:</span><span class="token string">"admin"</span>,<span class="token string">"secretID"</span><span class="token builtin class-name">:</span><span class="token string">"U6CxKs0YVWyOp5GrluychYIRxDmMDFd1mOOD"</span>,<span class="token string">"secretKey"</span><span class="token builtin class-name">:</span><span class="token string">"fubNIn8jLA55ktuuTpXM8Iw5ogdR2mlf"</span>,<span class="token string">"expires"</span>:0,<span class="token string">"description"</span><span class="token builtin class-name">:</span><span class="token string">"admin secret"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ›´æ–°secret0çš„æè¿°ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-XPUT</span> -H<span class="token string">"Authorization: Bearer $"</span> -d<span class="token string">'{"metadata":{"name":"secret"},"expires":0,"description":"admin secret(modify)"}'</span> http://iam.api.marmotedu.com:8080/v1/secrets/secret0<span class="token punctuation">{</span><span class="token string">"metadata"</span>:<span class="token punctuation">{</span><span class="token string">"id"</span>:60,<span class="token string">"instanceID"</span><span class="token builtin class-name">:</span><span class="token string">"secret-jedr3e"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"secret0"</span>,<span class="token string">"createdAt"</span><span class="token builtin class-name">:</span><span class="token string">"2021-07-26T15:20:26+08:00"</span>,<span class="token string">"updatedAt"</span><span class="token builtin class-name">:</span><span class="token string">"2021-07-26T15:23:35.878+08:00"</span><span class="token punctuation">}</span>,<span class="token string">"username"</span><span class="token builtin class-name">:</span><span class="token string">"admin"</span>,<span class="token string">"secretID"</span><span class="token builtin class-name">:</span><span class="token string">"U6CxKs0YVWyOp5GrluychYIRxDmMDFd1mOOD"</span>,<span class="token string">"secretKey"</span><span class="token builtin class-name">:</span><span class="token string">"fubNIn8jLA55ktuuTpXM8Iw5ogdR2mlf"</span>,<span class="token string">"expires"</span>:0,<span class="token string">"description"</span><span class="token builtin class-name">:</span><span class="token string">"admin secret(modify)"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>è·å–secretåˆ—è¡¨ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-XGET</span> -H<span class="token string">"Authorization: Bearer <span class="token variable">${TOKEN}</span>"</span> http://iam.api.marmotedu.com:8080/v1/secrets
<span class="token punctuation">{</span><span class="token string">"totalCount"</span>:1,<span class="token string">"items"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"metadata"</span>:<span class="token punctuation">{</span><span class="token string">"id"</span>:60,<span class="token string">"instanceID"</span><span class="token builtin class-name">:</span><span class="token string">"secret-jedr3e"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"secret0"</span>,<span class="token string">"createdAt"</span><span class="token builtin class-name">:</span><span class="token string">"2021-07-26T15:20:26+08:00"</span>,<span class="token string">"updatedAt"</span><span class="token builtin class-name">:</span><span class="token string">"2021-07-26T15:23:35+08:00"</span><span class="token punctuation">}</span>,<span class="token string">"username"</span><span class="token builtin class-name">:</span><span class="token string">"admin"</span>,<span class="token string">"secretID"</span><span class="token builtin class-name">:</span><span class="token string">"U6CxKs0YVWyOp5GrluychYIRxDmMDFd1mOOD"</span>,<span class="token string">"secretKey"</span><span class="token builtin class-name">:</span><span class="token string">"fubNIn8jLA55ktuuTpXM8Iw5ogdR2mlf"</span>,<span class="token string">"expires"</span>:0,<span class="token string">"description"</span><span class="token builtin class-name">:</span><span class="token string">"admin secret(modify)"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>åˆ é™¤secret0ï¼š</strong></p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>$ curl -XDELETE -H"Authorization: Bearer $" http://iam.api.marmotedu.com:8080/v1/secrets/secret0null
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¸Šé¢ï¼Œæˆ‘ç»™ä½ æ¼”ç¤ºäº†å¯†é’¥çš„ä½¿ç”¨æ–¹æ³•ã€‚ç”¨æˆ·å’Œç­–ç•¥èµ„æºç±»å‹çš„ä½¿ç”¨æ–¹æ³•è·Ÿå¯†é’¥ç±»ä¼¼ã€‚è¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•ä½ å¯ä»¥å‚è€ƒ <a href="https://github.com/marmotedu/iam/blob/v1.0.6/scripts/install/test.sh" target="_blank" rel="noopener noreferrer">test.sh<ExternalLinkIcon/></a> è„šæœ¬ï¼Œè¯¥è„šæœ¬æ˜¯ç”¨æ¥æµ‹è¯•IAMåº”ç”¨çš„ï¼Œé‡Œé¢åŒ…å«äº†å„ä¸ªæ¥å£çš„è¯·æ±‚æ–¹æ³•ã€‚</p>
<p>è¿™é‡Œï¼Œæˆ‘è¿˜æƒ³é¡ºä¾¿ä»‹ç»ä¸‹<strong>å¦‚ä½•æµ‹è¯•IAMåº”ç”¨ä¸­çš„å„ä¸ªéƒ¨åˆ†</strong>ã€‚ç¡®ä¿iam-apiserverã€iam-authz-serverã€iam-pumpç­‰æœåŠ¡æ­£å¸¸è¿è¡Œåï¼Œè¿›å…¥åˆ°IAMé¡¹ç›®çš„æ ¹ç›®å½•ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ ./scripts/install/test.sh iam::test::test <span class="token comment"># æµ‹è¯•æ•´ä¸ªIAMåº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ</span>
$ ./scripts/install/test.sh iam::test::login <span class="token comment"># æµ‹è¯•ç™»é™†æ¥å£æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®</span>
$ ./scripts/install/test.sh iam::test::user <span class="token comment"># æµ‹è¯•ç”¨æˆ·æ¥å£æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®</span>
$ ./scripts/install/test.sh iam::test::secret <span class="token comment"># æµ‹è¯•å¯†é’¥æ¥å£æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®</span>
$ ./scripts/install/test.sh iam::test::policy <span class="token comment"># æµ‹è¯•ç­–ç•¥æ¥å£æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®</span>
$ ./scripts/install/test.sh iam::test::apiserver <span class="token comment"># æµ‹è¯•iam-apiserveræœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</span>
$ ./scripts/install/test.sh iam::test::authz <span class="token comment"># æµ‹è¯•authzæ¥å£æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®</span>
$ ./scripts/install/test.sh iam::test::authzserver <span class="token comment"># æµ‹è¯•iam-authz-serveræœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</span>
$ ./scripts/install/test.sh iam::test::pump <span class="token comment"># æµ‹è¯•iam-pumpæ˜¯å¦æ­£å¸¸è¿è¡Œ</span>
$ ./scripts/install/test.sh iam::test::iamctl <span class="token comment"># æµ‹è¯•iamctlå·¥å…·æ˜¯å¦å¯ä»¥æ­£å¸¸ä½¿ç”¨</span>
$ ./scripts/install/test.sh iam::test::man <span class="token comment"># æµ‹è¯•manæ–‡ä»¶æ˜¯å¦æ­£ç¡®å®‰è£…</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€ä»¥ï¼Œæ¯æ¬¡å‘å¸ƒå®Œiam-apiserveråï¼Œä½ å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆiam-apiserverçš„å†’çƒŸæµ‹è¯•ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">IAM_APISERVER_HOST</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1 <span class="token comment"># iam-apiserveréƒ¨ç½²æœåŠ¡å™¨çš„IPåœ°å€</span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">IAM_APISERVER_INSECURE_BIND_PORT</span><span class="token operator">=</span><span class="token number">8080</span> <span class="token comment"># iam-apiserver HTTPæœåŠ¡çš„ç›‘å¬ç«¯å£</span>
$ ./scripts/install/test.sh iam::test::apiserver
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="iam-apiserverä»£ç å®ç°" tabindex="-1"><a class="header-anchor" href="#iam-apiserverä»£ç å®ç°" aria-hidden="true">#</a> iam-apiserverä»£ç å®ç°</h2>
<p>ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†iam-apiserverçš„åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹iam-apiserverå…·ä½“çš„ä»£ç å®ç°ã€‚æˆ‘ä¼šä»é…ç½®å¤„ç†ã€å¯åŠ¨æµç¨‹ã€è¯·æ±‚å¤„ç†æµç¨‹ã€ä»£ç æ¶æ„4ä¸ªæ–¹é¢æ¥è®²è§£ã€‚</p>
<h3 id="iam-apiserveré…ç½®å¤„ç†" tabindex="-1"><a class="header-anchor" href="#iam-apiserveré…ç½®å¤„ç†" aria-hidden="true">#</a> iam-apiserveré…ç½®å¤„ç†</h3>
<p>iam-apiserveræœåŠ¡çš„mainå‡½æ•°ä½äº<a href="https://github.com/marmotedu/iam/blob/v1.0.4/cmd/iam-apiserver/apiserver.go#L18" target="_blank" rel="noopener noreferrer">apiserver.go<ExternalLinkIcon/></a>æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥è·Ÿè¯»ä»£ç ï¼Œäº†è§£iam-apiserverçš„ä»£ç å®ç°ã€‚è¿™é‡Œï¼Œæˆ‘æ¥ä»‹ç»ä¸‹iam-apiserveræœåŠ¡çš„ä¸€äº›è®¾è®¡æ€æƒ³ã€‚</p>
<p>é¦–å…ˆï¼Œæ¥çœ‹ä¸‹iam-apiserverä¸­çš„3ç§é…ç½®ï¼šOptionsé…ç½®ã€åº”ç”¨é…ç½®å’Œ HTTP/GRPCæœåŠ¡é…ç½®ã€‚</p>
<ul>
<li>**Optionsé…ç½®ï¼š**ç”¨æ¥æ„å»ºå‘½ä»¤è¡Œå‚æ•°ï¼Œå®ƒçš„å€¼æ¥è‡ªäºå‘½ä»¤è¡Œé€‰é¡¹æˆ–è€…é…ç½®æ–‡ä»¶ï¼ˆä¹Ÿå¯èƒ½æ˜¯äºŒè€…Mergeåçš„é…ç½®ï¼‰ã€‚Optionså¯ä»¥ç”¨æ¥æ„å»ºåº”ç”¨æ¡†æ¶ï¼ŒOptionsé…ç½®ä¹Ÿæ˜¯åº”ç”¨é…ç½®çš„è¾“å…¥ã€‚</li>
<li>**åº”ç”¨****é…ç½®ï¼š**iam-apiserverç»„ä»¶ä¸­éœ€è¦çš„ä¸€åˆ‡é…ç½®ã€‚æœ‰å¾ˆå¤šåœ°æ–¹éœ€è¦é…ç½®ï¼Œä¾‹å¦‚ï¼Œå¯åŠ¨HTTP/GRPCéœ€è¦é…ç½®ç›‘å¬åœ°å€å’Œç«¯å£ï¼Œåˆå§‹åŒ–æ•°æ®åº“éœ€è¦é…ç½®æ•°æ®åº“åœ°å€ã€ç”¨æˆ·åã€å¯†ç ç­‰ã€‚</li>
<li>**HTTP/GRPCæœåŠ¡é…ç½®ï¼š**å¯åŠ¨HTTPæœåŠ¡æˆ–è€…GRPCæœåŠ¡éœ€è¦çš„é…ç½®ã€‚</li>
</ul>
<p>è¿™ä¸‰ç§é…ç½®çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://sm.nsddd.top/sm202302282136791.jpeg" alt="img"></p>
<p>Optionsé…ç½®æ¥ç®¡å‘½ä»¤è¡Œé€‰é¡¹ï¼Œåº”ç”¨é…ç½®æ¥ç®¡æ•´ä¸ªåº”ç”¨çš„é…ç½®ï¼ŒHTTP/GRPCæœåŠ¡é…ç½®æ¥ç®¡è·ŸHTTP/GRPCæœåŠ¡ç›¸å…³çš„é…ç½®ã€‚è¿™3ç§é…ç½®ç‹¬ç«‹å¼€æ¥ï¼Œå¯ä»¥è§£è€¦å‘½ä»¤è¡Œé€‰é¡¹ã€åº”ç”¨å’Œåº”ç”¨å†…çš„æœåŠ¡ï¼Œä½¿å¾—è¿™3ä¸ªéƒ¨åˆ†å¯ä»¥ç‹¬ç«‹æ‰©å±•ï¼Œåˆä¸ç›¸äº’å½±å“ã€‚</p>
<p>iam-apiserveræ ¹æ®Optionsé…ç½®æ¥æ„å»ºå‘½ä»¤è¡Œå‚æ•°å’Œåº”ç”¨é…ç½®ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡<code v-pre>github.com/marmotedu/iam/pkg/app</code>åŒ…çš„<a href="https://github.com/marmotedu/iam/blob/v1.0.4/pkg/app/app.go#L199" target="_blank" rel="noopener noreferrer">buildCommand<ExternalLinkIcon/></a>æ–¹æ³•æ¥æ„å»ºå‘½ä»¤è¡Œå‚æ•°ã€‚è¿™é‡Œçš„æ ¸å¿ƒæ˜¯ï¼Œé€šè¿‡<a href="https://github.com/marmotedu/iam/blob/v1.0.4/pkg/app/app.go#L157" target="_blank" rel="noopener noreferrer">NewApp<ExternalLinkIcon/></a>å‡½æ•°æ„å»ºApplicationå®ä¾‹æ—¶ï¼Œä¼ å…¥çš„<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/options/options.go#L19" target="_blank" rel="noopener noreferrer">Options<ExternalLinkIcon/></a>å®ç°äº†<code v-pre>Flags() (fss cliflag.NamedFlagSets)</code>æ–¹æ³•ï¼Œé€šè¿‡buildCommandæ–¹æ³•ä¸­çš„ä»¥ä¸‹ä»£ç ï¼Œå°†optionçš„Flagæ·»åŠ åˆ°cobraå®ä¾‹çš„FlagSetä¸­ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">if</span> a<span class="token punctuation">.</span>options <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    namedFlagSets <span class="token operator">=</span> a<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fs <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> namedFlagSets<span class="token punctuation">.</span>FlagSets <span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">AddFlagSet</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

          <span class="token operator">...</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/config/config.go#L16" target="_blank" rel="noopener noreferrer">CreateConfigFromOptions<ExternalLinkIcon/></a>å‡½æ•°æ¥æ„å»ºåº”ç”¨é…ç½®ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>cfg<span class="token punctuation">,</span> err <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">CreateConfigFromOptions</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span>                      
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                                               
    <span class="token keyword">return</span> err                                                
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ ¹æ®åº”ç”¨é…ç½®æ¥æ„å»ºHTTP/GRPCæœåŠ¡é…ç½®ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç æ ¹æ®åº”ç”¨é…ç½®ï¼Œæ„å»ºäº†HTTPæœåŠ¡å™¨çš„Addresså‚æ•°ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>InsecureServingOptions<span class="token punctuation">)</span> <span class="token function">ApplyTo</span><span class="token punctuation">(</span>c <span class="token operator">*</span>server<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>InsecureServing <span class="token operator">=</span> <span class="token operator">&amp;</span>server<span class="token punctuation">.</span>InsecureServingInfo<span class="token punctuation">{</span>
        Address<span class="token punctuation">:</span> net<span class="token punctuation">.</span><span class="token function">JoinHostPort</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>BindAddress<span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>BindPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­ï¼Œ<code v-pre>c *server.Config</code>æ˜¯HTTPæœåŠ¡å™¨çš„é…ç½®ï¼Œ<code v-pre>s *InsecureServingOptions</code>æ˜¯åº”ç”¨é…ç½®ã€‚</p>
<h3 id="iam-apiserverå¯åŠ¨æµç¨‹è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#iam-apiserverå¯åŠ¨æµç¨‹è®¾è®¡" aria-hidden="true">#</a> iam-apiserverå¯åŠ¨æµç¨‹è®¾è®¡</h3>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸‹iam-apiserverçš„å¯åŠ¨æµç¨‹è®¾è®¡ã€‚å¯åŠ¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="https://static001.geekbang.org/resource/image/8a/c7/8a94938bc087ed96d0ec87261db292c7.jpg?wh=4770x1487" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/8a/c7/8a94938bc087ed96d0ec87261db292c7.jpg?wh=4770x1487" alt="img"><ExternalLinkIcon/></a></p>
<p>**é¦–å…ˆï¼Œ**é€šè¿‡<code v-pre>opts := options.NewOptions()</code>åˆ›å»ºå¸¦æœ‰é»˜è®¤å€¼çš„Optionsç±»å‹å˜é‡optsã€‚optså˜é‡ä½œä¸º<code v-pre>github.com/marmotedu/iam/pkg/app</code>åŒ…çš„<code v-pre>NewApp</code>å‡½æ•°çš„è¾“å…¥å‚æ•°ï¼Œæœ€ç»ˆåœ¨Appæ¡†æ¶ä¸­ï¼Œè¢«æ¥è‡ªäºå‘½ä»¤è¡Œå‚æ•°æˆ–é…ç½®æ–‡ä»¶çš„é…ç½®ï¼ˆä¹Ÿå¯èƒ½æ˜¯äºŒè€…Mergeåçš„é…ç½®ï¼‰æ‰€å¡«å……ï¼Œoptså˜é‡ä¸­å„ä¸ªå­—æ®µçš„å€¼ä¼šç”¨æ¥åˆ›å»ºåº”ç”¨é…ç½®ã€‚</p>
<p>**æ¥ç€ï¼Œ**ä¼šæ³¨å†Œ<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/apiserver.go#L36" target="_blank" rel="noopener noreferrer">run<ExternalLinkIcon/></a>å‡½æ•°åˆ°Appæ¡†æ¶ä¸­ã€‚runå‡½æ•°æ˜¯iam-apiserverçš„å¯åŠ¨å‡½æ•°ï¼Œé‡Œé¢å°è£…äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„å¯åŠ¨é€»è¾‘ã€‚runå‡½æ•°ä¸­ï¼Œé¦–å…ˆä¼šåˆå§‹åŒ–æ—¥å¿—åŒ…ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®éœ€è¦ï¼Œåœ¨åé¢çš„ä»£ç ä¸­éšæ—¶è®°å½•æ—¥å¿—äº†ã€‚</p>
<p>**ç„¶åï¼Œ**ä¼šåˆ›å»ºåº”ç”¨é…ç½®ã€‚åº”ç”¨é…ç½®å’ŒOptionsé…ç½®å…¶å®æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼ŒäºŒè€…å¯èƒ½å®Œå…¨ä¸åŒï¼Œä½†åœ¨iam-apiserverä¸­ï¼ŒäºŒè€…é…ç½®é¡¹æ˜¯ç›¸åŒçš„ã€‚</p>
<p>**ä¹‹åï¼Œ**æ ¹æ®åº”ç”¨é…ç½®ï¼Œåˆ›å»ºHTTP/GRPCæœåŠ¡å™¨æ‰€ä½¿ç”¨çš„é…ç½®ã€‚åœ¨åˆ›å»ºé…ç½®åï¼Œä¼šå…ˆåˆ†åˆ«è¿›è¡Œé…ç½®è¡¥å…¨ï¼Œå†ä½¿ç”¨è¡¥å…¨åçš„é…ç½®åˆ›å»ºWebæœåŠ¡å®ä¾‹ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>genericServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> genericConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
extraServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> extraConfig<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
<span class="token operator">...</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ExtraConfig<span class="token punctuation">)</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>completedExtraConfig <span class="token punctuation">{</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>Addr <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>Addr <span class="token operator">=</span> <span class="token string">"127.0.0.1:8081"</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>completedExtraConfig<span class="token punctuation">{</span>c<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé¦–å…ˆè°ƒç”¨<code v-pre>Complete</code>/<code v-pre>complete</code>å‡½æ•°è¡¥å…¨é…ç½®ï¼Œå†åŸºäºè¡¥å…¨åçš„é…ç½®ï¼ŒNewä¸€ä¸ªHTTP/GRPCæœåŠ¡å®ä¾‹ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸ªè®¾è®¡æŠ€å·§ï¼š<code v-pre>complete</code>å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª<code v-pre>*completedExtraConfig</code>ç±»å‹çš„å®ä¾‹ï¼Œåœ¨åˆ›å»ºGRPCå®ä¾‹æ—¶ï¼Œæ˜¯è°ƒç”¨<code v-pre>completedExtraConfig</code>ç»“æ„ä½“æä¾›çš„<code v-pre>New</code>æ–¹æ³•ï¼Œè¿™ç§è®¾è®¡æ–¹æ³•å¯ä»¥ç¡®ä¿æˆ‘ä»¬åˆ›å»ºçš„GRPCå®ä¾‹ä¸€å®šæ˜¯åŸºäºcompleteä¹‹åçš„é…ç½®ï¼ˆcompletedï¼‰ã€‚</p>
<p>åœ¨å®é™…çš„Goé¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸€ç§æœºåˆ¶æ¥å¤„ç†æˆ–è¡¥å…¨é…ç½®ï¼Œè¿™åœ¨Goé¡¹ç›®å¼€å‘ä¸­æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ­¥éª¤ã€‚</p>
<p>**æœ€åï¼Œ**è°ƒç”¨<code v-pre>PrepareRun</code>æ–¹æ³•ï¼Œè¿›è¡ŒHTTP/GRPCæœåŠ¡å™¨å¯åŠ¨å‰çš„å‡†å¤‡ã€‚åœ¨å‡†å¤‡å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åšå„ç§åˆå§‹åŒ–æ“ä½œï¼Œä¾‹å¦‚åˆå§‹åŒ–æ•°æ®åº“ï¼Œå®‰è£…ä¸šåŠ¡ç›¸å…³çš„Ginä¸­é—´ä»¶ã€RESTful APIè·¯ç”±ç­‰ã€‚</p>
<p>å®ŒæˆHTTP/GRPCæœåŠ¡å™¨å¯åŠ¨å‰çš„å‡†å¤‡ä¹‹åï¼Œè°ƒç”¨<code v-pre>Run</code>æ–¹æ³•å¯åŠ¨HTTP/GRPCæœåŠ¡ã€‚åœ¨<code v-pre>Run</code>æ–¹æ³•ä¸­ï¼Œåˆ†åˆ«å¯åŠ¨äº†GRPCå’ŒHTTPæœåŠ¡ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªiam-apiserverçš„è½¯ä»¶æ¡†æ¶æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚</p>
<p>æœåŠ¡å¯åŠ¨åï¼Œå°±å¯ä»¥å¤„ç†è¯·æ±‚äº†ã€‚æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹iam-apiserverçš„RESTAPIè¯·æ±‚å¤„ç†æµç¨‹ã€‚</p>
<h3 id="iam-apiserver-çš„rest-apiè¯·æ±‚å¤„ç†æµç¨‹" tabindex="-1"><a class="header-anchor" href="#iam-apiserver-çš„rest-apiè¯·æ±‚å¤„ç†æµç¨‹" aria-hidden="true">#</a> iam-apiserver çš„REST APIè¯·æ±‚å¤„ç†æµç¨‹</h3>
<p>iam-apiserverçš„è¯·æ±‚å¤„ç†æµç¨‹ä¹Ÿæ˜¯æ¸…æ™°ã€è§„èŒƒçš„ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202302282203119.jpeg" alt="img"></p>
<p>ç»“åˆä¸Šé¢è¿™å¼ å›¾ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹iam-apiserver çš„REST APIè¯·æ±‚å¤„ç†æµç¨‹ï¼Œæ¥å¸®ä½ æ›´å¥½åœ°ç†è§£iam-apiserveræ˜¯å¦‚ä½•å¤„ç†HTTPè¯·æ±‚çš„ã€‚</p>
<p>**é¦–å…ˆï¼Œ**æˆ‘ä»¬é€šè¿‡APIè°ƒç”¨ï¼ˆ<code v-pre>&lt;HTTP Method&gt; + &lt;HTTP Request Path&gt;</code>ï¼‰è¯·æ±‚iam-apiserveræä¾›çš„RESTful APIæ¥å£ã€‚</p>
<p>**æ¥ç€ï¼Œ**Gin Webæ¡†æ¶æ¥æ”¶åˆ°HTTPè¯·æ±‚ä¹‹åï¼Œä¼šé€šè¿‡è®¤è¯ä¸­é—´ä»¶å®Œæˆè¯·æ±‚çš„è®¤è¯ï¼Œiam-apiserveræä¾›äº†Basicè®¤è¯å’ŒBearerè®¤è¯ä¸¤ç§è®¤è¯æ–¹å¼ã€‚</p>
<p>**è®¤è¯****é€šè¿‡åï¼Œ**è¯·æ±‚ä¼šè¢«æˆ‘ä»¬åŠ è½½çš„ä¸€ç³»åˆ—ä¸­é—´ä»¶æ‰€å¤„ç†ï¼Œä¾‹å¦‚è·¨åŸŸã€RequestIDã€Dumpç­‰ä¸­é—´ä»¶ã€‚</p>
<p>**æœ€åï¼Œ**æ ¹æ®<code v-pre>&lt;HTTP Method&gt; + &lt;HTTP Request Path&gt;</code>è¿›è¡Œè·¯ç”±åŒ¹é…ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¯·æ±‚çš„RESTful APIæ˜¯<code v-pre>POST + /v1/secrets</code>ï¼ŒGin Webæ¡†æ¶ä¼šæ ¹æ®HTTP Methodå’ŒHTTP Request Pathï¼ŒæŸ¥æ‰¾æ³¨å†Œçš„Controllersï¼Œæœ€ç»ˆåŒ¹é…åˆ°<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/controller/v1/secret/create.go" target="_blank" rel="noopener noreferrer">secretController.Create<ExternalLinkIcon/></a>Controllerã€‚åœ¨Create Controllerä¸­ï¼Œæˆ‘ä»¬ä¼šä¾æ¬¡æ‰§è¡Œè¯·æ±‚å‚æ•°è§£æã€è¯·æ±‚å‚æ•°æ ¡éªŒã€è°ƒç”¨ä¸šåŠ¡å±‚çš„æ–¹æ³•åˆ›å»ºSecretã€å¤„ç†ä¸šåŠ¡å±‚çš„è¿”å›ç»“æœï¼Œæœ€åè¿”å›æœ€ç»ˆçš„HTTPè¯·æ±‚ç»“æœã€‚</p>
<h3 id="iam-apiserverä»£ç æ¶æ„" tabindex="-1"><a class="header-anchor" href="#iam-apiserverä»£ç æ¶æ„" aria-hidden="true">#</a> iam-apiserverä»£ç æ¶æ„</h3>
<p>iam-apiserverä»£ç è®¾è®¡éµå¾ªç®€æ´æ¶æ„è®¾è®¡ï¼Œä¸€ä¸ªç®€æ´æ¶æ„å…·æœ‰ä»¥ä¸‹5ä¸ªç‰¹æ€§ï¼š</p>
<ul>
<li>**ç‹¬ç«‹äºæ¡†æ¶ï¼š**è¯¥æ¶æ„ä¸ä¼šä¾èµ–äºæŸäº›åŠŸèƒ½å¼ºå¤§çš„è½¯ä»¶åº“å­˜åœ¨ã€‚è¿™å¯ä»¥è®©ä½ ä½¿ç”¨è¿™æ ·çš„æ¡†æ¶ä½œä¸ºå·¥å…·ï¼Œè€Œä¸æ˜¯è®©ä½ çš„ç³»ç»Ÿé™·å…¥åˆ°æ¡†æ¶çš„çº¦æŸä¸­ã€‚</li>
<li>**å¯æµ‹è¯•æ€§ï¼š**ä¸šåŠ¡è§„åˆ™å¯ä»¥åœ¨æ²¡æœ‰UIã€æ•°æ®åº“ã€WebæœåŠ¡æˆ–å…¶ä»–å¤–éƒ¨å…ƒç´ çš„æƒ…å†µä¸‹è¿›è¡Œæµ‹è¯•ï¼Œåœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡Mockæ¥è§£è€¦è¿™äº›ä¾èµ–ã€‚</li>
<li>**ç‹¬ç«‹äºUI ï¼š**åœ¨æ— éœ€æ”¹å˜ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†çš„æƒ…å†µä¸‹ï¼ŒUIå¯ä»¥è½»æ¾åœ°æ”¹å˜ã€‚ä¾‹å¦‚ï¼Œåœ¨æ²¡æœ‰æ”¹å˜ä¸šåŠ¡è§„åˆ™çš„æƒ…å†µä¸‹ï¼ŒWeb UIå¯ä»¥æ›¿æ¢ä¸ºæ§åˆ¶å°UIã€‚</li>
<li>**ç‹¬ç«‹äºæ•°æ®åº“ï¼š**ä½ å¯ä»¥ç”¨Mongoã€Oracleã€Etcdæˆ–è€…å…¶ä»–æ•°æ®åº“æ¥æ›¿æ¢MariaDBï¼Œä½ çš„ä¸šåŠ¡è§„åˆ™ä¸è¦ç»‘å®šåˆ°æ•°æ®åº“ã€‚</li>
<li>**ç‹¬ç«‹äºå¤–éƒ¨åª’ä»‹ï¼š**å®é™…ä¸Šï¼Œä½ çš„ä¸šåŠ¡è§„åˆ™å¯ä»¥ç®€å•åˆ°æ ¹æœ¬ä¸å»äº†è§£å¤–éƒ¨ä¸–ç•Œã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼ŒåŸºäºè¿™äº›çº¦æŸï¼Œæ¯ä¸€å±‚éƒ½å¿…é¡»æ˜¯ç‹¬ç«‹çš„å’Œå¯æµ‹è¯•çš„ã€‚iam-apiserverä»£ç æ¶æ„åˆ†ä¸º4å±‚ï¼šæ¨¡å‹å±‚ï¼ˆModelsï¼‰ã€æ§åˆ¶å±‚ï¼ˆControllerï¼‰ã€ä¸šåŠ¡å±‚ ï¼ˆServiceï¼‰ã€ä»“åº“å±‚ï¼ˆRepositoryï¼‰ã€‚ä»æ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚åˆ°ä»“åº“å±‚ï¼Œä»å·¦åˆ°å³å±‚çº§ä¾æ¬¡åŠ æ·±ã€‚æ¨¡å‹å±‚ç‹¬ç«‹äºå…¶ä»–å±‚ï¼Œå¯ä¾›å…¶ä»–å±‚å¼•ç”¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202302282203289.jpeg" alt="img"></p>
<p>å±‚ä¸å±‚ä¹‹é—´å¯¼å…¥åŒ…æ—¶ï¼Œéƒ½æœ‰ä¸¥æ ¼çš„å¯¼å…¥å…³ç³»ï¼Œè¿™å¯ä»¥é˜²æ­¢åŒ…çš„å¾ªç¯å¯¼å…¥é—®é¢˜ã€‚å¯¼å…¥å…³ç³»å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ¨¡å‹å±‚çš„åŒ…å¯ä»¥è¢«ä»“åº“å±‚ã€ä¸šåŠ¡å±‚å’Œæ§åˆ¶å±‚å¯¼å…¥ï¼›</li>
<li>æ§åˆ¶å±‚èƒ½å¤Ÿå¯¼å…¥ä¸šåŠ¡å±‚å’Œä»“åº“å±‚çš„åŒ…ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œæ§åˆ¶å±‚è¦é¿å…å¯¼å…¥ä»“åº“å±‚çš„åŒ…ï¼Œæ§åˆ¶å±‚éœ€è¦å®Œæˆçš„ä¸šåŠ¡åŠŸèƒ½éƒ½é€šè¿‡ä¸šåŠ¡å±‚æ¥å®Œæˆã€‚è¿™æ ·å¯ä»¥ä½¿ä»£ç é€»è¾‘æ›´åŠ æ¸…æ™°ã€è§„èŒƒã€‚</li>
<li>ä¸šåŠ¡å±‚èƒ½å¤Ÿå¯¼å…¥ä»“åº“å±‚çš„åŒ…ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥è¯¦ç»†çœ‹ä¸‹æ¯ä¸€å±‚æ‰€å®Œæˆçš„åŠŸèƒ½ï¼Œä»¥åŠå…¶ä¸­çš„ä¸€äº›æ³¨æ„ç‚¹ã€‚</p>
<p><strong>æ¨¡å‹å±‚ï¼ˆModelsï¼‰</strong></p>
<p>æ¨¡å‹å±‚åœ¨æœ‰äº›è½¯ä»¶æ¶æ„ä¸­ä¹Ÿå«åšå®ä½“å±‚ï¼ˆEntitiesï¼‰ï¼Œæ¨¡å‹ä¼šåœ¨æ¯ä¸€å±‚ä¸­ä½¿ç”¨ï¼Œåœ¨è¿™ä¸€å±‚ä¸­å­˜å‚¨å¯¹è±¡çš„ç»“æ„å’Œå®ƒçš„æ–¹æ³•ã€‚IAMé¡¹ç›®æ¨¡å‹å±‚ä¸­çš„æ¨¡å‹å­˜æ”¾åœ¨<a href="https://github.com/marmotedu/api/tree/master/apiserver/v1" target="_blank" rel="noopener noreferrer">github.com/marmotedu/api/apiserver/v1<ExternalLinkIcon/></a>ç›®å½•ä¸‹ï¼Œå®šä¹‰äº†<code v-pre>User</code>ã€<code v-pre>UserList</code>ã€<code v-pre>Secret</code>ã€<code v-pre>SecretList</code>ã€<code v-pre>Policy</code>ã€<code v-pre>PolicyList</code>ã€<code v-pre>AuthzPolicy</code>æ¨¡å‹åŠå…¶æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Secret <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token comment">// May add TypeMeta in the future.</span>
  <span class="token comment">// metav1.TypeMeta `json:",inline"`</span>

  <span class="token comment">// Standard object's metadata.</span>
  metav1<span class="token punctuation">.</span>ObjectMeta <span class="token string">`       json:"metadata,omitempty"`</span>
  Username          <span class="token builtin">string</span> <span class="token string">`json:"username"           gorm:"column:username"  validate:"omitempty"`</span>
  SecretID          <span class="token builtin">string</span> <span class="token string">`json:"secretID"           gorm:"column:secretID"  validate:"omitempty"`</span>
  SecretKey         <span class="token builtin">string</span> <span class="token string">`json:"secretKey"          gorm:"column:secretKey" validate:"omitempty"`</span>

  <span class="token comment">// Required: true</span>
  Expires     <span class="token builtin">int64</span>  <span class="token string">`json:"expires"     gorm:"column:expires"     validate:"omitempty"`</span>
  Description <span class="token builtin">string</span> <span class="token string">`json:"description" gorm:"column:description" validate:"description"`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹‹æ‰€ä»¥å°†æ¨¡å‹å±‚çš„æ¨¡å‹å­˜æ”¾åœ¨<code v-pre>github.com/marmotedu/api</code>é¡¹ç›®ä¸­ï¼Œè€Œä¸æ˜¯<code v-pre>github.com/marmotedu/iam</code>é¡¹ç›®ä¸­ï¼Œæ˜¯ä¸ºäº†è®©è¿™äº›æ¨¡å‹èƒ½å¤Ÿè¢«å…¶ä»–é¡¹ç›®ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œiamçš„æ¨¡å‹å¯ä»¥è¢«<code v-pre>github.com/marmotedu/shippy</code>åº”ç”¨å¯¼å…¥ã€‚åŒæ ·ï¼Œshippyåº”ç”¨çš„æ¨¡å‹ä¹Ÿå¯ä»¥è¢«iamé¡¹ç›®å¯¼å…¥ï¼Œå¯¼å…¥å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202302282204303.jpeg" alt="img"></p>
<p>ä¸Šé¢çš„ä¾èµ–å…³ç³»éƒ½æ˜¯å•å‘çš„ï¼Œä¾èµ–å…³ç³»æ¸…æ™°ï¼Œä¸å­˜åœ¨å¾ªç¯ä¾èµ–çš„æƒ…å†µã€‚</p>
<p>è¦å¢åŠ shippyçš„æ¨¡å‹å®šä¹‰ï¼Œåªéœ€è¦åœ¨apiç›®å½•ä¸‹åˆ›å»ºæ–°çš„ç›®å½•å³å¯ã€‚ä¾‹å¦‚ï¼Œshippyåº”ç”¨ä¸­æœ‰ä¸€ä¸ªvesselæœåŠ¡ï¼Œå…¶æ¨¡å‹æ‰€åœ¨çš„åŒ…å¯ä»¥ä¸º<code v-pre>github.com/marmotedu/api/vessel</code>ã€‚</p>
<p>å¦å¤–ï¼Œè¿™é‡Œçš„æ¨¡å‹æ—¢å¯ä»¥ä½œä¸ºæ•°æ®åº“æ¨¡å‹ï¼Œåˆå¯ä»¥ä½œä¸ºAPIæ¥å£çš„è¯·æ±‚æ¨¡å‹ï¼ˆå…¥å‚ã€å‡ºå‚ï¼‰ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿç¡®ä¿<strong>åˆ›å»ºèµ„æºæ—¶çš„å±æ€§</strong>ã€<strong>èµ„æºä¿å­˜åœ¨æ•°æ®åº“ä¸­çš„å±æ€§</strong>ã€<strong>è¿”å›èµ„æºçš„å±æ€§</strong>ä¸‰è€…ä¸€è‡´ï¼Œå°±å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªæ¨¡å‹ã€‚é€šè¿‡ä½¿ç”¨åŒä¸€ä¸ªæ¨¡å‹ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬çš„ä»£ç æ›´åŠ ç®€æ´ã€æ˜“ç»´æŠ¤ï¼Œå¹¶èƒ½æé«˜å¼€å‘æ•ˆç‡ã€‚å¦‚æœè¿™ä¸‰ä¸ªå±æ€§æœ‰å·®å¼‚ï¼Œä½ å¯ä»¥å¦å¤–æ–°å»ºæ¨¡å‹æ¥é€‚é…ã€‚</p>
<p><strong>ä»“åº“å±‚ï¼ˆRepository)</strong></p>
<p>ä»“åº“å±‚ç”¨æ¥è·Ÿæ•°æ®åº“/ç¬¬ä¸‰æ–¹æœåŠ¡è¿›è¡ŒCURDäº¤äº’ï¼Œä½œä¸ºåº”ç”¨ç¨‹åºçš„æ•°æ®å¼•æ“è¿›è¡Œåº”ç”¨æ•°æ®çš„è¾“å…¥å’Œè¾“å‡ºã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œä»“åº“å±‚ä»…å¯¹æ•°æ®åº“/ç¬¬ä¸‰æ–¹æœåŠ¡æ‰§è¡ŒCRUDæ“ä½œï¼Œä¸å°è£…ä»»ä½•ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>ä»“åº“å±‚ä¹Ÿè´Ÿè´£é€‰æ‹©åº”ç”¨ä¸­å°†è¦ä½¿ç”¨ä»€ä¹ˆæ ·çš„æ•°æ®åº“ï¼Œå¯ä»¥æ˜¯MySQLã€MongoDBã€MariaDBã€Etcdç­‰ã€‚æ— è®ºä½¿ç”¨å“ªç§æ•°æ®åº“ï¼Œéƒ½è¦åœ¨è¿™å±‚å†³å®šã€‚ä»“åº“å±‚ä¾èµ–äºè¿æ¥æ•°æ®åº“æˆ–å…¶ä»–ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ã€‚</p>
<p>è¿™ä¸€å±‚ä¹Ÿä¼šèµ·åˆ°æ•°æ®è½¬æ¢çš„ä½œç”¨ï¼šå°†ä»æ•°æ®åº“/å¾®æœåŠ¡ä¸­è·å–çš„æ•°æ®è½¬æ¢ä¸ºæ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚èƒ½è¯†åˆ«çš„æ•°æ®ç»“æ„ï¼Œå°†æ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚çš„æ•°æ®æ ¼å¼è½¬æ¢ä¸ºæ•°æ®åº“æˆ–å¾®æœåŠ¡èƒ½è¯†åˆ«çš„æ•°æ®æ ¼å¼ã€‚</p>
<p>iam-apiserverçš„ä»“åº“å±‚ä½äº<a href="https://github.com/marmotedu/iam/tree/v1.0.3/internal/apiserver/store/mysql" target="_blank" rel="noopener noreferrer">internal/apiserver/store/mysql<ExternalLinkIcon/></a>ç›®å½•ä¸‹ï¼Œé‡Œé¢çš„æ–¹æ³•ç”¨æ¥è·ŸMariaDBè¿›è¡Œäº¤äº’ï¼Œå®ŒæˆCURDæ“ä½œï¼Œä¾‹å¦‚ï¼Œä»æ•°æ®åº“ä¸­è·å–å¯†é’¥ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>secrets<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> username<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>GetOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Secret<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    secret <span class="token operator">:=</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>Secret<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">:=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"username = ? and name= ?"</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>secret<span class="token punctuation">)</span><span class="token punctuation">.</span>Error
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> gorm<span class="token punctuation">.</span>ErrRecordNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrSecretNotFound<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrDatabase<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> secret<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¸šåŠ¡å±‚ (Service)</strong></p>
<p>ä¸šåŠ¡å±‚ä¸»è¦ç”¨æ¥å®Œæˆä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ä»£ç æ”¾åœ¨ä¸šåŠ¡å±‚ã€‚ä¸šåŠ¡å±‚ä¼šå¤„ç†æ¥è‡ªæ§åˆ¶å±‚çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ®éœ€è¦è¯·æ±‚ä»“åº“å±‚å®Œæˆæ•°æ®çš„CURDæ“ä½œã€‚ä¸šåŠ¡å±‚åŠŸèƒ½å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="https://static001.geekbang.org/resource/image/61/b6/6103c58d837fd81769977bc3c947ffb6.jpg?wh=1796x1236" target="_blank" rel="noopener noreferrer"><img src="http://sm.nsddd.top/sm202302282204294.jpeg" alt="img"><ExternalLinkIcon/></a></p>
<p>iam-apiserverçš„ä¸šåŠ¡å±‚ä½äº<a href="https://github.com/marmotedu/iam/tree/v1.0.3/internal/apiserver/service" target="_blank" rel="noopener noreferrer">internal/apiserver/service<ExternalLinkIcon/></a>ç›®å½•ä¸‹ã€‚ä¸‹é¢æ˜¯iam-apiserverä¸šåŠ¡å±‚ä¸­ï¼Œç”¨æ¥åˆ›å»ºå¯†é’¥çš„å‡½æ•°ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>secretService<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> secret <span class="token operator">*</span>v1<span class="token punctuation">.</span>Secret<span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrDatabase<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸šåŠ¡å±‚æœ€ç»ˆè¯·æ±‚ä»“åº“å±‚çš„<code v-pre>s.store</code>çš„<code v-pre>Create</code>æ–¹æ³•ï¼Œå°†å¯†é’¥ä¿¡æ¯ä¿å­˜åœ¨MariaDBæ•°æ®åº“ä¸­ã€‚</p>
<p><strong>æ§åˆ¶å±‚ï¼ˆControllerï¼‰</strong></p>
<p>æ§åˆ¶å±‚æ¥æ”¶HTTPè¯·æ±‚ï¼Œå¹¶è¿›è¡Œå‚æ•°è§£æã€å‚æ•°æ ¡éªŒã€é€»è¾‘åˆ†å‘å¤„ç†ã€è¯·æ±‚è¿”å›è¿™äº›æ“ä½œã€‚æ§åˆ¶å±‚ä¼šå°†é€»è¾‘åˆ†å‘ç»™ä¸šåŠ¡å±‚ï¼Œä¸šåŠ¡å±‚å¤„ç†åè¿”å›ï¼Œè¿”å›æ•°æ®åœ¨æ§åˆ¶å±‚ä¸­è¢«æ•´åˆå†åŠ å·¥ï¼Œæœ€ç»ˆè¿”å›ç»™è¯·æ±‚æ–¹ã€‚æ§åˆ¶å±‚ç›¸å½“äºå®ç°äº†ä¸šåŠ¡è·¯ç”±çš„åŠŸèƒ½ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202302282206659.jpeg" alt="img"></p>
<p>è¿™é‡Œæˆ‘æœ‰ä¸ªå»ºè®®ï¼Œä¸è¦åœ¨æ§åˆ¶å±‚å†™å¤æ‚çš„ä»£ç ï¼Œå¦‚æœéœ€è¦ï¼Œè¯·å°†è¿™äº›ä»£ç åˆ†å‘åˆ°ä¸šåŠ¡å±‚æˆ–å…¶ä»–åŒ…ä¸­ã€‚</p>
<p>iam-apiserverçš„æ§åˆ¶å±‚ä½äº<a href="https://github.com/marmotedu/iam/tree/v1.0.3/internal/apiserver/controller" target="_blank" rel="noopener noreferrer">internal/apiserver/controller<ExternalLinkIcon/></a>ç›®å½•ä¸‹ã€‚ä¸‹é¢æ˜¯iam-apiserveræ§åˆ¶å±‚ä¸­åˆ›å»ºå¯†é’¥çš„ä»£ç ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>SecretHandler<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">L</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"create secret function called."</span><span class="token punctuation">)</span>

  <span class="token keyword">var</span> r v1<span class="token punctuation">.</span>Secret

  <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBindJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrBind<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> errs <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrValidation<span class="token punctuation">,</span> errs<span class="token punctuation">.</span><span class="token function">ToAggregate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  username <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span>UsernameKey<span class="token punctuation">)</span>

  secrets<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>srv<span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> username<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>
    Offset<span class="token punctuation">:</span> pointer<span class="token punctuation">.</span><span class="token function">ToInt64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Limit<span class="token punctuation">:</span>  pointer<span class="token punctuation">.</span><span class="token function">ToInt64</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrDatabase<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> secrets<span class="token punctuation">.</span>TotalCount <span class="token operator">>=</span> maxSecretCount <span class="token punctuation">{</span>
    core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrReachMaxCount<span class="token punctuation">,</span> <span class="token string">"secret count: %d"</span><span class="token punctuation">,</span> secrets<span class="token punctuation">.</span>TotalCount<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// must reassign username</span>
  r<span class="token punctuation">.</span>Username <span class="token operator">=</span> username

  <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>srv<span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> err<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¸Šé¢çš„ä»£ç å®Œæˆäº†ä»¥ä¸‹æ“ä½œï¼š</strong></p>
<ol>
<li>è§£æHTTPè¯·æ±‚å‚æ•°ã€‚</li>
<li>è¿›è¡Œå‚æ•°éªŒè¯ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ ä¸€äº›ä¸šåŠ¡æ€§è´¨çš„å‚æ•°æ ¡éªŒï¼Œä¾‹å¦‚ï¼š<code v-pre>secrets.TotalCount &gt;= maxSecretCount</code>ã€‚</li>
<li>è°ƒç”¨ä¸šåŠ¡å±‚<code v-pre>s.srv</code>çš„<code v-pre>Create</code>æ–¹æ³•ï¼Œå®Œæˆå¯†é’¥çš„åˆ›å»ºã€‚</li>
<li>è¿”å›HTTPè¯·æ±‚å‚æ•°ã€‚</li>
</ol>
<p>ä¸Šé¢ï¼Œæˆ‘ä»¬ä»‹ç»äº†iam-apiserveré‡‡ç”¨çš„4å±‚ç»“æ„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹çœ‹<strong>æ¯ä¸€å±‚ä¹‹é—´æ˜¯å¦‚ä½•é€šä¿¡çš„</strong>ã€‚</p>
<p>é™¤äº†æ¨¡å‹å±‚ï¼Œæ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚ã€ä»“åº“å±‚ä¹‹é—´éƒ½æ˜¯é€šè¿‡æ¥å£è¿›è¡Œé€šä¿¡çš„ã€‚é€šè¿‡æ¥å£é€šä¿¡ï¼Œä¸€æ–¹é¢å¯ä»¥ä½¿ç›¸åŒçš„åŠŸèƒ½æ”¯æŒä¸åŒçš„å®ç°ï¼ˆä¹Ÿå°±æ˜¯è¯´å…·æœ‰æ’ä»¶åŒ–èƒ½åŠ›ï¼‰ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿä½¿å¾—æ¯ä¸€å±‚çš„ä»£ç å˜å¾—å¯æµ‹è¯•ã€‚</p>
<p>è¿™é‡Œï¼Œæˆ‘ç”¨åˆ›å»ºå¯†é’¥APIè¯·æ±‚çš„ä¾‹å­ï¼Œæ¥ç»™ä½ è®²è§£ä¸‹å±‚ä¸å±‚ä¹‹é—´æ˜¯å¦‚ä½•è¿›è¡Œé€šä¿¡çš„ã€‚</p>
<p><strong>é¦–å…ˆï¼Œæ¥çœ‹ä¸‹æ§åˆ¶å±‚å¦‚ä½•è·Ÿä¸šåŠ¡å±‚è¿›è¡Œé€šä¿¡ã€‚</strong></p>
<p>å¯¹å¯†é’¥çš„è¯·æ±‚å¤„ç†éƒ½æ˜¯é€šè¿‡SecretControlleræä¾›çš„æ–¹æ³•æ¥å¤„ç†çš„ï¼Œåˆ›å»ºå¯†é’¥è°ƒç”¨çš„æ˜¯å®ƒçš„<code v-pre>Create</code>æ–¹æ³•ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>SecretController<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>srv<span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> err<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨<code v-pre>Create</code>æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†<code v-pre>s.srv.Secrets().Create()</code>æ¥åˆ›å»ºå¯†é’¥ï¼Œ<code v-pre>s.srv</code>æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">type</span> Service <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Users</span><span class="token punctuation">(</span><span class="token punctuation">)</span> UserSrv
    <span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> SecretSrv
    <span class="token function">Policies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> PolicySrv
<span class="token punctuation">}</span>

<span class="token keyword">type</span> SecretSrv <span class="token keyword">interface</span> <span class="token punctuation">{</span>                                                             
    <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> secret <span class="token operator">*</span>v1<span class="token punctuation">.</span>Secret<span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">)</span> <span class="token builtin">error</span>    
    <span class="token function">Update</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> secret <span class="token operator">*</span>v1<span class="token punctuation">.</span>Secret<span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>UpdateOptions<span class="token punctuation">)</span> <span class="token builtin">error</span>            
    <span class="token function">Delete</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> username<span class="token punctuation">,</span> secretID <span class="token builtin">string</span><span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>DeleteOptions<span class="token punctuation">)</span> <span class="token builtin">error</span>                        
    <span class="token function">DeleteCollection</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> username <span class="token builtin">string</span><span class="token punctuation">,</span> secretIDs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>DeleteOptions<span class="token punctuation">)</span> <span class="token builtin">error</span>    
    <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> username<span class="token punctuation">,</span> secretID <span class="token builtin">string</span><span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>GetOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Secret<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>    
    <span class="token function">List</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> username <span class="token builtin">string</span><span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>SecretList<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>    
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæ§åˆ¶å±‚é€šè¿‡ä¸šåŠ¡å±‚æä¾›çš„<code v-pre>Service</code>æ¥å£ç±»å‹ï¼Œå‰¥ç¦»äº†ä¸šåŠ¡å±‚çš„å…·ä½“å®ç°ã€‚ä¸šåŠ¡å±‚çš„Serviceæ¥å£ç±»å‹æä¾›äº†<code v-pre>Secrets()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›äº†ä¸€ä¸ªå®ç°äº†<code v-pre>SecretSrv</code>æ¥å£çš„å®ä¾‹ã€‚åœ¨æ§åˆ¶å±‚ä¸­ï¼Œé€šè¿‡è°ƒç”¨è¯¥å®ä¾‹çš„<code v-pre>Create(ctx context.Context, secret *v1.Secret, opts metav1.CreateOptions) error</code>æ–¹æ³•æ¥å®Œæˆå¯†é’¥çš„åˆ›å»ºã€‚è‡³äºä¸šåŠ¡å±‚æ˜¯å¦‚ä½•åˆ›å»ºå¯†é’¥çš„ï¼Œæ§åˆ¶å±‚ä¸éœ€è¦çŸ¥é“ï¼Œä¹Ÿå°±æ˜¯è¯´åˆ›å»ºå¯†é’¥å¯ä»¥æœ‰å¤šç§å®ç°ã€‚</p>
<p>è¿™é‡Œä½¿ç”¨åˆ°äº†è®¾è®¡æ¨¡å¼ä¸­çš„<strong>å·¥å‚æ–¹æ³•æ¨¡å¼</strong>ã€‚<code v-pre>Service</code>æ˜¯å·¥å‚æ¥å£ï¼Œé‡Œé¢åŒ…å«äº†ä¸€ç³»åˆ—åˆ›å»ºå…·ä½“ä¸šåŠ¡å±‚å¯¹è±¡çš„å·¥å‚å‡½æ•°ï¼š<code v-pre>Users()</code>ã€<code v-pre>Secrets()</code>ã€<code v-pre>Policies()</code>ã€‚é€šè¿‡å·¥å‚æ–¹æ³•æ¨¡å¼ï¼Œä¸ä»…éšè—äº†ä¸šåŠ¡å±‚å¯¹è±¡çš„åˆ›å»ºç»†èŠ‚ï¼Œè€Œä¸”è¿˜å¯ä»¥å¾ˆæ–¹ä¾¿åœ°åœ¨<code v-pre>Service</code>å·¥å‚æ¥å£å®ç°æ–¹æ³•ä¸­æ·»åŠ æ–°çš„ä¸šåŠ¡å±‚å¯¹è±¡ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³æ–°å¢ä¸€ä¸ª<code v-pre>Template</code>ä¸šåŠ¡å±‚å¯¹è±¡ï¼Œç”¨æ¥åœ¨iam-apiserverä¸­é¢„ç½®ä¸€äº›ç­–ç•¥æ¨¡æ¿ï¼Œå¯ä»¥è¿™ä¹ˆæ¥åŠ ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">type</span> Service <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Users</span><span class="token punctuation">(</span><span class="token punctuation">)</span> UserSrv
    <span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> SecretSrv
    <span class="token function">Policies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> PolicySrv
    <span class="token function">Templates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> TemplateSrv
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>service<span class="token punctuation">)</span> <span class="token function">Templates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> TemplateSrv <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">newTemplates</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œæ–°å»ºä¸€ä¸ª<code v-pre>template.go</code>æ–‡ä»¶ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> TemplateSrv <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> template <span class="token operator">*</span>v1<span class="token punctuation">.</span>Template<span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token comment">// Other methods</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> templateService <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    store store<span class="token punctuation">.</span>Factory
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token boolean">_</span> TemplateSrv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>templateService<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">newTemplates</span><span class="token punctuation">(</span>srv <span class="token operator">*</span>service<span class="token punctuation">)</span> <span class="token operator">*</span>TemplateService <span class="token punctuation">{</span>
    <span class="token comment">// more create logic</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>templateService<span class="token punctuation">{</span>store<span class="token punctuation">:</span> srv<span class="token punctuation">.</span>store<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>templateService<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> template <span class="token operator">*</span>v1<span class="token punctuation">.</span>Template<span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment">// normal code</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹ä¸‰æ­¥æ–°å¢äº†ä¸€ä¸ªä¸šåŠ¡å±‚å¯¹è±¡ï¼š</p>
<ol>
<li>åœ¨<code v-pre>Service</code>æ¥å£å®šä¹‰ä¸­ï¼Œæ–°å¢äº†ä¸€ä¸ªå…¥å£ï¼š<code v-pre>Templates() TemplateSrv</code>ã€‚</li>
<li>åœ¨<code v-pre>service.go</code>æ–‡ä»¶ä¸­ï¼Œæ–°å¢äº†ä¸€ä¸ªå‡½æ•°ï¼š<code v-pre>Templates()</code>ã€‚</li>
<li>æ–°å»ºäº†<code v-pre>template.go</code>æ–‡ä»¶ï¼Œåœ¨<code v-pre>template.go</code>ä¸­å®šä¹‰äº†templateServiceç»“æ„ä½“ï¼Œå¹¶ä¸ºå®ƒå®ç°äº†<code v-pre>TemplateSrv</code>æ¥å£ã€‚</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ–°å¢çš„Templateä¸šåŠ¡å¯¹è±¡çš„ä»£ç å‡ ä¹éƒ½é—­ç¯åœ¨<code v-pre>template.go</code>æ–‡ä»¶ä¸­ã€‚å¯¹å·²æœ‰çš„<code v-pre>Service</code>å·¥å‚æ¥å£çš„åˆ›å»ºæ–¹æ³•ï¼Œé™¤äº†æ–°å¢ä¸€ä¸ªå·¥å‚æ–¹æ³•<code v-pre>Templates() TemplateSrv</code>å¤–ï¼Œæ²¡æœ‰å…¶ä»–ä»»ä½•å…¥ä¾µã€‚è¿™æ ·åšå¯ä»¥é¿å…å½±å“å·²æœ‰ä¸šåŠ¡ã€‚</p>
<p>åœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­ï¼Œä½ ä¹Ÿæœ‰å¯èƒ½ä¼šæƒ³åˆ°ä¸‹é¢è¿™ç§é”™è¯¯çš„åˆ›å»ºæ–¹å¼ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// é”™è¯¯æ–¹æ³•ä¸€</span>
<span class="token keyword">type</span> Service <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    UserSrv
    SecretSrv
    PolicySrv
    TemplateSrv
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„åˆ›å»ºæ–¹å¼ä¸­ï¼Œæˆ‘ä»¬å¦‚æœæƒ³åˆ›å»ºUserå’ŒSecretï¼Œé‚£åªèƒ½å®šä¹‰ä¸¤ä¸ªä¸åŒçš„æ–¹æ³•ï¼šCreateUserå’Œ CreateSecretï¼Œè¿œæ²¡æœ‰åœ¨Userå’ŒSecretå„è‡ªçš„åŸŸä¸­æä¾›åŒåçš„Createæ–¹æ³•æ¥å¾—ä¼˜é›…ã€‚</p>
<p>IAMé¡¹ç›®ä¸­è¿˜æœ‰å…¶ä»–åœ°æ–¹ä¹Ÿä½¿ç”¨äº†å·¥å‚æ–¹æ³•æ¨¡å¼ï¼Œä¾‹å¦‚<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/store/store.go#L12" target="_blank" rel="noopener noreferrer">Factory<ExternalLinkIcon/></a>å·¥å‚æ¥å£ã€‚</p>
<p><strong>å†æ¥çœ‹ä¸‹ä¸šåŠ¡å±‚å’Œä»“åº“å±‚æ˜¯å¦‚ä½•é€šä¿¡çš„ã€‚</strong></p>
<p>ä¸šåŠ¡å±‚å’Œä»“åº“å±‚ä¹Ÿæ˜¯é€šè¿‡æ¥å£æ¥é€šä¿¡çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸šåŠ¡å±‚ä¸­åˆ›å»ºå¯†é’¥çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>secretService<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> secret <span class="token operator">*</span>v1<span class="token punctuation">.</span>Secret<span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrDatabase<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>Create</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code v-pre>s.store.Secrets().Create()</code>æ–¹æ³•æ¥å°†å¯†é’¥ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚<code v-pre>s.store</code>æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="language-gp ext-gp line-numbers-mode"><pre v-pre class="language-gp"><code>type Factory interface {
    Users() UserStore
    Secrets() SecretStore
    Policies() PolicyStore
    Close() error
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸šåŠ¡å±‚ä¸ä»“åº“å±‚çš„é€šä¿¡å®ç°ï¼Œå’Œæ§åˆ¶å±‚ä¸ä¸šåŠ¡å±‚çš„é€šä¿¡å®ç°ç±»ä¼¼ï¼Œæ‰€ä»¥è¿™é‡Œä¸å†è¯¦ç»†ä»‹ç»ã€‚</p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬çŸ¥é“äº†ï¼Œæ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚å’Œä»“åº“å±‚ä¹‹é—´æ˜¯é€šè¿‡æ¥å£æ¥é€šä¿¡çš„ã€‚é€šè¿‡æ¥å£é€šä¿¡æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯å¯ä»¥è®©å„å±‚å˜å¾—å¯æµ‹ã€‚é‚£æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹<strong>å¦‚ä½•æµ‹è¯•å„å±‚çš„ä»£ç </strong>ã€‚å› ä¸º<strong>ç¬¬38è®²</strong>å’Œ<strong>ç¬¬39è®²</strong>ä¼šè¯¦ç»†ä»‹ç»å¦‚ä½•æµ‹è¯•Goä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œåªä»‹ç»ä¸‹æµ‹è¯•æ€è·¯ã€‚</p>
<ol>
<li>æ¨¡å‹å±‚</li>
</ol>
<p>å› ä¸ºæ¨¡å‹å±‚ä¸ä¾èµ–å…¶ä»–ä»»ä½•å±‚ï¼Œæˆ‘ä»¬åªéœ€è¦æµ‹è¯•å…¶ä¸­å®šä¹‰çš„ç»“æ„åŠå…¶å‡½æ•°å’Œæ–¹æ³•å³å¯ã€‚</p>
<ol>
<li>æ§åˆ¶å±‚</li>
</ol>
<p>æ§åˆ¶å±‚ä¾èµ–äºä¸šåŠ¡å±‚ï¼Œæ„å‘³ç€è¯¥å±‚éœ€è¦ä¸šåŠ¡å±‚æ¥æ”¯æŒæµ‹è¯•ã€‚ä½ å¯ä»¥é€šè¿‡<a href="https://github.com/golang/mock" target="_blank" rel="noopener noreferrer">golang/mock<ExternalLinkIcon/></a>æ¥mockä¸šåŠ¡å±‚ï¼Œæµ‹è¯•ç”¨ä¾‹å¯å‚è€ƒ<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/controller/v1/user/create_test.go#L19" target="_blank" rel="noopener noreferrer">TestUserController_Create<ExternalLinkIcon/></a>ã€‚</p>
<ol>
<li>ä¸šåŠ¡å±‚</li>
</ol>
<p>å› ä¸ºè¯¥å±‚ä¾èµ–äºä»“åº“å±‚ï¼Œæ„å‘³ç€è¯¥å±‚éœ€è¦ä»“åº“å±‚æ¥æ”¯æŒæµ‹è¯•ã€‚æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹æ³•æ¥æ¨¡æ‹Ÿä»“åº“å±‚ï¼š</p>
<ul>
<li>é€šè¿‡<code v-pre>golang/mock</code>æ¥mockä»“åº“å±‚ã€‚</li>
<li>è‡ªå·±å¼€å‘ä¸€ä¸ªfakeä»“åº“å±‚ã€‚</li>
</ul>
<p>ä½¿ç”¨<code v-pre>golang/mock</code>çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä½ å¯ä»¥å‚è€ƒ<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/service/v1/secret_test.go#L19" target="_blank" rel="noopener noreferrer">Test_secretService_Create<ExternalLinkIcon/></a>ã€‚</p>
<p>fakeçš„ä»“åº“å±‚å¯ä»¥å‚è€ƒ<a href="https://github.com/marmotedu/iam/tree/v1.0.4/internal/apiserver/store/fake" target="_blank" rel="noopener noreferrer">fake<ExternalLinkIcon/></a>ï¼Œä½¿ç”¨è¯¥fakeä»“åº“å±‚è¿›è¡Œæµ‹è¯•çš„æµ‹è¯•ç”¨ä¾‹ä¸º<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/service/v1/user_test.go#L76" target="_blank" rel="noopener noreferrer"> Test_userService_List<ExternalLinkIcon/></a>ã€‚</p>
<ol>
<li>ä»“åº“å±‚</li>
</ol>
<p>ä»“åº“å±‚ä¾èµ–äºæ•°æ®åº“ï¼Œå¦‚æœè°ƒç”¨äº†å…¶ä»–å¾®æœåŠ¡ï¼Œé‚£è¿˜ä¼šä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<a href="https://github.com/DATA-DOG/go-sqlmock" target="_blank" rel="noopener noreferrer">sqlmock<ExternalLinkIcon/></a>æ¥æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥ï¼Œé€šè¿‡<a href="https://github.com/jarcoal/httpmock" target="_blank" rel="noopener noreferrer">httpmock<ExternalLinkIcon/></a>æ¥æ¨¡æ‹ŸHTTPè¯·æ±‚ã€‚</p>
<h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2>
<p>è¿™ä¸€è®²ï¼Œæˆ‘ä¸»è¦ä»‹ç»äº†iam-apiserverçš„åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ï¼Œä»¥åŠå®ƒçš„ä»£ç å®ç°ã€‚iam-apiserveræ˜¯ä¸€ä¸ªWebæœåŠ¡ï¼Œæä¾›äº†REST APIæ¥å®Œæˆç”¨æˆ·ã€å¯†é’¥ã€ç­–ç•¥ä¸‰ç§RESTèµ„æºçš„å¢åˆ æ”¹æŸ¥ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡cURLã€Insomniaç­‰å·¥å…·ï¼Œæ¥å®ŒæˆREST APIè¯·æ±‚ã€‚</p>
<p>iam-apiserveråŒ…å«äº†3ç§é…ç½®ï¼šOptionsé…ç½®ã€åº”ç”¨é…ç½®ã€HTTP/GRPCæœåŠ¡é…ç½®ã€‚è¿™ä¸‰ç§é…ç½®åˆ†åˆ«ç”¨æ¥æ„å»ºå‘½ä»¤è¡Œå‚æ•°ã€åº”ç”¨å’ŒHTTP/GRPCæœåŠ¡ã€‚</p>
<p>iam-apiserveråœ¨å¯åŠ¨æ—¶ï¼Œä¼šå…ˆæ„å»ºåº”ç”¨æ¡†æ¶ï¼Œæ¥ç€ä¼šè®¾ç½®åº”ç”¨é€‰é¡¹ï¼Œç„¶åå¯¹åº”ç”¨è¿›è¡Œåˆå§‹åŒ–ï¼Œæœ€ååˆ›å»ºHTTP/GRPCæœåŠ¡çš„é…ç½®å’Œå®ä¾‹ï¼Œæœ€ç»ˆå¯åŠ¨HTTP/GRPCæœåŠ¡ã€‚</p>
<p>æœåŠ¡å¯åŠ¨ä¹‹åï¼Œå°±å¯ä»¥æ¥æ”¶HTTPè¯·æ±‚äº†ã€‚ä¸€ä¸ªHTTPè¯·æ±‚ä¼šå…ˆè¿›è¡Œè®¤è¯ï¼Œæ¥ç€ä¼šè¢«æ³¨å†Œçš„ä¸­é—´ä»¶å¤„ç†ï¼Œç„¶åï¼Œä¼šæ ¹æ®<code v-pre>(HTTP Method, HTTP Request Path)</code>åŒ¹é…åˆ°å¤„ç†å‡½æ•°ã€‚åœ¨å¤„ç†å‡½æ•°ä¸­ï¼Œä¼šè§£æè¯·æ±‚å‚æ•°ã€æ ¡éªŒå‚æ•°ã€è°ƒç”¨ä¸šåŠ¡é€»è¾‘å¤„ç†å‡½æ•°ï¼Œæœ€ç»ˆè¿”å›è¯·æ±‚ç»“æœã€‚</p>
<p>iam-apiserveré‡‡ç”¨äº†ç®€æ´æ¶æ„ï¼Œæ•´ä¸ªåº”ç”¨åˆ†ä¸º4å±‚ï¼šæ¨¡å‹å±‚ã€æ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚å’Œä»“åº“å±‚ã€‚æ¨¡å‹å±‚å­˜å‚¨å¯¹è±¡çš„ç»“æ„å’Œå®ƒçš„æ–¹æ³•ï¼›ä»“åº“å±‚ç”¨æ¥è·Ÿæ•°æ®åº“/ç¬¬ä¸‰æ–¹æœåŠ¡è¿›è¡ŒCURDäº¤äº’ï¼›ä¸šåŠ¡å±‚ä¸»è¦ç”¨æ¥å®Œæˆä¸šåŠ¡é€»è¾‘å¤„ç†ï¼›æ§åˆ¶å±‚æ¥æ”¶HTTPè¯·æ±‚ï¼Œå¹¶è¿›è¡Œå‚æ•°è§£æã€å‚æ•°æ ¡éªŒã€é€»è¾‘åˆ†å‘å¤„ç†ã€è¯·æ±‚è¿”å›æ“ä½œã€‚æ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚ã€ä»“åº“å±‚ä¹‹é—´é€šè¿‡æ¥å£é€šä¿¡ï¼Œé€šè¿‡æ¥å£é€šä¿¡å¯ä»¥ä½¿ç›¸åŒçš„åŠŸèƒ½æ”¯æŒä¸åŒçš„å®ç°ï¼Œå¹¶ä½¿æ¯ä¸€å±‚çš„ä»£ç å˜å¾—å¯æµ‹è¯•ã€‚</p>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '19.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '21.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/projects/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


