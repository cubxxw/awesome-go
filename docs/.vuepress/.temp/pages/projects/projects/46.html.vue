<template><div><ul>
<li><a href="https://github.com/cubxxw/iam" target="_blank" rel="noopener noreferrer">ğŸ”¥ å¼€æºåœ°å€<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬46èŠ‚-iamæ’éšœæŒ‡å—" tabindex="-1"><a class="header-anchor" href="#ç¬¬46èŠ‚-iamæ’éšœæŒ‡å—" aria-hidden="true">#</a> ç¬¬46èŠ‚ IAMæ’éšœæŒ‡å—</h1>
<br>
<div><a href = '45.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '47.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<nav class="table-of-contents"><ul><li><router-link to="#å¦‚ä½•æ’éšœ">å¦‚ä½•æ’éšœï¼Ÿ</router-link><ul><li><router-link to="#å‘ç°é—®é¢˜">å‘ç°é—®é¢˜</router-link></li><li><router-link to="#å®šä½é—®é¢˜">å®šä½é—®é¢˜</router-link></li><li><router-link to="#è§£å†³é—®é¢˜">è§£å†³é—®é¢˜</router-link></li></ul></li><li><router-link to="#iamå¸¸è§æ•…éšœåŠè§£å†³åŠæ³•">IAMå¸¸è§æ•…éšœåŠè§£å†³åŠæ³•</router-link></li><li><router-link to="#æ€»ç»“">æ€»ç»“</router-link></li><li><router-link to="#è¯¾åç»ƒä¹ ">è¯¾åç»ƒä¹ </router-link></li><li><router-link to="#end-é“¾æ¥">END é“¾æ¥</router-link></li></ul></nav>
<p>[TOC]</p>
<p>ä»Šå¤©æˆ‘ä»¬æ›´æ–°ä¸€æœŸç‰¹åˆ«æ”¾é€ä½œä¸ºåŠ é¤ã€‚åœ¨éƒ¨ç½²å’Œä½¿ç”¨IAMçš„è¿‡ç¨‹ä¸­ï¼Œéš¾å…ä¼šå‡ºç°ä¸€äº›å¼‚å¸¸(ä¹Ÿç§°ä¸ºæ•…éšœã€é—®é¢˜)ã€‚è¿™æ—¶å€™ï¼Œå°±éœ€è¦æˆ‘ä»¬èƒ½å¤Ÿå®šä½æ•…éšœï¼Œå¹¶ä¿®å¤æ•…éšœã€‚è¿™é‡Œï¼Œæˆ‘æ€»ç»“äº†ä¸€äº›IAMçš„æ’éšœæ–¹æ³•ï¼Œä»¥åŠä¸€äº›å¸¸è§æ•…éšœçš„è§£å†³æ–¹æ³•ï¼Œä¾›ä½ å‚è€ƒã€‚</p>
<h2 id="å¦‚ä½•æ’éšœ" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•æ’éšœ" aria-hidden="true">#</a> å¦‚ä½•æ’éšœï¼Ÿ</h2>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å‘ç°é—®é¢˜ï¼Œç„¶åå®šä½é—®é¢˜ã€‚æˆ‘ä»¬å¯èƒ½éœ€è¦ç»è¿‡å¤šè½®åˆ†ææ’æŸ¥æ‰èƒ½å®šä½åˆ°é—®é¢˜çš„æ ¹å› ï¼Œæœ€åå»è§£å†³é—®é¢˜ã€‚æ’éšœæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202303071741286.png" alt="image-20230307174145120"></p>
<p>å¦‚æœæƒ³æ’æŸ¥é—®é¢˜å¹¶è§£å†³é—®é¢˜ï¼Œä½ è¿˜éœ€è¦å…·å¤‡è¿™ä¸¤ä¸ªåŸºæœ¬èƒ½åŠ›ï¼šèƒ½å¤Ÿç†è§£é”™è¯¯æ—¥å¿—çš„å†…å®¹ï¼›æ ¹æ®é”™è¯¯æ—¥å¿—ï¼Œæ‰¾å‡ºè§£å†³æ–¹æ¡ˆã€‚</p>
<p>æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­æ¥è¯´å§ã€‚æœ‰ä»¥ä¸‹é”™è¯¯ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token punctuation">[</span>going@dev iam<span class="token punctuation">]</span>$ mysql <span class="token parameter variable">-h127.0.0.1</span> <span class="token parameter variable">-uroot</span> -p<span class="token string">'iam59!z$'</span>
bash: /usr/bin/mysql: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•
<span class="token punctuation">[</span>going@dev iam<span class="token punctuation">]</span>$
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºè¿™ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥ç†è§£é”™è¯¯å†…å®¹ï¼šmysqlå‘½ä»¤æ²¡æœ‰æ‰¾åˆ°ï¼Œè¯´æ˜æ²¡æœ‰å®‰è£…mysqlï¼Œæˆ–è€…å®‰è£…mysqlå¤±è´¥ã€‚</p>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯é‡æ–°æ‰§è¡Œ <a href="https://time.geekbang.org/column/article/378082" target="_blank" rel="noopener noreferrer">03è®²<ExternalLinkIcon/></a> ä¸­å®‰è£…MariaDBçš„æ­¥éª¤ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ ./scripts/install/mariadb.sh iam::mariadb::install
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šä»¥<code v-pre>iam-apiserver</code>æœåŠ¡ä¸ºä¾‹ï¼Œç»™ä½ æ¼”ç¤ºä¸‹å…·ä½“å¦‚ä½•æ’éšœå¹¶è§£å†³é—®é¢˜ã€‚</p>
<h3 id="å‘ç°é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#å‘ç°é—®é¢˜" aria-hidden="true">#</a> å‘ç°é—®é¢˜</h3>
<p>è¦æ’éšœï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å‘ç°é—®é¢˜ã€‚æˆ‘ä»¬é€šå¸¸ç”¨ä¸‹é¢è¿™å‡ ç§æ–¹å¼æ¥å‘ç°é—®é¢˜ã€‚</p>
<ul>
<li>æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼šå¯åŠ¨iam-apiserveræœåŠ¡åï¼Œæ‰§è¡Œ<code v-pre>systemctl status iam-apiserver</code> å‘ç°iam-apiserverå¯åŠ¨å¤±è´¥ï¼Œå³<code v-pre>Active</code>çš„å€¼ä¸ä¸º<code v-pre>active (running)</code>ã€‚</li>
<li>åŠŸèƒ½å¼‚å¸¸ï¼šè®¿é—®iam-apiserveræœåŠ¡ï¼ŒåŠŸèƒ½å¼‚å¸¸æˆ–è€…æŠ¥é”™ï¼Œä¾‹å¦‚æ¥å£è¿”å›å€¼è·Ÿé¢„æœŸä¸ä¸€æ ·ç­‰ã€‚</li>
<li>æ—¥å¿—æŠ¥é”™ï¼šåœ¨iam-apiserverçš„æ—¥å¿—ä¸­å‘ç°ä¸€äº›<code v-pre>WARN</code>ã€<code v-pre>ERROR</code>ã€<code v-pre>PANIC</code>ã€<code v-pre>FATAL</code>ç­‰çº§åˆ«çš„é”™è¯¯æ—¥å¿—ã€‚</li>
</ul>
<h3 id="å®šä½é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#å®šä½é—®é¢˜" aria-hidden="true">#</a> å®šä½é—®é¢˜</h3>
<p>å‘ç°é—®é¢˜ä¹‹åï¼Œå°±éœ€è¦æˆ‘ä»¬å®šä½å‡ºé—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸‰ç§æ–¹å¼æ¥å®šä½é—®é¢˜ã€‚</p>
<ul>
<li>æŸ¥çœ‹æ—¥å¿—ï¼Œå®ƒæ˜¯æœ€ç®€å•çš„æ’éšœæ–¹å¼ã€‚</li>
<li>ä½¿ç”¨Goè°ƒè¯•å·¥å…·Delveæ¥å®šä½é—®é¢˜ã€‚</li>
<li>æ·»åŠ Debugæ—¥å¿—ï¼Œä»ç¨‹åºå…¥å£å¤„è·Ÿè¯»ä»£ç ï¼Œåœ¨å…³é”®ä½ç½®å¤„æ‰“å°Debugæ—¥å¿—ï¼Œæ¥å®šä½é—®é¢˜ã€‚</li>
</ul>
<p>åœ¨å®šä½é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨â€œé¡ºè—¤æ‘¸ç“œâ€çš„æ€è·¯å»æ’æŸ¥é—®é¢˜ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œæµç¨‹æ˜¯ï¼š<code v-pre>A -&gt; B -&gt; â€¦ -&gt; N</code>ã€‚å…¶ä¸­Aã€Bã€Néƒ½å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ’æŸ¥ç‚¹ã€‚æ‰€è°“çš„æ’æŸ¥ç‚¹ï¼Œå°±æ˜¯éœ€è¦åœ¨è¯¥å¤„å®šä½é—®é¢˜çš„ç‚¹ï¼Œè¿™äº›ç‚¹å¯èƒ½æ˜¯å¯¼è‡´é—®é¢˜çš„æ ¹å› æ‰€åœ¨ã€‚</p>
<p>åœ¨æ’éšœè¿‡ç¨‹ä¸­ï¼Œä½ å¯ä»¥æ ¹æ®æœ€ä¸Šå±‚çš„æ—¥å¿—æŠ¥é”™ï¼Œæ‰¾åˆ°ä¸‹ä¸€ä¸ªæ’æŸ¥ç‚¹Bã€‚å¦‚æœç»è¿‡å®šä½ï¼Œå‘ç°Bæ²¡æœ‰é—®é¢˜ï¼Œé‚£ç»§ç»­æ ¹æ®ç¨‹åºæ‰§è¡Œæµç¨‹ï¼Œæ‰¾ä¸‹ä¸€ä¸ªæ’æŸ¥ç‚¹æ’æŸ¥é—®é¢˜ã€‚å¦‚æ­¤åå¤ï¼Œç›´åˆ°æ‰¾åˆ°æœ€ç»ˆçš„æ’æŸ¥ç‚¹ï¼Œä¹Ÿå°±æ˜¯å‡ºé—®é¢˜çš„æ ¹å› Nï¼ŒNå³ä¸ºBugç‚¹ã€‚æ‰§è¡Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://static001.geekbang.org/resource/image/cc/6d/cc26b83cb2177106695e1a9f7f09ae6d.jpg?wh=2248x931" alt="img"></p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹è¿™ä¸‰ç§å®šä½é—®é¢˜çš„æ–¹æ³•ã€‚</p>
<h4 id="æŸ¥çœ‹æ—¥å¿—å®šä½é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#æŸ¥çœ‹æ—¥å¿—å®šä½é—®é¢˜" aria-hidden="true">#</a> æŸ¥çœ‹æ—¥å¿—å®šä½é—®é¢˜</h4>
<p>æˆ‘ä»¬é¦–å…ˆåº”è¯¥é€šè¿‡æ—¥å¿—æ¥å®šä½é—®é¢˜ï¼Œè¿™æ˜¯æœ€ç®€å•é«˜æ•ˆçš„æ–¹å¼ã€‚è¦é€šè¿‡æ—¥å¿—æ¥å®šä½é—®é¢˜ï¼Œä½ ä¸ä»…è¦ä¼šçœ‹æ—¥å¿—ï¼Œè¿˜è¦èƒ½è¯»æ‡‚æ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯ç†è§£æ—¥å¿—æŠ¥é”™çš„åŸå› ã€‚</p>
<p>ä¸‹é¢æˆ‘æ¥å…·ä½“è®²è§£ç”¨è¿™ç§æ–¹æ³•å®šä½é—®é¢˜çš„æ­¥éª¤ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼Œç¡®ä¿æœåŠ¡è¿è¡Œæ­£å¸¸ã€‚</strong></p>
<p>ä½ å¯ä»¥é€šè¿‡æ‰§è¡Œ <code v-pre>systemctl status</code> å‘½ä»¤æ¥æŸ¥çœ‹æœåŠ¡çš„è¿è¡ŒçŠ¶å†µï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ systemctl status iam-apiserver
â— iam-apiserver.service - IAM APIServer
   Loaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/iam-apiserver.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: activating <span class="token punctuation">(</span>auto-restart<span class="token punctuation">)</span> <span class="token punctuation">(</span>Result: exit-code<span class="token punctuation">)</span> since Thu <span class="token number">2021</span>-09-09 <span class="token number">13</span>:47:56 CST<span class="token punctuation">;</span> 2s ago
     Docs: https://github.com/marmotedu/iam/blob/master/init/README.md
  Process: <span class="token number">119463</span> <span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/opt/iam/bin/iam-apiserver <span class="token parameter variable">--config</span><span class="token operator">=</span>/etc/iam/iam-apiserver.yaml <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">1</span>/FAILURE<span class="token punctuation">)</span>
  Process: <span class="token number">119461</span> <span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>/usr/bin/mkdir <span class="token parameter variable">-p</span> /var/log/iam <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">0</span>/SUCCESS<span class="token punctuation">)</span>
  Process: <span class="token number">119460</span> <span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>/usr/bin/mkdir <span class="token parameter variable">-p</span> /data/iam/iam-apiserver <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">0</span>/SUCCESS<span class="token punctuation">)</span>
 Main PID: <span class="token number">119463</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">1</span>/FAILURE<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code v-pre>Active</code>ä¸æ˜¯<code v-pre>active (running)</code>ï¼Œè¯´æ˜iam-apiserveræœåŠ¡æ²¡æœ‰æ­£å¸¸è¿è¡Œã€‚ä»ä¸Šé¢è¾“å‡ºä¸­çš„<code v-pre>Process: 119463 ExecStart=/opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml (code=exited, status=1/FAILURE)</code>ä¿¡æ¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è·å–ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ul>
<li>iam-apiserveræœåŠ¡å¯åŠ¨å‘½ä»¤ä¸º<code v-pre>/opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml</code>ã€‚</li>
<li><code v-pre>/opt/iam/bin/iam-apiserver</code>åŠ è½½çš„é…ç½®æ–‡ä»¶ä¸º<code v-pre>/etc/iam/iam-apiserver.yaml</code>ã€‚</li>
<li><code v-pre>/opt/iam/bin/iam-apiserver</code>å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç ä¸º1ï¼Œå…¶è¿›ç¨‹IDä¸º<code v-pre>119463</code>ã€‚</li>
</ul>
<p>è¿™é‡Œæ³¨æ„ï¼Œ<code v-pre>systemctl status</code>ä¼šå°†è¶…è¿‡ä¸€å®šé•¿åº¦çš„è¡Œçš„ååŠéƒ¨åˆ†ç”¨çœç•¥å·æ›¿ä»£ï¼Œå¦‚æœæƒ³æŸ¥çœ‹å®Œæ•´çš„ä¿¡æ¯ï¼Œå¯ä»¥è¿½åŠ <code v-pre>-l</code>å‚æ•°ï¼Œä¹Ÿå°±æ˜¯<code v-pre>systemctl status -l</code>æ¥æŸ¥çœ‹ã€‚</p>
<p>æ—¢ç„¶iam-apiserverå‘½ä»¤å¯åŠ¨å¤±è´¥ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦æŸ¥çœ‹iam-apiserverå¯åŠ¨æ—¶çš„æ—¥å¿—ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ä¸€äº›æŠ¥é”™æ—¥å¿—ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œå°±è¿›å…¥<strong>ç¬¬äºŒæ­¥ï¼ŒæŸ¥çœ‹</strong><code v-pre>iam-apiserver</code><strong>è¿è¡Œæ—¥å¿—ã€‚</strong></p>
<p>è¿™é‡Œæä¸€å¥ï¼Œå¦‚æœä½ å¯¹systemdä¸äº†è§£ï¼Œä¹Ÿå¯ä»¥è¶æœºæ¶è¡¥ä¸€æ³¢ã€‚ä½ å¯ä»¥å‚è€ƒé˜®ä¸€å³°å¤§ä½¬çš„ä¸¤ç¯‡åšå®¢ï¼š<a href="https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html" target="_blank" rel="noopener noreferrer">Systemd å…¥é—¨æ•™ç¨‹ï¼šå‘½ä»¤ç¯‡<ExternalLinkIcon/></a>å’Œ<a href="https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html" target="_blank" rel="noopener noreferrer">Systemd å…¥é—¨æ•™ç¨‹ï¼šå®æˆ˜ç¯‡<ExternalLinkIcon/></a>ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•æŸ¥çœ‹å‘¢ï¼Ÿæˆ‘ä»¬æœ‰3ç§æŸ¥çœ‹æ–¹å¼ï¼Œæˆ‘åœ¨ä¸‹é¢æŒ‰ä¼˜å…ˆçº§é¡ºåºæ’åˆ—äº†ä¸‹ã€‚ä½ åœ¨å®šä½é—®é¢˜å’ŒæŸ¥çœ‹æ—¥å¿—æ—¶ï¼ŒæŒ‰ä¼˜å…ˆçº§3é€‰1å³å¯ï¼Œ1 &gt; 2 &gt; 3ã€‚</p>
<ol>
<li>é€šè¿‡<code v-pre>journalctl -u iam-apiserver</code>æŸ¥çœ‹ã€‚</li>
<li>é€šè¿‡iam-apiserveræ—¥å¿—æ–‡ä»¶æŸ¥çœ‹ã€‚</li>
<li>é€šè¿‡consoleæŸ¥çœ‹ã€‚</li>
</ol>
<p>ä¸‹é¢æˆ‘æ¥åˆ†åˆ«ä»‹ç»ä¸‹è¿™ä¸‰ç§æŸ¥çœ‹æ–¹å¼ã€‚</p>
<p>å…ˆæ¥çœ‹ä¼˜å…ˆçº§æœ€é«˜çš„æ–¹å¼ï¼Œé€šè¿‡<code v-pre>journalctl -u iam-apiserver</code>æŸ¥çœ‹ã€‚</p>
<p>systemd æä¾›äº†è‡ªå·±çš„æ—¥å¿—ç³»ç»Ÿï¼Œç§°ä¸º journalã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code v-pre>journalctl</code>å‘½ä»¤æ¥è¯»å–journalæ—¥å¿—ã€‚<code v-pre>journalctl</code>æä¾›äº†<code v-pre>-u</code>é€‰é¡¹æ¥æŸ¥çœ‹æŸä¸ª Unit çš„æ—¥å¿—ï¼Œæä¾›äº†<code v-pre>_PID</code>æ¥æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹IDçš„æ—¥å¿—ã€‚åœ¨<strong>ç¬¬ä¸€æ­¥</strong>ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“æœåŠ¡å¯åŠ¨å¤±è´¥çš„è¿›ç¨‹IDä¸º<code v-pre>119463</code>ã€‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹è¿™æ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">sudo</span> journalctl <span class="token assign-left variable">_PID</span><span class="token operator">=</span><span class="token number">119463</span>
-- Logs begin at Thu <span class="token number">2021</span>-09-09 09:12:25 CST, end at Thu <span class="token number">2021</span>-09-09 <span class="token number">14</span>:40:48 CST. --
<span class="token punctuation">..</span>.
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: <span class="token number">2021</span>-09-09 <span class="token number">13</span>:47:56.727        INFO        apiserver        gorm@v1.21.12/gorm.go:202        mysql/mysql.go:75<span class="token punctuation">[</span>error<span class="token punctuation">]</span> faile<span class="token operator">></span>
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: <span class="token number">2021</span>-09-09 <span class="token number">13</span>:47:56.727        FATAL        apiserver        apiserver/server.go:139        Failed to get cache instance: g<span class="token operator">></span>
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: github.com/marmotedu/iam/internal/apiserver.<span class="token punctuation">(</span>*completedExtraConfig<span class="token punctuation">)</span>.New
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>:         /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:139
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: github.com/marmotedu/iam/internal/apiserver.createAPIServer
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>:         /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:66
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: github.com/marmotedu/iam/internal/apiserver.Run
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>:         /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/run.go:11
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: github.com/marmotedu/iam/internal/apiserver.run.func1
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>:         /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/app.go:46
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: github.com/marmotedu/iam/pkg/app.<span class="token punctuation">(</span>*App<span class="token punctuation">)</span>.runCommand
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>:         /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:278
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: github.com/spf13/cobra.<span class="token punctuation">(</span>*Command<span class="token punctuation">)</span>.execute
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>:         /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:856
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: github.com/spf13/cobra.<span class="token punctuation">(</span>*Command<span class="token punctuation">)</span>.ExecuteC
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>:         /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:974
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: github.com/spf13/cobra.<span class="token punctuation">(</span>*Command<span class="token punctuation">)</span>.Execute
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>:         /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:902
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: github.com/marmotedu/iam/pkg/app.<span class="token punctuation">(</span>*App<span class="token punctuation">)</span>.Run
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>:         /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:233
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: main.main
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>:         /home/going/workspace/golang/src/github.com/marmotedu/iam/cmd/iam-apiserver/apiserver.go:24
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>: runtime.main
Sep 09 <span class="token number">13</span>:47:56 VM-200-70-centos iam-apiserver<span class="token punctuation">[</span><span class="token number">119463</span><span class="token punctuation">]</span>:         /home/going/go/go1.16.2/src/runtime/proc.go:225
lines <span class="token number">10</span>-54/54 <span class="token punctuation">(</span>END<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸Šé¢çš„æ—¥å¿—ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æœåŠ¡å¯åŠ¨å¤±è´¥çš„åŸå› ï¼š<code v-pre>iam-apiserver</code>å¯åŠ¨æ—¶ï¼Œå‘ç”Ÿäº†<code v-pre>FATAL</code>çº§åˆ«çš„é”™è¯¯ã€‚åˆ°è¿™é‡Œï¼Œä½ å·²ç»åˆæ­¥å®šä½åˆ°é—®é¢˜åŸå› äº†ã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹é€šè¿‡iam-apiserveræ—¥å¿—æ–‡ä»¶æŸ¥çœ‹çš„æ–¹å¼ã€‚</p>
<p>ä½œä¸ºä¸€ä¸ªä¼ä¸šçº§çš„å®æˆ˜é¡¹ç›®ï¼Œiam-apiserverçš„æ—¥å¿—å½“ç„¶æ˜¯ä¼šè®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ä¸­çš„ã€‚åœ¨<strong>ç¬¬ä¸€æ­¥</strong>ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code v-pre>systemctl status iam-apiserver</code>è¾“å‡ºçš„ä¿¡æ¯ï¼ŒçŸ¥é“äº†iam-apiserverå¯åŠ¨æ—¶åŠ è½½çš„é…ç½®æ–‡ä»¶ä¸º<code v-pre>/etc/iam/iam-apiserver.yaml</code>ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡iam-apiserverçš„é…ç½®æ–‡ä»¶iam-apiserver.yamlä¸­çš„<code v-pre>log.output-paths</code>é…ç½®é¡¹ï¼ŒæŸ¥çœ‹è®°å½•æ—¥å¿—æ–‡ä»¶çš„ä½ç½®ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>log:
    name: apiserver <span class="token comment"># Loggerçš„åå­—</span>
    development: <span class="token boolean">true</span> <span class="token comment"># æ˜¯å¦æ˜¯å¼€å‘æ¨¡å¼ã€‚å¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œä¼šå¯¹DPanicLevelè¿›è¡Œå †æ ˆè·Ÿè¸ªã€‚</span>
    level: debug <span class="token comment"># æ—¥å¿—çº§åˆ«ï¼Œä¼˜å…ˆçº§ä»ä½åˆ°é«˜ä¾æ¬¡ä¸ºï¼šdebug, info, warn, error, dpanic, panic, fatalã€‚</span>
    format: console <span class="token comment"># æ”¯æŒçš„æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œç›®å‰æ”¯æŒconsoleå’Œjsonä¸¤ç§ã€‚consoleå…¶å®å°±æ˜¯textæ ¼å¼ã€‚</span>
    enable-color: <span class="token boolean">true</span> <span class="token comment"># æ˜¯å¦å¼€å¯é¢œè‰²è¾“å‡ºï¼Œtrue:æ˜¯ï¼Œfalse:å¦</span>
    disable-caller: <span class="token boolean">false</span> <span class="token comment"># æ˜¯å¦å¼€å¯ callerï¼Œå¦‚æœå¼€å¯ä¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºè°ƒç”¨æ—¥å¿—æ‰€åœ¨çš„æ–‡ä»¶ã€å‡½æ•°å’Œè¡Œå·</span>
    disable-stacktrace: <span class="token boolean">false</span> <span class="token comment"># æ˜¯å¦åœ¨panicåŠä»¥ä¸Šçº§åˆ«ç¦æ­¢æ‰“å°å †æ ˆä¿¡æ¯</span>
    output-paths: /var/log/iam/iam-apiserver.log,stdout <span class="token comment"># æ”¯æŒè¾“å‡ºåˆ°å¤šä¸ªè¾“å‡ºï¼Œé€—å·åˆ†å¼€ã€‚æ”¯æŒè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰å’Œæ–‡ä»¶ã€‚</span>
    error-output-paths: /var/log/iam/iam-apiserver.error.log <span class="token comment"># zapå†…éƒ¨(éä¸šåŠ¡)é”™è¯¯æ—¥å¿—è¾“å‡ºè·¯å¾„ï¼Œå¤šä¸ªè¾“å‡ºï¼Œé€—å·åˆ†å¼€</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œiam-apiserverå°†æ—¥å¿—åˆ†åˆ«è®°å½•åˆ°äº†<code v-pre>/var/log/iam/iam-apiserver.log</code>å’Œ<code v-pre>stdout</code>ä¸­ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹<code v-pre>/var/log/iam/iam-apiserver.log</code>æ—¥å¿—æ–‡ä»¶ï¼Œæ¥æŸ¥çœ‹æŠ¥é”™ä¿¡æ¯ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">tail</span> <span class="token parameter variable">-25</span> /var/log/iam/iam-apiserver.log
<span class="token punctuation">..</span>.
<span class="token number">2021</span>-09-09 <span class="token number">15</span>:42:35.231  INFO  apiserver  server/genericapiserver.go:88  GET    /version --<span class="token operator">></span> github.com/marmotedu/iam/internal/pkg/server.<span class="token punctuation">(</span>*GenericAPIServer<span class="token punctuation">)</span>.InstallAPIs.func2 <span class="token punctuation">(</span><span class="token number">10</span> handlers<span class="token punctuation">)</span>
<span class="token number">2021</span>-09-09 <span class="token number">15</span>:42:35.232  INFO  apiserver  gorm@v1.21.12/gorm.go:202  mysql/mysql.go:75<span class="token punctuation">[</span>error<span class="token punctuation">]</span> failed to initialize database, got error dial tcp <span class="token number">127.0</span>.0.1:3309: connect: connection refused
<span class="token number">2021</span>-09-09 <span class="token number">15</span>:42:35.232  FATAL  apiserver  apiserver/server.go:139  Failed to get cache instance: got nil cache server
github.com/marmotedu/iam/internal/apiserver.<span class="token punctuation">(</span>*completedExtraConfig<span class="token punctuation">)</span>.New
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:139
github.com/marmotedu/iam/internal/apiserver.createAPIServer
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:66
github.com/marmotedu/iam/internal/apiserver.Run
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/run.go:11
github.com/marmotedu/iam/internal/apiserver.run.func1
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/app.go:46
github.com/marmotedu/iam/pkg/app.<span class="token punctuation">(</span>*App<span class="token punctuation">)</span>.runCommand
  /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:278
github.com/spf13/cobra.<span class="token punctuation">(</span>*Command<span class="token punctuation">)</span>.execute
  /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:856
github.com/spf13/cobra.<span class="token punctuation">(</span>*Command<span class="token punctuation">)</span>.ExecuteC
  /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:974
github.com/spf13/cobra.<span class="token punctuation">(</span>*Command<span class="token punctuation">)</span>.Execute
  /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:902
github.com/marmotedu/iam/pkg/app.<span class="token punctuation">(</span>*App<span class="token punctuation">)</span>.Run
  /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:233
main.main
  /home/going/workspace/golang/src/github.com/marmotedu/iam/cmd/iam-apiserver/apiserver.go:24
runtime.main
  /home/going/go/go1.16.2/src/runtime/proc.go:225
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å†æ¥çœ‹æœ€åä¸€ç§æŸ¥çœ‹æ–¹å¼ï¼Œé€šè¿‡consoleæŸ¥çœ‹ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡consoleæ¥çœ‹æ—¥å¿—ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬åœ¨Linuxç»ˆç«¯å‰å°è¿è¡Œiam-apiserverï¼ˆåœ¨<strong>ç¬¬ä¸€æ­¥</strong>ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†å¯åŠ¨å‘½ä»¤ï¼‰ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">sudo</span> /opt/iam/bin/iam-apiserver <span class="token parameter variable">--config</span><span class="token operator">=</span>/etc/iam/iam-apiserver.yaml
<span class="token punctuation">..</span>.
<span class="token number">2021</span>-09-09 <span class="token number">15</span>:47:00.660  INFO  apiserver  server/genericapiserver.go:88  GET    /debug/pprof/mutex --<span class="token operator">></span> github.com/gin-contrib/pprof.pprofHandler.func1 <span class="token punctuation">(</span><span class="token number">10</span> handlers<span class="token punctuation">)</span>
<span class="token number">2021</span>-09-09 <span class="token number">15</span>:47:00.660  INFO  apiserver  server/genericapiserver.go:88  GET    /debug/pprof/threadcreate --<span class="token operator">></span> github.com/gin-contrib/pprof.pprofHandler.func1 <span class="token punctuation">(</span><span class="token number">10</span> handlers<span class="token punctuation">)</span>
<span class="token number">2021</span>-09-09 <span class="token number">15</span>:47:00.660  INFO  apiserver  server/genericapiserver.go:88  GET    /version --<span class="token operator">></span> github.com/marmotedu/iam/internal/pkg/server.<span class="token punctuation">(</span>*GenericAPIServer<span class="token punctuation">)</span>.InstallAPIs.func2 <span class="token punctuation">(</span><span class="token number">10</span> handlers<span class="token punctuation">)</span>
<span class="token number">2021</span>-09-09 <span class="token number">15</span>:47:00.661  INFO  apiserver  gorm@v1.21.12/gorm.go:202  mysql/mysql.go:75<span class="token punctuation">[</span>error<span class="token punctuation">]</span> failed to initialize database, got error dial tcp <span class="token number">127.0</span>.0.1:3309: connect: connection refused
<span class="token number">2021</span>-09-09 <span class="token number">15</span>:47:00.661  FATAL  apiserver  apiserver/server.go:139  Failed to get cache instance: got nil cache server
github.com/marmotedu/iam/internal/apiserver.<span class="token punctuation">(</span>*completedExtraConfig<span class="token punctuation">)</span>.New
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:139
github.com/marmotedu/iam/internal/apiserver.createAPIServer
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:66
github.com/marmotedu/iam/internal/apiserver.Run
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/run.go:11
github.com/marmotedu/iam/internal/apiserver.run.func1
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/app.go:46
github.com/marmotedu/iam/pkg/app.<span class="token punctuation">(</span>*App<span class="token punctuation">)</span>.runCommand
  /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:278
github.com/spf13/cobra.<span class="token punctuation">(</span>*Command<span class="token punctuation">)</span>.execute
  /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:856
github.com/spf13/cobra.<span class="token punctuation">(</span>*Command<span class="token punctuation">)</span>.ExecuteC
  /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:974
github.com/spf13/cobra.<span class="token punctuation">(</span>*Command<span class="token punctuation">)</span>.Execute
  /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:902
github.com/marmotedu/iam/pkg/app.<span class="token punctuation">(</span>*App<span class="token punctuation">)</span>.Run
  /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:233
main.main
  /home/going/workspace/golang/src/github.com/marmotedu/iam/cmd/iam-apiserver/apiserver.go:24
runtime.main
  /home/going/go/go1.16.2/src/runtime/proc.go:225
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä¸Šé¢è¿™3ç§æŸ¥çœ‹æ–¹å¼ï¼Œæˆ‘ä»¬å‡èƒ½åˆæ­¥å®šä½åˆ°æœåŠ¡å¼‚å¸¸çš„åŸå› ã€‚</p>
<h4 id="ä½¿ç”¨goè°ƒè¯•å·¥å…·delveæ¥å®šä½é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨goè°ƒè¯•å·¥å…·delveæ¥å®šä½é—®é¢˜" aria-hidden="true">#</a> ä½¿ç”¨Goè°ƒè¯•å·¥å…·Delveæ¥å®šä½é—®é¢˜</h4>
<p>æŸ¥çœ‹æ—¥å¿—æ˜¯æœ€ç®€å•çš„æ’éšœæ–¹å¼ï¼Œé€šè¿‡æŸ¥çœ‹æ—¥å¿—ï¼Œæˆ‘ä»¬å¯èƒ½å®šä½å‡ºé—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œè¿™ç§æƒ…å†µä¸‹é—®é¢˜å°±èƒ½å¾—åˆ°å¿«é€Ÿçš„è§£å†³ã€‚ä½†æœ‰äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šè¿‡æ—¥å¿—å¹¶ä¸ä¸€å®šèƒ½å®šä½å‡ºé—®é¢˜ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>ç¨‹åºå¼‚å¸¸ï¼Œä½†æ˜¯æ²¡æœ‰é”™è¯¯æ—¥å¿—ã€‚</li>
<li>æ—¥å¿—æœ‰æŠ¥é”™ï¼Œä½†åªèƒ½åˆ¤æ–­é—®é¢˜çš„é¢ï¼Œè¿˜ä¸èƒ½ç²¾å‡†æ‰¾åˆ°é—®é¢˜çš„æ ¹å› ã€‚</li>
</ul>
<p>é‡åˆ°ä¸Šé¢è¿™ä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬éƒ½éœ€è¦å†è¿›ä¸€æ­¥åœ°å®šä½é—®é¢˜ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Delveè°ƒè¯•å·¥å…·æ¥å°è¯•å®šä½é—®é¢˜ã€‚Delveå·¥å…·çš„ç”¨æ³•ä½ å¯ä»¥å‚è€ƒ <a href="https://github.com/marmotedu/geekbang-go/blob/master/Delve%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3.md" target="_blank" rel="noopener noreferrer">Delveä½¿ç”¨è¯¦è§£<ExternalLinkIcon/></a>ã€‚</p>
<h4 id="æ·»åŠ debugæ—¥å¿—å®šä½é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#æ·»åŠ debugæ—¥å¿—å®šä½é—®é¢˜" aria-hidden="true">#</a> æ·»åŠ Debugæ—¥å¿—å®šä½é—®é¢˜</h4>
<p>å¦‚æœä½¿ç”¨ Delve å·¥å…·ä»ç„¶æ²¡æœ‰å®šä½å‡ºé—®é¢˜ï¼Œæ¥ä¸‹æ¥ä½ å¯ä»¥å°è¯•æœ€åŸå§‹çš„æ–¹æ³•ï¼šæ·»åŠ Debugæ—¥å¿—æ¥å®šä½é—®é¢˜ã€‚è¿™ç§æ–¹æ³•å…·ä½“å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼Œåœ¨å…³é”®ä»£ç æ®µæ·»åŠ Debugæ—¥å¿—ã€‚</strong></p>
<p>ä½ éœ€è¦æ ¹æ®è‡ªå·±å¯¹ä»£ç çš„ç†è§£æ¥å†³å®šå…³é”®ä»£ç æ®µã€‚å¦‚æœä¸ç¡®å®šå“ªæ®µä»£ç å‡ºé—®é¢˜ï¼Œå¯ä»¥ä»è¯·æ±‚å…¥å£å¤„æ·»åŠ Debugæ—¥å¿—ï¼Œç„¶åè·Ÿç€ä»£ç æµç¨‹ä¸€æ­¥æ­¥å¾€ä¸‹æ’æŸ¥ï¼Œå¹¶åœ¨éœ€è¦çš„åœ°æ–¹æ·»åŠ Debugæ—¥å¿—ã€‚</p>
<p>ä¾‹å¦‚ï¼Œé€šè¿‡æ’æŸ¥æ—¥å¿—ï¼Œæˆ‘ä»¬å®šä½åˆ°<code v-pre>internal/apiserver/server.go:139</code>ä½ç½®çš„ä»£ç å¯¼è‡´ç¨‹åºFATALï¼ŒFATALåŸå› æ˜¯<code v-pre>Failed to get cache instance: got nil cache server</code>ã€‚<code v-pre>cache server</code>æ˜¯<code v-pre>nil</code>ï¼Œè¯´æ˜<code v-pre>cache server</code>æ²¡æœ‰è¢«åˆå§‹åŒ–ã€‚æŸ¥çœ‹<code v-pre>cache server</code>åˆå§‹åŒ–å‡½æ•°ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">GetCacheInsOr</span><span class="token punctuation">(</span>store store<span class="token punctuation">.</span>Factory<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Cache<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> store <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cacheServer <span class="token operator">=</span> <span class="token operator">&amp;</span>Cache<span class="token punctuation">{</span>store<span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> cacheServer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"got nil cache server"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> cacheServer<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬ä¸éš¾åˆ†æå‡ºï¼Œæ˜¯<code v-pre>store == nil</code>å¯¼è‡´<code v-pre>cacheServer</code>æ²¡æœ‰è¢«åˆå§‹åŒ–ã€‚å†æ¥çœ‹ä¸‹storeçš„åˆå§‹åŒ–ä»£ç ï¼Œå¹¶åŠ ä¸€äº›Debugæ—¥å¿—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202303071810106.png" alt="å›¾ç‰‡"></p>
<p>æˆ‘ä»¬æ·»åŠ å®ŒDebugä»£ç åï¼Œå°±å¯ä»¥é‡æ–°ç¼–è¯‘å¹¶è¿è¡Œç¨‹åºäº†ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼šå¯ä»¥åœ¨é”™è¯¯è¿”å›çš„ä½ç½®æ·»åŠ Debugæ—¥å¿—ï¼Œè¿™æ ·èƒ½å¤§æ¦‚ç‡å¸®åŠ©ä½ å®šä½åˆ°å‡ºé”™çš„ä½ç½®ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">"DEBUG POINT - 1: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç¬¬äºŒæ­¥ï¼Œé‡æ–°ç¼–è¯‘æºç ï¼Œå¹¶å¯åŠ¨ã€‚</strong></p>
<p>*è¿™é‡Œä¸ºäº†è°ƒè¯•ã€çœ‹æ—¥å¿—æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨Linuxç»ˆç«¯çš„å‰ç«¯è¿è¡Œiam-apiserverï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">sudo</span> /opt/iam/bin/iam-apiserver <span class="token parameter variable">--config</span><span class="token operator">=</span>/etc/iam/iam-apiserver.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æŸ¥çœ‹æˆ‘ä»¬æ·»åŠ çš„Debugæ—¥å¿—æ‰“å°çš„å†…å®¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202303071813916.png" alt="å›¾ç‰‡"></p>
<p>ä»Debugæ—¥å¿—ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ç”¨æ¥åˆ›å»ºMySQLå®ä¾‹çš„ç«¯å£æ˜¯é”™è¯¯çš„ï¼Œæ­£ç¡®çš„ç«¯å£åº”è¯¥æ˜¯<code v-pre>3306</code>ï¼Œè€Œä¸æ˜¯<code v-pre>3309</code>ã€‚MySQLæœåŠ¡å™¨çš„ç«¯å£æ˜¯åœ¨iam-apiserver.yamlä¸­é…ç½®çš„ã€‚ä¿®æ”¹iam-apiserver.yamlä¸ºæ­£ç¡®çš„é…ç½®ï¼Œå¹¶å¯åŠ¨ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">sudo</span> /opt/iam/bin/iam-apiserver <span class="token parameter variable">--config</span><span class="token operator">=</span>/etc/iam/iam-apiserver.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å†æ¬¡æŸ¥çœ‹consoleæ—¥å¿—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="https://static001.geekbang.org/resource/image/f7/9d/f72b766b7504016259bef04eb03dac9d.png?wh=1920x271" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/f7/9d/f72b766b7504016259bef04eb03dac9d.png?wh=1920x271" alt="å›¾ç‰‡"><ExternalLinkIcon/></a></p>
<p>å¯ä»¥çœ‹åˆ°é—®é¢˜å·²ç»ä¿®å¤ï¼Œ<code v-pre>dbIns</code>ä¸ä¸º<code v-pre>nil</code>ï¼Œç¨‹åºæ­£å¸¸è¿è¡Œï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ systemctl status iam-apiserver
â— iam-apiserver.service - IAM APIServer
   Loaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/iam-apiserver.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Thu <span class="token number">2021</span>-09-09 <span class="token number">20</span>:48:18 CST<span class="token punctuation">;</span> 17s ago
     Docs: https://github.com/marmotedu/iam/blob/master/init/README.md
  Process: <span class="token number">255648</span> <span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>/usr/bin/mkdir <span class="token parameter variable">-p</span> /var/log/iam <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">0</span>/SUCCESS<span class="token punctuation">)</span>
  Process: <span class="token number">255647</span> <span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>/usr/bin/mkdir <span class="token parameter variable">-p</span> /data/iam/iam-apiserver <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">0</span>/SUCCESS<span class="token punctuation">)</span>
 Main PID: <span class="token number">255650</span> <span class="token punctuation">(</span>iam-apiserver<span class="token punctuation">)</span>
    Tasks: <span class="token number">5</span> <span class="token punctuation">(</span>limit: <span class="token number">23724</span><span class="token punctuation">)</span>
   Memory: <span class="token number">7</span>.3M
   CGroup: /system.slice/iam-apiserver.service
           â””â”€255650 /opt/iam/bin/iam-apiserver <span class="token parameter variable">--config</span><span class="token operator">=</span>/etc/iam/iam-apiserver.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™é‡Œï¼Œ<code v-pre>Active</code>ä¸º<code v-pre>active (running)</code>çŠ¶æ€ã€‚</p>
<p>å› ä¸ºè¿™äº›Debugæ—¥å¿—èƒ½å¤ŸååŠ©ä½ å®šä½é—®é¢˜ï¼Œä»ä¾§é¢è¯´æ˜è¿™äº›æ—¥å¿—æ˜¯æœ‰ç”¨çš„ï¼Œæ‰€ä»¥ä½ å¯ä»¥ä¿ç•™è¿™äº›Debugæ—¥å¿—è°ƒç”¨ä»£ç ã€‚</p>
<h3 id="è§£å†³é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#è§£å†³é—®é¢˜" aria-hidden="true">#</a> è§£å†³é—®é¢˜</h3>
<p>åœ¨å®šä½é—®é¢˜é˜¶æ®µï¼Œæˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†é—®é¢˜çš„åŸå› ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥æ ¹æ®è‡ªå·±å¯¹ä¸šåŠ¡ã€åº•å±‚ä»£ç å®ç°çš„æŒæ¡å’Œç†è§£ï¼Œä¿®å¤è¿™ä¸ªé—®é¢˜äº†ã€‚è‡³äºæ€ä¹ˆä¿®å¤ï¼Œä½ éœ€è¦ç»“åˆå…·ä½“æƒ…å†µæ¥åˆ¤æ–­ï¼Œå¹¶æ²¡æœ‰ç»Ÿä¸€çš„æµç¨‹å’Œæ–¹æ³•è®ºï¼Œè¿™é‡Œå°±ä¸å¤šä»‹ç»äº†ã€‚</p>
<p>ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†æ’æŸ¥é—®é¢˜çš„æ€è·¯å’Œæ–¹æ³•ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥å‘ä½ å±•ç¤º9ä¸ªåœ¨éƒ¨ç½²å’Œä½¿ç”¨IAMç³»ç»Ÿæ—¶å®¹æ˜“é‡åˆ°çš„é—®é¢˜ï¼Œå¹¶æä¾›è§£å†³æ–¹æ³•ã€‚è¿™äº›é—®é¢˜åŸºæœ¬ä¸Šéƒ½æ˜¯ç”±æœåŠ¡å™¨ç¯å¢ƒå¼•èµ·çš„ã€‚</p>
<h2 id="iamå¸¸è§æ•…éšœåŠè§£å†³åŠæ³•" tabindex="-1"><a class="header-anchor" href="#iamå¸¸è§æ•…éšœåŠè§£å†³åŠæ³•" aria-hidden="true">#</a> IAMå¸¸è§æ•…éšœåŠè§£å†³åŠæ³•</h2>
<p>é—®é¢˜ä¸€ï¼šå®‰è£…neovimï¼ŒæŠ¥ <code v-pre>No match for argument: neovim</code> é”™è¯¯ã€‚</p>
<p>è§£å†³æ–¹æ³•æ˜¯å®‰è£… EPEL æºï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">sudo</span> yum <span class="token function">install</span> https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>é—®é¢˜äºŒï¼šå®‰è£…protoc-gen-goå¤±è´¥ï¼ˆè¶…æ—¶ã€æŠ¥é”™ç­‰ï¼‰ã€‚</p>
<p>è¿™ä¸ªæ•…éšœå‡ºç°ï¼Œå¯èƒ½æ˜¯å› ä¸ºä½ å½“å‰æœåŠ¡å™¨æ‰€åœ¨çš„ç½‘ç»œç¯å¢ƒæ— æ³•è®¿é—®<code v-pre>github.com</code>ï¼Œæˆ–è€…è®¿é—®<code v-pre>github.com</code>é€Ÿåº¦å¤ªæ…¢ã€‚</p>
<p>è§£å†³æ–¹æ³•æ˜¯æ‰‹åŠ¨ç¼–è¯‘å®‰è£…ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">git</span> clone <span class="token parameter variable">--depth</span> <span class="token number">1</span> https://github.com/golang/protobuf <span class="token variable">$GOPATH</span>/src/github.com/golang/protobuf
$ <span class="token builtin class-name">cd</span> <span class="token variable">$GOPATH</span>/src/github.com/golang/protobuf/protoc-gen-go
$ go <span class="token function">install</span> <span class="token parameter variable">-v</span> <span class="token builtin class-name">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é—®é¢˜ä¸‰ï¼šé‡åˆ°<code v-pre>xxx: permission denied</code>è¿™ç±»çš„é”™è¯¯ã€‚</p>
<p>å‡ºç°è¿™ç§é”™è¯¯ï¼Œæ˜¯å› ä¸ºä½ æ²¡æœ‰æƒé™æ‰§è¡Œå½“å‰çš„æ“ä½œã€‚è§£å†³æ–¹æ³•æ˜¯æ’æŸ¥è‡ªå·±æ˜¯å¦æœ‰æƒé™æ‰§è¡Œå½“å‰æ“ä½œã€‚å¦‚æœæ²¡æœ‰æƒé™ï¼Œéœ€è¦ä½ åˆ‡æ¢åˆ°æœ‰æƒé™çš„ç”¨æˆ·ï¼Œæˆ–è€…æ”¾å¼ƒæ‰§è¡Œå½“å‰æ“ä½œã€‚</p>
<p>ä¸ºäº†è¯´æ˜é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ä¸¾ä¸€ä¸ªé”™è¯¯ä¾‹å­ï¼Œå¹¶ç»™å‡ºæ’æŸ¥æ€è·¯ã€‚ä¾‹å­çš„é”™è¯¯æ—¥å¿—å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token punctuation">[</span>going@VM-8-9-centos /<span class="token punctuation">]</span>$ go get <span class="token parameter variable">-u</span> github.com/golang/protobuf/protoc-gen-go
go: could not create module cache: <span class="token function">mkdir</span> /golang: permission denied
<span class="token punctuation">[</span>going@VM-8-9-centos /<span class="token punctuation">]</span>$ <span class="token function">sudo</span> go get <span class="token parameter variable">-u</span> github.com/golang/protobuf/protoc-gen-go
sudo: go: <span class="token builtin class-name">command</span> not found
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°é”™è¯¯ä¸­ï¼Œ ä¸€å…±æŠ¥äº†ä¸¤ä¸ªé”™è¯¯ï¼Œåˆ†åˆ«æ˜¯<code v-pre>mkdir /golang: permission denied</code>å’Œ<code v-pre>sudo: go: command not found</code>ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹<code v-pre>mkdir /golang: permission denied</code>é”™è¯¯ã€‚</p>
<p>é€šè¿‡å‘½ä»¤è¡Œæç¤ºç¬¦<code v-pre>$</code>å¯ä»¥çŸ¥é“ï¼Œå½“å‰ç™»é™†ç”¨æˆ·æ˜¯æ™®é€šç”¨æˆ·ï¼›é€šè¿‡æŠ¥é”™<code v-pre>mkdir /golang: permission denied</code>å¯ä»¥çŸ¥é“<code v-pre>go get -u github.com/golang/protobuf/protoc-gen-go</code>å‘½ä»¤åº•å±‚æ‰§è¡Œäº†<code v-pre>mkdir /golang</code>ï¼Œå› ä¸ºæ™®é€šç”¨æˆ·æ²¡æœ‰å†™<code v-pre>/</code> ç›®å½•çš„æƒé™ï¼Œæ‰€ä»¥ä¼šæŠ¥æƒé™é”™è¯¯ã€‚è§£å†³æ–¹æ³•æ˜¯åˆ‡æ¢åˆ°ç”¨æˆ·çš„ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ<code v-pre>go get -u</code>å‘½ä»¤ã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹ä¸‹<code v-pre>sudo: go: command not found</code>é”™è¯¯ã€‚<code v-pre>sudo</code>å‘½ä»¤ä¼šå°†å‘½ä»¤æ‰§è¡Œçš„ç¯å¢ƒåˆ‡æ¢åˆ°<code v-pre>root</code>ç”¨æˆ·ï¼Œ<code v-pre>root</code>ç”¨æˆ·æ˜¾ç„¶æ˜¯æ²¡æœ‰å®‰è£…<code v-pre>go</code>å‘½ä»¤çš„ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´<code v-pre>command not found</code>é”™è¯¯ã€‚è§£å†³æ–¹å¼æ˜¯å»æ‰ <code v-pre>sudo</code> ï¼Œç›´æ¥æ‰§è¡Œ <code v-pre>$ go get -u xxx</code> ã€‚</p>
<p>é—®é¢˜å››ï¼šVimIDEä½¿ç”¨è¿‡ç¨‹ä¸­ï¼ŒæŠ¥å„ç±»é”™è¯¯ã€‚</p>
<p>è¿™é‡Œçš„æŠ¥é”™åŸå› è·Ÿç¯å¢ƒæœ‰å…³ç³»ï¼Œå®‰è£…VimIDEæ—¶çš„ç³»ç»Ÿç¯å¢ƒã€åŒ…çš„ç‰ˆæœ¬ç­‰ç­‰ï¼Œéƒ½å¯èƒ½ä¼šå¯¼è‡´ä½¿ç”¨VimIDEæŠ¥é”™ã€‚å› ä¸ºé”™è¯¯ç±»å‹å¤ªå¤šï¼Œæ²¡æ³•ä¸€ä¸€è¯´æ˜ï¼Œæ‰€ä»¥æˆ‘å»ºè®®ä½ å¿½ç•¥è¿™äº›é”™è¯¯ï¼Œå…¶å®å®Œå…¨ä¸å½±å“åé¢çš„å­¦ä¹ ã€‚</p>
<p>é—®é¢˜äº”ï¼šè®¿é—®iam-authz-serverçš„<code v-pre>/v1/authz</code>æ¥å£æŠ¥<code v-pre>{&quot;code&quot;:100202,&quot;message&quot;:&quot;Signature is invalid&quot;}</code>ã€‚</p>
<p>è¿™æ—¶å¯èƒ½æ˜¯ç­¾å‘çš„Tokenæœ‰é—®é¢˜ï¼Œå»ºè®®é‡æ–°æ‰§è¡Œä»¥ä¸‹5ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>é‡æ–°ç™»é™†ç³»ç»Ÿï¼Œå¹¶è·å–è®¿é—®ä»¤ç‰Œï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token assign-left variable">token</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">'Content-Type: application/json'</span> -d<span class="token string">'{"username":"admin","password":"Admin@2021"}'</span> http://127.0.0.1:8080/login <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> .token<span class="token variable">`</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¦‚æœæ²¡æœ‰å®‰è£…<code v-pre>jq</code>å‘½ä»¤ï¼Œå¯ä»¥æ‰§è¡Œ<code v-pre>sudo yum -y install jq</code>å‘½ä»¤æ¥å®‰è£…ã€‚</p>
<ol>
<li>åˆ›å»ºæˆæƒç­–ç•¥ï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">"Content-Type: application/json"</span> -H<span class="token string">"Authorization: Bearer <span class="token variable">$token</span>"</span> -d<span class="token string">'{"metadata":{"name":"authztest"},"policy":{"description":"One policy to rule them all.","subjects":["users:&lt;peter|ken>","users:maria","groups:admins"],"actions":["delete","&lt;create|update>"],"effect":"allow","resources":["resources:articles:&lt;.>","resources:printer"],"conditions":{"remoteIPAddress":{"type":"CIDRCondition","options":{"cidr":"192.168.0.1/16"}}}}}'</span> http://127.0.0.1:8080/v1/policies
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol>
<li>åˆ›å»ºå¯†é’¥ï¼Œå¹¶ä»å‘½ä»¤çš„è¾“å‡ºä¸­æå–secretID å’Œ secretKeyï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">"Content-Type: application/json"</span> -H<span class="token string">"Authorization: Bearer <span class="token variable">$token</span>"</span> -d<span class="token string">'{"metadata":{"name":"authztest"},"expires":0,"description":"admin secret"}'</span> http://127.0.0.1:8080/v1/secrets
<span class="token punctuation">{</span><span class="token string">"metadata"</span>:<span class="token punctuation">{</span><span class="token string">"id"</span>:23,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"authztest"</span>,<span class="token string">"createdAt"</span><span class="token builtin class-name">:</span><span class="token string">"2021-04-08T07:24:50.071671422+08:00"</span>,<span class="token string">"updatedAt"</span><span class="token builtin class-name">:</span><span class="token string">"2021-04-08T07:24:50.071671422+08:00"</span><span class="token punctuation">}</span>,<span class="token string">"username"</span><span class="token builtin class-name">:</span><span class="token string">"admin"</span>,<span class="token string">"secretID"</span><span class="token builtin class-name">:</span><span class="token string">"ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox"</span>,<span class="token string">"secretKey"</span><span class="token builtin class-name">:</span><span class="token string">"7Sfa5EfAPIwcTLGCfSvqLf0zZGCjF3l8"</span>,<span class="token string">"expires"</span>:0,<span class="token string">"description"</span><span class="token builtin class-name">:</span><span class="token string">"admin secret"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol>
<li>ç”Ÿæˆè®¿é—® iam-authz-server çš„ Token</li>
</ol>
<p>iamctl æä¾›äº† <code v-pre>jwt sigin</code> å‘½ä»¤ï¼Œä½ å¯ä»¥æ ¹æ® <code v-pre>secretID</code> å’Œ <code v-pre>secretKey</code> ç­¾å‘ Tokenï¼Œæ–¹ä¾¿ä½ ä½¿ç”¨ã€‚ç­¾å‘Tokençš„å…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ iamctl jwt sign ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox 7Sfa5EfAPIwcTLGCfSvqLf0zZGCjF3l8 <span class="token comment"># iamctl jwt sign $secretID $secretKey</span>
eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol>
<li>æµ‹è¯•èµ„æºæˆæƒæ˜¯å¦é€šè¿‡ï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">'Content-Type: application/json'</span> -H<span class="token string">'Authorization: Bearer eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ'</span> -d<span class="token string">'{"subject":"users:maria","action":"delete","resource":"resources:articles:ladon-introduction","context":{"remoteIPAddress":"192.168.0.5"}}'</span> http://127.0.0.1:9090/v1/authz
<span class="token punctuation">{</span><span class="token string">"allowed"</span>:true<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>é—®é¢˜å…­ï¼šæ‰§è¡Œ<code v-pre>iamctl user list</code>æŠ¥<code v-pre>error: {&quot;code&quot;:100207,&quot;message&quot;:&quot;Permission denied&quot;}</code>ã€‚</p>
<p>å‡ºç°è¿™ç§æƒ…å†µï¼Œå¯èƒ½æ˜¯å¯†ç æ²¡æœ‰é…ç½®æ­£ç¡®ã€‚</p>
<p>ä½ å¯ä»¥çœ‹ä¸‹<code v-pre>$HOME/.iam/iamctl.yaml</code>é…ç½®æ–‡ä»¶ä¸­çš„ç”¨æˆ·åå’Œå¯†ç é…ç½®çš„æ˜¯ä¸æ˜¯adminï¼Œä»¥åŠadminçš„å¯†ç æ˜¯å¦æ˜¯<code v-pre>Admin@2021</code>ã€‚</p>
<p>é—®é¢˜ä¸ƒï¼šåœ¨åˆ›å»ºç”¨æˆ·æ—¶æŠ¥<code v-pre>{&quot;code&quot;:100101,&quot;message&quot;:&quot;Database error&quot;}</code>é”™è¯¯ã€‚</p>
<p>å‡ºç°è¿™ç§æƒ…å†µï¼Œå¯èƒ½æ˜¯ç”¨æˆ·åé‡äº†ï¼Œå»ºè®®æ¢ä¸ªæ–°çš„ç”¨æˆ·åå†æ¬¡åˆ›å»ºã€‚</p>
<p>é—®é¢˜å…«ï¼šæŠ¥<code v-pre>No such file or directory</code>ã€<code v-pre>command not found</code>ã€<code v-pre>permission denied</code>é”™è¯¯ã€‚</p>
<p>é‡åˆ°è¿™ç±»é”™è¯¯ï¼Œè¦æ ¹æ®æç¤ºæ’æŸ¥å’Œè§£å†³é—®é¢˜ã€‚</p>
<ul>
<li><code v-pre>No such file or directory</code>ï¼šç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„åŸå› æ˜¯ä»€ä¹ˆã€‚</li>
<li><code v-pre>command not found</code>ï¼šç¡®è®¤å‘½ä»¤æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå¯ä»¥é‡æ–°å®‰è£…å‘½ä»¤ã€‚</li>
<li><code v-pre>permission denied</code>ï¼šç¡®è®¤æ˜¯å¦æœ‰æ“ä½œæƒé™ï¼Œå¦‚æœæ²¡æœ‰ï¼Œè¦åˆ‡æ¢åˆ°æœ‰æƒé™çš„ç”¨æˆ·æˆ–è€…ç›®å½•ã€‚</li>
</ul>
<p>é—®é¢˜ä¹ï¼šæŠ¥<code v-pre>iam-apiserver.service</code>ã€<code v-pre>/opt/iam/bin/iam-apiserver</code>ã€<code v-pre>/etc/iam/iam-apiserver.yaml</code>æ–‡ä»¶ä¸å­˜åœ¨ã€‚</p>
<p>æˆ‘æ¥ä»‹ç»ä¸‹è¿™äº›æ–‡ä»¶çš„ä½œç”¨ã€‚</p>
<ul>
<li><code v-pre>/etc/systemd/system/iam-apiserver.service</code>ï¼šiam-apiserverçš„sysmted Unitæ–‡ä»¶ã€‚</li>
<li><code v-pre>/opt/iam/bin/iam-apiserver</code>ï¼šiam-apiserverçš„äºŒè¿›åˆ¶å¯åŠ¨å‘½ä»¤ã€‚</li>
<li><code v-pre>/etc/iam/iam-apiserver.yaml</code>ï¼šiam-apiserverçš„é…ç½®æ–‡ä»¶ã€‚</li>
</ul>
<p>å¦‚æœæŸä¸ªæ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‚£å°±éœ€è¦ä½ é‡æ–°å®‰è£…è¿™äº›æ–‡ä»¶ã€‚æˆ‘æ¥åˆ†åˆ«ä»‹ç»è¿™ä¸‰ä¸ªæ–‡ä»¶çš„å®‰è£…æ–¹æ³•ã€‚</p>
<p><code v-pre>/etc/systemd/system/iam-apiserver.service</code>å®‰è£…æ–¹æ³•ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ ./scripts/genconfig.sh scripts/install/environment.sh init/iam-apiserver.service <span class="token operator">></span> iam-apiserver.service
$ <span class="token function">sudo</span> <span class="token function">mv</span> iam-apiserver.service /etc/systemd/system/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>/opt/iam/bin/iam-apiserver</code>å®‰è£…æ–¹æ³•ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ <span class="token builtin class-name">source</span> scripts/install/environment.sh
$ <span class="token function">make</span> build <span class="token assign-left variable">BINS</span><span class="token operator">=</span>iam-apiserver
$ <span class="token function">sudo</span> <span class="token function">cp</span> _output/platforms/linux/amd64/iam-apiserver <span class="token variable">${IAM_INSTALL_DIR}</span>/bin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>/etc/iam/iam-apiserver.yaml</code>å®‰è£…æ–¹æ³•ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ ./scripts/genconfig.sh scripts/install/environment.sh configs/iam-apiserver.yaml <span class="token operator">></span> iam-apiserver.yaml
$ <span class="token function">sudo</span> <span class="token function">mv</span> iam-apiserver.yaml <span class="token variable">${IAM_CONFIG_DIR}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2>
<p>è¿™ä¸€è®²ï¼Œæˆ‘ä»¥<code v-pre>iam-apiserver</code>æœåŠ¡ä¸ºä¾‹ï¼Œå‘ä½ ä»‹ç»äº†æ’éšœçš„åŸºæœ¬æµç¨‹ï¼šå‘ç°é—®é¢˜ -&gt; å®šä½é—®é¢˜ -&gt; è§£å†³é—®é¢˜ã€‚</p>
<p>ä½ å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼æ¥å‘ç°é—®é¢˜ã€‚</p>
<ul>
<li>æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼šå¯åŠ¨iam-apiserveræœåŠ¡åï¼Œæ‰§è¡Œ<code v-pre>systemctl status iam-apiserver</code> å‘ç°iam-apiserverå¯åŠ¨å¤±è´¥ï¼Œå³<code v-pre>Active</code>çš„å€¼ä¸ä¸º<code v-pre>active (running)</code>ã€‚</li>
<li>åŠŸèƒ½å¼‚å¸¸ï¼šè®¿é—®iam-apiserveræœåŠ¡ï¼ŒåŠŸèƒ½å¼‚å¸¸æˆ–è€…æŠ¥é”™ï¼Œä¾‹å¦‚æ¥å£è¿”å›å€¼è·Ÿé¢„æœŸä¸ä¸€æ ·ï¼›æ¥å£æŠ¥é”™ã€‚</li>
<li>æ—¥å¿—æŠ¥é”™ï¼šåœ¨iam-apiserverçš„æ—¥å¿—ä¸­å‘ç°ä¸€äº›<code v-pre>WARN</code>ã€<code v-pre>ERROR</code>ã€<code v-pre>PANIC</code>ã€<code v-pre>FATAL</code>ç­‰é«˜çº§åˆ«çš„é”™è¯¯æ—¥å¿—ã€‚</li>
</ul>
<p>å‘ç°é—®é¢˜ä¹‹åï¼Œä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹æ—¥å¿—ã€ä½¿ç”¨Goè°ƒè¯•å·¥å…·Delveå’Œæ·»åŠ Debugæ—¥å¿—è¿™ä¸‰ç§æ–¹å¼æ¥å®šä½é—®é¢˜ã€‚</p>
<ul>
<li>æŸ¥çœ‹æ—¥å¿—ï¼šæŸ¥çœ‹æ—¥å¿—æ˜¯æœ€ç®€å•çš„æ’éšœæ–¹å¼ã€‚</li>
<li>ä½¿ç”¨Goè°ƒè¯•å·¥å…·Delveæ¥å®šä½é—®é¢˜ã€‚</li>
<li>æ·»åŠ Debugæ—¥å¿—ï¼šä»ç¨‹åºå…¥å£å¤„è·Ÿè¯»ä»£ç ï¼Œåœ¨å…³é”®ä½ç½®å¤„æ‰“å°Debugæ—¥å¿—ï¼Œæ¥å®šä½é—®é¢˜ã€‚</li>
</ul>
<p>æ‰¾åˆ°é—®é¢˜æ ¹å› ä¹‹åï¼Œå°±è¦è§£å†³é—®é¢˜ã€‚ä½ éœ€è¦æ ¹æ®è‡ªå·±å¯¹ä¸šåŠ¡ã€åº•å±‚ä»£ç å®ç°çš„æŒæ¡å’Œç†è§£ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>æœ€åï¼Œæˆ‘å‘ä½ å±•ç¤ºäº†9ä¸ªåœ¨éƒ¨ç½²å’Œä½¿ç”¨IAMç³»ç»Ÿæ—¶å®¹æ˜“é‡åˆ°çš„é—®é¢˜ï¼Œå¹¶æä¾›äº†è§£å†³æ–¹æ³•ï¼Œå¸Œæœ›èƒ½ç»™ä½ ä¸€äº›åˆ‡å®çš„å¸®åŠ©ã€‚</p>
<h2 id="è¯¾åç»ƒä¹ " tabindex="-1"><a class="header-anchor" href="#è¯¾åç»ƒä¹ " aria-hidden="true">#</a> è¯¾åç»ƒä¹ </h2>
<ol>
<li>æ€è€ƒä¸‹ï¼Œå¦‚ä½•æŸ¥æ‰¾iam-apiserverçš„systemd Unitæ–‡ä»¶çš„è·¯å¾„ï¼Ÿ</li>
<li>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token assign-left variable">token</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">'Content-Type: application/json'</span> -d<span class="token string">'{"username":"admin","password":"Admin@2021"}'</span> http://127.0.0.1:8080/login <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> .token<span class="token variable">`</span></span>
$ <span class="token builtin class-name">echo</span> <span class="token variable">$token</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥è·å–<code v-pre>token</code>ï¼Œä½†å‘ç°<code v-pre>token</code>å€¼ä¸ºç©ºã€‚è¯·ç»™å‡ºä½ çš„æ’éšœæµç¨‹å’Œæ–¹æ³•ã€‚</p>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '45.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '47.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/projects/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


