<template><div><ul>
<li><a href="https://github.com/cubxxw/iam" target="_blank" rel="noopener noreferrer">ğŸ”¥ å¼€æºåœ°å€<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬13èŠ‚-ä»-0-ç¼–å†™ä¸€ä¸ªæ—¥å¿—åŒ…" tabindex="-1"><a class="header-anchor" href="#ç¬¬13èŠ‚-ä»-0-ç¼–å†™ä¸€ä¸ªæ—¥å¿—åŒ…" aria-hidden="true">#</a> ç¬¬13èŠ‚  ä» 0 ç¼–å†™ä¸€ä¸ªæ—¥å¿—åŒ…</h1>
<br>
<div><a href = '12.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '14.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<nav class="table-of-contents"><ul><li><router-link to="#ä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…">ä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…</router-link></li><li><router-link to="#æ ‡å‡†åº“logåŒ…ä½¿ç”¨">æ ‡å‡†åº“logåŒ…ä½¿ç”¨</router-link></li><li><router-link to="#glog">glog</router-link></li><li><router-link to="#logrusä»‹ç»">logrusä»‹ç»</router-link></li><li><router-link to="#zapåŒ…ä»‹ç»">zapåŒ…ä»‹ç»</router-link><ul><li><router-link to="#zapä½¿ç”¨æ–¹æ³•">zapä½¿ç”¨æ–¹æ³•</router-link></li></ul></li><li><router-link to="#å…¶å®ƒå¼€æºåŒ…">å…¶å®ƒå¼€æºåŒ…</router-link></li><li><router-link to="#å¼€æºæ—¥å¿—åŒ…é€‰æ‹©">å¼€æºæ—¥å¿—åŒ…é€‰æ‹©</router-link></li><li><router-link to="#ä»0ç¼–å†™ä¸€ä¸ªæ—¥å¿—åŒ…">ä»0ç¼–å†™ä¸€ä¸ªæ—¥å¿—åŒ…</router-link><ul><li><router-link to="#å®šä¹‰æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—é€‰é¡¹">å®šä¹‰æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—é€‰é¡¹</router-link></li><li><router-link to="#åˆ›å»ºloggeråŠå„çº§åˆ«æ—¥å¿—æ‰“å°æ–¹æ³•">åˆ›å»ºLoggeråŠå„çº§åˆ«æ—¥å¿—æ‰“å°æ–¹æ³•</router-link></li><li><router-link to="#å°†æ—¥å¿—è¾“å‡ºåˆ°æ”¯æŒçš„è¾“å‡ºä¸­">å°†æ—¥å¿—è¾“å‡ºåˆ°æ”¯æŒçš„è¾“å‡ºä¸­</router-link></li><li><router-link to="#è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼">è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼</router-link></li><li><router-link to="#æµ‹è¯•æ—¥å¿—åŒ…">æµ‹è¯•æ—¥å¿—åŒ…</router-link></li><li><router-link to="#iamé¡¹ç›®æ—¥å¿—åŒ…è®¾è®¡">IAMé¡¹ç›®æ—¥å¿—åŒ…è®¾è®¡</router-link></li><li><router-link to="#æ€»ç»“">æ€»ç»“</router-link></li><li><router-link to="#è¯¾åç»ƒä¹ ">è¯¾åç»ƒä¹ </router-link></li></ul></li><li><router-link to="#end-é“¾æ¥">END é“¾æ¥</router-link></li></ul></nav>
<p>[TOC]</p>
<h2 id="ä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…" tabindex="-1"><a class="header-anchor" href="#ä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…" aria-hidden="true">#</a> ä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…</h2>
<p>åœ¨åšé¡¹ç›®å¼€å‘æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä»0ç¼–å†™è‡ªå·±çš„æ—¥å¿—åŒ…ã€ä¹Ÿå¯ä»¥ä½¿ç”¨Goè¯­è¨€æ ‡å‡†åº“çš„logåŒ…ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å¼€æºçš„æ—¥å¿—åŒ…ï¼Œä½†æ›´å¤šçš„æ˜¯åŸºäºä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæ¥å®ç°å®šåˆ¶åŒ–çš„æ—¥å¿—åŠŸèƒ½ã€‚Goç”Ÿæ€ä¸­ä¹Ÿæœ‰ä¸€äº›éå¸¸ä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…ï¼Œä¾‹å¦‚æ ‡å‡†åº“logåŒ…ã€glogã€logrusã€zapã€seelogã€zerologç­‰ã€‚ç”¨çš„æ¯”è¾ƒå¤šçš„æ˜¯<code v-pre>glog</code>ã€<code v-pre>logrus</code>å’Œ<code v-pre>zap</code>ã€‚</p>
<h2 id="æ ‡å‡†åº“logåŒ…ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#æ ‡å‡†åº“logåŒ…ä½¿ç”¨" aria-hidden="true">#</a> æ ‡å‡†åº“logåŒ…ä½¿ç”¨</h2>
<p>æ ‡å‡†åº“logåŒ…åŠŸèƒ½éå¸¸ç®€å•ï¼Œæä¾›äº†å¼€ç®±ï¼Œä»…æä¾›äº†Printã€Panicå’ŒFatalä¸‰ç±»å‡½æ•°ç”¨äºæ—¥å¿—è¾“å‡ºã€‚å› ä¸ºæ˜¯æ ‡å‡†åº“è‡ªå¸¦çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦æˆ‘ä»¬ä¸‹è½½å®‰è£…ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚æ ‡å‡†åº“logåŒ…åªæœ‰ä¸åˆ°400è¡Œçš„ä»£ç é‡ï¼Œå¦‚æœè¯»è€…æƒ³ç ”ç©¶å¦‚ä½•å®ç°ä¸€ä¸ªæ—¥å¿—åŒ…ï¼Œé˜…è¯»æ ‡å‡†åº“logåŒ…æ˜¯ä¸€ä¸ªä¸é”™çš„å¼€å§‹ã€‚Goçš„æ ‡å‡†åº“å¤§é‡ä½¿ç”¨äº†logåŒ…ï¼Œä¾‹å¦‚ï¼š<code v-pre>net/httpã€net/rpc</code>ç­‰ã€‚</p>
<p><strong>logåŒ…ä½¿ç”¨</strong></p>
<p>åœ¨ä½¿ç”¨logåŒ…æ—¶ï¼Œéœ€è¦é¦–å…ˆåˆ›å»ºä¸€ä¸ª<code v-pre>*log. Logger</code>ç±»å‹çš„logå®ä¾‹ï¼Œæ‰€æœ‰çš„æ—¥å¿—è¾“å‡ºéƒ½æ˜¯é€šè¿‡è¯¥å®ä¾‹æä¾›çš„æ–¹æ³•æ¥å®Œæˆçš„ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨logåŒ…æä¾›çš„å…¨å±€å…¨å±€å˜é‡<code v-pre>std</code>ï¼Œ<code v-pre>std</code>å®šä¹‰å¦‚ä¸‹ï¼ˆä½äºGoæ ‡å‡†åŒ…logç›®å½•ä¸‹çš„log.goæ–‡ä»¶ä¸­ï¼‰ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">var</span> std <span class="token operator">=</span> <span class="token function">New</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> LstdFlags<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¹Ÿä¹Ÿå¯ä»¥ä½¿ç”¨<code v-pre>log.Newå‡½</code>æ•°åˆ›å»ºè‡ªå·±çš„loggerï¼Œåœ¨åˆ›å»ºæ—¶ï¼Œå¯ä»¥æŒ‡å®šè¾“å‡ºçš„ä½ç½®ã€æ¯è¡Œæ—¥å¿—çš„å‰ç¼€å’Œæ—¥å¿—å±æ€§ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>logger := log.New(logFile, "[Debug]", log.Lshortfile)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æœ‰å¦‚ä¸‹å‡ ç§æ—¥å¿—å±æ€§å¯ä¾›é€‰æ‹©ï¼š</p>
<ul>
<li>Ldateï¼šå½“å‰æ—¶åŒºçš„æ—¥æœŸï¼Œæ ¼å¼æ˜¯ï¼š2009/01/23ã€‚</li>
<li>Ltimeï¼šå½“å‰æ—¶åŒºçš„æ—¶é—´ï¼Œæ ¼å¼æ˜¯ï¼š01:23:23ï¼Œç²¾ç¡®åˆ°ç§’ã€‚</li>
<li>Lmicrosecondsï¼šå½“å‰æ—¶åŒºçš„æ—¶é—´ï¼Œæ ¼å¼æ˜¯ï¼š01:23:23.862600ï¼Œç²¾ç¡®åˆ°å¾®å¦™ã€‚</li>
<li>Llongfileï¼šå…¨æ–‡ä»¶åå’Œè¡Œå·ã€‚</li>
<li>Lshortfileï¼šå½“å‰æ–‡ä»¶åå’Œè¡Œå·ï¼Œä¼šè¦†ç›–Llongfileã€‚</li>
<li>LUTCï¼šä½¿ç”¨UTCè€Œéæœ¬åœ°æ—¶åŒºã€‚</li>
<li>Lmsgprefixï¼šå°†â€œå‰ç¼€â€ä»è¡Œçš„å¼€å¤´ç§»è‡³æ¶ˆæ¯ä¹‹å‰ã€‚</li>
<li>LstdFlagsï¼šæ ‡å‡†Loggerçš„é»˜è®¤å€¼ï¼ˆLdateã€Ltimeï¼‰ã€‚</li>
</ul>
<p>é™¤äº†åœ¨æ‰§è¡Œlog.Newæ—¶é…ç½®log.Loggerä¹‹å¤–ï¼Œåˆ›å»ºä¹‹åè¿˜å¯ä»¥é€šè¿‡log.Loggeræä¾›çš„3ç§æ–¹æ³•æ¥æ”¹å˜log.Loggerçš„é…ç½®ï¼š</p>
<ul>
<li>SetOutputï¼šæŒ‡å®šè¾“å‡ºçš„ä½ç½®ã€‚</li>
<li>SetPrefixï¼šè®¾ç½®æ¯è¡Œæ—¥å¿—çš„å‰ç¼€ã€‚</li>
<li>SetFlagsï¼šè®¾ç½®æ—¥å¿—å±æ€§ã€‚</li>
</ul>
<p>log.Loggeræä¾›äº†Printã€Panicã€Fatalå‡½æ•°æ¥è®°å½•æ—¥å¿—ï¼š</p>
<ul>
<li>Printï¼šæ‰“å°æ—¥å¿—ï¼Œä¾‹å¦‚ï¼šlog.Print(&quot;call Print: line1&quot;)</li>
<li>Panicï¼šæ‰“å°æ—¥å¿—åæ‰§è¡Œpanic(s)ï¼Œsä¸ºæ—¥å¿—å†…å®¹ã€‚</li>
<li>Fatalï¼šæ‰“å°æ—¥å¿—åæ‰§è¡Œos.Exit(1)ã€‚</li>
</ul>
<p>Printã€Panicã€Fatalå‡½æ•°è¿˜æä¾›Printlnã€Printfã€Paniclnã€Panicfã€Fatallnã€Fatalfæ¥æ ¼å¼åŒ–æ‰“å°æ—¥å¿—ã€‚Printåº•å±‚è°ƒç”¨<code v-pre>fmt.Sprint(v...)</code>ï¼ŒPrintlnåº•å±‚è°ƒç”¨<code v-pre>fmt.Sprintln(v...)</code>ï¼ŒPrintfåº•å±‚è°ƒç”¨äº†<code v-pre>fmt.Sprintf(format, v...)</code>ã€‚</p>
<p>æ ‡å‡†åº“logçš„ä½¿ç”¨ç¤ºä¾‹ï¼ˆmain.goæ–‡ä»¶ï¼‰ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>package main

import (
    "log"
    "os"
)

func main() {
    // è¾“å‡ºåˆ°æ–‡ä»¶
    logFile, err := os.Create("./log.log")
    defer logFile.Close()
    if err != nil {
        log.Fatalln("create file log.log failed")
    }
    logger := log.New(logFile, "[Debug] ", log.Lshortfile)
    logger.SetOutput(os.Stdout)
    logger.Print("call Print: line1")
    logger.Println("call Println: line2")

    // ä¿®æ”¹æ—¥å¿—é…ç½®
    logger.SetPrefix("[Info] ")
    logger.SetFlags(log.Ldate)
    logger.SetOutput(os.Stdout)
    logger.Print("Info check stdout")
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ‰§è¡Œä¸Šè¿°ç¨‹åºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>$ go run main.go
[Debug] main.go:17: call Print: line1
[Debug] main.go:18: call Println: line2
[Info] 2020/11/28 Info check stdout
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="glog" tabindex="-1"><a class="header-anchor" href="#glog" aria-hidden="true">#</a> glog</h2>
<p><a href="https://github.com/golang/glog" target="_blank" rel="noopener noreferrer">glog<ExternalLinkIcon/></a>æ˜¯Googleæ¨å‡ºçš„æ—¥å¿—åŒ…ï¼Œè·Ÿæ ‡å‡†åº“logåŒ…ä¸€æ ·ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§çš„æ—¥å¿—åŒ…ï¼Œä½¿ç”¨ç®€å•æ–¹ä¾¿ï¼Œä½†è¦æ¯”æ ‡å‡†åº“logåŒ…æä¾›æ›´å¤šçš„åŠŸèƒ½ï¼Œglogå…·æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>æ”¯æŒ4ç§æ—¥å¿—çº§åˆ«ï¼šINFOã€WARNINGã€ERRORã€FATALã€‚</li>
<li>æ”¯æŒå‘½ä»¤è¡Œé€‰é¡¹ï¼Œä¾‹å¦‚ï¼š<code v-pre>-alsologtostderr</code>ã€<code v-pre>-log_backtrace_at</code>ã€<code v-pre>-log_dir</code>ã€<code v-pre>-logtostderr</code>ã€<code v-pre>-v</code>ç­‰ï¼Œæ¯ä¸ªå‚æ•°å®ç°æŸç§åŠŸèƒ½ã€‚</li>
<li>æ”¯æŒæ ¹æ®æ–‡ä»¶å¤§å°åˆ‡å‰²æ—¥å¿—æ–‡ä»¶ã€‚</li>
<li>æ”¯æŒæ—¥å¿—æŒ‰çº§åˆ«åˆ†ç±»è¾“å‡ºã€‚</li>
<li>æ”¯æŒV levelï¼ŒV levelç‰¹æ€§å¯ä»¥ä½¿å¼€å‘è€…è‡ªå®šä¹‰æ—¥å¿—çº§åˆ«ã€‚</li>
<li>æ”¯æŒvmoduleï¼Œvmoduleå¯ä»¥ä½¿å¼€å‘è€…å¯¹ä¸åŒçš„æ–‡ä»¶ä½¿ç”¨ä¸åŒçš„æ—¥å¿—çº§åˆ«ã€‚</li>
<li>æ”¯æŒtraceLocationï¼ŒtraceLocationå¯ä»¥æ‰“å°å‡ºæŒ‡å®šä½ç½®çš„æ ˆä¿¡æ¯ã€‚</li>
</ul>
<p>kubernetesé¡¹ç›®å°±ä½¿ç”¨äº†åŸºäºglogå°è£…çš„klogä½œä¸ºå…¶æ—¥å¿—åº“ã€‚</p>
<p><strong>glogä½¿ç”¨æ–¹æ³•</strong></p>
<p>glogä½¿ç”¨éå¸¸ç®€å•ï¼Œå¸¸è§çš„ç”¨æ³•å¦‚ä¸‹ã€‚</p>
<ol>
<li>åŸºæœ¬ç”¨æ³•</li>
</ol>
<p>glogçš„æœ€å¸¸ç”¨çš„ä½¿ç”¨æ–¹æ³•ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>package main

import (
    "flag"

    "github.com/golang/glog"
)

func main() {
    glog.MaxSize = 1024 * 1024 * 1024 // 1Gè‡ªåŠ¨åˆ†å‰²
    flag.Parse()
    defer glog.Flush()

    glog.Info("This is info message")
    glog.Infof("This is info message: %v", 123)

    glog.Warning("This is warning message")
    glog.Warningf("This is warning message: %v", 123)

    glog.Error("This is error message")
    glog.Errorf("This is error message: %v", 123)

    //glog.Fatal("This is fatal message")
    //glog.Fatalf("This is fatal message: %v", 123)
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>glogæ”¯æŒ4ç§æ—¥å¿—çº§åˆ«ï¼Œä»ä½åˆ°é«˜ä¾æ¬¡ä¸ºï¼šINFOã€WARNINGã€ERRORã€FATALã€‚glogæ”¯æŒå‘½ä»¤è¡Œå‚æ•°ï¼Œåœ¨ç¨‹åºä¸­ï¼Œåªéœ€è¦åœ¨ä½¿ç”¨glogä¹‹å‰è°ƒç”¨flag.Parse()å³å¯ï¼Œæ”¯æŒå¦‚ä¸‹7ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼š</p>
<ul>
<li><code v-pre>-alsologtostderr</code>ï¼šåŒæ—¶å°†æ—¥å¿—æ‰“å°åˆ°æ–‡ä»¶å’Œæ ‡å‡†é”™è¯¯è¾“å‡ºã€‚</li>
<li><code v-pre>-log_backtrace_at value</code>ï¼šæŒ‡å®šä»£ç è¿è¡Œåˆ°æŒ‡å®šè¡Œæ—¶ï¼ŒæŠŠè¯¥ä»£ç çš„æ ˆä¿¡æ¯æ‰“å°å‡ºæ¥ã€‚</li>
<li><code v-pre>-log_dir</code>ï¼šæŒ‡å®šæ—¥å¿—å­˜å‚¨çš„æ–‡ä»¶å¤¹ã€‚</li>
<li><code v-pre>-logtostderr</code>ï¼šæ—¥å¿—æ‰“å°åˆ°æ ‡å‡†é”™è¯¯è¾“å‡ºï¼Œè€Œä¸æ˜¯æ–‡ä»¶ä¸­ã€‚</li>
<li><code v-pre>-stderrthreshold value</code>ï¼šæŒ‡å®šå¤§äºæˆ–è€…ç­‰äºè¯¥çº§åˆ«çš„æ—¥å¿—æ‰ä¼šè¢«è¾“å‡ºåˆ°æ ‡å‡†é”™è¯¯è¾“å‡ºï¼Œé»˜è®¤ä¸ºERRORã€‚</li>
<li><code v-pre>-v value</code>ï¼šæŒ‡å®šæ—¥å¿—çº§åˆ«ã€‚</li>
<li><code v-pre>-vmodule value</code>ï¼šå¯¹ä¸åŒçš„æ–‡ä»¶ä½¿ç”¨ä¸åŒçš„æ—¥å¿—çº§åˆ«ã€‚</li>
</ul>
<p>æ‰§è¡Œä¸Šè¿°ä»£ç ï¼ˆå‡è®¾ä¿å­˜åœ¨example1.goæ–‡ä»¶ä¸­ï¼‰ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>$ mkdir -p log &amp;&amp; go run example1.go -log_dir=log -alsologtostderr
I1202 09:43:49.618480   26223 example1.go:14] This is info message
I1202 09:43:49.618781   26223 example1.go:15] This is info message: 123
W1202 09:43:49.618792   26223 example1.go:17] This is warning message
W1202 09:43:49.618830   26223 example1.go:18] This is warning message: 123
E1202 09:43:49.618840   26223 example1.go:20] This is error message
E1202 09:43:49.618877   26223 example1.go:21] This is error message: 123
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šå‘½ä»¤ä¼šåŒæ—¶å°†æ—¥å¿—æ‰“å°åœ¨logç›®å½•å’Œæ ‡å‡†é”™è¯¯è¾“å‡ºä¸­ï¼ˆ<code v-pre>-alsologtostderr</code>ï¼‰ï¼Œlogç›®å½•ä¸‹æ–‡ä»¶åˆ—è¡¨ä¸ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>main.colin.colin.log.ERROR.20201202-081133.24123
main.colin.colin.log.INFO.20201202-081133.24123
main.colin.colin.log.WARNING.20201202-081133.24123
main.ERROR -> main.colin.colin.log.ERROR.20201202-081133.24123
main.INFO -> main.colin.colin.log.INFO.20201202-081133.24123
main.WARNING -> main.colin.colin.log.WARNING.20201202-081133.24123
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>main.INFOæ–‡ä»¶æ˜¯ä¸€ä¸ªè½¯é“¾æ¥ï¼Œé“¾æ¥åˆ°æœ€æ–°çš„INFOçº§åˆ«çš„æ—¥å¿—æ–‡ä»¶ï¼Œä½ä¼˜å…ˆçº§çš„æ—¥å¿—æ–‡ä»¶åŒ…å«é«˜ä¼˜å…ˆçº§çš„æ—¥å¿—ï¼Œä¾‹å¦‚INFOçº§åˆ«çš„æ—¥å¿—æ–‡ä»¶ä¸­åŒ…å«WARNINGã€ERRORã€FATALçº§åˆ«çš„æ—¥å¿—ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å•ä¸ªæ—¥å¿—æ–‡ä»¶è¾¾åˆ°1.8Gæ—¶,ï¼Œglogä¼šå¯¹æ—¥å¿—æ–‡ä»¶è¿›è¡Œè½¬å­˜ï¼šå…³é—­å½“å‰çš„æ–‡ä»¶ï¼Œæ–°å»ºæ—¥å¿—æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡glog.MaxSizeè®¾ç½®è½¬å­˜é˜ˆå€¼ã€‚</p>
<p>ä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥å‘ç°ï¼Œglogçš„æ—¥å¿—è¾“å‡ºæ ¼å¼ä¸ºï¼š<code v-pre>&lt;header&gt;] &lt;message&gt;</code>ï¼Œå…¶ä¸­headerçš„æ ¼å¼ä¸ºï¼š<code v-pre>Lmmdd hh:mm:ss.uuuuuu threadid file:line</code>ï¼š</p>
<ul>
<li>Lmmddï¼šLä»£è¡¨äº†glogçš„æ—¥å¿—çº§åˆ«ï¼šI -&gt; INFOã€W -&gt; WARNINGã€E -&gt; ERRORã€F -&gt; FATALã€‚</li>
<li>hh:mm:ss.uuuuuuï¼šä»£è¡¨äº†æ—¶é—´ä¿¡æ¯ï¼Œä¾‹å¦‚10:12:32.995956ã€‚</li>
<li>threadidï¼Œæ˜¯è¿›ç¨‹PIDï¼Œå³os.Getpid()çš„è¿”å›å€¼ã€‚</li>
<li>file:lineï¼šæŒ‡æ˜äº†æ‰“å°æ—¥å¿—çš„ä½ç½®ï¼šæ–‡ä»¶åå’Œè¡Œå·ã€‚</li>
</ul>
<p>ä½¿ç”¨glog.Infoã€glog.Warningç­‰å‡½æ•°è®°å½•æ—¥å¿—åï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œè¿™äº›æ—¥å¿—ä¼šæš‚å­˜åœ¨å†…å­˜çš„bufferä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥å†™å…¥æ–‡ä»¶ä¸­ï¼Œåªæœ‰æ˜¾å¼çš„è°ƒç”¨glog.Flush()ï¼Œæ•°æ®æ‰ä¼šè¢«å†™å…¥æ–‡ä»¶ã€‚glogçš„initå‡½æ•°ä¸­å¯åŠ¨äº†ä¸€ä¸ªgoroutineæ¥å‘¨æœŸæ€§çš„è°ƒç”¨glog.Flush()ï¼Œé»˜è®¤çš„flushé—´éš”ä¸º30ç§’ã€‚å¦‚æœç¨‹åºé€€å‡ºï¼Œè‡ªä¸Šæ¬¡glog.Flush()å‡½æ•°æ‰§è¡Œä¹‹åäº§ç”Ÿçš„æ—¥å¿—ï¼Œå°±ä¼šè¢«ä¸¢å¤±ï¼Œæ‰€ä»¥åœ¨ç¨‹åºé€€å‡ºæ—¶ï¼Œéœ€è¦è°ƒç”¨glog.Flush()å°†æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚</p>
<p>è¿™é‡Œè¦æ³¨æ„ï¼Œè°ƒç”¨glog.Fatalå‡½æ•°åï¼Œglogä¼šæ‰“å°æ—¥å¿—å¹¶é€€å‡ºç¨‹åºï¼Œåœ¨ç¨‹åºé€€å‡ºå‰ï¼Œä¼šå°†ç¼“å­˜ä¸­çš„æ‰€æœ‰æ—¥å¿—éƒ½å†™å…¥æ—¥å¿—ï¼Œä½†æ˜¯å¯¹äºglog.Infoã€glog.Warningã€glog.Errorå‡½æ•°åˆ™ä¸ä¼šã€‚</p>
<ol>
<li>vmoduleåŠŸèƒ½</li>
</ol>
<p>glog æœ€å¸¸ç”¨çš„å°±æ˜¯ V level çš„åŠŸèƒ½ï¼ŒVè¶Šå°ï¼Œè¯´æ˜æ—¥å¿—çº§åˆ«è¶Šé«˜ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼šï¼ˆä¿å­˜åœ¨example2.goæ–‡ä»¶ä¸­ï¼‰ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>package main

import (
    "flag"

    "github.com/golang/glog"
)

func main() {
    flag.Parse()
    defer glog.Flush()

    glog.V(3).Info("LEVEL 3 message") // ä½¿ç”¨æ—¥å¿—çº§åˆ« 3
    glog.V(5).Info("LEVEL 5 message") // ä½¿ç”¨æ—¥å¿—çº§åˆ« 5
    glog.V(7).Info("LEVEL 7 message") // ä½¿ç”¨æ—¥å¿—çº§åˆ« 7
    glog.V(8).Info("LEVEL 8 message") // ä½¿ç”¨æ—¥å¿—çº§åˆ« 8
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œä¸Šè¿°ä»£ç ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>$ go run example2.go -log_dir=log -alsologtostderr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¸Šé¢çš„å‘½ä»¤ä¸ä¼šæœ‰ä»»ä½•è¾“å‡ºï¼Œå› ä¸ºæ—¥å¿—çº§åˆ«ä¸å¤Ÿï¼Œå¯ä»¥é€šè¿‡<code v-pre>-v</code>è®¾ç½®æ—¥å¿—çº§åˆ«ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>$ go run example2.go -log_dir=log -alsologtostderr -v=5
I1202 09:52:44.163989   29042 example2.go:13] LEVEL 3 message
I1202 09:52:44.164335   29042 example2.go:14] LEVEL 5 message
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤æ—¶ï¼Œæ—¥å¿—çº§åˆ«é«˜äºæˆ–è€…ç­‰äº5ï¼ˆVå€¼å°äºæˆ–è€…ç­‰äº5ï¼‰çš„æ—¥å¿—å°†è¢«æ‰“å°å‡ºæ¥ã€‚</p>
<p>glogè¿˜æ”¯æŒå¯¹ä¸åŒçš„æ–‡ä»¶ä½¿ç”¨ä¸åŒçš„æ—¥å¿—çº§åˆ«ï¼ˆ<code v-pre>-vmodule</code>ï¼‰ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>$ go run main.go foo.go -v=3 -log_dir=log -alsologtostderr -vmodule=foo=5
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>é€šè¿‡æŒ‡å®š<code v-pre>-vmodule=foo=5</code>å‚æ•°ï¼Œå¯ä»¥è®¾ç½®å¯¹foo.goæ–‡ä»¶ä½¿ç”¨5çº§åˆ«ï¼Œå¯¹å…¶å®ƒæ–‡ä»¶ä½¿ç”¨3çº§åˆ«ã€‚<code v-pre>-vmodule</code>çš„è¾“å…¥å‚æ•°çœå»äº†.goåç¼€ï¼Œè¯­æ³•æ ¼å¼ä¸ºï¼š<code v-pre>-vmodule=file1=2,file2=1,fs*=3</code>ã€‚</p>
<ol>
<li>traceLocationåŠŸèƒ½</li>
</ol>
<p>traceLocationå¯ä»¥æ‰“å°å‡ºæŒ‡å®šä½ç½®çš„æ ˆä¿¡æ¯ï¼ˆ<code v-pre>-log_backtrace_at=filename:line_number</code>ï¼‰ï¼Œä¾‹å¦‚æœ‰å¦‚ä¸‹ä»£ç ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"flag"</span>

    <span class="token string">"github.com/golang/glog"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    glog<span class="token punctuation">.</span>MaxSize <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token comment">// 1Gè‡ªåŠ¨åˆ†å‰²</span>
    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> glog<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    glog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"This is info message"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œä»¥ä¸Šä»£ç ï¼ˆä¿å­˜åœ¨example3.goæ–‡ä»¶ä¸­ï¼‰ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>$ go run example3.go -log_dir=log -alsologtostderr -log_backtrace_at=example3.go:13
I1202 10:12:41.304582    1340 example3.go:13] This is info message
goroutine 1 [running]:
... æ‰“å°backtraceï¼Œæ­¤å¤„çœç•¥ ...
I1202 10:12:41.304779    1340 example3.go:14] This is info message: 123
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="logrusä»‹ç»" tabindex="-1"><a class="header-anchor" href="#logrusä»‹ç»" aria-hidden="true">#</a> logrusä»‹ç»</h2>
<p><a href="https://github.com/sirupsen/logrus" target="_blank" rel="noopener noreferrer">logrus<ExternalLinkIcon/></a>æ˜¯ç›®å‰Githubä¸Šstaræ•°é‡æœ€å¤šçš„æ—¥å¿—åŒ…ï¼ŒåŠŸèƒ½å¼ºå¤§ã€æ€§èƒ½é«˜æ•ˆã€é«˜åº¦çµæ´»ï¼Œè¿˜æä¾›äº†è‡ªå®šä¹‰æ’ä»¶çš„åŠŸèƒ½ã€‚å¾ˆå¤šä¼˜ç§€çš„å¼€æºé¡¹ç›®ï¼Œä¾‹å¦‚ï¼š<code v-pre>docker</code>ã€<code v-pre>prometheus</code>ç­‰éƒ½ä½¿ç”¨äº†logrusã€‚logrusé™¤äº†å…·æœ‰æ—¥å¿—çš„åŸºæœ¬åŠŸèƒ½å¤–ï¼Œè¿˜å…·æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>æ”¯æŒå¸¸ç”¨çš„æ—¥å¿—çº§åˆ«ï¼Œlogrusæ”¯æŒå¦‚ä¸‹æ—¥å¿—çº§åˆ«ï¼šDebugã€Infoã€Warnã€Errorã€Fatalå’ŒPanicã€‚</li>
<li>å¯æ‰©å±•ï¼Œlogrusçš„hookæœºåˆ¶å…è®¸ä½¿ç”¨è€…é€šè¿‡hookçš„æ–¹å¼å°†æ—¥å¿—åˆ†å‘åˆ°ä»»æ„åœ°æ–¹ï¼Œä¾‹å¦‚ï¼šæœ¬åœ°æ–‡ä»¶ã€æ ‡å‡†è¾“å‡ºã€elasticsearchã€logstashã€kafkaç­‰ã€‚</li>
<li>æ”¯æŒè‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ï¼Œlogruså†…ç½®äº†2ç§æ ¼å¼ï¼šJSONFormatterå’ŒTextFormatterã€‚é™¤æ­¤ä¹‹å¤–ï¼Œlogruså…è®¸ä½¿ç”¨è€…é€šè¿‡å®ç°Formatteræ¥å£ï¼Œæ¥è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ã€‚</li>
<li>ç»“æ„åŒ–æ—¥å¿—è®°å½•ï¼Œlogrusçš„Fieldæœºåˆ¶å¯ä»¥å…è®¸ä½¿ç”¨è€…è‡ªå®šä¹‰æ—¥å¿—å­—æ®µï¼Œè€Œä¸æ˜¯é€šè¿‡å†—é•¿çš„æ¶ˆæ¯æ¥è®°å½•æ—¥å¿—ã€‚</li>
<li>é¢„è®¾æ—¥å¿—å­—æ®µï¼Œlogrusçš„Default Fieldsæœºåˆ¶å¯ä»¥ç»™ä¸€éƒ¨åˆ†æˆ–è€…å…¨éƒ¨æ—¥å¿—ç»Ÿä¸€æ·»åŠ å…±åŒçš„æ—¥å¿—å­—æ®µï¼Œä¾‹å¦‚ç»™æŸæ¬¡HTTPè¯·æ±‚çš„æ‰€æœ‰æ—¥å¿—æ·»åŠ X-Request-IDå­—æ®µã€‚</li>
<li>Fatal handlersï¼šlogruså…è®¸æ³¨å†Œä¸€ä¸ªæˆ–å¤šä¸ªhandlerï¼Œå½“å‘ç”Ÿfatalçº§åˆ«çš„æ—¥å¿—æ—¶è°ƒç”¨ã€‚å½“æˆ‘ä»¬çš„ç¨‹åºéœ€è¦ä¼˜é›…å…³é—­æ—¶ï¼Œè¯¥ç‰¹æ€§ä¼šéå¸¸æœ‰ç”¨ã€‚</li>
</ul>
<p>logrusä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ol>
<li>åŸºæœ¬ç”¨æ³•</li>
</ol>
<p>logruså¯ä»¥é€šè¿‡ç®€å•çš„é…ç½®ï¼Œæ¥å®šä¹‰è¾“å‡ºã€æ ¼å¼æˆ–è€…æ—¥å¿—çº§åˆ«ç­‰ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"os"</span>

    <span class="token string">"github.com/sirupsen/logrus"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// logrusè®¾ç½®</span>
    logrus<span class="token punctuation">.</span><span class="token function">SetFormatter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>logrus<span class="token punctuation">.</span>JSONFormatter<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    logrus<span class="token punctuation">.</span><span class="token function">SetOutput</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">)</span>
    logrus<span class="token punctuation">.</span><span class="token function">SetLevel</span><span class="token punctuation">(</span>logrus<span class="token punctuation">.</span>WarnLevel<span class="token punctuation">)</span>

    <span class="token comment">// logrusä½¿ç”¨</span>
    logrus<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Useful debugging information."</span><span class="token punctuation">)</span>
    logrus<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Something noteworthy happened!"</span><span class="token punctuation">)</span>
    logrus<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"You should probably take a look at this."</span><span class="token punctuation">)</span>
    logrus<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Something failed but I'm not quitting."</span><span class="token punctuation">)</span>

    logrus<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>logrus<span class="token punctuation">.</span>Fields<span class="token punctuation">{</span>
        <span class="token string">"animal"</span><span class="token punctuation">:</span> <span class="token string">"walrus"</span><span class="token punctuation">,</span>
        <span class="token string">"size"</span><span class="token punctuation">:</span>   <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"A group of walrus emerges from the ocean"</span><span class="token punctuation">)</span>

    logrus<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>logrus<span class="token punctuation">.</span>Fields<span class="token punctuation">{</span>
        <span class="token string">"omg"</span><span class="token punctuation">:</span>    <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string">"number"</span><span class="token punctuation">:</span> <span class="token number">122</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"The group's number increased tremendously!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥é€šè¿‡logrus.SetFormatterè®¾ç½®è¾“å‡ºçš„æ—¥å¿—æ ¼å¼ï¼Œlogrusè‡ªå¸¦æœ‰JSONFormatterå’ŒTextFormatterã€‚é€šè¿‡logrus.SetLevelæ¥è®¾ç½®æ—¥å¿—çº§åˆ«ï¼Œé€šè¿‡logrus.SetOutputè®¾ç½®æ—¥å¿—è¾“å‡ºç­‰ã€‚</p>
<p>å‡è®¾ä¸Šè¿°ä»£ç ä¿å­˜åœ¨example1.goæ–‡ä»¶ä¸­ï¼Œè¿è¡Œä»£ç ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>$ go run example1.go
{"level":"warning","msg":"You should probably take a look at this.","time":"2020-12-03T22:35:35+08:00"}
{"level":"error","msg":"Something failed but I'm not quitting.","time":"2020-12-03T22:35:35+08:00"}
{"level":"warning","msg":"The group's number increased tremendously!","number":122,"omg":true,"time":"2020-12-03T22:35:35+08:00"}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol>
<li>Default Fields</li>
</ol>
<p>é€šå¸¸ï¼Œåœ¨ä¸€ä¸ªåº”ç”¨ä¸­ã€æˆ–è€…åº”ç”¨çš„ä¸€éƒ¨åˆ†ä¸­ï¼Œå§‹ç»ˆé™„å¸¦ä¸€äº›å›ºå®šçš„è®°å½•å­—æ®µä¼šå¾ˆæœ‰å¸®åŠ©ã€‚æ¯”å¦‚åœ¨å¤„ç†ç”¨æˆ·HTTPè¯·æ±‚æ—¶ï¼Œä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„æ—¥å¿—éƒ½ä¼šæœ‰request_idã€‚ä¸ºäº†é¿å…æ¯æ¬¡è®°å½•æ—¥å¿—éƒ½è¦ä½¿ç”¨ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>logrus.WithFields(logrus.Fields{"request_idâ€", request_id})
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªlogrus.Entryå®ä¾‹ï¼Œä¸ºè¿™ä¸ªå®ä¾‹è®¾ç½®é»˜è®¤Fieldsï¼ŒæŠŠlogrus.Entryå®ä¾‹è®¾ç½®åˆ°è®°å½•å™¨Loggerï¼Œå†è®°å½•æ—¥å¿—æ—¶æ¯æ¬¡éƒ½ä¼šé™„å¸¦ä¸Šè¿™äº›é»˜è®¤çš„å­—æ®µã€‚</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>logger := log.WithFields(log.Fields{"request_id": request_id})
logger.Info("something happened on that request") // ä¹Ÿä¼šè®°å½•request_id
logger.Warn("something not great happened")
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol>
<li>Hookæ¥å£</li>
</ol>
<p>logruså…·æœ‰hookèƒ½åŠ›ï¼Œå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰ä¸€äº›æ—¥å¿—å¤„ç†é€»è¾‘ï¼Œå®ç°ä¸€ä¸ªhookåªéœ€è¦å®ç°å¦‚ä¸‹æ¥å£ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>// logrusåœ¨è®°å½•Levels()è¿”å›çš„æ—¥å¿—çº§åˆ«çš„æ¶ˆæ¯æ—¶ä¼šè§¦å‘HOOK,
// æŒ‰ç…§Fireæ–¹æ³•å®šä¹‰çš„å†…å®¹ä¿®æ”¹logrus.Entry.
type Hook interface {
    Levels() []Level
    Fire(*Entry) error
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸€ä¸ªç®€å•è‡ªå®šä¹‰hookå¦‚ä¸‹ï¼ŒDefaultFieldHookå®šä¹‰ä¼šåœ¨æ‰€æœ‰çº§åˆ«çš„æ—¥å¿—æ¶ˆæ¯ä¸­åŠ å…¥é»˜è®¤å­—æ®µ<code v-pre>myHook=&quot;MyHookTest&quot;</code>:</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>type DefaultFieldHook struct {
}

func (hook *DefaultFieldHook) Fire(entry *log.Entry) error {
    entry.Data["myHook"] = " MyHookTest "
    return nil
}

func (hook *DefaultFieldHook) Levels() []log.Level {
    return log.AllLevels
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°äº†hookä¹‹åï¼Œåªéœ€è¦è°ƒç”¨log.AddHook(hook)å³å¯å°†è‡ªå®šä¹‰çš„hookæ³¨å†Œåˆ°logrusä¸­ã€‚é€šè¿‡hookå¯ä»¥å®ç°å¾ˆå¤šå¼ºå¤§çš„æ—¥å¿—å¤„ç†åŠŸèƒ½ï¼Œæ¯”è¾ƒå¸¸è§çš„ç”¨æ³•æ˜¯ï¼Œå½“æœ‰æŒ‡å®šçº§åˆ«çš„æ—¥å¿—äº§ç”Ÿæ—¶ï¼Œé‚®ä»¶é€šçŸ¥æˆ–è€…å‘Šè­¦ç»™ç›¸å…³è´Ÿè´£äººã€‚</p>
<h2 id="zapåŒ…ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#zapåŒ…ä»‹ç»" aria-hidden="true">#</a> zapåŒ…ä»‹ç»</h2>
<p><a href="https://github.com/uber-go/zap" target="_blank" rel="noopener noreferrer">zap<ExternalLinkIcon/></a>æ˜¯uberå¼€æºçš„æ—¥å¿—åŒ…ï¼Œä»¥é«˜æ€§èƒ½è‘—ç§°ï¼Œå¾ˆå¤šå…¬å¸çš„æ—¥å¿—åŒ…éƒ½æ˜¯åŸºäºzapæ”¹é€ è€Œæ¥ã€‚zapé™¤äº†å…·æœ‰æ—¥å¿—åŸºæœ¬çš„åŠŸèƒ½ä¹‹å¤–ï¼Œè¿˜å…·æœ‰å¾ˆå¤šå¼ºå¤§çš„ç‰¹æ€§ï¼š</p>
<ul>
<li>æ”¯æŒå¸¸ç”¨çš„æ—¥å¿—çº§åˆ«ï¼Œä¾‹å¦‚ï¼šDebugã€Infoã€Warnã€Errorã€DPanicã€Panicã€Fatalã€‚</li>
<li>æ€§èƒ½éå¸¸é«˜ï¼Œzapå…·æœ‰éå¸¸é«˜çš„æ€§èƒ½ï¼Œé€‚åˆå¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ã€‚</li>
<li>åƒlogrusä¸€æ ·ï¼Œæ”¯æŒç»“æ„åŒ–çš„æ—¥å¿—è®°å½•ã€‚</li>
<li>æ”¯æŒé¢„è®¾æ—¥å¿—å­—æ®µã€‚</li>
<li>æ”¯æŒé’ˆå¯¹ç‰¹å®šçš„æ—¥å¿—çº§åˆ«ï¼Œè¾“å‡ºè°ƒç”¨å †æ ˆã€‚</li>
<li>æ”¯æŒhookã€‚</li>
</ul>
<h3 id="zapä½¿ç”¨æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#zapä½¿ç”¨æ–¹æ³•" aria-hidden="true">#</a> zapä½¿ç”¨æ–¹æ³•</h3>
<p><strong>åŸºæœ¬ç”¨æ³•ï¼š</strong></p>
<p>zapä½¿ç”¨æ–¹æ³•è·Ÿå…¶ä»–æ—¥å¿—åŒ…ä½¿ç”¨æ–¹æ³•æ¯”è¾ƒç±»ä¼¼ï¼Œå¦‚ä¸‹æ˜¯ä¸€ä¸ªå¸¸è§çš„ç”¨æ³•ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"time"</span>

    <span class="token string">"go.uber.org/zap"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zap<span class="token punctuation">.</span><span class="token function">NewProduction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> logger<span class="token punctuation">.</span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// flushes buffer, if any</span>
    url <span class="token operator">:=</span> <span class="token string">"http://marmotedu.com"</span>
    logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"failed to fetch URL"</span><span class="token punctuation">,</span>
        zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">,</span>
        zap<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"attempt"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        zap<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token string">"backoff"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    sugar <span class="token operator">:=</span> logger<span class="token punctuation">.</span><span class="token function">Sugar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    sugar<span class="token punctuation">.</span><span class="token function">Infow</span><span class="token punctuation">(</span><span class="token string">"failed to fetch URL"</span><span class="token punctuation">,</span>
        <span class="token string">"url"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span>
        <span class="token string">"attempt"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token string">"backoff"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    sugar<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Failed to fetch URL: %s"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°†ä¸Šè¿°ä»£ç ä¿å­˜åœ¨ <code v-pre>example1.go</code>æ–‡ä»¶ä¸­ï¼Œè¿è¡Œï¼š</p>
<div class="language-json ext-json line-numbers-mode"><pre v-pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">"level"</span><span class="token operator">:</span><span class="token string">"info"</span><span class="token punctuation">,</span><span class="token property">"ts"</span><span class="token operator">:</span><span class="token number">1607006503.3008754</span><span class="token punctuation">,</span><span class="token property">"caller"</span><span class="token operator">:</span><span class="token string">"zap/example1.go:13"</span><span class="token punctuation">,</span><span class="token property">"msg"</span><span class="token operator">:</span><span class="token string">"failed to fetch URL"</span><span class="token punctuation">,</span><span class="token property">"url"</span><span class="token operator">:</span><span class="token string">"http://marmotedu.com"</span><span class="token punctuation">,</span><span class="token property">"attempt"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">"backoff"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"level"</span><span class="token operator">:</span><span class="token string">"info"</span><span class="token punctuation">,</span><span class="token property">"ts"</span><span class="token operator">:</span><span class="token number">1607006503.3009226</span><span class="token punctuation">,</span><span class="token property">"caller"</span><span class="token operator">:</span><span class="token string">"zap/example1.go:20"</span><span class="token punctuation">,</span><span class="token property">"msg"</span><span class="token operator">:</span><span class="token string">"failed to fetch URL"</span><span class="token punctuation">,</span><span class="token property">"url"</span><span class="token operator">:</span><span class="token string">"http://marmotedu.com"</span><span class="token punctuation">,</span><span class="token property">"attempt"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">"backoff"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"level"</span><span class="token operator">:</span><span class="token string">"info"</span><span class="token punctuation">,</span><span class="token property">"ts"</span><span class="token operator">:</span><span class="token number">1607006503.300958</span><span class="token punctuation">,</span><span class="token property">"caller"</span><span class="token operator">:</span><span class="token string">"zap/example1.go:25"</span><span class="token punctuation">,</span><span class="token property">"msg"</span><span class="token operator">:</span><span class="token string">"Failed to fetch URL: http://marmotedu.com"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é»˜è®¤çš„æ—¥å¿—è¾“å‡ºæ ¼å¼ä¸ºJSONæ ¼å¼ï¼Œå¹¶è®°å½•äº†æ–‡ä»¶åå’Œè¡Œå·ã€‚</p>
<p>ä¸Šè¿°ä»£ç é€šè¿‡<code v-pre>zap.NewProduction()</code>åˆ›å»ºäº†ä¸€ä¸ªloggerï¼Œzapè¿˜æä¾›äº†<code v-pre>zap.NewExample()</code>ã€<code v-pre>zap.NewDevelopment()</code>æ¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªloggerï¼Œä¸åŒæ–¹æ³•åˆ›å»ºçš„loggerå…·æœ‰ä¸åŒçš„è®¾ç½®ï¼ŒExampleé€‚åˆç”¨åœ¨æµ‹è¯•ä»£ç ä¸­ï¼ŒDevelopmentåœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨ï¼ŒProductionç”¨åœ¨ç”Ÿäº§ç¯å¢ƒã€‚å¦‚æœæƒ³è‡ªå®šä¹‰loggerï¼Œå¯ä»¥è°ƒç”¨<code v-pre>zap.New()</code>æ–¹æ³•æ¥åˆ›å»ºã€‚loggeræä¾›äº†Debugã€Infoã€Warnã€Errorã€Panicã€Fatalç­‰æ–¹æ³•ï¼Œç”¨æ¥è®°å½•ä¸åŒçº§åˆ«çš„æ—¥å¿—ã€‚åœ¨ç¨‹åºé€€å‡ºæ—¶ï¼Œæ³¨æ„è¦è°ƒç”¨<code v-pre>defer logger.Sync()</code>å°†ç¼“å­˜ä¸­çš„æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚</p>
<p><strong>å½“æˆ‘ä»¬å¯¹æ—¥å¿—çš„æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨Loggerè€ŒéSugaredLoggerï¼ŒLoggeræ€§èƒ½æ›´å¥½ï¼Œå†…å­˜åˆ†é…æ¬¡æ•°æ›´å°‘ã€‚</strong> ä¸ºäº†æé«˜æ€§èƒ½ï¼ŒLoggeræ²¡æœ‰ä½¿ç”¨<code v-pre>interface</code>å’Œåå°„ï¼Œå¹¶ä¸”Loggeråªæ”¯æŒç»“æ„åŒ–çš„æ—¥å¿—ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨Loggeræ—¶ï¼Œéœ€è¦æŒ‡å®šå…·ä½“çš„ç±»å‹å’Œkey-valueæ ¼å¼çš„æ—¥å¿—å­—æ®µï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"failed to fetch URL"</span><span class="token punctuation">,</span>
    zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">,</span>
    zap<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"attempt"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    zap<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token string">"backoff"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœè§‰å¾—Loggerçš„æ—¥å¿—æ ¼å¼æ¯”è¾ƒç¹çï¼Œå¯ä»¥ä½¿ç”¨æ›´åŠ ä¾¿æ·çš„<code v-pre>SugaredLogger</code>ï¼Œè°ƒç”¨<code v-pre>logger.Sugar()</code>å³å¯åˆ›å»º<code v-pre>SugaredLogger</code>ã€‚<code v-pre>SugaredLogger</code>çš„ä½¿ç”¨æ¯”<code v-pre>Logger</code>ç®€å•ï¼Œä½†æ€§èƒ½æ¯”Loggerä½ 50% å·¦å³ï¼Œå¯ä»¥ç”¨åœ¨è°ƒç”¨æ¬¡æ•°ä¸é«˜çš„å‡½æ•°ä¸­ï¼Œè°ƒç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>sugar <span class="token operator">:=</span> logger<span class="token punctuation">.</span><span class="token function">Sugar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    sugar<span class="token punctuation">.</span><span class="token function">Infow</span><span class="token punctuation">(</span><span class="token string">"failed to fetch URL"</span><span class="token punctuation">,</span>
    <span class="token string">"url"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span>
    <span class="token string">"attempt"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token string">"backoff"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
sugar<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Failed to fetch URL: %s"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®šåˆ¶Logger</strong></p>
<p>å¯ä»¥ä½¿ç”¨<code v-pre>NexExample()/NewDevelopment()/NewProduction()</code>å‡½æ•°åˆ›å»ºé»˜è®¤çš„Loggerï¼Œæ¯ç§æ–¹æ³•åˆ›å»ºçš„Loggeré…ç½®ä¸ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªå®šåˆ¶åŒ–çš„Loggerï¼Œåˆ›å»ºæ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"encoding/json"</span>

    <span class="token string">"go.uber.org/zap"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rawJSON <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`{
    "level":"debug",
    "encoding":"json",
    "outputPaths": ["stdout", "test.log"],
    "errorOutputPaths": ["stderr"],
    "initialFields":{"name":"dj"},
    "encoderConfig": {
      "messageKey": "message",
      "levelKey": "level",
      "levelEncoder": "lowercase"
    }
  }`</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> cfg zap<span class="token punctuation">.</span>Config
    <span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>rawJSON<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    logger<span class="token punctuation">,</span> err <span class="token operator">:=</span> cfg<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> logger<span class="token punctuation">.</span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"server start work successfully!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šç¤ºä¾‹è°ƒç”¨zap.Configçš„Buildæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºå’Œæ–‡ä»¶test.logçš„Loggerï¼Œå°†ä¸Šè¿°ä»£ç ä¿å­˜åœ¨<code v-pre>example2.go</code>æ–‡ä»¶ä¸­ï¼Œè¿è¡Œï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ go run example2.go
<span class="token punctuation">{</span><span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"info"</span>,<span class="token string">"message"</span><span class="token builtin class-name">:</span><span class="token string">"server start work successfully!"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"dj"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>zap.Configå®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Level AtomicLevel
    Development <span class="token builtin">bool</span>
    DisableCaller <span class="token builtin">bool</span>
    DisableStacktrace <span class="token builtin">bool</span>
    Sampling <span class="token operator">*</span>SamplingConfig
    Encoding <span class="token builtin">string</span>
    EncoderConfig zapcore<span class="token punctuation">.</span>EncoderConfig
    OutputPaths <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    ErrorOutputPaths <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    InitialFields <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Configç»“æ„ä½“ï¼Œå„å­—æ®µè¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li>Levelï¼šæ—¥å¿—çº§åˆ«ã€‚</li>
<li>Developmentï¼šè®¾ç½®Loggerçš„æ¨¡å¼ä¸ºdevelopmentæ¨¡å¼ã€‚</li>
<li>DisableCallerï¼šç¦ç”¨è°ƒç”¨ä¿¡æ¯. è¯¥å­—æ®µå€¼ä¸º true æ—¶, æ—¥å¿—ä¸­å°†ä¸å†æ˜¾ç¤ºè¯¥æ—¥å¿—æ‰€åœ¨çš„å‡½æ•°è°ƒç”¨ä¿¡æ¯ã€‚</li>
<li>DisableStacktraceï¼šç¦ç”¨è‡ªåŠ¨å †æ ˆè·Ÿè¸ªæ•è·ã€‚</li>
<li>Samplingï¼šæµæ§é…ç½®, ä¹Ÿå«é‡‡æ ·. å•ä½æ˜¯æ¯ç§’é’Ÿ, ä½œç”¨æ˜¯é™åˆ¶æ—¥å¿—åœ¨æ¯ç§’é’Ÿå†…çš„è¾“å‡ºæ•°é‡, ä»¥é˜²æ­¢CPUå’ŒIOè¢«è¿‡åº¦å ç”¨ã€‚</li>
<li>Encodingï¼šæŒ‡å®šæ—¥å¿—ç¼–ç å™¨, ç›®å‰ä»…æ”¯æŒä¸¤ç§ç¼–ç å™¨ï¼šconsoleå’Œjsonï¼Œé»˜è®¤ä¸ºjsonã€‚</li>
<li>EncoderConfigï¼šç¼–ç é…ç½®ã€‚</li>
<li>OutputPathsï¼šé…ç½®æ—¥å¿—æ ‡å‡†è¾“å‡ºï¼Œå¯ä»¥é…ç½®å¤šä¸ªæ—¥å¿—è¾“å‡ºè·¯å¾„, ä¸€èˆ¬æƒ…å†µå¯ä»¥ä»…é…ç½®æ ‡å‡†è¾“å‡ºæˆ–è¾“å‡ºåˆ°æ–‡ä»¶, å¦‚æœ‰éœ€æ±‚çš„è¯, ä¹Ÿå¯ä»¥ä¸¤è€…åŒæ—¶é…ç½®ã€‚</li>
<li>ErrorOutputPathsï¼šé”™è¯¯è¾“å‡ºè·¯å¾„ï¼Œå¯ä»¥æ˜¯å¤šä¸ªã€‚</li>
<li>InitialFieldsï¼šåˆå§‹åŒ–å­—æ®µé…ç½®, è¯¥é…ç½®çš„å­—æ®µä¼šä»¥ç»“æ„åŒ–çš„å½¢å¼æ‰“å°åœ¨æ¯æ¡æ—¥å¿—è¾“å‡ºä¸­ã€‚</li>
</ul>
<p>è°ƒç”¨zap.Configçš„Build()æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨zap.Configé…ç½®åˆ›å»ºä¸€ä¸ªLoggerã€‚</p>
<p>å…¶ä¸­EncoderConfigä¸ºç¼–ç é…ç½®ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> EncoderConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    MessageKey    <span class="token builtin">string</span> <span class="token string">`json:"messageKey" yaml:"messageKey"`</span>
    LevelKey      <span class="token builtin">string</span> <span class="token string">`json:"levelKey" yaml:"levelKey"`</span>
    TimeKey       <span class="token builtin">string</span> <span class="token string">`json:"timeKey" yaml:"timeKey"`</span>
    NameKey       <span class="token builtin">string</span> <span class="token string">`json:"nameKey" yaml:"nameKey"`</span>
    CallerKey     <span class="token builtin">string</span> <span class="token string">`json:"callerKey" yaml:"callerKey"`</span>
    FunctionKey   <span class="token builtin">string</span> <span class="token string">`json:"functionKey" yaml:"functionKey"`</span>
    StacktraceKey <span class="token builtin">string</span> <span class="token string">`json:"stacktraceKey" yaml:"stacktraceKey"`</span>
    LineEnding    <span class="token builtin">string</span> <span class="token string">`json:"lineEnding" yaml:"lineEnding"`</span>
    EncodeLevel    LevelEncoder    <span class="token string">`json:"levelEncoder" yaml:"levelEncoder"`</span>
    EncodeTime     TimeEncoder     <span class="token string">`json:"timeEncoder" yaml:"timeEncoder"`</span>
    EncodeDuration DurationEncoder <span class="token string">`json:"durationEncoder" yaml:"durationEncoder"`</span>
    EncodeCaller   CallerEncoder   <span class="token string">`json:"callerEncoder" yaml:"callerEncoder"`</span>
    EncodeName NameEncoder <span class="token string">`json:"nameEncoder" yaml:"nameEncoder"`</span>
    ConsoleSeparator <span class="token builtin">string</span> <span class="token string">`json:"consoleSeparator" yaml:"consoleSeparator"`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¸¸ç”¨çš„è®¾ç½®å¦‚ä¸‹ï¼š</p>
<ul>
<li>MessageKeyï¼šæ—¥å¿—ä¸­ä¿¡æ¯çš„é”®åï¼Œé»˜è®¤ä¸ºmsgã€‚</li>
<li>LevelKeyï¼šæ—¥å¿—ä¸­çº§åˆ«çš„é”®åï¼Œé»˜è®¤ä¸ºlevelã€‚</li>
<li>EncodeLevelï¼šæ—¥å¿—ä¸­çº§åˆ«çš„æ ¼å¼ï¼Œé»˜è®¤ä¸ºå°å†™ï¼Œå¦‚debug/infoã€‚</li>
</ul>
<ol>
<li>é€‰é¡¹</li>
</ol>
<p>zapæ”¯æŒå¤šç§é€‰é¡¹ï¼Œé€‰é¡¹çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"go.uber.org/zap"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zap<span class="token punctuation">.</span><span class="token function">NewProduction</span><span class="token punctuation">(</span>zap<span class="token punctuation">.</span><span class="token function">AddCaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> logger<span class="token punctuation">.</span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°†ä¸Šè¿°ä»£ç ä¿å­˜åœ¨example3.goä¸­ï¼Œæ‰§è¡Œï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>$ go run example3.go
{"level":"info","ts":1607010625.6718638,"caller":"zap/example3.go:9","msg":"hello world"}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°æ—¥å¿—è¾“å‡ºäº†æ—¥å¿—çš„è°ƒç”¨ä¿¡æ¯ï¼ˆæ–‡ä»¶å:è¡Œå·ï¼‰<code v-pre>&quot;caller&quot;:&quot;zap/example3.go:9&quot;</code>ã€‚zapæä¾›äº†å¤šä¸ªé€‰é¡¹å¯ä¾›é€‰æ‹©ï¼š</p>
<ul>
<li><code v-pre>AddStacktrace(lvl zapcore.LevelEnabler)</code>ï¼šç”¨æ¥åœ¨æŒ‡å®šçº§åˆ«åŠä»¥ä¸Šçº§åˆ«è¾“å‡ºè°ƒç”¨å †æ ˆã€‚</li>
<li><code v-pre>zap.WithCaller(enabled bool)</code>ï¼šæŒ‡å®šæ˜¯å¦åœ¨æ—¥å¿—è¾“å‡ºå†…å®¹ä¸­å¢åŠ æ–‡ä»¶åå’Œè¡Œå·ã€‚</li>
<li><code v-pre>zap.AddCaller()</code>ï¼šä¸zap.WithCaller(true)ç­‰ä»·ï¼ŒæŒ‡å®šåœ¨æ—¥å¿—è¾“å‡ºå†…å®¹ä¸­å¢åŠ è¡Œå·å’Œæ–‡ä»¶åã€‚</li>
<li><code v-pre>zap. AddCallerSkip(skip int)</code>ï¼šæŒ‡å®šåœ¨è°ƒç”¨æ ˆä¸­è·³è¿‡çš„è°ƒç”¨æ·±åº¦ï¼Œå¦åˆ™é€šè¿‡è°ƒç”¨æ ˆè·å¾—çš„è¡Œå·å¯èƒ½æ€»æ˜¯æ—¥å¿—ç»„ä»¶ä¸­çš„è¡Œå·ã€‚</li>
<li><code v-pre>zap. IncreaseLevel(lvl zapcore.LevelEnabler)</code>ï¼šæé«˜æ—¥å¿—çº§åˆ«ï¼Œå¦‚æœä¼ å…¥çš„lvlæ¯”å½“å‰loggerçš„çº§åˆ«ä½ï¼Œåˆ™ä¸ä¼šæ”¹å˜æ—¥å¿—çº§åˆ«ã€‚</li>
<li><code v-pre>ErrorOutput(w zapcore.WriteSyncer)</code>ï¼šæŒ‡å®šæ—¥å¿—ç»„ä»¶ä¸­å‡ºç°å¼‚å¸¸æ—¶çš„è¾“å‡ºä½ç½®ã€‚</li>
<li><code v-pre>Fields(fs ...Field)</code>ï¼šæ·»åŠ å…¬å…±å­—æ®µã€‚</li>
<li><code v-pre>Hooks(hooks ...func(zapcore.Entry) error)</code>ï¼šæ³¨å†Œé’©å­å‡½æ•°ï¼Œç”¨æ¥åœ¨æ—¥å¿—æ‰“å°æ—¶åŒæ—¶è°ƒç”¨hookæ–¹æ³•ã€‚</li>
<li><code v-pre>WrapCore(f func(zapcore.Core) zapcore.Core)</code>ï¼šæ›¿æ¢Loggerçš„zapcore.Coreã€‚ -<code v-pre> Development()</code>ï¼šå°†Loggerä¿®æ”¹ä¸ºDevelopmentæ¨¡å¼ã€‚</li>
</ul>
<p><strong>é¢„è®¾æ—¥å¿—å­—æ®µ</strong></p>
<p>å¦‚æœæ¯æ¡æ—¥å¿—éƒ½æœŸæœ›åŠ ä¸€äº›å…¬å…±å­—æ®µï¼Œä¾‹å¦‚requestIDï¼Œå¯ä»¥åœ¨åˆ›å»ºLoggeræ—¶ä½¿ç”¨<code v-pre>Fields(fs ...Field)</code>é€‰é¡¹ï¼Œå¦‚ä¸‹ä»£ç ä¸­ï¼Œæ·»åŠ äº†requestIDã€userIDå…¬å…±å­—æ®µåˆ°æ¯æ¡æ—¥å¿—ä¸­ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"go.uber.org/zap"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger <span class="token operator">:=</span> zap<span class="token punctuation">.</span><span class="token function">NewExample</span><span class="token punctuation">(</span>zap<span class="token punctuation">.</span><span class="token function">Fields</span><span class="token punctuation">(</span>
        zap<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"userID"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"requestID"</span><span class="token punctuation">,</span> <span class="token string">"fbf54504"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>

    logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"This is a debug message"</span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"This is a info message"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°†ä¸Šè¿°ä»£ç ä¿å­˜åˆ°<code v-pre>preset_field.go</code>æ–‡ä»¶ä¸­ï¼Œè¿è¡Œï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ go run preset_field.go
<span class="token punctuation">{</span><span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"debug"</span>,<span class="token string">"msg"</span><span class="token builtin class-name">:</span><span class="token string">"This is a debug message"</span>,<span class="token string">"userID"</span>:10,<span class="token string">"requestID"</span><span class="token builtin class-name">:</span><span class="token string">"fbf54504"</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"info"</span>,<span class="token string">"msg"</span><span class="token builtin class-name">:</span><span class="token string">"This is a info message"</span>,<span class="token string">"userID"</span>:10,<span class="token string">"requestID"</span><span class="token builtin class-name">:</span><span class="token string">"fbf54504"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å…¨å±€Loggerï¼š</strong></p>
<p>zapæä¾›äº†2ä¸ªå…¨å±€Loggerï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬è°ƒç”¨ï¼š</p>
<ul>
<li><code v-pre>*zap.Logger</code>ï¼šå¯é€šè¿‡zap.L()è·å¾—ï¼Œæä¾›äº†Debug()ã€Info()ã€Warn()ã€Error()ã€Panic()ã€DPanic()ã€Fatal()æ–¹æ³•æ¥è®°å½•æ—¥å¿—ã€‚</li>
<li><code v-pre>*zap.SugaredLogger</code>ï¼šå¯é€šè¿‡zap.S()è·å¾—ï¼Œæä¾›äº†Debugf()ã€Debugw()ã€Infof()ã€Infow()ã€Warnf()ã€Warnw()ã€Errorf()ã€Errorw()ã€Panicf()ã€Panicw()ã€DPanicf()ã€DPanicw()ã€Fatalf()ã€Fatalw()æ–¹æ³•æ¥è®°å½•æ—¥å¿—ã€‚</li>
</ul>
<p>é»˜è®¤çš„å…¨å±€Loggerä¸ä¼šè®°å½•ä»»ä½•æ—¥å¿—ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ— ç”¨çš„Loggerï¼Œä¾‹å¦‚zap.L()è¿”å›äº†åä¸º<code v-pre>_globalL</code>çš„Loggerï¼Œ<code v-pre>_globalL</code>å®šä¹‰ä¸ºï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>_globalL  <span class="token operator">=</span> <span class="token function">NewNop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">NewNop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Logger <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Logger<span class="token punctuation">{</span>
        core<span class="token punctuation">:</span>        zapcore<span class="token punctuation">.</span><span class="token function">NewNopCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        errorOutput<span class="token punctuation">:</span> zapcore<span class="token punctuation">.</span><span class="token function">AddSync</span><span class="token punctuation">(</span>ioutil<span class="token punctuation">.</span>Discard<span class="token punctuation">)</span><span class="token punctuation">,</span>
        addStack<span class="token punctuation">:</span>    zapcore<span class="token punctuation">.</span>FatalLevel <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>zapcore.NewNopCore()</code>å‡½æ•°å®šä¹‰ä¸ºï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> nopCore <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// NewNopCore returns a no-op Core.</span>
<span class="token keyword">func</span> <span class="token function">NewNopCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Core                                        <span class="token punctuation">{</span> <span class="token keyword">return</span> nopCore<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>nopCore<span class="token punctuation">)</span> <span class="token function">Enabled</span><span class="token punctuation">(</span>Level<span class="token punctuation">)</span> <span class="token builtin">bool</span>                            <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n nopCore<span class="token punctuation">)</span> <span class="token function">With</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Field<span class="token punctuation">)</span> Core                           <span class="token punctuation">{</span> <span class="token keyword">return</span> n <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>nopCore<span class="token punctuation">)</span> <span class="token function">Check</span><span class="token punctuation">(</span><span class="token boolean">_</span> Entry<span class="token punctuation">,</span> ce <span class="token operator">*</span>CheckedEntry<span class="token punctuation">)</span> <span class="token operator">*</span>CheckedEntry <span class="token punctuation">{</span> <span class="token keyword">return</span> ce <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>nopCore<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>Entry<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Field<span class="token punctuation">)</span> <span class="token builtin">error</span>                    <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">nil</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>nopCore<span class="token punctuation">)</span> <span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>                                   <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">nil</span> <span class="token punctuation">}</span>

<span class="token comment">// NewCore creates a Core that writes logs to a WriteSyncer.</span>
<span class="token keyword">func</span> <span class="token function">NewCore</span><span class="token punctuation">(</span>enc Encoder<span class="token punctuation">,</span> ws WriteSyncer<span class="token punctuation">,</span> enab LevelEnabler<span class="token punctuation">)</span> Core <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>ioCore<span class="token punctuation">{</span>
        LevelEnabler<span class="token punctuation">:</span> enab<span class="token punctuation">,</span>
        enc<span class="token punctuation">:</span>          enc<span class="token punctuation">,</span>
        out<span class="token punctuation">:</span>          ws<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°NewNop()åˆ›å»ºä¸€ä¸ªä¸è®°å½•ä»»ä½•æ—¥å¿—ã€ä»»ä½•å†…éƒ¨é”™è¯¯ã€ä¸æ‰§è¡Œä»»ä½•é’©å­çš„Loggerã€‚å¯ä»¥ä½¿ç”¨ReplaceGlobalså‡½æ•°å°†å…¨å±€Loggeræ›¿æ¢ä¸ºæˆ‘ä»¬åˆ›å»ºçš„Loggerï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>package main

import "go.uber.org/zap"

func main() {
    zap.L().Info("default global Logger")
    zap.S().Info("default global SugaredLogger")

    logger := zap.NewExample()
    defer logger.Sync()

    zap.ReplaceGlobals(logger)
    zap.L().Info("replaced global Logger")
    zap.S().Info("replaced global SugaredLogger")
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡è®¾ä¸Šè¿°ä»£ç ä¿å­˜åœ¨<code v-pre>global_logger.go</code>æ–‡ä»¶ä¸­ï¼Œè¿è¡Œï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>$ go run global_logger.go
{"level":"info","msg":"replaced global Logger"}
{"level":"info","msg":"replaced global SugaredLogger"}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°åœ¨<code v-pre>zap.ReplaceGlobals(logger)</code>ä¹‹å‰çš„æ—¥å¿—ï¼Œå¹¶æ²¡æœ‰è¢«æ‰“å°å‡ºæ¥ã€‚</p>
<h2 id="å…¶å®ƒå¼€æºåŒ…" tabindex="-1"><a class="header-anchor" href="#å…¶å®ƒå¼€æºåŒ…" aria-hidden="true">#</a> å…¶å®ƒå¼€æºåŒ…</h2>
<p>è¿˜æœ‰å¾ˆå¤šå…¶å®ƒä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…ä¾›æˆ‘ä»¬é€‰æ‹©ï¼Œä¾‹å¦‚ï¼šlog15ã€zerologã€seelogã€apex/logã€go-loggingç­‰ã€‚ä½ å¯ä»¥åœ¨å¼€å‘ä¸­ï¼Œéƒ½è¯¦åŠ è°ƒç ”ï¼Œé€‰æ‹©ä¸€ä¸ªé€‚åˆè‡ªå·±çš„æ—¥å¿—åŒ…ã€‚</p>
<h2 id="å¼€æºæ—¥å¿—åŒ…é€‰æ‹©" tabindex="-1"><a class="header-anchor" href="#å¼€æºæ—¥å¿—åŒ…é€‰æ‹©" aria-hidden="true">#</a> å¼€æºæ—¥å¿—åŒ…é€‰æ‹©</h2>
<p>æˆ‘ä»¬ä»‹ç»äº†å¾ˆå¤šæ—¥å¿—åŒ…ï¼Œæ¯ç§æ—¥å¿—åŒ…ä½¿ç”¨çš„åœºæ™¯ä¸åŒï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ç»“åˆæ—¥å¿—åŒ…çš„ç‰¹æ€§è¿›è¡Œé€‰æ‹©ï¼š</p>
<ul>
<li><strong>æ ‡å‡†åº“logåŒ…ï¼š</strong> æ ‡å‡†åº“logåŒ…ä¸æ”¯æŒæ—¥å¿—çº§åˆ«ã€æ—¥å¿—åˆ†å‰²ã€æ—¥å¿—æ ¼å¼ç­‰åŠŸèƒ½ï¼Œæ‰€ä»¥åœ¨å¤§å‹é¡¹ç›®ä¸­å¾ˆå°‘ç›´æ¥ä½¿ç”¨ï¼Œé€šå¸¸ç”¨äºä¸€äº›çŸ­å°çš„ç¨‹åºï¼Œæ¯”å¦‚ï¼šç”¨äºç”ŸæˆJWT Tokençš„main.goæ–‡ä»¶ä¸­ã€‚æ ‡å‡†åº“æ—¥å¿—åŒ…ä¹Ÿå¾ˆé€‚åˆä¸€äº›ç®€çŸ­çš„ä»£ç ï¼Œç”¨äºå¿«é€Ÿè°ƒè¯•å’ŒéªŒè¯ã€‚</li>
<li><strong>glogï¼š</strong> glogå®ç°äº†æ—¥å¿—åŒ…çš„åŸºæœ¬åŠŸèƒ½ï¼Œå¯¹äºä¸€äº›å¯¹æ—¥å¿—åŠŸèƒ½è¦æ±‚ä¸å¤šçš„å°å‹é¡¹ç›®éå¸¸é€‚åˆã€‚</li>
<li><strong>logrusï¼š</strong> logrusåŠŸèƒ½å¼ºå¤§ï¼Œä¸ä»…å®ç°äº†æ—¥å¿—åŒ…çš„åŸºæœ¬åŠŸèƒ½ï¼Œè¿˜æœ‰å¾ˆå¤šé«˜çº§ç‰¹æ€§ï¼Œé€‚åˆä¸€äº›å¤§å‹é¡¹ç›®ï¼Œå°¤å…¶æ˜¯éœ€è¦ç»“æ„åŒ–æ—¥å¿—è®°å½•çš„é¡¹ç›®ã€‚</li>
<li><strong>zapï¼š</strong> zapæä¾›äº†å¾ˆå¼ºå¤§çš„æ—¥å¿—åŠŸèƒ½ï¼Œæ€§èƒ½é«˜ï¼Œå†…å­˜åˆ†é…æ¬¡æ•°å°‘ï¼Œé€‚åˆå¯¹æ—¥å¿—æ€§èƒ½è¦æ±‚å¾ˆé«˜çš„é¡¹ç›®ã€‚å¦å¤–ï¼ŒzapåŒ…ä¸­çš„å­åŒ…zapcoreï¼Œæä¾›äº†å¾ˆå¤šåº•å±‚çš„æ—¥å¿—æ¥å£ï¼Œé€‚åˆç”¨æ¥åšäºŒæ¬¡å°è£…ã€‚ä¾‹å¦‚ iam é¡¹ç›®ä½œè€… å°±åŸºäºzapå’Œzapcoreå°è£…äº†<a href="https://github.com/marmotedu/log" target="_blank" rel="noopener noreferrer">marmotedu/log<ExternalLinkIcon/></a>æ—¥å¿—åŒ…ï¼Œè¯¥æ—¥å¿—åŒ…å¯ä»¥å¾ˆå¥½çš„å…¼å®¹glogï¼Œå°è£…èƒŒæ™¯æ˜¯å› ä¸ºåœ¨åšå®¹å™¨äº‘å¹³å°å¼€å‘æ—¶ï¼Œå‘ç°kubernetesæºç ä¸­å¤§é‡ä½¿ç”¨äº†glogï¼Œéœ€è¦æ—¥å¿—åŒ…èƒ½å¤Ÿå…¼å®¹glogã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ å¦‚ä½•ä»é›¶å¼€å§‹å¼€å‘å‡ºä¸€ä¸ªæ—¥å¿—åŒ…ï¼š</p>
<h2 id="ä»0ç¼–å†™ä¸€ä¸ªæ—¥å¿—åŒ…" tabindex="-1"><a class="header-anchor" href="#ä»0ç¼–å†™ä¸€ä¸ªæ—¥å¿—åŒ…" aria-hidden="true">#</a> ä»0ç¼–å†™ä¸€ä¸ªæ—¥å¿—åŒ…</h2>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šå‘ä½ å±•ç¤ºå¦‚ä½•å¿«é€Ÿç¼–å†™ä¸€ä¸ªå…·å¤‡åŸºæœ¬åŠŸèƒ½çš„æ—¥å¿—åŒ…ï¼Œè®©ä½ é€šè¿‡è¿™ä¸ªç®€çŸ­çš„æ—¥å¿—åŒ…å®ç°æŒæ¡æ—¥å¿—åŒ…çš„æ ¸å¿ƒè®¾è®¡æ€è·¯ã€‚è¯¥æ—¥å¿—åŒ…ä¸»è¦å®ç°ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li>æ”¯æŒè‡ªå®šä¹‰é…ç½®ã€‚</li>
<li>æ”¯æŒæ–‡ä»¶åå’Œè¡Œå·ã€‚</li>
<li>æ”¯æŒæ—¥å¿—çº§åˆ« Debugã€Infoã€Warnã€Errorã€Panicã€Fatalã€‚</li>
<li>æ”¯æŒè¾“å‡ºåˆ°æœ¬åœ°æ–‡ä»¶å’Œæ ‡å‡†è¾“å‡ºã€‚</li>
<li>æ”¯æŒJSONå’ŒTEXTæ ¼å¼çš„æ—¥å¿—è¾“å‡ºï¼Œæ”¯æŒè‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ã€‚</li>
<li>æ”¯æŒé€‰é¡¹æ¨¡å¼ã€‚</li>
</ul>
<p>æ—¥å¿—åŒ…åç§°ä¸º<code v-pre>cuslog</code>ï¼Œç¤ºä¾‹é¡¹ç›®å®Œæ•´ä»£ç å­˜æ”¾åœ¨ <a href="https://github.com/marmotedu/gopractise-demo/tree/main/log/cuslog" target="_blank" rel="noopener noreferrer">cuslog<ExternalLinkIcon/></a>ã€‚</p>
<p><strong>å…·ä½“å®ç°åˆ†ä¸ºä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š</strong></p>
<ol>
<li>å®šä¹‰ï¼šå®šä¹‰æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—é€‰é¡¹ã€‚</li>
<li>åˆ›å»ºï¼šåˆ›å»ºLoggeråŠå„çº§åˆ«æ—¥å¿—æ‰“å°æ–¹æ³•ã€‚</li>
<li>å†™å…¥ï¼šå°†æ—¥å¿—è¾“å‡ºåˆ°æ”¯æŒçš„è¾“å‡ºä¸­ã€‚</li>
<li>è‡ªå®šä¹‰ï¼šè‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼ã€‚</li>
</ol>
<h3 id="å®šä¹‰æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—é€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#å®šä¹‰æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—é€‰é¡¹" aria-hidden="true">#</a> å®šä¹‰æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—é€‰é¡¹</h3>
<p>ä¸€ä¸ªåŸºæœ¬çš„æ—¥å¿—åŒ…ï¼Œé¦–å…ˆéœ€è¦å®šä¹‰å¥½æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—é€‰é¡¹ã€‚æœ¬ç¤ºä¾‹å°†å®šä¹‰ä»£ç ä¿å­˜åœ¨<a href="https://github.com/marmotedu/gopractise-demo/blob/main/log/cuslog/options.go" target="_blank" rel="noopener noreferrer">options.go<ExternalLinkIcon/></a>æ–‡ä»¶ä¸­ã€‚</p>
<p>å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®šä¹‰æ—¥å¿—çº§åˆ«ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Level <span class="token builtin">uint8</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
    DebugLevel Level <span class="token operator">=</span> <span class="token boolean">iota</span>
    InfoLevel
    WarnLevel
    ErrorLevel
    PanicLevel
    FatalLevel
<span class="token punctuation">)</span>

<span class="token keyword">var</span> LevelNameMapping <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>Level<span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
    DebugLevel<span class="token punctuation">:</span> <span class="token string">"DEBUG"</span><span class="token punctuation">,</span>
    InfoLevel<span class="token punctuation">:</span>  <span class="token string">"INFO"</span><span class="token punctuation">,</span>
    WarnLevel<span class="token punctuation">:</span>  <span class="token string">"WARN"</span><span class="token punctuation">,</span>
    ErrorLevel<span class="token punctuation">:</span> <span class="token string">"ERROR"</span><span class="token punctuation">,</span>
    PanicLevel<span class="token punctuation">:</span> <span class="token string">"PANIC"</span><span class="token punctuation">,</span>
    FatalLevel<span class="token punctuation">:</span> <span class="token string">"FATAL"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ—¥å¿—è¾“å‡ºæ—¶ï¼Œè¦é€šè¿‡å¯¹æ¯”å¼€å…³çº§åˆ«å’Œè¾“å‡ºçº§åˆ«çš„å¤§å°ï¼Œæ¥å†³å®šæ˜¯å¦è¾“å‡ºï¼Œæ‰€ä»¥æ—¥å¿—çº§åˆ«Levelè¦å®šä¹‰æˆæ–¹ä¾¿æ¯”è¾ƒçš„æ•°å€¼ç±»å‹ã€‚å‡ ä¹æ‰€æœ‰çš„æ—¥å¿—åŒ…éƒ½æ˜¯ç”¨å¸¸é‡è®¡æ•°å™¨<code v-pre>iota</code>æ¥å®šä¹‰æ—¥å¿—çº§åˆ«ã€‚</p>
<p>å¦å¤–ï¼Œå› ä¸ºè¦åœ¨æ—¥å¿—è¾“å‡ºä¸­ï¼Œè¾“å‡ºå¯è¯»çš„æ—¥å¿—çº§åˆ«ï¼ˆä¾‹å¦‚è¾“å‡ºINFOè€Œä¸æ˜¯1ï¼‰ï¼Œæ‰€ä»¥éœ€è¦æœ‰Levelåˆ°Level Nameçš„æ˜ å°„LevelNameMappingï¼ŒLevelNameMappingä¼šåœ¨æ ¼å¼åŒ–æ—¶ç”¨åˆ°ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹å®šä¹‰æ—¥å¿—é€‰é¡¹ã€‚æ—¥å¿—éœ€è¦æ˜¯å¯é…ç½®çš„ï¼Œæ–¹ä¾¿å¼€å‘è€…æ ¹æ®ä¸åŒçš„ç¯å¢ƒè®¾ç½®ä¸åŒçš„æ—¥å¿—è¡Œä¸ºï¼Œæ¯”è¾ƒå¸¸è§çš„é…ç½®é€‰é¡¹ä¸ºï¼š</p>
<ul>
<li>æ—¥å¿—çº§åˆ«ã€‚</li>
<li>è¾“å‡ºä½ç½®ï¼Œä¾‹å¦‚æ ‡å‡†è¾“å‡ºæˆ–è€…æ–‡ä»¶ã€‚</li>
<li>è¾“å‡ºæ ¼å¼ï¼Œä¾‹å¦‚JSONæˆ–è€…Textã€‚</li>
<li>æ˜¯å¦å¼€å¯æ–‡ä»¶åå’Œè¡Œå·ã€‚</li>
</ul>
<p>æœ¬ç¤ºä¾‹çš„æ—¥å¿—é€‰é¡¹å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> options <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    output        io<span class="token punctuation">.</span>Writer
    level         Level
    stdLevel      Level
    formatter     Formatter
    disableCaller <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸ºäº†çµæ´»åœ°è®¾ç½®æ—¥å¿—çš„é€‰é¡¹ï¼Œä½ å¯ä»¥é€šè¿‡é€‰é¡¹æ¨¡å¼ï¼Œæ¥å¯¹æ—¥å¿—é€‰é¡¹è¿›è¡Œè®¾ç½®ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Option <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>options<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">initOptions</span><span class="token punctuation">(</span>opts <span class="token operator">...</span>Option<span class="token punctuation">)</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    o <span class="token operator">=</span> <span class="token operator">&amp;</span>options<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        <span class="token function">opt</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> o<span class="token punctuation">.</span>output <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        o<span class="token punctuation">.</span>output <span class="token operator">=</span> os<span class="token punctuation">.</span>Stderr
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> o<span class="token punctuation">.</span>formatter <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        o<span class="token punctuation">.</span>formatter <span class="token operator">=</span> <span class="token operator">&amp;</span>TextFormatter<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithLevel</span><span class="token punctuation">(</span>level Level<span class="token punctuation">)</span> Option <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>o <span class="token operator">*</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        o<span class="token punctuation">.</span>level <span class="token operator">=</span> level
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
<span class="token keyword">func</span> <span class="token function">SetOptions</span><span class="token punctuation">(</span>opts <span class="token operator">...</span>Option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token punctuation">.</span><span class="token function">SetOptions</span><span class="token punctuation">(</span>opts<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>logger<span class="token punctuation">)</span> <span class="token function">SetOptions</span><span class="token punctuation">(</span>opts <span class="token operator">...</span>Option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    l<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> l<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        <span class="token function">opt</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>opt<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…·æœ‰é€‰é¡¹æ¨¡å¼çš„æ—¥å¿—åŒ…ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼Œæ¥åŠ¨æ€åœ°ä¿®æ”¹æ—¥å¿—çš„é€‰é¡¹ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>cuslog.SetOptions(cuslog.WithLevel(cuslog.DebugLevel))
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä½ å¯ä»¥æ ¹æ®éœ€è¦ï¼Œå¯¹æ¯ä¸€ä¸ªæ—¥å¿—é€‰é¡¹åˆ›å»ºè®¾ç½®å‡½æ•° <code v-pre>WithXXXX</code> ã€‚è¿™ä¸ªç¤ºä¾‹æ—¥å¿—åŒ…æ”¯æŒå¦‚ä¸‹é€‰é¡¹è®¾ç½®å‡½æ•°ï¼š</p>
<ul>
<li>WithOutputï¼ˆoutput io.Writerï¼‰ï¼šè®¾ç½®è¾“å‡ºä½ç½®ã€‚</li>
<li>WithLevelï¼ˆlevel Levelï¼‰ï¼šè®¾ç½®è¾“å‡ºçº§åˆ«ã€‚</li>
<li>WithFormatterï¼ˆformatter Formatterï¼‰ï¼šè®¾ç½®è¾“å‡ºæ ¼å¼ã€‚</li>
<li>WithDisableCallerï¼ˆcaller boolï¼‰ï¼šè®¾ç½®æ˜¯å¦æ‰“å°æ–‡ä»¶åå’Œè¡Œå·ã€‚</li>
</ul>
<h3 id="åˆ›å»ºloggeråŠå„çº§åˆ«æ—¥å¿—æ‰“å°æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºloggeråŠå„çº§åˆ«æ—¥å¿—æ‰“å°æ–¹æ³•" aria-hidden="true">#</a> åˆ›å»ºLoggeråŠå„çº§åˆ«æ—¥å¿—æ‰“å°æ–¹æ³•</h3>
<p>ä¸ºäº†æ‰“å°æ—¥å¿—ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®æ—¥å¿—é…ç½®ï¼Œåˆ›å»ºä¸€ä¸ªLoggerï¼Œç„¶åé€šè¿‡è°ƒç”¨Loggerçš„æ—¥å¿—æ‰“å°æ–¹æ³•ï¼Œå®Œæˆå„çº§åˆ«æ—¥å¿—çš„è¾“å‡ºã€‚æœ¬ç¤ºä¾‹å°†åˆ›å»ºä»£ç ä¿å­˜åœ¨<a href="https://github.com/marmotedu/gopractise-demo/blob/main/log/cuslog/logger.go" target="_blank" rel="noopener noreferrer">logger.go<ExternalLinkIcon/></a>æ–‡ä»¶ä¸­ã€‚</p>
<p>å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼åˆ›å»º<code v-pre>Logger</code>ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">var</span> std <span class="token operator">=</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> logger <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    opt       <span class="token operator">*</span>options
    mu        sync<span class="token punctuation">.</span>Mutex
    entryPool <span class="token operator">*</span>sync<span class="token punctuation">.</span>Pool
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>opts <span class="token operator">...</span>Option<span class="token punctuation">)</span> <span class="token operator">*</span>logger <span class="token punctuation">{</span>
    logger <span class="token operator">:=</span> <span class="token operator">&amp;</span>logger<span class="token punctuation">{</span>opt<span class="token punctuation">:</span> <span class="token function">initOptions</span><span class="token punctuation">(</span>opts<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    logger<span class="token punctuation">.</span>entryPool <span class="token operator">=</span> <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>Pool<span class="token punctuation">{</span>New<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">entry</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> logger
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªLoggerï¼Œå¹¶å®ç°äº†åˆ›å»ºLoggerçš„Newå‡½æ•°ã€‚æ—¥å¿—åŒ…éƒ½ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„å…¨å±€Loggerï¼Œæœ¬ç¤ºä¾‹é€šè¿‡ <code v-pre>var std = New()</code> åˆ›å»ºäº†ä¸€ä¸ªå…¨å±€çš„é»˜è®¤Loggerã€‚<code v-pre>cuslog.Debug</code>ã€<code v-pre>cuslog.Info</code>å’Œ<code v-pre>cuslog.Warnf</code>ç­‰å‡½æ•°ï¼Œåˆ™æ˜¯é€šè¿‡è°ƒç”¨<code v-pre>std Logger</code>æ‰€æä¾›çš„æ–¹æ³•æ¥æ‰“å°æ—¥å¿—çš„ã€‚</p>
<p>å®šä¹‰äº†ä¸€ä¸ªLoggerä¹‹åï¼Œè¿˜éœ€è¦ç»™è¯¥Loggeræ·»åŠ æœ€æ ¸å¿ƒçš„æ—¥å¿—æ‰“å°æ–¹æ³•ï¼Œè¦æä¾›æ‰€æœ‰æ”¯æŒçº§åˆ«çš„æ—¥å¿—æ‰“å°æ–¹æ³•ã€‚</p>
<p>å¦‚æœæ—¥å¿—çº§åˆ«æ˜¯Xyzï¼Œåˆ™é€šå¸¸éœ€è¦æä¾›ä¸¤ç±»æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯éæ ¼å¼åŒ–æ–¹æ³•<code v-pre>Xyz(args ...interface{})</code>å’Œæ ¼å¼åŒ–æ–¹æ³•<code v-pre>Xyzf(format string, args ...interface{})</code>ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>logger<span class="token punctuation">)</span> <span class="token function">Debug</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    l<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>DebugLevel<span class="token punctuation">,</span> FmtEmptySeparate<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>logger<span class="token punctuation">)</span> <span class="token function">Debugf</span><span class="token punctuation">(</span>format <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    l<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>DebugLevel<span class="token punctuation">,</span> format<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ¬ç¤ºä¾‹å®ç°äº†å¦‚ä¸‹æ–¹æ³•ï¼šDebugã€Debugfã€Infoã€Infofã€Warnã€Warnfã€Errorã€Errorfã€Panicã€Panicfã€Fatalã€Fatalfã€‚æ›´è¯¦ç»†çš„å®ç°ï¼Œä½ å¯ä»¥å‚è€ƒ <a href="https://github.com/marmotedu/gopractise-demo/blob/main/log/cuslog/logger.go" target="_blank" rel="noopener noreferrer">cuslog/logger.go<ExternalLinkIcon/></a>ã€‚</p>
<p>è¿™é‡Œè¦æ³¨æ„ï¼ŒPanicã€Panicfè¦è°ƒç”¨panic()å‡½æ•°ï¼ŒFatalã€Fatalfå‡½æ•°è¦è°ƒç”¨ <code v-pre>os.Exit(1)</code> å‡½æ•°ã€‚</p>
<h3 id="å°†æ—¥å¿—è¾“å‡ºåˆ°æ”¯æŒçš„è¾“å‡ºä¸­" tabindex="-1"><a class="header-anchor" href="#å°†æ—¥å¿—è¾“å‡ºåˆ°æ”¯æŒçš„è¾“å‡ºä¸­" aria-hidden="true">#</a> å°†æ—¥å¿—è¾“å‡ºåˆ°æ”¯æŒçš„è¾“å‡ºä¸­</h3>
<p>è°ƒç”¨æ—¥å¿—æ‰“å°å‡½æ•°ä¹‹åï¼Œè¿˜éœ€è¦å°†è¿™äº›æ—¥å¿—è¾“å‡ºåˆ°æ”¯æŒçš„è¾“å‡ºä¸­ï¼Œæ‰€ä»¥éœ€è¦å®ç°<code v-pre>write</code>å‡½æ•°ï¼Œå®ƒçš„å†™å…¥é€»è¾‘ä¿å­˜åœ¨<a href="https://github.com/marmotedu/gopractise-demo/blob/main/log/cuslog/entry.go" target="_blank" rel="noopener noreferrer">entry.go<ExternalLinkIcon/></a>æ–‡ä»¶ä¸­ã€‚å®ç°æ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Entry <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    logger <span class="token operator">*</span>logger
    Buffer <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer
    Map    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    Level  Level
    Time   time<span class="token punctuation">.</span>Time
    File   <span class="token builtin">string</span>
    Line   <span class="token builtin">int</span>
    Func   <span class="token builtin">string</span>
    Format <span class="token builtin">string</span>
    Args   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Entry<span class="token punctuation">)</span> <span class="token function">write</span><span class="token punctuation">(</span>level Level<span class="token punctuation">,</span> format <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> e<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>level <span class="token operator">></span> level <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    e<span class="token punctuation">.</span>Time <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    e<span class="token punctuation">.</span>Level <span class="token operator">=</span> level
    e<span class="token punctuation">.</span>Format <span class="token operator">=</span> format
    e<span class="token punctuation">.</span>Args <span class="token operator">=</span> args
    <span class="token keyword">if</span> <span class="token operator">!</span>e<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>disableCaller <span class="token punctuation">{</span>
        <span class="token keyword">if</span> pc<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> ok <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">Caller</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>File <span class="token operator">=</span> <span class="token string">"???"</span>
            e<span class="token punctuation">.</span>Func <span class="token operator">=</span> <span class="token string">"???"</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>File<span class="token punctuation">,</span> e<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> e<span class="token punctuation">.</span>Func <span class="token operator">=</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">FuncForPC</span><span class="token punctuation">(</span>pc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            e<span class="token punctuation">.</span>Func <span class="token operator">=</span> e<span class="token punctuation">.</span>Func<span class="token punctuation">[</span>strings<span class="token punctuation">.</span><span class="token function">LastIndex</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Func<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    e<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    e<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    e<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Entry<span class="token punctuation">)</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>formatter<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Entry<span class="token punctuation">)</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>opt<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Buffer<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    e<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Entry<span class="token punctuation">)</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span>Args<span class="token punctuation">,</span> e<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> e<span class="token punctuation">.</span>File<span class="token punctuation">,</span> e<span class="token punctuation">.</span>Format<span class="token punctuation">,</span> e<span class="token punctuation">.</span>Func <span class="token operator">=</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span>
    e<span class="token punctuation">.</span>Buffer<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    e<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>entryPool<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç ï¼Œé¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªEntryç»“æ„ä½“ç±»å‹ï¼Œè¯¥ç±»å‹ç”¨æ¥ä¿å­˜æ‰€æœ‰çš„æ—¥å¿—ä¿¡æ¯ï¼Œå³æ—¥å¿—é…ç½®å’Œæ—¥å¿—å†…å®¹ã€‚å†™å…¥é€»è¾‘éƒ½æ˜¯å›´ç»•Entryç±»å‹çš„å®ä¾‹æ¥å®Œæˆçš„ã€‚</p>
<p>ç”¨Entryçš„writeæ–¹æ³•æ¥å®Œæˆæ—¥å¿—çš„å†™å…¥ï¼Œåœ¨writeæ–¹æ³•ä¸­ï¼Œä¼šé¦–å…ˆåˆ¤æ–­æ—¥å¿—çš„è¾“å‡ºçº§åˆ«å’Œå¼€å…³çº§åˆ«ï¼Œå¦‚æœè¾“å‡ºçº§åˆ«å°äºå¼€å…³çº§åˆ«ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸åšä»»ä½•è®°å½•ã€‚</p>
<p>åœ¨writeä¸­ï¼Œè¿˜ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦è®°å½•æ–‡ä»¶åå’Œè¡Œå·ï¼Œå¦‚æœéœ€è¦åˆ™è°ƒç”¨ <code v-pre>runtime.Caller()</code> æ¥è·å–æ–‡ä»¶åå’Œè¡Œå·ï¼Œè°ƒç”¨ <code v-pre>runtime.Caller()</code> æ—¶ï¼Œè¦æ³¨æ„ä¼ å…¥æ­£ç¡®çš„æ ˆæ·±åº¦ã€‚</p>
<p>writeå‡½æ•°ä¸­è°ƒç”¨ <code v-pre>e.format</code> æ¥æ ¼å¼åŒ–æ—¥å¿—ï¼Œè°ƒç”¨ <code v-pre>e.writer</code> æ¥å†™å…¥æ—¥å¿—ï¼Œåœ¨åˆ›å»ºLoggerä¼ å…¥çš„æ—¥å¿—é…ç½®ä¸­ï¼ŒæŒ‡å®šäº†è¾“å‡ºä½ç½® <code v-pre>output io.Writer</code> ï¼Œoutputç±»å‹ä¸º <code v-pre>io.Writer</code> ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Writer <span class="token keyword">interface</span> <span class="token punctuation">{</span>    
    <span class="token function">Write</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>io.Writerå®ç°äº†Writeæ–¹æ³•å¯ä¾›å†™å…¥ï¼Œæ‰€ä»¥åªéœ€è¦è°ƒç”¨<code v-pre>e.logger.opt.output.Write(e.Buffer.Bytes())</code>å³å¯å°†æ—¥å¿—å†™å…¥åˆ°æŒ‡å®šçš„ä½ç½®ä¸­ã€‚æœ€åï¼Œä¼šè°ƒç”¨release()æ–¹æ³•æ¥æ¸…ç©ºç¼“å­˜å’Œå¯¹è±¡æ± ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†æ—¥å¿—çš„è®°å½•å’Œå†™å…¥ã€‚</p>
<h3 id="è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼" tabindex="-1"><a class="header-anchor" href="#è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼" aria-hidden="true">#</a> è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼</h3>
<p>cuslogåŒ…æ”¯æŒè‡ªå®šä¹‰è¾“å‡ºæ ¼å¼ï¼Œå¹¶ä¸”å†…ç½®äº†JSONå’Œ Text æ ¼å¼çš„ <code v-pre>Formatter</code>ã€‚<code v-pre>Formatter</code> æ¥å£å®šä¹‰ä¸ºï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Formatter <span class="token keyword">interface</span> <span class="token punctuation">{</span>    
    <span class="token function">Format</span><span class="token punctuation">(</span>entry <span class="token operator">*</span>Entry<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>cuslogå†…ç½®çš„Formatteræœ‰ä¸¤ä¸ªï¼š<a href="https://github.com/marmotedu/gopractise-demo/blob/main/log/cuslog/formatter_json.go" target="_blank" rel="noopener noreferrer">JSON<ExternalLinkIcon/></a>å’Œ<a href="https://github.com/marmotedu/gopractise-demo/blob/main/log/cuslog/formatter_text.go" target="_blank" rel="noopener noreferrer">TEXT<ExternalLinkIcon/></a>ã€‚</p>
<h3 id="æµ‹è¯•æ—¥å¿—åŒ…" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•æ—¥å¿—åŒ…" aria-hidden="true">#</a> æµ‹è¯•æ—¥å¿—åŒ…</h3>
<p>cuslogæ—¥å¿—åŒ…å¼€å‘å®Œæˆä¹‹åï¼Œå¯ä»¥ç¼–å†™æµ‹è¯•ä»£ç ï¼Œè°ƒç”¨<code v-pre>cuslog</code>åŒ…æ¥æµ‹è¯•<code v-pre>cuslog</code>åŒ…ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"log"</span>
    <span class="token string">"os"</span>

    <span class="token string">"github.com/marmotedu/gopractise-demo/log/cuslog"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cuslog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"std log"</span><span class="token punctuation">)</span>
    cuslog<span class="token punctuation">.</span><span class="token function">SetOptions</span><span class="token punctuation">(</span>cuslog<span class="token punctuation">.</span><span class="token function">WithLevel</span><span class="token punctuation">(</span>cuslog<span class="token punctuation">.</span>DebugLevel<span class="token punctuation">)</span><span class="token punctuation">)</span>
    cuslog<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"change std log to debug level"</span><span class="token punctuation">)</span>
    cuslog<span class="token punctuation">.</span><span class="token function">SetOptions</span><span class="token punctuation">(</span>cuslog<span class="token punctuation">.</span><span class="token function">WithFormatter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cuslog<span class="token punctuation">.</span>JsonFormatter<span class="token punctuation">{</span>IgnoreBasicFields<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    cuslog<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"log in json format"</span><span class="token punctuation">)</span>
    cuslog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"another log in json format"</span><span class="token punctuation">)</span>

    <span class="token comment">// è¾“å‡ºåˆ°æ–‡ä»¶</span>
    fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">"test.log"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_APPEND<span class="token operator">|</span>os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">"create file test.log failed"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> fd<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    l <span class="token operator">:=</span> cuslog<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>cuslog<span class="token punctuation">.</span><span class="token function">WithLevel</span><span class="token punctuation">(</span>cuslog<span class="token punctuation">.</span>InfoLevel<span class="token punctuation">)</span><span class="token punctuation">,</span>
        cuslog<span class="token punctuation">.</span><span class="token function">WithOutput</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span>
        cuslog<span class="token punctuation">.</span><span class="token function">WithFormatter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cuslog<span class="token punctuation">.</span>JsonFormatter<span class="token punctuation">{</span>IgnoreBasicFields<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    l<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"custom log with json formatter"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°†ä¸Šè¿°ä»£ç ä¿å­˜åœ¨main.goæ–‡ä»¶ä¸­ï¼Œè¿è¡Œï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ go run example.go
<span class="token number">2020</span>-12-04T10:32:12+08:00 INFO example.go:11 std log
<span class="token number">2020</span>-12-04T10:32:12+08:00 DEBUG example.go:13 change std log to debug level
<span class="token punctuation">{</span><span class="token string">"file"</span><span class="token builtin class-name">:</span><span class="token string">"/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/log/cuslog/example/example.go:15"</span>,<span class="token string">"func"</span><span class="token builtin class-name">:</span><span class="token string">"main.main"</span>,<span class="token string">"message"</span><span class="token builtin class-name">:</span><span class="token string">"log in json format"</span>,<span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"DEBUG"</span>,<span class="token string">"time"</span><span class="token builtin class-name">:</span><span class="token string">"2020-12-04T10:32:12+08:00"</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">"level"</span><span class="token builtin class-name">:</span><span class="token string">"INFO"</span>,<span class="token string">"time"</span><span class="token builtin class-name">:</span><span class="token string">"2020-12-04T10:32:12+08:00"</span>,<span class="token string">"file"</span><span class="token builtin class-name">:</span><span class="token string">"/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/log/cuslog/example/example.go:16"</span>,<span class="token string">"func"</span><span class="token builtin class-name">:</span><span class="token string">"main.main"</span>,<span class="token string">"message"</span><span class="token builtin class-name">:</span><span class="token string">"another log in json format"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ°è¿™é‡Œæ—¥å¿—åŒ…å°±å¼€å‘å®Œæˆäº†ï¼Œå®Œæ•´åŒ…è§ <a href="https://github.com/marmotedu/gopractise-demo/tree/main/log/cuslog" target="_blank" rel="noopener noreferrer">log/cuslog<ExternalLinkIcon/></a>ã€‚</p>
<h3 id="iamé¡¹ç›®æ—¥å¿—åŒ…è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#iamé¡¹ç›®æ—¥å¿—åŒ…è®¾è®¡" aria-hidden="true">#</a> IAMé¡¹ç›®æ—¥å¿—åŒ…è®¾è®¡</h3>
<p>è¿™ä¸€è®²çš„æœ€åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹æˆ‘ä»¬çš„IAMé¡¹ç›®ä¸­ï¼Œæ—¥å¿—åŒ…æ˜¯æ€ä¹ˆè®¾è®¡çš„ã€‚</p>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹IAMé¡¹ç›®logåŒ…çš„å­˜æ”¾ä½ç½®ï¼š<a href="https://github.com/marmotedu/iam/tree/v1.0.0/pkg/log" target="_blank" rel="noopener noreferrer">pkg/log<ExternalLinkIcon/></a>ã€‚æ”¾åœ¨è¿™ä¸ªä½ç½®ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªï¼Œ<code v-pre>log</code> åŒ…å±äºIAMé¡¹ç›®ï¼Œæœ‰å®šåˆ¶å¼€å‘çš„å†…å®¹ï¼›</li>
<li>ç¬¬äºŒä¸ªï¼Œ<code v-pre>log</code> åŒ…åŠŸèƒ½å®Œå¤‡ã€æˆç†Ÿï¼Œå¤–éƒ¨é¡¹ç›®ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚</li>
</ul>
<p>è¯¥logåŒ…æ˜¯åŸºäº <code v-pre>go.uber.org/zap</code> åŒ…å°è£…è€Œæ¥çš„ï¼Œæ ¹æ®éœ€è¦æ·»åŠ äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡logåŒ…çš„<a href="https://github.com/marmotedu/iam/blob/master/pkg/log/options.go#L47" target="_blank" rel="noopener noreferrer">Options<ExternalLinkIcon/></a>ï¼Œæ¥çœ‹ä¸‹logåŒ…æ‰€å®ç°çš„åŠŸèƒ½ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// Options contains configuration items related to log.</span>
<span class="token keyword">type</span> Options <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	OutputPaths       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"output-paths"       mapstructure:"output-paths"`</span>
	ErrorOutputPaths  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"error-output-paths" mapstructure:"error-output-paths"`</span>
	Level             <span class="token builtin">string</span>   <span class="token string">`json:"level"              mapstructure:"level"`</span>
	Format            <span class="token builtin">string</span>   <span class="token string">`json:"format"             mapstructure:"format"`</span>
	DisableCaller     <span class="token builtin">bool</span>     <span class="token string">`json:"disable-caller"     mapstructure:"disable-caller"`</span>
	DisableStacktrace <span class="token builtin">bool</span>     <span class="token string">`json:"disable-stacktrace" mapstructure:"disable-stacktrace"`</span>
	EnableColor       <span class="token builtin">bool</span>     <span class="token string">`json:"enable-color"       mapstructure:"enable-color"`</span>
	Development       <span class="token builtin">bool</span>     <span class="token string">`json:"development"        mapstructure:"development"`</span>
	Name              <span class="token builtin">string</span>   <span class="token string">`json:"name"               mapstructure:"name"`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Optionså„é…ç½®é¡¹å«ä¹‰å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li>developmentï¼šæ˜¯å¦æ˜¯å¼€å‘æ¨¡å¼ã€‚å¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œä¼šå¯¹DPanicLevelè¿›è¡Œå †æ ˆè·Ÿè¸ªã€‚</li>
<li>nameï¼šLoggerçš„åå­—ã€‚</li>
<li>disable-callerï¼šæ˜¯å¦å¼€å¯ callerï¼Œå¦‚æœå¼€å¯ä¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºè°ƒç”¨æ—¥å¿—æ‰€åœ¨çš„æ–‡ä»¶ã€å‡½æ•°å’Œè¡Œå·ã€‚</li>
<li>disable-stacktraceï¼šæ˜¯å¦åœ¨PanicåŠä»¥ä¸Šçº§åˆ«ç¦æ­¢æ‰“å°å †æ ˆä¿¡æ¯ã€‚</li>
<li>enable-colorï¼šæ˜¯å¦å¼€å¯é¢œè‰²è¾“å‡ºï¼Œtrueï¼Œæ˜¯ï¼›falseï¼Œå¦ã€‚</li>
<li>levelï¼šæ—¥å¿—çº§åˆ«ï¼Œä¼˜å…ˆçº§ä»ä½åˆ°é«˜ä¾æ¬¡ä¸ºï¼šDebug, Info, Warn, Error, Dpanic, Panic, Fatalã€‚</li>
<li>formatï¼šæ”¯æŒçš„æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œç›®å‰æ”¯æŒConsoleå’ŒJSONä¸¤ç§ã€‚Consoleå…¶å®å°±æ˜¯Textæ ¼å¼ã€‚</li>
<li>output-pathsï¼šæ”¯æŒè¾“å‡ºåˆ°å¤šä¸ªè¾“å‡ºï¼Œç”¨é€—å·åˆ†å¼€ã€‚æ”¯æŒè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰å’Œæ–‡ä»¶ã€‚</li>
<li>error-output-pathsï¼šzapå†…éƒ¨(éä¸šåŠ¡)é”™è¯¯æ—¥å¿—è¾“å‡ºè·¯å¾„ï¼Œå¤šä¸ªè¾“å‡ºï¼Œç”¨é€—å·åˆ†å¼€ã€‚</li>
</ul>
<p><strong>logåŒ…çš„Optionsç»“æ„ä½“æ”¯æŒä»¥ä¸‹3ä¸ªæ–¹æ³•ï¼š</strong></p>
<ul>
<li>Buildæ–¹æ³•ã€‚Buildæ–¹æ³•å¯ä»¥æ ¹æ®Optionsæ„å»ºä¸€ä¸ªå…¨å±€çš„Loggerã€‚</li>
<li>AddFlagsæ–¹æ³•ã€‚AddFlagsæ–¹æ³•å¯ä»¥å°†Optionsçš„å„ä¸ªå­—æ®µè¿½åŠ åˆ°ä¼ å…¥çš„pflag.FlagSetå˜é‡ä¸­ã€‚</li>
<li>Stringæ–¹æ³•ã€‚Stringæ–¹æ³•å¯ä»¥å°†Optionsçš„å€¼ä»¥JSONæ ¼å¼å­—ç¬¦ä¸²è¿”å›ã€‚</li>
</ul>
<p><strong>logåŒ…å®ç°äº†ä»¥ä¸‹3ç§æ—¥å¿—è®°å½•æ–¹æ³•ï¼š</strong></p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"This is a info message"</span><span class="token punctuation">,</span> log<span class="token punctuation">.</span><span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"int_key"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"This is a formatted %s message"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">Infow</span><span class="token punctuation">(</span><span class="token string">"Message printed with Infow"</span><span class="token punctuation">,</span> <span class="token string">"X-Request-ID"</span><span class="token punctuation">,</span> <span class="token string">"fbf54504-64da-4088-9b86-67824a7fb508"</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>Info</code> ä½¿ç”¨æŒ‡å®šçš„ <code v-pre>key/value</code> è®°å½•æ—¥å¿—ã€‚<code v-pre>Infof</code> æ ¼å¼åŒ–è®°å½•æ—¥å¿—ã€‚ <code v-pre>Infow</code> ä¹Ÿæ˜¯ä½¿ç”¨æŒ‡å®šçš„ <code v-pre>key/value</code>è®°å½•æ—¥å¿—ï¼Œè·Ÿ <code v-pre>Info</code> çš„åŒºåˆ«æ˜¯ï¼šä½¿ç”¨ <code v-pre>Info</code> éœ€è¦æŒ‡å®šå€¼çš„ç±»å‹ï¼Œé€šè¿‡æŒ‡å®šå€¼çš„æ—¥å¿—ç±»å‹ï¼Œæ—¥å¿—åº“åº•å±‚ä¸éœ€è¦è¿›è¡Œåå°„æ“ä½œï¼Œæ‰€ä»¥ä½¿ç”¨ <code v-pre>Info</code> è®°å½•æ—¥å¿—æ€§èƒ½æœ€é«˜ã€‚</p>
<p>logåŒ…æ”¯æŒéå¸¸ä¸°å¯Œçš„ç±»å‹ï¼Œå…·ä½“ä½ å¯ä»¥å‚è€ƒ <a href="https://github.com/marmotedu/iam/blob/master/pkg/log/types.go#L56" target="_blank" rel="noopener noreferrer">types.go<ExternalLinkIcon/></a>ã€‚</p>
<p><strong>ä¸Šè¿°æ—¥å¿—è¾“å‡ºä¸ºï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token number">2021</span>-07-06 <span class="token number">14</span>:02:07.070 INFO This is a info message <span class="token punctuation">{</span><span class="token string">"int_key"</span><span class="token builtin class-name">:</span> <span class="token number">10</span><span class="token punctuation">}</span>
<span class="token number">2021</span>-07-06 <span class="token number">14</span>:02:07.071 INFO This is a formatted info message
<span class="token number">2021</span>-07-06 <span class="token number">14</span>:02:07.071 INFO Message printed with Infow <span class="token punctuation">{</span><span class="token string">"X-Request-ID"</span><span class="token builtin class-name">:</span> <span class="token string">"fbf54504-64da-4088-9b86-67824a7fb508"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>logåŒ…ä¸ºæ¯ç§çº§åˆ«çš„æ—¥å¿—éƒ½æä¾›äº†3ç§æ—¥å¿—è®°å½•æ–¹å¼ï¼Œä¸¾ä¸ªä¾‹å­ï¼šå‡è®¾æ—¥å¿—æ ¼å¼ä¸º <code v-pre>Xyz</code> ï¼Œåˆ™åˆ†åˆ«æä¾›äº† <code v-pre>Xyz(msg string, fields ...Field)</code> ï¼Œ<code v-pre>Xyzf(format string, v ...interface{})</code> ï¼Œ<code v-pre>Xyzw(msg string, keysAndValues ...interface{})</code> 3ç§æ—¥å¿—è®°å½•æ–¹æ³•ã€‚</p>
<p>å¦å¤–ï¼ŒlogåŒ…ç›¸è¾ƒäºä¸€èˆ¬çš„æ—¥å¿—åŒ…ï¼Œè¿˜æä¾›äº†ä¼—å¤šè®°å½•æ—¥å¿—çš„æ–¹æ³•ã€‚</p>
<p><strong>ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œ</strong> logåŒ…æ”¯æŒV Levelï¼Œå¯ä»¥é€šè¿‡æ•´å‹æ•°å€¼æ¥çµæ´»æŒ‡å®šæ—¥å¿—çº§åˆ«ï¼Œæ•°å€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šä½ã€‚ä¾‹å¦‚ï¼š</p>
<blockquote>
<p>âš ï¸ <code v-pre>V Level</code>æ˜¯æŒ‡åœ¨<code v-pre>glog</code>æ—¥å¿—åº“ä¸­ç”¨äºæ§åˆ¶æ—¥å¿—çº§åˆ«çš„ä¸€ç§æœºåˆ¶ã€‚<code v-pre>glog</code>æ˜¯ä¸€ä¸ª Go è¯­è¨€çš„æ—¥å¿—åº“ï¼Œå¯ä»¥æ–¹ä¾¿åœ°è¿›è¡Œæ—¥å¿—è®°å½•å’Œè¾“å‡ºã€‚</p>
<p><code v-pre>V Level</code>è¡¨ç¤º verbose levelï¼Œå³å†—é•¿ç¨‹åº¦ã€‚åœ¨<code v-pre>glog</code>ä¸­ï¼Œé€šè¿‡è®¾ç½®<code v-pre>V Level</code>çš„å€¼ï¼Œå¯ä»¥æ§åˆ¶æ—¥å¿—çš„è¾“å‡ºçº§åˆ«ã€‚<code v-pre>V Level</code>çš„å–å€¼èŒƒå›´æ˜¯<code v-pre>0~~4</code>ï¼Œå…¶ä¸­0è¡¨ç¤ºåªè¾“å‡ºæ™®é€šæ—¥å¿—ï¼Œ<code v-pre>1~~4</code>è¡¨ç¤ºè¾“å‡ºå¯¹åº”çº§åˆ«çš„è°ƒè¯•ä¿¡æ¯ã€‚</p>
<p><code v-pre>glog</code>ä¸­é€šè¿‡<code v-pre>V()</code>æ–¹æ³•æ¥è®¾ç½®<code v-pre>V Level</code>çš„å€¼ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>glog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"This is a verbose level 1 log message."</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé€šè¿‡<code v-pre>glog.V(1)</code>è®¾ç½®<code v-pre>V Level</code>çš„å€¼ä¸º1ï¼Œç„¶åè°ƒç”¨<code v-pre>Info()</code>æ–¹æ³•è¾“å‡ºä¸€æ¡æ—¥å¿—ã€‚ç”±äº<code v-pre>V Level</code>çš„å€¼ä¸º1ï¼Œå› æ­¤è¿™æ¡æ—¥å¿—ä¼šè¢«è¾“å‡ºã€‚</p>
<p>åœ¨<code v-pre>glog</code>ä¸­ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code v-pre>vmodule</code>é€‰é¡¹æ¥æ§åˆ¶ä¸åŒåŒ…ä¸­çš„æ—¥å¿—è¾“å‡ºçº§åˆ«ã€‚é€šè¿‡è®¾ç½®<code v-pre>vmodule</code>é€‰é¡¹ï¼Œå¯ä»¥å®ç°æ›´ç»†ç²’åº¦çš„æ—¥å¿—æ§åˆ¶ã€‚ä¾‹å¦‚ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ go run main.go <span class="token parameter variable">-vmodule</span><span class="token operator">=</span>module1<span class="token operator">=</span><span class="token number">2</span>,module2<span class="token operator">=</span><span class="token number">3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé€šè¿‡è®¾ç½®<code v-pre>vmodule</code>é€‰é¡¹æ¥æ§åˆ¶<code v-pre>module1</code>åŒ…ä¸­çš„æ—¥å¿—è¾“å‡ºçº§åˆ«ä¸º2ï¼Œ<code v-pre>module2</code>åŒ…ä¸­çš„æ—¥å¿—è¾“å‡ºçº§åˆ«ä¸º3ã€‚è¿™æ ·ï¼Œå°±å¯ä»¥æ›´åŠ çµæ´»åœ°æ§åˆ¶æ—¥å¿—çš„è¾“å‡ºçº§åˆ«ï¼Œä»¥é€‚åº”ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚</p>
</blockquote>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// V levelä½¿ç”¨</span>
log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"This is a V level message"</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"This is a %s V level message"</span><span class="token punctuation">,</span> <span class="token string">"formatted"</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infow</span><span class="token punctuation">(</span><span class="token string">"This is a V level message with fields"</span><span class="token punctuation">,</span> <span class="token string">"X-Request-ID"</span><span class="token punctuation">,</span> <span class="token string">"7a7b9f24-4cae-4b2a-9464-69088b45b904"</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œè¦æ³¨æ„ï¼ŒLog.Våªæ”¯æŒ <code v-pre>Info</code> ã€<code v-pre>Infof</code> ã€<code v-pre>Infow</code>ä¸‰ç§æ—¥å¿—è®°å½•æ–¹æ³•ã€‚</p>
<p><strong>ç¬¬äºŒä¸ªæ–¹æ³•ï¼Œ</strong> logåŒ…æ”¯æŒWithValueså‡½æ•°ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// WithValuesä½¿ç”¨</span>
lv <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">WithValues</span><span class="token punctuation">(</span><span class="token string">"X-Request-ID"</span><span class="token punctuation">,</span> <span class="token string">"7a7b9f24-4cae-4b2a-9464-69088b45b904"</span><span class="token punctuation">)</span>
lv<span class="token punctuation">.</span><span class="token function">Infow</span><span class="token punctuation">(</span><span class="token string">"Info message printed with [WithValues] logger"</span><span class="token punctuation">)</span>
lv<span class="token punctuation">.</span><span class="token function">Infow</span><span class="token punctuation">(</span><span class="token string">"Debug message printed with [WithValues] logger"</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¸Šè¿°æ—¥å¿—è¾“å‡ºå¦‚ä¸‹ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token number">2021</span>-07-06 <span class="token number">14</span>:15:28.555 INFO Info message printed with <span class="token punctuation">[</span>WithValues<span class="token punctuation">]</span> logger <span class="token punctuation">{</span><span class="token string">"X-Request-ID"</span><span class="token builtin class-name">:</span> <span class="token string">"7a7b9f24-4cae-4b2a-9464-69088b45b904"</span><span class="token punctuation">}</span>
<span class="token number">2021</span>-07-06 <span class="token number">14</span>:15:28.556 INFO Debug message printed with <span class="token punctuation">[</span>WithValues<span class="token punctuation">]</span> logger <span class="token punctuation">{</span><span class="token string">"X-Request-ID"</span><span class="token builtin class-name">:</span> <span class="token string">"7a7b9f24-4cae-4b2a-9464-69088b45b904"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>WithValues</code> å¯ä»¥è¿”å›ä¸€ä¸ªæºå¸¦æŒ‡å®škey-valueçš„Loggerï¼Œä¾›åé¢ä½¿ç”¨ã€‚</p>
<p><strong>ç¬¬ä¸‰ä¸ªæ–¹æ³•ï¼Œ</strong> logåŒ…æä¾› <code v-pre>WithContext</code> å’Œ <code v-pre>FromContext</code> ç”¨æ¥å°†æŒ‡å®šçš„Loggeræ·»åŠ åˆ°æŸä¸ªContextä¸­ï¼Œä»¥åŠä»æŸä¸ªContextä¸­è·å–Loggerï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// Contextä½¿ç”¨</span>
ctx <span class="token operator">:=</span> lv<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
lc <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
lc<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Message printed with [WithContext] logger"</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>WithContext</code>å’Œ<code v-pre>FromContext</code>éå¸¸é€‚åˆç”¨åœ¨ä»¥<code v-pre>context.Context</code>ä¼ é€’çš„å‡½æ•°ä¸­ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
    <span class="token operator">...</span>
 
    <span class="token comment">// WithValuesä½¿ç”¨</span>
    lv <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">WithValues</span><span class="token punctuation">(</span><span class="token string">"X-Request-ID"</span><span class="token punctuation">,</span> <span class="token string">"7a7b9f24-4cae-4b2a-9464-69088b45b904"</span><span class="token punctuation">)</span>
     
    <span class="token comment">// Contextä½¿ç”¨</span>
    lv<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Start to call pirntString"</span><span class="token punctuation">)</span>
    ctx <span class="token operator">:=</span> lv<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">pirntString</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"World"</span><span class="token punctuation">)</span>  
<span class="token punctuation">}</span>
 
<span class="token keyword">func</span> <span class="token function">pirntString</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lc <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    lc<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Hello %s"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>2021-07-06 14:38:02.050 INFO Start to call pirntString {"X-Request-ID": "7a7b9f24-4cae-4b2a-9464-69088b45b904"}
2021-07-06 14:38:02.050 INFO Hello World {"X-Request-ID": "7a7b9f24-4cae-4b2a-9464-69088b45b904"}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å°†Loggeræ·»åŠ åˆ°Contextä¸­ï¼Œå¹¶é€šè¿‡Contextåœ¨ä¸åŒå‡½æ•°é—´ä¼ é€’ï¼Œå¯ä»¥ä½¿key-valueåœ¨ä¸åŒå‡½æ•°é—´ä¼ é€’ã€‚ä¾‹å¦‚ä¸Šè¿°ä»£ç ä¸­ï¼Œ <code v-pre>X-Request-ID</code> åœ¨mainå‡½æ•°ã€printStringå‡½æ•°ä¸­çš„æ—¥å¿—è¾“å‡ºä¸­å‡æœ‰è®°å½•ï¼Œä»è€Œå®ç°äº†ä¸€ç§è°ƒç”¨é“¾çš„æ•ˆæœã€‚</p>
<p><strong>ç¬¬å››ä¸ªæ–¹æ³•ï¼Œ</strong> å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä»Contextä¸­æå–å‡ºæŒ‡å®šçš„key-valueï¼Œä½œä¸ºä¸Šä¸‹æ–‡æ·»åŠ åˆ°æ—¥å¿—è¾“å‡ºä¸­ï¼Œä¾‹å¦‚ <a href="https://github.com/marmotedu/iam/blob/v1.0.0/internal/apiserver/api/v1/user/create.go#L20" target="_blank" rel="noopener noreferrer">internal/apiserver/api/v1/user/create.go<ExternalLinkIcon/></a>æ–‡ä»¶ä¸­çš„æ—¥å¿—è°ƒç”¨ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// Info logs a message at level Info on the compatibleLogger.</span>
log<span class="token punctuation">.</span><span class="token function">L</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"user create function called."</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡è°ƒç”¨ <code v-pre>Log.L()</code> å‡½æ•°ï¼Œå®ç°å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token comment">// L method output with specified context value.</span>
<span class="token keyword">func</span> <span class="token function">L</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">*</span>zapLogger <span class="token punctuation">{</span>
    <span class="token keyword">return</span> std<span class="token punctuation">.</span><span class="token function">L</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>zapLogger<span class="token punctuation">)</span> <span class="token function">L</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">*</span>zapLogger <span class="token punctuation">{</span>
    lg <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
    requestID<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>KeyRequestID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
    username<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>KeyUsername<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
    lg<span class="token punctuation">.</span>zapLogger <span class="token operator">=</span> lg<span class="token punctuation">.</span>zapLogger<span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>KeyRequestID<span class="token punctuation">,</span> requestID<span class="token punctuation">)</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>KeyUsername<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span>
 
    <span class="token keyword">return</span> lg
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>L()</code> æ–¹æ³•ä¼šä»ä¼ å…¥çš„Contextä¸­æå–å‡º <code v-pre>requestID</code> å’Œ <code v-pre>username</code> ï¼Œè¿½åŠ åˆ°Loggerä¸­ï¼Œå¹¶è¿”å›Loggerã€‚è¿™æ—¶å€™è°ƒç”¨è¯¥Loggerçš„Infoã€Infofã€Infowç­‰æ–¹æ³•è®°å½•æ—¥å¿—ï¼Œè¾“å‡ºçš„æ—¥å¿—ä¸­å‡åŒ…å« <code v-pre>requestID</code> å’Œ <code v-pre>username</code> å­—æ®µï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token number">2021</span>-07-06 <span class="token number">14</span>:46:00.743 INFO    apiserver       secret/create.go:23     create secret <span class="token keyword">function</span> called.  <span class="token punctuation">{</span><span class="token string">"requestID"</span><span class="token builtin class-name">:</span> <span class="token string">"73144bed-534d-4f68-8e8d-dc8a8ed48507"</span>, <span class="token string">"username"</span><span class="token builtin class-name">:</span> <span class="token string">"admin"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>é€šè¿‡å°†Contextåœ¨å‡½æ•°é—´ä¼ é€’ï¼Œå¾ˆå®¹æ˜“å°±èƒ½å®ç°è°ƒç”¨é“¾æ•ˆæœï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// Create add new secret key pairs to the storage.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>SecretHandler<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">L</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"create secret function called."</span><span class="token punctuation">)</span>
     
    <span class="token operator">...</span>
     
    secrets<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>srv<span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> username<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>    
        Offset<span class="token punctuation">:</span> pointer<span class="token punctuation">.</span><span class="token function">ToInt64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Limit<span class="token punctuation">:</span>  pointer<span class="token punctuation">.</span><span class="token function">ToInt64</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
     
    <span class="token operator">...</span>
     
     <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>srv<span class="token punctuation">.</span><span class="token function">Secrets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> err<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
 
    core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç è¾“å‡ºä¸ºï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token number">2021</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">46</span><span class="token punctuation">:</span><span class="token number">00.743</span> INFO    apiserver       secret<span class="token operator">/</span>create<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">23</span>     create secret function called<span class="token punctuation">.</span>  <span class="token punctuation">{</span><span class="token string">"requestID"</span><span class="token punctuation">:</span> <span class="token string">"73144bed-534d-4f68-8e8d-dc8a8ed48507"</span><span class="token punctuation">,</span> <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">}</span>
<span class="token number">2021</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">46</span><span class="token punctuation">:</span><span class="token number">00.744</span> INFO    apiserver       secret<span class="token operator">/</span>create<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">23</span>     list secret from storage<span class="token punctuation">.</span>  <span class="token punctuation">{</span><span class="token string">"requestID"</span><span class="token punctuation">:</span> <span class="token string">"73144bed-534d-4f68-8e8d-dc8a8ed48507"</span><span class="token punctuation">,</span> <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">}</span>
<span class="token number">2021</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">46</span><span class="token punctuation">:</span><span class="token number">00.745</span> INFO    apiserver       secret<span class="token operator">/</span>create<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">23</span>     insert secret to storage<span class="token punctuation">.</span>  <span class="token punctuation">{</span><span class="token string">"requestID"</span><span class="token punctuation">:</span> <span class="token string">"73144bed-534d-4f68-8e8d-dc8a8ed48507"</span><span class="token punctuation">,</span> <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œè¦æ³¨æ„ï¼Œ <code v-pre>log.L</code> å‡½æ•°é»˜è®¤ä¼šä»Contextä¸­å– <code v-pre>requestID</code> å’Œ <code v-pre>username</code> é”®ï¼Œè¿™è·ŸIAMé¡¹ç›®æœ‰è€¦åˆåº¦ï¼Œä½†è¿™ä¸å½±å“<code v-pre>log</code>åŒ…ä¾›ç¬¬ä¸‰æ–¹é¡¹ç›®ä½¿ç”¨ã€‚è¿™ä¹Ÿæ˜¯æˆ‘å»ºè®®ä½ è‡ªå·±å°è£…æ—¥å¿—åŒ…çš„åŸå› ã€‚</p>
<h3 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h3>
<p>å¼€å‘ä¸€ä¸ªæ—¥å¿—åŒ…ï¼Œæˆ‘ä»¬å¾ˆå¤šæ—¶å€™éœ€è¦åŸºäºä¸€äº›ä¸šç•Œä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚å½“å‰å¾ˆå¤šé¡¹ç›®çš„æ—¥å¿—åŒ…éƒ½æ˜¯åŸºäº<code v-pre>zap</code>æ—¥å¿—åŒ…æ¥å°è£…çš„ï¼Œå¦‚æœä½ æœ‰å°è£…çš„éœ€è¦ï¼Œæˆ‘å»ºè®®ä½ ä¼˜å…ˆé€‰æ‹©zapæ—¥å¿—åŒ…ã€‚</p>
<p>è¿™ä¸€è®²ä¸­ï¼Œæˆ‘å…ˆç»™ä½ ä»‹ç»äº†æ ‡å‡†åº“logåŒ…ã€glogã€logruså’Œzapè¿™å››ç§å¸¸ç”¨çš„æ—¥å¿—åŒ…ï¼Œç„¶åå‘ä½ å±•ç°äº†å¼€å‘ä¸€ä¸ªæ—¥å¿—åŒ…çš„å››ä¸ªæ­¥éª¤ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>å®šä¹‰æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—é€‰é¡¹ã€‚</li>
<li>åˆ›å»ºLoggeråŠå„çº§åˆ«æ—¥å¿—æ‰“å°æ–¹æ³•ã€‚</li>
<li>å°†æ—¥å¿—è¾“å‡ºåˆ°æ”¯æŒçš„è¾“å‡ºä¸­ã€‚</li>
<li>è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼ã€‚</li>
</ol>
<p>æœ€åï¼Œæˆ‘ä»‹ç»äº†IAMé¡¹ç›®å°è£…çš„logåŒ…çš„è®¾è®¡å’Œä½¿ç”¨æ–¹å¼ã€‚logåŒ…åŸºäº <code v-pre>go.uber.org/zap</code>å°è£…ï¼Œå¹¶æä¾›äº†ä»¥ä¸‹å¼ºå¤§ç‰¹æ€§ï¼š</p>
<ul>
<li>logåŒ…æ”¯æŒV Levelï¼Œå¯ä»¥çµæ´»çš„é€šè¿‡æ•´å‹æ•°å€¼æ¥æŒ‡å®šæ—¥å¿—çº§åˆ«ã€‚</li>
<li>logåŒ…æ”¯æŒ <code v-pre>WithValues</code> å‡½æ•°ï¼Œ <code v-pre>WithValues</code> å¯ä»¥è¿”å›ä¸€ä¸ªæºå¸¦æŒ‡å®škey-valueå¯¹çš„Loggerï¼Œä¾›åé¢ä½¿ç”¨ã€‚</li>
<li>logåŒ…æä¾› <code v-pre>WithContext</code> å’Œ <code v-pre>FromContext</code> ç”¨æ¥å°†æŒ‡å®šçš„Loggeræ·»åŠ åˆ°æŸä¸ªContextä¸­å’Œä»æŸä¸ªContextä¸­è·å–Loggerã€‚</li>
<li>logåŒ…æä¾›äº† <code v-pre>Log.L()</code> å‡½æ•°ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ä»Contextä¸­æå–å‡ºæŒ‡å®šçš„key-valueå¯¹ï¼Œä½œä¸ºä¸Šä¸‹æ–‡æ·»åŠ åˆ°æ—¥å¿—è¾“å‡ºä¸­ã€‚</li>
</ul>
<h3 id="è¯¾åç»ƒä¹ " tabindex="-1"><a class="header-anchor" href="#è¯¾åç»ƒä¹ " aria-hidden="true">#</a> è¯¾åç»ƒä¹ </h3>
<ol>
<li>å°è¯•å®ç°ä¸€ä¸ªæ–°çš„Formatterï¼Œå¯ä»¥ä½¿ä¸åŒæ—¥å¿—çº§åˆ«ä»¥ä¸åŒé¢œè‰²è¾“å‡ºï¼ˆä¾‹å¦‚ï¼šErrorçº§åˆ«çš„æ—¥å¿—è¾“å‡ºä¸­ <code v-pre>Error</code> å­—ç¬¦ä¸²ç”¨çº¢è‰²å­—ä½“è¾“å‡ºï¼Œ <code v-pre>Info</code> å­—ç¬¦ä¸²ç”¨ç™½è‰²å­—ä½“è¾“å‡ºï¼‰ã€‚</li>
<li>å°è¯•å°†<a href="https://github.com/marmotedu/gopractise-demo/blob/master/log/cuslog/entry.go#L36" target="_blank" rel="noopener noreferrer">runtime.Caller(2)<ExternalLinkIcon/></a>å‡½æ•°è°ƒç”¨ä¸­çš„ <code v-pre>2</code> æ”¹æˆ <code v-pre>1</code> ï¼Œçœ‹çœ‹æ—¥å¿—è¾“å‡ºæ˜¯å¦è·Ÿä¿®æ”¹å‰æœ‰å·®å¼‚ï¼Œå¦‚æœæœ‰å·®å¼‚ï¼Œæ€è€ƒå·®å¼‚äº§ç”Ÿçš„åŸå› ã€‚</li>
</ol>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '12.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '14.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/projects/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


