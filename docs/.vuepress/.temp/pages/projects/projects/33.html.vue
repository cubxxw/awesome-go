<template><div><ul>
<li><a href="https://github.com/cubxxw/iam" target="_blank" rel="noopener noreferrer">ğŸ”¥ å¼€æºåœ°å€<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬33èŠ‚-è½¯ä»¶éƒ¨ç½²å®æˆ˜-ä¸­-iam-ç³»ç»Ÿç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®æˆ˜" tabindex="-1"><a class="header-anchor" href="#ç¬¬33èŠ‚-è½¯ä»¶éƒ¨ç½²å®æˆ˜-ä¸­-iam-ç³»ç»Ÿç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®æˆ˜" aria-hidden="true">#</a> ç¬¬33èŠ‚ è½¯ä»¶éƒ¨ç½²å®æˆ˜ï¼ˆä¸­ï¼‰ï¼šIAM ç³»ç»Ÿç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®æˆ˜</h1>
<br>
<div><a href = '32.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '34.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<nav class="table-of-contents"><ul><li><router-link to="#éƒ¨ç½²iamåº”ç”¨">éƒ¨ç½²IAMåº”ç”¨</router-link><ul><li><router-link to="#åœ¨10-0-4-20æœåŠ¡å™¨ä¸Šéƒ¨ç½²iamåº”ç”¨">åœ¨10.0.4.20æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨</router-link></li><li><router-link to="#åœ¨10-0-4-21æœåŠ¡å™¨ä¸Šéƒ¨ç½²iamåº”ç”¨">åœ¨10.0.4.21æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨</router-link></li></ul></li><li><router-link to="#é…ç½®nginxä½œä¸ºåå‘ä»£ç†">é…ç½®Nginxä½œä¸ºåå‘ä»£ç†</router-link></li><li><router-link to="#é…ç½®nginxä½œä¸ºè´Ÿè½½å‡è¡¡">é…ç½®Nginxä½œä¸ºè´Ÿè½½å‡è¡¡</router-link><ul><li><router-link to="#_10-0-4-20æœåŠ¡å™¨é…ç½®">10.0.4.20æœåŠ¡å™¨é…ç½®</router-link></li><li><router-link to="#_10-0-4-21æœåŠ¡å™¨é…ç½®">10.0.4.21æœåŠ¡å™¨é…ç½®</router-link></li><li><router-link to="#æµ‹è¯•è´Ÿè½½å‡è¡¡">æµ‹è¯•è´Ÿè½½å‡è¡¡</router-link></li></ul></li><li><router-link to="#é…ç½®keepalived">é…ç½®Keepalived</router-link><ul><li><router-link to="#ç¬¬ä¸€æ­¥-åˆ›å»ºè…¾è®¯äº‘havip">ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè…¾è®¯äº‘HAVIP</router-link></li><li><router-link to="#ç¬¬äºŒæ­¥-ä¸»æœåŠ¡å™¨é…ç½®">ç¬¬äºŒæ­¥ï¼šä¸»æœåŠ¡å™¨é…ç½®</router-link></li><li><router-link to="#ç¬¬ä¸‰æ­¥-å¤‡æœåŠ¡å™¨é…ç½®">ç¬¬ä¸‰æ­¥ï¼šå¤‡æœåŠ¡å™¨é…ç½®</router-link></li><li><router-link to="#ç¬¬å››æ­¥-æµ‹è¯•keepalived">ç¬¬å››æ­¥ï¼šæµ‹è¯•Keepalived</router-link></li><li><router-link to="#ç¬¬äº”æ­¥-vipç»‘å®šå…¬ç½‘ip">ç¬¬äº”æ­¥ï¼šVIPç»‘å®šå…¬ç½‘IP</router-link></li><li><router-link to="#ç¬¬å…­æ­¥-æµ‹è¯•å…¬ç½‘è®¿é—®">ç¬¬å…­æ­¥ï¼šæµ‹è¯•å…¬ç½‘è®¿é—®</router-link></li></ul></li><li><router-link to="#æ€»ç»“">æ€»ç»“</router-link></li><li><router-link to="#è¯¾åç»ƒä¹ ">è¯¾åç»ƒä¹ </router-link></li><li><router-link to="#end-é“¾æ¥">END é“¾æ¥</router-link></li></ul></nav>
<p>[TOC]</p>
<p>ä¸Šä¸€è®²ï¼Œæˆ‘ä»‹ç»äº†IAMéƒ¨ç½²ç”¨åˆ°çš„ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼ŒNginxå’ŒKeepalivedã€‚é‚£ä¹ˆè¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨Nginxå’ŒKeepalivedæ¥éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„IAMåº”ç”¨ã€‚ä¸‹ä¸€è®²ï¼Œæˆ‘å†ä»‹ç»ä¸‹IAMåº”ç”¨å®‰å…¨å’Œå¼¹æ€§ä¼¸ç¼©èƒ½åŠ›çš„æ„å»ºæ–¹å¼ã€‚</p>
<p>è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ä¸‹é¢å››ä¸ªæ­¥éª¤æ¥éƒ¨ç½²IAMåº”ç”¨ï¼š</p>
<ol>
<li>åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨ä¸­çš„æœåŠ¡ã€‚</li>
<li>é…ç½®Nginxï¼Œå®ç°åå‘ä»£ç†åŠŸèƒ½ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Nginxæ¥è®¿é—®éƒ¨ç½²åœ¨å†…ç½‘çš„IAMæœåŠ¡ã€‚</li>
<li>é…ç½®Nginxï¼Œå®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚é€šè¿‡è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æœåŠ¡çš„æ°´å¹³æ‰©ç¼©å®¹ï¼Œä½¿IAMåº”ç”¨å…·å¤‡é«˜å¯ç”¨èƒ½åŠ›ã€‚</li>
<li>é…ç½®Keepalivedï¼Œå®ç°Nginxçš„é«˜å¯ç”¨ã€‚é€šè¿‡Nginx + Keepalivedçš„ç»„åˆï¼Œå¯ä»¥å®ç°æ•´ä¸ªåº”ç”¨æ¶æ„çš„é«˜å¯ç”¨ã€‚</li>
</ol>
<h2 id="éƒ¨ç½²iamåº”ç”¨" tabindex="-1"><a class="header-anchor" href="#éƒ¨ç½²iamåº”ç”¨" aria-hidden="true">#</a> éƒ¨ç½²IAMåº”ç”¨</h2>
<p>éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„IAMåº”ç”¨ï¼Œéœ€è¦è‡³å°‘ä¸¤ä¸ªèŠ‚ç‚¹ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æŒ‰ç…§å…ˆåé¡ºåºï¼Œåˆ†åˆ«åœ¨<code v-pre>10.0.4.20</code>å’Œ<code v-pre>10.0.4.21</code>æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨ã€‚</p>
<h3 id="åœ¨10-0-4-20æœåŠ¡å™¨ä¸Šéƒ¨ç½²iamåº”ç”¨" tabindex="-1"><a class="header-anchor" href="#åœ¨10-0-4-20æœåŠ¡å™¨ä¸Šéƒ¨ç½²iamåº”ç”¨" aria-hidden="true">#</a> åœ¨<code v-pre>10.0.4.20</code>æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨</h3>
<p>é¦–å…ˆï¼Œæˆ‘æ¥ä»‹ç»ä¸‹å¦‚ä½•åœ¨<code v-pre>10.0.4.20</code>æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨ã€‚</p>
<p>æˆ‘ä»¬è¦åœ¨è¿™ä¸ªæœåŠ¡å™¨ä¸Šéƒ¨ç½²å¦‚ä¸‹ç»„ä»¶ï¼š</p>
<ul>
<li>iam-apiserver</li>
<li>iam-authz-server</li>
<li>iam-pump</li>
<li>MariaDB</li>
<li>Redis</li>
<li>MongoDB</li>
</ul>
<p>è¿™äº›ç»„ä»¶çš„éƒ¨ç½²æ–¹å¼ï¼Œ<a href="https://time.geekbang.org/column/article/378082" target="_blank" rel="noopener noreferrer">03è®²<ExternalLinkIcon/></a> æœ‰ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸å†è¯´æ˜ã€‚</p>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®¾ç½®MariaDBï¼Œç»™æ¥è‡ªäº<code v-pre>10.0.4.21</code>æœåŠ¡å™¨çš„æ•°æ®åº“è¿æ¥æˆæƒï¼Œæˆæƒå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ mysql <span class="token parameter variable">-hlocalhost</span> <span class="token parameter variable">-P3306</span> <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-proot</span> <span class="token comment"># å…ˆä»¥rootç”¨æˆ·ç™»é™†æ•°æ®åº“</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> grant all on iam.* TO iam@10.0.4.21 identified by <span class="token string">'iam1234'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> flush privileges<span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åœ¨10-0-4-21æœåŠ¡å™¨ä¸Šéƒ¨ç½²iamåº”ç”¨" tabindex="-1"><a class="header-anchor" href="#åœ¨10-0-4-21æœåŠ¡å™¨ä¸Šéƒ¨ç½²iamåº”ç”¨" aria-hidden="true">#</a> åœ¨<code v-pre>10.0.4.21</code>æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨</h3>
<p>ç„¶åï¼Œåœ¨<code v-pre>10.0.4.21</code>æœåŠ¡å™¨ä¸Šå®‰è£…å¥½iam-apiserverã€iam-authz-server å’Œ iam-pumpã€‚è¿™äº›ç»„ä»¶é€šè¿‡<code v-pre>10.0.4.20</code> IPåœ°å€ï¼Œè¿æ¥<code v-pre>10.0.4.20</code>æœåŠ¡å™¨ä¸Šçš„MariaDBã€Rediså’ŒMongoDBã€‚</p>
<h2 id="é…ç½®nginxä½œä¸ºåå‘ä»£ç†" tabindex="-1"><a class="header-anchor" href="#é…ç½®nginxä½œä¸ºåå‘ä»£ç†" aria-hidden="true">#</a> é…ç½®Nginxä½œä¸ºåå‘ä»£ç†</h2>
<p>å‡å®šè¦è®¿é—®çš„API Serverå’ŒIAM Authorization Serverçš„åŸŸååˆ†åˆ«ä¸º<code v-pre>iam.api.marmotedu.com</code>å’Œ<code v-pre>iam.authz.marmotedu.com</code>ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«ä¸ºiam-apiserverå’Œiam-authz-serveré…ç½®Nginxåå‘ä»£ç†ã€‚æ•´ä¸ªé…ç½®è¿‡ç¨‹å¯ä»¥åˆ†ä¸º5æ­¥ï¼ˆåœ¨<code v-pre>10.0.4.20</code>æœåŠ¡å™¨ä¸Šæ“ä½œï¼‰ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼Œé…ç½®iam-apiserverã€‚</strong></p>
<p>æ–°å»ºNginxé…ç½®æ–‡ä»¶<code v-pre>/etc/nginx/conf.d/iam-apiserver.conf</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  iam.api.marmotedu.com<span class="token punctuation">;</span>
    root         /usr/share/nginx/html<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
      proxy_set_header X-Forwarded-Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_pass  http://127.0.0.1:8080/<span class="token punctuation">;</span>
      client_max_body_size 5m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">404</span> /404.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /40x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /50x.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ‰å‡ ç‚¹ä½ åœ¨é…ç½®æ—¶éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œè¯´æ˜ä¸‹ã€‚</p>
<ul>
<li><code v-pre>server_name</code>éœ€è¦ä¸º<code v-pre>iam.api.marmotedu.com</code>ï¼Œæˆ‘ä»¬é€šè¿‡<code v-pre>iam.api.marmotedu.com</code>è®¿é—®iam-apiserverã€‚</li>
<li>iam-apiserveré»˜è®¤å¯åŠ¨çš„ç«¯å£ä¸º<code v-pre>8080</code>ã€‚</li>
<li>ç”±äºNginxé»˜è®¤å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°ä¸º<code v-pre>1MB</code>ï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½å¤ªå°ï¼Œæ‰€ä»¥è¿™é‡Œå°†æ­¤é™åˆ¶æ”¹ä¸º5MBï¼ˆ<code v-pre>client_max_body_size 5m</code>ï¼‰ã€‚å¦‚æœéœ€è¦ä¸Šä¼ å›¾ç‰‡ä¹‹ç±»çš„ï¼Œå¯èƒ½éœ€è¦è®¾ç½®æˆæ›´å¤§çš„å€¼ï¼Œæ¯”å¦‚<code v-pre>50m</code>ã€‚</li>
<li>server_nameç”¨æ¥è¯´æ˜è®¿é—®NginxæœåŠ¡å™¨çš„åŸŸåï¼Œä¾‹å¦‚<code v-pre>curl -H 'Host: iam.api.marmotedu.com' http://x.x.x.x:80/healthz</code>ï¼Œ<code v-pre>x.x.x.x</code>ä¸ºNginxæœåŠ¡å™¨çš„IPåœ°å€ã€‚</li>
<li>proxy_passè¡¨ç¤ºåå‘ä»£ç†çš„è·¯å¾„ã€‚å› ä¸ºè¿™é‡Œæ˜¯æœ¬æœºçš„iam-apiserveræœåŠ¡ï¼Œæ‰€ä»¥IPä¸º<code v-pre>127.0.0.1</code>ã€‚ç«¯å£è¦å’ŒAPIæœåŠ¡ç«¯å£ä¸€è‡´ï¼Œä¸º<code v-pre>8080</code>ã€‚</li>
</ul>
<p>æœ€åè¿˜è¦æé†’ä¸‹ï¼Œå› ä¸º Nginx é…ç½®é€‰é¡¹æ¯”è¾ƒå¤šï¼Œè·Ÿå®é™…éœ€æ±‚å’Œç¯å¢ƒæœ‰å…³ï¼Œæ‰€ä»¥è¿™é‡Œçš„é…ç½®æ˜¯åŸºç¡€çš„ã€æœªç»ä¼˜åŒ–çš„é…ç½®ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦ä½ å†åšè°ƒèŠ‚ã€‚</p>
<p><strong>ç¬¬äºŒæ­¥ï¼Œé…ç½®iam-authz-serverã€‚</strong></p>
<p>æ–°å»ºNginxé…ç½®æ–‡ä»¶<code v-pre>/etc/nginx/conf.d/iam-authz-server.conf</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  iam.authz.marmotedu.com<span class="token punctuation">;</span>
    root         /usr/share/nginx/html<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
      proxy_set_header X-Forwarded-Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_pass  http://127.0.0.1:9090/<span class="token punctuation">;</span>
      client_max_body_size 5m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">404</span> /404.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /40x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /50x.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ˜¯ä¸€äº›é…ç½®è¯´æ˜ã€‚</p>
<ul>
<li>server_nameéœ€è¦ä¸º<code v-pre>iam.authz.marmotedu.com</code>ï¼Œæˆ‘ä»¬é€šè¿‡<code v-pre>iam.authz.marmotedu.com</code>è®¿é—®iam-authz-serverã€‚</li>
<li>iam-authz-serveré»˜è®¤å¯åŠ¨çš„ç«¯å£ä¸º<code v-pre>9090</code>ã€‚</li>
<li>å…¶ä»–é…ç½®è·Ÿ<code v-pre>/etc/nginx/conf.d/iam-apiserver.conf</code>ä¸€è‡´ã€‚</li>
</ul>
<p><strong>ç¬¬ä¸‰æ­¥ï¼Œé…ç½®å®ŒNginxåï¼Œé‡å¯Nginxï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl restart nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>ç¬¬å››æ­¥ï¼Œåœ¨/etc/hostsä¸­è¿½åŠ ä¸‹é¢ä¸¤è¡Œï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token number">127.0</span>.0.1 iam.api.marmotedu.com
<span class="token number">127.0</span>.0.1 iam.authz.marmotedu.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç¬¬äº”æ­¥ï¼Œå‘é€HTTPè¯·æ±‚ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> http://iam.api.marmotedu.com/healthz
<span class="token punctuation">{</span><span class="token string">"status"</span><span class="token builtin class-name">:</span><span class="token string">"ok"</span><span class="token punctuation">}</span>
$ <span class="token function">curl</span> http://iam.authz.marmotedu.com/healthz
<span class="token punctuation">{</span><span class="token string">"status"</span><span class="token builtin class-name">:</span><span class="token string">"ok"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬åˆ†åˆ«è¯·æ±‚iam-apiserverå’Œiam-authz-serverçš„å¥åº·æ£€æŸ¥æ¥å£ï¼Œè¾“å‡ºäº†<code v-pre>{&quot;status&quot;:&quot;ok&quot;}</code>ï¼Œè¯´æ˜æˆ‘ä»¬å¯ä»¥æˆåŠŸé€šè¿‡ä»£ç†è®¿é—®åç«¯çš„APIæœåŠ¡ã€‚</p>
<p>åœ¨ç”¨curlè¯·æ±‚<code v-pre>http://iam.api.marmotedu.com/healthz</code>åï¼Œåç«¯çš„è¯·æ±‚æµç¨‹å®é™…ä¸Šæ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li>å› ä¸ºåœ¨<code v-pre>/etc/hosts</code>ä¸­é…ç½®äº†<code v-pre>127.0.0.1 iam.api.marmotedu.com</code>ï¼Œæ‰€ä»¥è¯·æ±‚<code v-pre>http://iam.api.marmotedu.com/healthz</code>å®é™…ä¸Šæ˜¯è¯·æ±‚æœ¬æœºçš„Nginxç«¯å£ï¼ˆ<code v-pre>127.0.0.1:80</code>ï¼‰ã€‚</li>
<li>Nginxåœ¨æ”¶åˆ°è¯·æ±‚åï¼Œä¼šè§£æè¯·æ±‚ï¼Œå¾—åˆ°è¯·æ±‚åŸŸåä¸º<code v-pre>iam.api.marmotedu.com</code>ã€‚æ ¹æ®è¯·æ±‚åŸŸåå»åŒ¹é… Nginxçš„serveré…ç½®ï¼ŒåŒ¹é…åˆ°<code v-pre>server_name iam.api.marmotedu.com;</code>é…ç½®ã€‚</li>
<li>åŒ¹é…åˆ°serveråï¼ŒæŠŠè¯·æ±‚è½¬å‘åˆ°è¯¥serverçš„<code v-pre>proxy_pass</code>è·¯å¾„ã€‚</li>
<li>ç­‰å¾…APIæœåŠ¡å™¨è¿”å›ç»“æœï¼Œå¹¶è¿”å›å®¢æˆ·ç«¯ã€‚</li>
</ol>
<h2 id="é…ç½®nginxä½œä¸ºè´Ÿè½½å‡è¡¡" tabindex="-1"><a class="header-anchor" href="#é…ç½®nginxä½œä¸ºè´Ÿè½½å‡è¡¡" aria-hidden="true">#</a> é…ç½®Nginxä½œä¸ºè´Ÿè½½å‡è¡¡</h2>
<p>è¿™é—¨è¯¾é‡‡ç”¨Nginxè½®è¯¢çš„è´Ÿè½½å‡è¡¡ç­–ç•¥è½¬å‘è¯·æ±‚ã€‚è´Ÿè½½å‡è¡¡éœ€è¦è‡³å°‘ä¸¤å°æœåŠ¡å™¨ï¼Œæ‰€ä»¥ä¼šåˆ†åˆ«åœ¨<code v-pre>10.0.4.20</code>å’Œ<code v-pre>10.0.4.21</code>æœåŠ¡å™¨ä¸Šæ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚ä¸‹é¢æˆ‘åˆ†åˆ«æ¥ä»‹ç»ä¸‹å¦‚ä½•é…ç½®è¿™ä¸¤å°æœåŠ¡å™¨ï¼Œå¹¶éªŒè¯é…ç½®æ˜¯å¦æˆåŠŸã€‚</p>
<h3 id="_10-0-4-20æœåŠ¡å™¨é…ç½®" tabindex="-1"><a class="header-anchor" href="#_10-0-4-20æœåŠ¡å™¨é…ç½®" aria-hidden="true">#</a> <code v-pre>10.0.4.20</code>æœåŠ¡å™¨é…ç½®</h3>
<p>ç™»é™†<code v-pre>10.0.4.20</code>æœåŠ¡å™¨ï¼Œåœ¨<code v-pre>/etc/nginx/nginx.conf</code>ä¸­æ·»åŠ upstreamé…ç½®ï¼Œé…ç½®è¿‡ç¨‹å¯ä»¥åˆ†ä¸º3æ­¥ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼Œåœ¨</strong><code v-pre>/etc/nginx/nginx.conf</code><strong>ä¸­æ·»åŠ upstreamï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>http <span class="token punctuation">{</span>
    log_format  main  <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" '</span>
                      <span class="token string">'$status $body_bytes_sent "$http_referer" '</span>
                      <span class="token string">'"$http_user_agent" "$http_x_forwarded_for"'</span><span class="token punctuation">;</span>

    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span>

    sendfile            on<span class="token punctuation">;</span>
    tcp_nopush          on<span class="token punctuation">;</span>
    tcp_nodelay         on<span class="token punctuation">;</span>
    keepalive_timeout   <span class="token number">65</span><span class="token punctuation">;</span>
    types_hash_max_size <span class="token number">2048</span><span class="token punctuation">;</span>

    include             /etc/nginx/mime.types<span class="token punctuation">;</span>
    default_type        application/octet-stream<span class="token punctuation">;</span>

    <span class="token comment"># Load modular configuration files from the /etc/nginx/conf.d directory.</span>
    <span class="token comment"># See http://nginx.org/en/docs/ngx_core_module.html#include</span>
    <span class="token comment"># for more information.</span>
    include /etc/nginx/conf.d/*.conf<span class="token punctuation">;</span>
    upstream iam.api.marmotedu.com <span class="token punctuation">{</span>
        server <span class="token number">127.0</span>.0.1:8080
        server <span class="token number">10.0</span>.4.21:8080
    <span class="token punctuation">}</span>
    upstream iam.authz.marmotedu.com <span class="token punctuation">{</span>
        server <span class="token number">127.0</span>.0.1:9090
        server <span class="token number">10.0</span>.4.21:9090
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>é…ç½®è¯´æ˜ï¼š</em></p>
<ul>
<li>upstreamæ˜¯é…ç½®åœ¨<code v-pre>/etc/nginx/nginx.conf</code>æ–‡ä»¶ä¸­çš„<code v-pre>http{ â€¦ }</code>éƒ¨åˆ†çš„ã€‚</li>
<li>å› ä¸ºæˆ‘ä»¬è¦åˆ†åˆ«ä¸ºiam-apiserverå’Œiam-authz-serveré…ç½®è´Ÿè½½å‡è¡¡ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªupstreamï¼Œåˆ†åˆ«æ˜¯<code v-pre>iam.api.marmotedu.com</code>å’Œ<code v-pre>iam.authz.marmotedu.com</code>ã€‚ä¸ºäº†ä¾¿äºè¯†åˆ«ï¼Œupstreamåç§°å’ŒåŸŸåæœ€å¥½ä¿æŒä¸€è‡´ã€‚</li>
<li>åœ¨upstreamä¸­ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«æ·»åŠ æ‰€æœ‰çš„iam-apiserverå’Œiam-authz-serverçš„åç«¯ï¼ˆ<code v-pre>ip:port</code>ï¼‰ï¼Œæœ¬æœºçš„åç«¯ä¸ºäº†è®¿é—®æ›´å¿«ï¼Œå¯ä»¥ä½¿ç”¨<code v-pre>127.0.0.1:&lt;port&gt;</code>ï¼Œå…¶ä»–æœºå™¨çš„åç«¯ï¼Œéœ€è¦ä½¿ç”¨<code v-pre>&lt;å†…ç½‘&gt;:port</code>ï¼Œä¾‹å¦‚<code v-pre>10.0.4.21:8080</code>ã€<code v-pre>10.0.4.21:9090</code>ã€‚</li>
</ul>
<p><strong>ç¬¬äºŒæ­¥ï¼Œä¿®æ”¹proxy_passã€‚</strong></p>
<p>ä¿®æ”¹<code v-pre>/etc/nginx/conf.d/iam-apiserver.conf</code>æ–‡ä»¶ï¼Œå°†<code v-pre>proxy_pass</code>ä¿®æ”¹ä¸ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>proxy_pass http://iam.api.marmotedu.com/;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¿®æ”¹<code v-pre>/etc/nginx/conf.d/iam-authz-server.conf</code>æ–‡ä»¶ï¼Œå°†<code v-pre>proxy_pass</code>ä¿®æ”¹ä¸ºï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>proxy_pass http://iam.authz.marmotedu.com/;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å½“Nginxè½¬å‘åˆ°<code v-pre>http://iam.api.marmotedu.com/</code>åŸŸåæ—¶ï¼Œä¼šä»<code v-pre>iam.api.marmotedu.com</code> upstreamé…ç½®çš„åç«¯åˆ—è¡¨ä¸­ï¼Œæ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰å–ä¸€ä¸ªåç«¯ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘è¿‡å»ã€‚è½¬å‘<code v-pre>http://iam.authz.marmotedu.com/</code>åŸŸåçš„é€»è¾‘ä¹Ÿä¸€æ ·ã€‚</p>
<p><strong>ç¬¬ä¸‰æ­¥ï¼Œé…ç½®å®ŒNginxåï¼Œé‡å¯Nginxï¼š</strong></p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>$ sudo systemctl restart nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æœ€ç»ˆé…ç½®å¥½çš„é…ç½®æ–‡ä»¶ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢è¿™äº›ï¼ˆä¿å­˜åœ¨<a href="https://github.com/marmotedu/iam/tree/v1.0.8/configs/ha/10.0.4.20" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.20<ExternalLinkIcon/></a>ç›®å½•ä¸‹ï¼‰ï¼š</p>
<ul>
<li>nginx.confï¼š<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/nginx.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.20/nginx.conf<ExternalLinkIcon/></a>ã€‚</li>
<li>iam-apiserver.confï¼š<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/iam-apiserver.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.20/iam-apiserver.conf<ExternalLinkIcon/></a>ã€‚</li>
<li>iam-authz-server.confï¼š<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/iam-authz-server.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.20/iam-authz-server.conf<ExternalLinkIcon/></a>ã€‚</li>
</ul>
<h3 id="_10-0-4-21æœåŠ¡å™¨é…ç½®" tabindex="-1"><a class="header-anchor" href="#_10-0-4-21æœåŠ¡å™¨é…ç½®" aria-hidden="true">#</a> <code v-pre>10.0.4.21</code>æœåŠ¡å™¨é…ç½®</h3>
<p>ç™»é™†<code v-pre>10.0.4.21</code>æœåŠ¡å™¨ï¼Œåœ¨<code v-pre>/etc/nginx/nginx.conf</code>ä¸­æ·»åŠ upstreamé…ç½®ã€‚é…ç½®è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‹é¢4æ­¥ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼Œåœ¨</strong><code v-pre>/etc/nginx/nginx.conf</code><strong>ä¸­æ·»åŠ upstreamï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>
http <span class="token punctuation">{</span>
    log_format  main  <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" '</span>
                      <span class="token string">'$status $body_bytes_sent "$http_referer" '</span>
                      <span class="token string">'"$http_user_agent" "$http_x_forwarded_for"'</span><span class="token punctuation">;</span>

    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span>

    sendfile            on<span class="token punctuation">;</span>
    tcp_nopush          on<span class="token punctuation">;</span>
    tcp_nodelay         on<span class="token punctuation">;</span>
    keepalive_timeout   <span class="token number">65</span><span class="token punctuation">;</span>
    types_hash_max_size <span class="token number">2048</span><span class="token punctuation">;</span>

    include             /etc/nginx/mime.types<span class="token punctuation">;</span>
    default_type        application/octet-stream<span class="token punctuation">;</span>

    <span class="token comment"># Load modular configuration files from the /etc/nginx/conf.d directory.</span>
    <span class="token comment"># See http://nginx.org/en/docs/ngx_core_module.html#include</span>
    <span class="token comment"># for more information.</span>
    include /etc/nginx/conf.d/*.conf<span class="token punctuation">;</span>
    upstream iam.api.marmotedu.com <span class="token punctuation">{</span>
        server <span class="token number">127.0</span>.0.1:8080
        server <span class="token number">10.0</span>.4.20:8080
    <span class="token punctuation">}</span>
    upstream iam.authz.marmotedu.com <span class="token punctuation">{</span>
        server <span class="token number">127.0</span>.0.1:9090
        server <span class="token number">10.0</span>.4.20:9090
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>upstreamä¸­ï¼Œéœ€è¦é…ç½®<code v-pre>10.0.4.20</code>æœåŠ¡å™¨ä¸Šçš„iam-apiserverå’Œiam-authz-serverçš„åç«¯ï¼Œä¾‹å¦‚<code v-pre>10.0.4.20:8080</code>ã€<code v-pre>10.0.4.20:9090</code>ã€‚</p>
<p><strong>ç¬¬äºŒæ­¥ï¼Œåˆ›å»º</strong><code v-pre>/etc/nginx/conf.d/iam-apiserver.conf</code><strong>æ–‡ä»¶</strong>ï¼ˆiam-apiserverçš„åå‘ä»£ç†+è´Ÿè½½å‡è¡¡é…ç½®ï¼‰ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  iam.api.marmotedu.com<span class="token punctuation">;</span>
    root         /usr/share/nginx/html<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
      proxy_set_header X-Forwarded-Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_pass  http://iam.api.marmotedu.com/<span class="token punctuation">;</span>
      client_max_body_size 5m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">404</span> /404.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /40x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /50x.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç¬¬ä¸‰æ­¥ï¼Œåˆ›å»º</strong><code v-pre>/etc/nginx/conf.d/iam-authz-server</code><strong>æ–‡ä»¶</strong>ï¼ˆiam-authz-serverçš„åå‘ä»£ç†+è´Ÿè½½å‡è¡¡é…ç½®ï¼‰ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  iam.authz.marmotedu.com<span class="token punctuation">;</span>
    root         /usr/share/nginx/html<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
      proxy_set_header X-Forwarded-Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_pass  http://iam.authz.marmotedu.com/<span class="token punctuation">;</span>
      client_max_body_size 5m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">404</span> /404.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /40x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /50x.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç¬¬å››æ­¥ï¼Œé…ç½®å®ŒNginxåï¼Œé‡å¯Nginxï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl restart nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æœ€ç»ˆé…ç½®å¥½çš„é…ç½®æ–‡ä»¶ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢è¿™äº›ï¼ˆä¿å­˜åœ¨<a href="https://github.com/marmotedu/iam/tree/v1.0.8/configs/ha/10.0.4.21" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.21<ExternalLinkIcon/></a>ç›®å½•ä¸‹ï¼‰ï¼š</p>
<ul>
<li>nginx.confï¼š<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/nginx.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.21/nginx.conf<ExternalLinkIcon/></a>ã€‚</li>
<li>iam-apiserver.confï¼š<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/iam-apiserver.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.21/iam-apiserver.conf<ExternalLinkIcon/></a>ã€‚</li>
<li>iam-authz-server.confï¼š<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/iam-authz-server.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.21/iam-authz-server.conf<ExternalLinkIcon/></a>ã€‚</li>
</ul>
<h3 id="æµ‹è¯•è´Ÿè½½å‡è¡¡" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•è´Ÿè½½å‡è¡¡" aria-hidden="true">#</a> æµ‹è¯•è´Ÿè½½å‡è¡¡</h3>
<p>ä¸Šé¢ï¼Œæˆ‘ä»¬é…ç½®äº†Nginxè´Ÿè½½å‡è¡¡å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦æµ‹è¯•ä¸‹æ˜¯å¦é…ç½®æˆåŠŸã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼Œæ‰§è¡Œæµ‹è¯•è„šæœ¬ï¼ˆ</strong><a href="https://github.com/marmotedu/iam/blob/v1.0.8/test/nginx/loadbalance.sh" target="_blank" rel="noopener noreferrer">test/nginx/loadbalance.sh<ExternalLinkIcon/></a><strong>ï¼‰ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token shebang important">#!/usr/bin/env bash</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">domain</span> <span class="token keyword">in</span> iam.api.marmotedu.com iam.authz.marmotedu.com
<span class="token keyword">do</span>
  <span class="token keyword">for</span> <span class="token for-or-select variable">n</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">10</span><span class="token variable">)</span></span>
  <span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token variable">$domain</span>
    <span class="token function">nohup</span> <span class="token function">curl</span> http://<span class="token variable">${domain}</span>/healthz <span class="token operator">&amp;></span>/dev/null <span class="token operator">&amp;</span>
  <span class="token keyword">done</span>
<span class="token keyword">done</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç¬¬äºŒæ­¥ï¼Œåˆ†åˆ«æŸ¥çœ‹iam-apiserverå’Œiam-authz-serverçš„æ—¥å¿—ã€‚</strong></p>
<p>è¿™é‡Œæˆ‘å±•ç¤ºä¸‹iam-apiserverçš„æ—¥å¿—ï¼ˆiam-authz-serverçš„æ—¥å¿—ä½ å¯è‡ªè¡ŒæŸ¥çœ‹ï¼‰ã€‚</p>
<p><code v-pre>10.0.4.20</code>æœåŠ¡å™¨çš„iam-apiserveræ—¥å¿—å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://static001.geekbang.org/resource/image/58/26/58d072c92552fa3068e3ef3acd0ed726.png?wh=1920x498" alt="å›¾ç‰‡"></p>
<p><code v-pre>10.0.4.21</code>æœåŠ¡å™¨çš„iam-apiserveræ—¥å¿—å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://static001.geekbang.org/resource/image/19/85/199066c65ff60007f80f3c2dyy11c785.png?wh=1920x482" alt="å›¾ç‰‡"></p>
<p>é€šè¿‡ä¸Šé¢ä¸¤å¼ å›¾ï¼Œä½ å¯ä»¥çœ‹åˆ°<code v-pre>10.0.4.20</code>å’Œ<code v-pre>10.0.4.21</code>å„æ”¶åˆ°<code v-pre>5</code>ä¸ª<code v-pre>/healthz</code>è¯·æ±‚ï¼Œè¯´æ˜è´Ÿè½½å‡è¡¡é…ç½®æˆåŠŸã€‚</p>
<h2 id="é…ç½®keepalived" tabindex="-1"><a class="header-anchor" href="#é…ç½®keepalived" aria-hidden="true">#</a> é…ç½®Keepalived</h2>
<p>åœ¨ <a href="https://time.geekbang.org/column/article/411663" target="_blank" rel="noopener noreferrer">40è®²<ExternalLinkIcon/></a>ï¼Œæˆ‘ä»¬åˆ†åˆ«åœ¨<code v-pre>10.0.4.20</code>å’Œ<code v-pre>10.0.4.21</code>æœåŠ¡å™¨ä¸Šå®‰è£…äº†Keepalivedã€‚è¿™é‡Œï¼Œæˆ‘æ¥ä»‹ç»ä¸‹å¦‚ä½•é…ç½®Keepalivedï¼Œå®ç°Nginxçš„é«˜å¯ç”¨ã€‚ä¸ºäº†é¿å…æ•…éšœæ¢å¤æ—¶ï¼ŒVIPåˆ‡æ¢é€ æˆçš„æœåŠ¡å»¶æ—¶ï¼Œè¿™ä¸€è®²é‡‡ç”¨Keepalivedçš„éæŠ¢å æ¨¡å¼ã€‚</p>
<p>é…ç½®Keepalivedçš„æµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œåˆ†ä¸ºåˆ›å»ºè…¾è®¯äº‘HAVIPã€ä¸»æœåŠ¡å™¨é…ç½®ã€å¤‡æœåŠ¡å™¨é…ç½®ã€æµ‹è¯•Keepalivedã€VIPç»‘å®šå…¬ç½‘IPå’Œæµ‹è¯•å…¬ç½‘è®¿é—®å…­å¤§æ­¥ï¼Œæ¯ä¸€æ­¥ä¸­éƒ½æœ‰å¾ˆå¤šå°æ­¥éª¤ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥åœ°çœ‹ä¸‹ã€‚</p>
<h3 id="ç¬¬ä¸€æ­¥-åˆ›å»ºè…¾è®¯äº‘havip" tabindex="-1"><a class="header-anchor" href="#ç¬¬ä¸€æ­¥-åˆ›å»ºè…¾è®¯äº‘havip" aria-hidden="true">#</a> <strong>ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè…¾è®¯äº‘HAVIP</strong></h3>
<p>å…¬æœ‰äº‘å‚å•†çš„æ™®é€šå†…ç½‘IPï¼Œå‡ºäºå®‰å…¨è€ƒè™‘ï¼ˆå¦‚é¿å…ARPæ¬ºéª—ç­‰ï¼‰ï¼Œä¸æ”¯æŒä¸»æœºé€šè¿‡ARPå®£å‘ŠIP ã€‚å¦‚æœç”¨æˆ·ç›´æ¥åœ¨<code v-pre>keepalived.conf</code>æ–‡ä»¶ä¸­æŒ‡å®šä¸€ä¸ªæ™®é€šå†…ç½‘IPä¸ºvirtual IPï¼Œå½“Keepalivedå°†virtual IPä»MASTERæœºå™¨åˆ‡æ¢åˆ°BACKUPæœºå™¨æ—¶ï¼Œå°†æ— æ³•æ›´æ–°IPå’ŒMACåœ°å€çš„æ˜ å°„ï¼Œè€Œéœ€è¦è°ƒAPIæ¥è¿›è¡ŒIPåˆ‡æ¢ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œçš„VIPéœ€è¦ç”³è¯·è…¾è®¯äº‘çš„HAVIPã€‚</p>
<p>ç”³è¯·çš„æµç¨‹å¯ä»¥åˆ†ä¸ºä¸‹é¢4æ­¥ï¼š</p>
<ol>
<li>ç™»å½•ç§æœ‰ç½‘ç»œæ§åˆ¶å°**ã€‚**</li>
<li>åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œé€‰æ‹©ã€IPä¸ç½‘å¡ã€‘&gt;ã€é«˜å¯ç”¨è™šæ‹ŸIPã€‘ã€‚</li>
<li>åœ¨HAVIPç®¡ç†é¡µé¢ï¼Œé€‰æ‹©æ‰€åœ¨åœ°åŸŸï¼Œå•å‡»ã€ç”³è¯·ã€‘ã€‚</li>
<li>åœ¨å¼¹å‡ºçš„ã€ç”³è¯·é«˜å¯ç”¨è™šæ‹ŸIPã€‘å¯¹è¯æ¡†ä¸­è¾“å…¥åç§°ï¼Œé€‰æ‹©HAVIPæ‰€åœ¨çš„ç§æœ‰ç½‘ç»œå’Œå­ç½‘ç­‰ä¿¡æ¯ï¼Œå•å‡»ã€ç¡®å®šã€‘å³å¯ã€‚</li>
</ol>
<p>è¿™é‡Œé€‰æ‹©çš„ç§æœ‰ç½‘ç»œå’Œå­ç½‘ï¼Œéœ€è¦å’Œ<code v-pre>10.0.4.20</code>ã€<code v-pre>10.0.4.21</code>ç›¸åŒã€‚HAVIP çš„ IP åœ°å€å¯ä»¥è‡ªåŠ¨åˆ†é…ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨å¡«å†™ï¼Œè¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨å¡«å†™ä¸º10.0.4.99ã€‚ç”³è¯·é¡µé¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="https://static001.geekbang.org/resource/image/a4/11/a49d6e7e080d658392dbb144a1560811.png?wh=827x1016" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/a4/11/a49d6e7e080d658392dbb144a1560811.png?wh=827x1016" alt="å›¾ç‰‡"><ExternalLinkIcon/></a></p>
<h3 id="ç¬¬äºŒæ­¥-ä¸»æœåŠ¡å™¨é…ç½®" tabindex="-1"><a class="header-anchor" href="#ç¬¬äºŒæ­¥-ä¸»æœåŠ¡å™¨é…ç½®" aria-hidden="true">#</a> ç¬¬äºŒæ­¥ï¼šä¸»æœåŠ¡å™¨é…ç½®</h3>
<p>è¿›è¡Œä¸»æœåŠ¡å™¨é…ç½®ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤æ­¥ã€‚</p>
<p><strong>é¦–å…ˆï¼Œä¿®æ”¹Keepalivedé…ç½®æ–‡ä»¶ã€‚</strong></p>
<p>ç™»é™†æœåŠ¡å™¨<code v-pre>10.0.4.20</code>ï¼Œç¼–è¾‘<code v-pre>/etc/keepalived/keepalived.conf</code>ï¼Œä¿®æ”¹é…ç½®ï¼Œä¿®æ”¹åé…ç½®å†…å®¹å¦‚ä¸‹ï¼ˆå‚è€ƒï¼š<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/keepalived.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.20/keepalived.conf<ExternalLinkIcon/></a>ï¼‰ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># å…¨å±€å®šä¹‰ï¼Œå®šä¹‰å…¨å±€çš„é…ç½®é€‰é¡¹</span>
global_defs <span class="token punctuation">{</span>
<span class="token comment"># æŒ‡å®škeepalivedåœ¨å‘ç”Ÿåˆ‡æ¢æ“ä½œæ—¶å‘é€emailï¼Œå‘é€ç»™å“ªäº›email</span>
<span class="token comment"># å»ºè®®åœ¨keepalived_notify.shä¸­å‘é€é‚®ä»¶</span>
  notification_email <span class="token punctuation">{</span>
    acassen@firewall.loc
  <span class="token punctuation">}</span>
  notification_email_from Alexandre.Cassen@firewall.loc <span class="token comment"># å‘é€emailæ—¶é‚®ä»¶æºåœ°å€</span>
    smtp_server <span class="token number">192.168</span>.200.1 <span class="token comment"># å‘é€emailæ—¶smtpæœåŠ¡å™¨åœ°å€</span>
    smtp_connect_timeout <span class="token number">30</span> <span class="token comment"># è¿æ¥smtpçš„è¶…æ—¶æ—¶é—´</span>
    router_id VM-4-20-centos <span class="token comment"># æœºå™¨æ ‡è¯†ï¼Œé€šå¸¸å¯ä»¥è®¾ç½®ä¸ºhostname</span>
    vrrp_skip_check_adv_addr <span class="token comment"># å¦‚æœæ¥æ”¶åˆ°çš„æŠ¥æ–‡å’Œä¸Šä¸€ä¸ªæŠ¥æ–‡æ¥è‡ªåŒä¸€ä¸ªè·¯ç”±å™¨ï¼Œåˆ™ä¸æ‰§è¡Œæ£€æŸ¥ã€‚é»˜è®¤æ˜¯è·³è¿‡æ£€æŸ¥</span>
    vrrp_garp_interval <span class="token number">0</span> <span class="token comment"># å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„gratuitous arpæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0</span>
    vrrp_gna_interval <span class="token number">0</span> <span class="token comment"># å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„naæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0</span>
<span class="token punctuation">}</span>
<span class="token comment"># æ£€æµ‹è„šæœ¬é…ç½®</span>
vrrp_script checkhaproxy
<span class="token punctuation">{</span>
  script <span class="token string">"/etc/keepalived/check_nginx.sh"</span> <span class="token comment"># æ£€æµ‹è„šæœ¬è·¯å¾„</span>
    interval <span class="token number">5</span> <span class="token comment"># æ£€æµ‹æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰</span>
    weight <span class="token number">0</span> <span class="token comment"># æ ¹æ®è¯¥æƒé‡æ”¹å˜priorityï¼Œå½“å€¼ä¸º0æ—¶ï¼Œä¸æ”¹å˜å®ä¾‹çš„ä¼˜å…ˆçº§</span>
<span class="token punctuation">}</span>
<span class="token comment"># VRRPå®ä¾‹é…ç½®</span>
vrrp_instance VI_1 <span class="token punctuation">{</span>
  state BACKUP  <span class="token comment"># è®¾ç½®åˆå§‹çŠ¶æ€ä¸º'å¤‡ä»½'</span>
    interface eth0 <span class="token comment"># è®¾ç½®ç»‘å®šVIPçš„ç½‘å¡ï¼Œä¾‹å¦‚eth0</span>
    virtual_router_id <span class="token number">51</span>  <span class="token comment"># é…ç½®é›†ç¾¤VRIDï¼Œäº’ä¸ºä¸»å¤‡çš„VRIDéœ€è¦æ˜¯ç›¸åŒçš„å€¼</span>
    nopreempt               <span class="token comment"># è®¾ç½®éæŠ¢å æ¨¡å¼ï¼Œåªèƒ½è®¾ç½®åœ¨stateä¸ºbackupçš„èŠ‚ç‚¹ä¸Š</span>
    priority <span class="token number">100</span> <span class="token comment"># è®¾ç½®ä¼˜å…ˆçº§ï¼Œå€¼èŒƒå›´0ï½254ï¼Œå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæœ€é«˜çš„ä¸ºmaster</span>
    advert_int <span class="token number">1</span> <span class="token comment"># ç»„æ’­ä¿¡æ¯å‘é€æ—¶é—´é—´éš”ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»è®¾ç½®ä¸€æ ·ï¼Œé»˜è®¤ä¸º1ç§’</span>
<span class="token comment"># éªŒè¯ä¿¡æ¯ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»ä¸€è‡´</span>
    authentication <span class="token punctuation">{</span>
      auth_type PASS <span class="token comment"># è®¤è¯æ–¹å¼ï¼Œå¯ä»¥æ˜¯PASSæˆ–AHä¸¤ç§è®¤è¯æ–¹å¼</span>
        auth_pass <span class="token number">1111</span> <span class="token comment"># è®¤è¯å¯†ç </span>
    <span class="token punctuation">}</span>
  unicast_src_ip <span class="token number">10.0</span>.4.20  <span class="token comment"># è®¾ç½®æœ¬æœºå†…ç½‘IPåœ°å€</span>
    unicast_peer <span class="token punctuation">{</span>
      <span class="token number">10.0</span>.4.21             <span class="token comment"># å¯¹ç«¯è®¾å¤‡çš„IPåœ°å€</span>
    <span class="token punctuation">}</span>
<span class="token comment"># VIPï¼Œå½“stateä¸ºmasteræ—¶æ·»åŠ ï¼Œå½“stateä¸ºbackupæ—¶åˆ é™¤</span>
  virtual_ipaddress <span class="token punctuation">{</span>
    <span class="token number">10.0</span>.4.99 <span class="token comment"># è®¾ç½®é«˜å¯ç”¨è™šæ‹ŸVIPï¼Œå¦‚æœæ˜¯è…¾è®¯äº‘çš„CVMï¼Œéœ€è¦å¡«å†™æ§åˆ¶å°ç”³è¯·åˆ°çš„HAVIPåœ°å€ã€‚</span>
  <span class="token punctuation">}</span>
  notify_master <span class="token string">"/etc/keepalived/keepalived_notify.sh MASTER"</span> <span class="token comment"># å½“åˆ‡æ¢åˆ°masterçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬</span>
    notify_backup <span class="token string">"/etc/keepalived/keepalived_notify.sh BACKUP"</span> <span class="token comment"># å½“åˆ‡æ¢åˆ°backupçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬</span>
    notify_fault <span class="token string">"/etc/keepalived/keepalived_notify.sh FAULT"</span> <span class="token comment"># å½“åˆ‡æ¢åˆ°faultçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬</span>
    notify_stop <span class="token string">"/etc/keepalived/keepalived_notify.sh STOP"</span> <span class="token comment"># å½“åˆ‡æ¢åˆ°stopçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬</span>
    garp_master_delay <span class="token number">1</span>    <span class="token comment"># è®¾ç½®å½“åˆ‡ä¸ºä¸»çŠ¶æ€åå¤šä¹…æ›´æ–°ARPç¼“å­˜</span>
    garp_master_refresh <span class="token number">5</span>   <span class="token comment"># è®¾ç½®ä¸»èŠ‚ç‚¹å‘é€ARPæŠ¥æ–‡çš„æ—¶é—´é—´éš”</span>
    <span class="token comment"># è·Ÿè¸ªæ¥å£ï¼Œé‡Œé¢ä»»æ„ä¸€å—ç½‘å¡å‡ºç°é—®é¢˜ï¼Œéƒ½ä¼šè¿›å…¥æ•…éšœ(FAULT)çŠ¶æ€</span>
    track_interface <span class="token punctuation">{</span>
      eth0
    <span class="token punctuation">}</span>
  <span class="token comment"># è¦æ‰§è¡Œçš„æ£€æŸ¥è„šæœ¬</span>
  track_script <span class="token punctuation">{</span>
    checkhaproxy
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæœ‰å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š</p>
<ul>
<li>ç¡®ä¿å·²ç»é…ç½®äº†garpç›¸å…³å‚æ•°ã€‚å› ä¸ºKeepalivedä¾èµ–ARPæŠ¥æ–‡æ›´æ–°IPä¿¡æ¯ï¼Œå¦‚æœç¼ºå°‘è¿™äº›å‚æ•°ï¼Œä¼šå¯¼è‡´æŸäº›åœºæ™¯ä¸‹ä¸»è®¾å¤‡ä¸å‘é€ARPï¼Œè¿›è€Œå¯¼è‡´é€šä¿¡å¼‚å¸¸ã€‚garpç›¸å…³å‚æ•°é…ç½®å¦‚ä¸‹ï¼š</li>
</ul>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>garp_master_delay <span class="token number">1</span>
garp_master_refresh <span class="token number">5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li>ç¡®å®šæ²¡æœ‰é‡‡ç”¨ strict æ¨¡å¼ï¼Œå³éœ€è¦åˆ é™¤vrrp_stricté…ç½®ã€‚</li>
<li>é…ç½®ä¸­çš„<code v-pre>/etc/keepalived/check_nginx.sh</code>å’Œ<code v-pre>/etc/keepalived/keepalived_notify.sh</code>è„šæœ¬æ–‡ä»¶ï¼Œå¯åˆ†åˆ«æ‹·è´è‡ª<a href="https://github.com/marmotedu/iam/blob/v1.0.8/scripts/check_nginx.sh" target="_blank" rel="noopener noreferrer">scripts/check_nginx.sh<ExternalLinkIcon/></a>å’Œ<a href="https://github.com/marmotedu/iam/blob/v1.0.8/scripts/keepalived_notify.sh" target="_blank" rel="noopener noreferrer">scripts/keepalived_notify.sh<ExternalLinkIcon/></a>ã€‚</li>
</ul>
<p><strong>ç„¶åï¼Œé‡å¯Keepalivedï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl restart keepalived
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="ç¬¬ä¸‰æ­¥-å¤‡æœåŠ¡å™¨é…ç½®" tabindex="-1"><a class="header-anchor" href="#ç¬¬ä¸‰æ­¥-å¤‡æœåŠ¡å™¨é…ç½®" aria-hidden="true">#</a> ç¬¬ä¸‰æ­¥ï¼šå¤‡æœåŠ¡å™¨é…ç½®</h3>
<p>è¿›è¡Œå¤‡æœåŠ¡å™¨é…ç½®ä¹Ÿåˆ†ä¸ºä¸¤æ­¥ã€‚</p>
<p><strong>é¦–å…ˆï¼Œä¿®æ”¹Keepalivedé…ç½®æ–‡ä»¶ã€‚</strong></p>
<p>ç™»é™†æœåŠ¡å™¨<code v-pre>10.0.4.21</code>ï¼Œç¼–è¾‘<code v-pre>/etc/keepalived/keepalived.conf</code>ï¼Œä¿®æ”¹é…ç½®ï¼Œä¿®æ”¹åé…ç½®å†…å®¹å¦‚ä¸‹ï¼ˆå‚è€ƒï¼š<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/keepalived.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.21/keepalived.conf<ExternalLinkIcon/></a>ï¼‰ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># å…¨å±€å®šä¹‰ï¼Œå®šä¹‰å…¨å±€çš„é…ç½®é€‰é¡¹</span>
global_defs <span class="token punctuation">{</span>
<span class="token comment"># æŒ‡å®škeepalivedåœ¨å‘ç”Ÿåˆ‡æ¢æ“ä½œæ—¶å‘é€emailï¼Œå‘é€ç»™å“ªäº›email</span>
<span class="token comment"># å»ºè®®åœ¨keepalived_notify.shä¸­å‘é€é‚®ä»¶</span>
  notification_email <span class="token punctuation">{</span>
    acassen@firewall.loc
  <span class="token punctuation">}</span>
  notification_email_from Alexandre.Cassen@firewall.loc <span class="token comment"># å‘é€emailæ—¶é‚®ä»¶æºåœ°å€</span>
    smtp_server <span class="token number">192.168</span>.200.1 <span class="token comment"># å‘é€emailæ—¶smtpæœåŠ¡å™¨åœ°å€</span>
    smtp_connect_timeout <span class="token number">30</span> <span class="token comment"># è¿æ¥smtpçš„è¶…æ—¶æ—¶é—´</span>
    router_id VM-4-21-centos <span class="token comment"># æœºå™¨æ ‡è¯†ï¼Œé€šå¸¸å¯ä»¥è®¾ç½®ä¸ºhostname</span>
    vrrp_skip_check_adv_addr <span class="token comment"># å¦‚æœæ¥æ”¶åˆ°çš„æŠ¥æ–‡å’Œä¸Šä¸€ä¸ªæŠ¥æ–‡æ¥è‡ªåŒä¸€ä¸ªè·¯ç”±å™¨ï¼Œåˆ™ä¸æ‰§è¡Œæ£€æŸ¥ã€‚é»˜è®¤æ˜¯è·³è¿‡æ£€æŸ¥</span>
    vrrp_garp_interval <span class="token number">0</span> <span class="token comment"># å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„gratuitous arpæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0</span>
    vrrp_gna_interval <span class="token number">0</span> <span class="token comment"># å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„naæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0</span>
<span class="token punctuation">}</span>
<span class="token comment"># æ£€æµ‹è„šæœ¬é…ç½®</span>
vrrp_script checkhaproxy
<span class="token punctuation">{</span>
  script <span class="token string">"/etc/keepalived/check_nginx.sh"</span> <span class="token comment"># æ£€æµ‹è„šæœ¬è·¯å¾„</span>
    interval <span class="token number">5</span> <span class="token comment"># æ£€æµ‹æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰</span>
    weight <span class="token number">0</span> <span class="token comment"># æ ¹æ®è¯¥æƒé‡æ”¹å˜priorityï¼Œå½“å€¼ä¸º0æ—¶ï¼Œä¸æ”¹å˜å®ä¾‹çš„ä¼˜å…ˆçº§</span>
<span class="token punctuation">}</span>
<span class="token comment"># VRRPå®ä¾‹é…ç½®</span>
vrrp_instance VI_1 <span class="token punctuation">{</span>
  state BACKUP  <span class="token comment"># è®¾ç½®åˆå§‹çŠ¶æ€ä¸º'å¤‡ä»½'</span>
    interface eth0 <span class="token comment"># è®¾ç½®ç»‘å®šVIPçš„ç½‘å¡ï¼Œä¾‹å¦‚eth0</span>
    virtual_router_id <span class="token number">51</span>  <span class="token comment"># é…ç½®é›†ç¾¤VRIDï¼Œäº’ä¸ºä¸»å¤‡çš„VRIDéœ€è¦æ˜¯ç›¸åŒçš„å€¼</span>
    nopreempt               <span class="token comment"># è®¾ç½®éæŠ¢å æ¨¡å¼ï¼Œåªèƒ½è®¾ç½®åœ¨stateä¸ºbackupçš„èŠ‚ç‚¹ä¸Š</span>
    priority <span class="token number">50</span> <span class="token comment"># è®¾ç½®ä¼˜å…ˆçº§ï¼Œå€¼èŒƒå›´0ï½254ï¼Œå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæœ€é«˜çš„ä¸ºmaster</span>
    advert_int <span class="token number">1</span> <span class="token comment"># ç»„æ’­ä¿¡æ¯å‘é€æ—¶é—´é—´éš”ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»è®¾ç½®ä¸€æ ·ï¼Œé»˜è®¤ä¸º1ç§’</span>
<span class="token comment"># éªŒè¯ä¿¡æ¯ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»ä¸€è‡´</span>
    authentication <span class="token punctuation">{</span>
      auth_type PASS <span class="token comment"># è®¤è¯æ–¹å¼ï¼Œå¯ä»¥æ˜¯PASSæˆ–AHä¸¤ç§è®¤è¯æ–¹å¼</span>
        auth_pass <span class="token number">1111</span> <span class="token comment"># è®¤è¯å¯†ç </span>
    <span class="token punctuation">}</span>
  unicast_src_ip <span class="token number">10.0</span>.4.21  <span class="token comment"># è®¾ç½®æœ¬æœºå†…ç½‘IPåœ°å€</span>
    unicast_peer <span class="token punctuation">{</span>
      <span class="token number">10.0</span>.4.20             <span class="token comment"># å¯¹ç«¯è®¾å¤‡çš„IPåœ°å€</span>
    <span class="token punctuation">}</span>
<span class="token comment"># VIPï¼Œå½“stateä¸ºmasteræ—¶æ·»åŠ ï¼Œå½“stateä¸ºbackupæ—¶åˆ é™¤</span>
  virtual_ipaddress <span class="token punctuation">{</span>
    <span class="token number">10.0</span>.4.99 <span class="token comment"># è®¾ç½®é«˜å¯ç”¨è™šæ‹ŸVIPï¼Œå¦‚æœæ˜¯è…¾è®¯äº‘çš„CVMï¼Œéœ€è¦å¡«å†™æ§åˆ¶å°ç”³è¯·åˆ°çš„HAVIPåœ°å€ã€‚</span>
  <span class="token punctuation">}</span>
  notify_master <span class="token string">"/etc/keepalived/keepalived_notify.sh MASTER"</span> <span class="token comment"># å½“åˆ‡æ¢åˆ°masterçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬</span>
    notify_backup <span class="token string">"/etc/keepalived/keepalived_notify.sh BACKUP"</span> <span class="token comment"># å½“åˆ‡æ¢åˆ°backupçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬</span>
    notify_fault <span class="token string">"/etc/keepalived/keepalived_notify.sh FAULT"</span> <span class="token comment"># å½“åˆ‡æ¢åˆ°faultçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬</span>
    notify_stop <span class="token string">"/etc/keepalived/keepalived_notify.sh STOP"</span> <span class="token comment"># å½“åˆ‡æ¢åˆ°stopçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬</span>
    garp_master_delay <span class="token number">1</span>    <span class="token comment"># è®¾ç½®å½“åˆ‡ä¸ºä¸»çŠ¶æ€åå¤šä¹…æ›´æ–°ARPç¼“å­˜</span>
    garp_master_refresh <span class="token number">5</span>   <span class="token comment"># è®¾ç½®ä¸»èŠ‚ç‚¹å‘é€ARPæŠ¥æ–‡çš„æ—¶é—´é—´éš”</span>
    <span class="token comment"># è·Ÿè¸ªæ¥å£ï¼Œé‡Œé¢ä»»æ„ä¸€å—ç½‘å¡å‡ºç°é—®é¢˜ï¼Œéƒ½ä¼šè¿›å…¥æ•…éšœ(FAULT)çŠ¶æ€</span>
    track_interface <span class="token punctuation">{</span>
      eth0
    <span class="token punctuation">}</span>
  <span class="token comment"># è¦æ‰§è¡Œçš„æ£€æŸ¥è„šæœ¬</span>
  track_script <span class="token punctuation">{</span>
    checkhaproxy
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç„¶åï¼Œé‡å¯Keepalivedï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl restart keepalived
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="ç¬¬å››æ­¥-æµ‹è¯•keepalived" tabindex="-1"><a class="header-anchor" href="#ç¬¬å››æ­¥-æµ‹è¯•keepalived" aria-hidden="true">#</a> ç¬¬å››æ­¥ï¼šæµ‹è¯•Keepalived</h3>
<p>ä¸Šé¢çš„é…ç½®ä¸­ï¼Œ<code v-pre>10.0.4.20</code>çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹<code v-pre>10.0.4.20</code>å°†è¢«é€‰æ‹©ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="https://static001.geekbang.org/resource/image/54/79/54968f40707b779e2ab70d3ab5a53479.png?wh=1920x500" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/54/79/54968f40707b779e2ab70d3ab5a53479.png?wh=1920x500" alt="å›¾ç‰‡"><ExternalLinkIcon/></a></p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¨¡æ‹Ÿä¸€äº›æ•…éšœåœºæ™¯ï¼Œæ¥çœ‹ä¸‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆã€‚</p>
<p><strong>åœºæ™¯1ï¼šKeepalivedæ•…éšœ</strong></p>
<p>åœ¨<code v-pre>10.0.4.20</code>æœåŠ¡å™¨ä¸Šæ‰§è¡Œ<code v-pre>sudo systemctl stop keepalived</code>æ¨¡æ‹ŸKeepalivedæ•…éšœï¼ŒæŸ¥çœ‹VIPï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544" alt="å›¾ç‰‡"><ExternalLinkIcon/></a></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒVIPä»<code v-pre>10.0.4.20</code>æœåŠ¡å™¨ä¸Šï¼Œæ¼‚ç§»åˆ°äº†<code v-pre>10.0.4.21</code>æœåŠ¡å™¨ä¸Šã€‚æŸ¥çœ‹<code v-pre>/var/log/keepalived.log</code>ï¼Œå¯ä»¥çœ‹åˆ°<code v-pre>10.0.4.20</code>æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹ä¸€è¡Œæ—¥å¿—ï¼š</p>
<div class="language-plain ext-plain line-numbers-mode"><pre v-pre class="language-plain"><code>[2020-10-14 14:01:51] notify_stop
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code v-pre>10.0.4.21</code>æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹æ—¥å¿—ï¼š</p>
<div class="language-plain ext-plain line-numbers-mode"><pre v-pre class="language-plain"><code>[2020-10-14 14:01:52] notify_master
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>åœºæ™¯2ï¼šNginxæ•…éšœ</strong></p>
<p>åœ¨<code v-pre>10.0.4.20</code>å’Œ<code v-pre>10.0.4.21</code>æœåŠ¡å™¨ä¸Šåˆ†åˆ«æ‰§è¡Œ<code v-pre>sudo systemctl restart keepalived</code>ï¼Œè®©VIPæ¼‚ç§»åˆ°<code v-pre>10.0.4.20</code>æœåŠ¡å™¨ä¸Šã€‚</p>
<p>åœ¨<code v-pre>10.0.4.20</code>æœåŠ¡å™¨ä¸Šï¼Œæ‰§è¡Œ <code v-pre>sudo systemctl stop nginx</code> æ¨¡æ‹ŸNginxæ•…éšœï¼ŒæŸ¥çœ‹VIPï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544" alt="å›¾ç‰‡"><ExternalLinkIcon/></a></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒVIPä»<code v-pre>10.0.4.20</code>æœåŠ¡å™¨ä¸Šï¼Œæ¼‚ç§»åˆ°äº†<code v-pre>10.0.4.21</code>æœåŠ¡å™¨ä¸Šã€‚æŸ¥çœ‹<code v-pre>/var/log/keepalived.log</code>ï¼Œå¯ä»¥çœ‹åˆ°<code v-pre>10.0.4.20</code>æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹ä¸€è¡Œæ—¥å¿—ï¼š</p>
<div class="language-plain ext-plain line-numbers-mode"><pre v-pre class="language-plain"><code>[2020-10-14 14:02:34] notify_fault
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code v-pre>10.0.4.21</code> æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹æ—¥å¿—ï¼š</p>
<div class="language-plain ext-plain line-numbers-mode"><pre v-pre class="language-plain"><code>[2020-10-14 14:02:35] notify_master
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>åœºæ™¯3ï¼šNginxæ¢å¤</strong></p>
<p>åŸºäº<strong>åœºæ™¯2</strong>ï¼Œåœ¨<code v-pre>10.0.4.20</code>æœåŠ¡å™¨ä¸Šæ‰§è¡Œ<code v-pre>sudo systemctl start nginx</code>æ¢å¤Nginxï¼ŒæŸ¥çœ‹VIPï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544" alt="å›¾ç‰‡"><ExternalLinkIcon/></a></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒVIPä»ç„¶åœ¨<code v-pre>10.0.4.21</code>æœåŠ¡å™¨ä¸Šï¼Œæ²¡æœ‰è¢«<code v-pre>10.0.4.20</code>æŠ¢å ã€‚æŸ¥çœ‹<code v-pre>/var/log/keepalived.log</code>ï¼Œå¯ä»¥çœ‹åˆ°<code v-pre>10.0.4.20</code>æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹ä¸€è¡Œæ—¥å¿—ï¼š</p>
<div class="language-plain ext-plain line-numbers-mode"><pre v-pre class="language-plain"><code>[2020-10-14 14:03:44] notify_backup
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code v-pre>10.0.4.21</code>æœåŠ¡å™¨æ²¡æœ‰æ–°å¢æ—¥å¿—ã€‚</p>
<h3 id="ç¬¬äº”æ­¥-vipç»‘å®šå…¬ç½‘ip" tabindex="-1"><a class="header-anchor" href="#ç¬¬äº”æ­¥-vipç»‘å®šå…¬ç½‘ip" aria-hidden="true">#</a> ç¬¬äº”æ­¥ï¼šVIPç»‘å®šå…¬ç½‘IP</h3>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸé…ç½®äº†Keepalived + Nginxçš„é«˜å¯ç”¨æ–¹æ¡ˆã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„VIPæ˜¯å†…ç½‘ï¼Œè¿˜ä¸èƒ½é€šè¿‡å¤–ç½‘è®¿é—®ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°†VIPç»‘å®šä¸€ä¸ªå¤–ç½‘IPï¼Œä¾›å¤–ç½‘è®¿é—®ã€‚åœ¨è…¾è®¯äº‘ä¸Šï¼Œå¯é€šè¿‡ç»‘å®šå¼¹æ€§å…¬ç½‘IPæ¥å®ç°å¤–ç½‘è®¿é—®ï¼Œéœ€è¦å…ˆç”³è¯·å…¬ç½‘IPï¼Œç„¶åå°†VIPç»‘å®šå¼¹æ€§å…¬ç½‘IPã€‚ä¸‹é¢æˆ‘æ¥è®²è®²å…·ä½“æ­¥éª¤ã€‚</p>
<p>ç”³è¯·å…¬ç½‘IPï¼š</p>
<ol>
<li>ç™»å½•<strong>ç§æœ‰ç½‘ç»œæ§åˆ¶å°ã€‚</strong></li>
<li>åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œé€‰æ‹©ã€IPä¸ç½‘å¡ã€‘&gt;ã€å¼¹æ€§å…¬ç½‘IPã€‘ã€‚</li>
<li>åœ¨å¼¹æ€§å…¬ç½‘IPç®¡ç†é¡µé¢ï¼Œé€‰æ‹©æ‰€åœ¨åœ°åŸŸï¼Œå•å‡»ã€ç”³è¯·ã€‘ã€‚</li>
</ol>
<p>å°†VIPç»‘å®šå¼¹æ€§å…¬ç½‘IPï¼š</p>
<ol>
<li>ç™»å½•<strong>ç§æœ‰ç½‘ç»œæ§åˆ¶å°</strong>ã€‚</li>
<li>åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œé€‰æ‹©ã€IPä¸ç½‘å¡ã€‘&gt;ã€é«˜å¯ç”¨è™šæ‹Ÿã€‘ã€‚</li>
<li>å•å‡»éœ€è¦ç»‘å®šçš„HAVIPæ‰€åœ¨è¡Œçš„ã€ç»‘å®šã€‘ã€‚</li>
<li>åœ¨å¼¹å‡ºç•Œé¢ä¸­ï¼Œé€‰æ‹©éœ€è¦ç»‘å®šçš„å…¬ç½‘IPå³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>
</ol>
<p><a href="https://static001.geekbang.org/resource/image/83/62/83bc9f4595325e9d339e7c3269aa3462.png?wh=1388x666" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/83/62/83bc9f4595325e9d339e7c3269aa3462.png?wh=1388x666" alt="å›¾ç‰‡"><ExternalLinkIcon/></a></p>
<p>ç»‘å®šçš„å¼¹æ€§å…¬ç½‘IPæ˜¯<code v-pre>106.52.252.139</code>ã€‚</p>
<p>è¿™é‡Œæç¤ºä¸‹ï¼Œè…¾è®¯äº‘å¹³å°ä¸­ï¼Œå¦‚æœHAVIPæ²¡æœ‰ç»‘å®šå®ä¾‹ï¼Œç»‘å®šHAVIPçš„EIPä¼šå¤„äºé—²ç½®çŠ¶æ€ï¼ŒæŒ‰<code v-pre>Â¥0.2/å°æ—¶</code> æ”¶å–é—²ç½®è´¹ç”¨ã€‚æ‰€ä»¥ï¼Œä½ éœ€è¦æ­£ç¡®é…ç½®é«˜å¯ç”¨åº”ç”¨ï¼Œç¡®ä¿ç»‘å®šæˆåŠŸã€‚</p>
<h3 id="ç¬¬å…­æ­¥-æµ‹è¯•å…¬ç½‘è®¿é—®" tabindex="-1"><a class="header-anchor" href="#ç¬¬å…­æ­¥-æµ‹è¯•å…¬ç½‘è®¿é—®" aria-hidden="true">#</a> ç¬¬å…­æ­¥ï¼šæµ‹è¯•å…¬ç½‘è®¿é—®</h3>
<p>æœ€åï¼Œä½ å¯ä»¥é€šè¿‡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ¥æµ‹è¯•ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> -H<span class="token string">"Host: iam.api.marmotedu.com"</span> http://106.52.252.139/healthz -H<span class="token string">"iam.api.marmotedu.com"</span>
<span class="token punctuation">{</span><span class="token string">"status"</span><span class="token builtin class-name">:</span><span class="token string">"ok"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥æˆåŠŸé€šè¿‡å…¬ç½‘è®¿é—®åç«¯çš„é«˜å¯ç”¨æœåŠ¡ã€‚åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æˆåŠŸéƒ¨ç½²äº†ä¸€ä¸ªå¯ç”¨æ€§å¾ˆé«˜çš„IAMåº”ç”¨ã€‚</p>
<h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2>
<p>ä»Šå¤©ï¼Œæˆ‘ä¸»è¦è®²äº†å¦‚ä½•ä½¿ç”¨Nginxå’ŒKeepalivedï¼Œæ¥éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„IAMåº”ç”¨ã€‚</p>
<p>ä¸ºäº†éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„IAMåº”ç”¨ï¼Œæˆ‘ä»¬è‡³å°‘éœ€è¦ä¸¤å°æœåŠ¡å™¨ï¼Œå¹¶ä¸”éƒ¨ç½²ç›¸åŒçš„æœåŠ¡iam-apiserverã€iam-authz-serverã€iam-pumpã€‚è€Œä¸”ï¼Œé€‰æ‹©å…¶ä¸­ä¸€å°æœåŠ¡å™¨éƒ¨ç½²æ•°æ®åº“æœåŠ¡ï¼šMariaDBã€Redisã€MongoDBã€‚</p>
<p>ä¸ºäº†å®‰å…¨å’Œæ€§èƒ½ï¼Œiam-apiserverã€iam-authz-serverã€iam-pumpæœåŠ¡éƒ½æ˜¯é€šè¿‡å†…ç½‘æ¥è®¿é—®æ•°æ®åº“æœåŠ¡çš„ã€‚è¿™ä¸€è®²ï¼Œæˆ‘è¿˜ä»‹ç»äº†å¦‚ä½•é…ç½®Nginxæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œå¦‚ä½•é…ç½®Keepalivedæ¥å®ç°Nginxçš„é«˜å¯ç”¨ã€‚</p>
<h2 id="è¯¾åç»ƒä¹ " tabindex="-1"><a class="header-anchor" href="#è¯¾åç»ƒä¹ " aria-hidden="true">#</a> è¯¾åç»ƒä¹ </h2>
<ol>
<li>æ€è€ƒä¸‹ï¼Œå½“å‰éƒ¨ç½²æ¶æ„ä¸‹å¦‚æœiam-apiserveréœ€è¦æ‰©å®¹ï¼Œå¯ä»¥æ€ä¹ˆæ‰©å®¹ï¼Ÿ</li>
<li>æ€è€ƒä¸‹ï¼Œå½“VIPåˆ‡æ¢æ—¶ï¼Œå¦‚ä½•å®ç°å‘Šè­¦åŠŸèƒ½ï¼Œç»™ç³»ç»Ÿè¿ç»´äººå‘˜å‘Šè­¦ï¼Ÿ</li>
</ol>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '32.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '34.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/projects/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


