<template><div><ul>
<li><a href="https://github.com/cubxxw/iam" target="_blank" rel="noopener noreferrer">ğŸ”¥ å¼€æºåœ°å€<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬23èŠ‚-æ•°æ®æµ-é€šè¿‡iam-authz-serverè®¾è®¡-çœ‹æ•°æ®æµæœåŠ¡çš„è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#ç¬¬23èŠ‚-æ•°æ®æµ-é€šè¿‡iam-authz-serverè®¾è®¡-çœ‹æ•°æ®æµæœåŠ¡çš„è®¾è®¡" aria-hidden="true">#</a> ç¬¬23èŠ‚ æ•°æ®æµï¼šé€šè¿‡iam-authz-serverè®¾è®¡ï¼Œçœ‹æ•°æ®æµæœåŠ¡çš„è®¾è®¡</h1>
<br>
<div><a href = '22.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '24.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<nav class="table-of-contents"><ul><li><router-link to="#å‰è¨€">å‰è¨€</router-link></li><li><router-link to="#iam-authz-serverçš„åŠŸèƒ½ä»‹ç»">iam-authz-serverçš„åŠŸèƒ½ä»‹ç»</router-link><ul><li><router-link to="#github-com-ory-ladonåŒ…ä»‹ç»">github.com/ory/ladonåŒ…ä»‹ç»</router-link></li><li><router-link to="#iam-authz-serverä½¿ç”¨æ–¹æ³•ä»‹ç»">iam-authz-serverä½¿ç”¨æ–¹æ³•ä»‹ç»</router-link></li></ul></li><li><router-link to="#iam-authz-serverçš„ä»£ç å®ç°">iam-authz-serverçš„ä»£ç å®ç°</router-link><ul><li><router-link to="#iam-authz-serverçš„é…ç½®å¤„ç†">iam-authz-serverçš„é…ç½®å¤„ç†</router-link></li><li><router-link to="#iam-authz-serverå¯åŠ¨æµç¨‹è®¾è®¡">iam-authz-serverå¯åŠ¨æµç¨‹è®¾è®¡</router-link></li><li><router-link to="#iam-authz-server-çš„-restful-apiè¯·æ±‚å¤„ç†æµç¨‹">iam-authz-server çš„ RESTful APIè¯·æ±‚å¤„ç†æµç¨‹</router-link></li><li><router-link to="#iam-authz-serverçš„ä»£ç æ¶æ„">iam-authz-serverçš„ä»£ç æ¶æ„</router-link></li></ul></li><li><router-link to="#iam-authz-serverå…³é”®ä»£ç åˆ†æ">iam-authz-serverå…³é”®ä»£ç åˆ†æ</router-link><ul><li><router-link to="#èµ„æºæˆæƒ">èµ„æºæˆæƒ</router-link></li><li><router-link to="#ç¼“å­˜è®¾è®¡">ç¼“å­˜è®¾è®¡</router-link></li><li><router-link to="#æ•°æ®ä¸€è‡´æ€§">æ•°æ®ä¸€è‡´æ€§</router-link></li></ul></li><li><router-link to="#æ€»ç»“">æ€»ç»“</router-link></li><li><router-link to="#end-é“¾æ¥">END é“¾æ¥</router-link></li></ul></nav>
<p>[TOC]</p>
<h2 id="å‰è¨€" tabindex="-1"><a class="header-anchor" href="#å‰è¨€" aria-hidden="true">#</a> å‰è¨€</h2>
<p>åœ¨ <a href="https://time.geekbang.org/column/article/401190" target="_blank" rel="noopener noreferrer">28è®²<ExternalLinkIcon/></a> å’Œ <a href="https://time.geekbang.org/column/article/402206" target="_blank" rel="noopener noreferrer">29è®²<ExternalLinkIcon/></a> ï¼Œæˆ‘ä»‹ç»äº†IAMçš„æ§åˆ¶æµæœåŠ¡iam-apiserverçš„è®¾è®¡å’Œå®ç°ã€‚è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹IAMæ•°æ®æµæœåŠ¡iam-authz-serverçš„è®¾è®¡å’Œå®ç°ã€‚</p>
<p>å› ä¸ºiam-authz-serveræ˜¯æ•°æ®æµæœåŠ¡ï¼Œå¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œæ‰€ä»¥é‡‡ç”¨äº†ä¸€äº›æœºåˆ¶æ¥æœ€å¤§åŒ–APIæ¥å£çš„æ€§èƒ½ã€‚å¦å¤–ï¼Œä¸ºäº†æé«˜å¼€å‘æ•ˆç‡ï¼Œé¿å…é‡å¤é€ è½®å­ï¼Œiam-authz-serverå’Œiam-apiserverå…±äº«äº†å¤§éƒ¨åˆ†çš„åŠŸèƒ½ä»£ç ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹ï¼Œiam-authz-serveræ˜¯å¦‚ä½•è·Ÿiam-apiserverå…±äº«ä»£ç çš„ï¼Œä»¥åŠiam-authz-serveræ˜¯å¦‚ä½•ä¿è¯APIæ¥å£æ€§èƒ½çš„ã€‚</p>
<h2 id="iam-authz-serverçš„åŠŸèƒ½ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#iam-authz-serverçš„åŠŸèƒ½ä»‹ç»" aria-hidden="true">#</a> iam-authz-serverçš„åŠŸèƒ½ä»‹ç»</h2>
<p>iam-authz-serverç›®å‰çš„å”¯ä¸€åŠŸèƒ½ï¼Œæ˜¯é€šè¿‡æä¾› <code v-pre>/v1/authz</code> RESTful APIæ¥å£å®Œæˆèµ„æºæˆæƒã€‚ <code v-pre>/v1/authz</code> æ¥å£æ˜¯é€šè¿‡<a href="https://github.com/ory/ladon" target="_blank" rel="noopener noreferrer">github.com/ory/ladon<ExternalLinkIcon/></a>æ¥å®Œæˆèµ„æºæˆæƒçš„ã€‚</p>
<p>å› ä¸ºiam-authz-serveræ‰¿è½½äº†æ•°æ®æµçš„è¯·æ±‚ï¼Œéœ€è¦ç¡®ä¿APIæ¥å£å…·æœ‰è¾ƒé«˜çš„æ€§èƒ½ã€‚ä¸ºäº†ä¿è¯APIæ¥å£çš„æ€§èƒ½ï¼Œiam-authz-serveråœ¨è®¾è®¡ä¸Šä½¿ç”¨äº†å¤§é‡çš„ç¼“å­˜æŠ€æœ¯ã€‚</p>
<h3 id="github-com-ory-ladonåŒ…ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#github-com-ory-ladonåŒ…ä»‹ç»" aria-hidden="true">#</a> github.com/ory/ladonåŒ…ä»‹ç»</h3>
<p>å› ä¸ºiam-authz-serverèµ„æºæˆæƒæ˜¯é€šè¿‡ <code v-pre>github.com/ory/ladon</code> æ¥å®Œæˆçš„ï¼Œä¸ºäº†è®©ä½ æ›´å¥½åœ°ç†è§£iam-authz-serverçš„æˆæƒç­–ç•¥ï¼Œåœ¨è¿™é‡Œæˆ‘å…ˆä»‹ç»ä¸‹ <code v-pre>github.com/ory/ladon</code> åŒ…ã€‚</p>
<p><strong><a href="https://github.com/ory/ladon" target="_blank" rel="noopener noreferrer">Ladon<ExternalLinkIcon/></a>æ˜¯ç”¨Goè¯­è¨€ç¼–å†™çš„ç”¨äºå®ç°è®¿é—®æ§åˆ¶ç­–ç•¥çš„åº“ï¼Œç±»ä¼¼äºRBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ç³»ç»Ÿï¼ŒRole Based Access Controlï¼‰å’ŒACLï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ŒAccess Control Listsï¼‰ã€‚ä½†æ˜¯ä¸RBACå’ŒACLç›¸æ¯”ï¼ŒLadonå¯ä»¥å®ç°æ›´ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨æ›´ä¸ºå¤æ‚çš„ç¯å¢ƒä¸­ï¼ˆä¾‹å¦‚å¤šç§Ÿæˆ·ã€åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºå’Œå¤§å‹ç»„ç»‡ï¼‰å·¥ä½œã€‚</strong></p>
<p>Ladonè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼šåœ¨ç‰¹å®šçš„æ¡ä»¶ä¸‹ï¼Œè°èƒ½å¤Ÿ/ä¸èƒ½å¤Ÿå¯¹å“ªäº›èµ„æºåšå“ªäº›æ“ä½œã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒLadonå¼•å…¥äº†æˆæƒç­–ç•¥ã€‚æˆæƒç­–ç•¥æ˜¯ä¸€ä¸ªæœ‰è¯­æ³•è§„èŒƒçš„æ–‡æ¡£ï¼Œè¿™ä¸ªæ–‡æ¡£æè¿°äº†è°åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹èƒ½å¤Ÿå¯¹å“ªäº›èµ„æºåšå“ªäº›æ“ä½œã€‚Ladonå¯ä»¥ç”¨è¯·æ±‚çš„ä¸Šä¸‹æ–‡ï¼Œå»åŒ¹é…è®¾ç½®çš„æˆæƒç­–ç•¥ï¼Œæœ€ç»ˆåˆ¤æ–­å‡ºå½“å‰æˆæƒè¯·æ±‚æ˜¯å¦é€šè¿‡ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªLadonçš„æˆæƒç­–ç•¥æ ·ä¾‹ï¼š</p>
<div class="language-json ext-json line-numbers-mode"><pre v-pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"One policy to rule them all."</span><span class="token punctuation">,</span>
  <span class="token property">"subjects"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"users:&lt;peter|ken>"</span><span class="token punctuation">,</span> <span class="token string">"users:maria"</span><span class="token punctuation">,</span> <span class="token string">"groups:admins"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"actions"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"delete"</span><span class="token punctuation">,</span> <span class="token string">"&lt;create|update>"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"effect"</span><span class="token operator">:</span> <span class="token string">"allow"</span><span class="token punctuation">,</span>
  <span class="token property">"resources"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"resources:articles:&lt;.*>"</span><span class="token punctuation">,</span>
    <span class="token string">"resources:printer"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"conditions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"remoteIP"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"CIDRCondition"</span><span class="token punctuation">,</span>
        <span class="token property">"options"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"cidr"</span><span class="token operator">:</span> <span class="token string">"192.168.0.1/16"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç­–ç•¥ï¼ˆPolicyï¼‰ç”±è‹¥å¹²å…ƒç´ æ„æˆï¼Œç”¨æ¥æè¿°æˆæƒçš„å…·ä½“ä¿¡æ¯ï¼Œä½ å¯ä»¥æŠŠå®ƒä»¬çœ‹æˆä¸€ç»„è§„åˆ™ã€‚æ ¸å¿ƒå…ƒç´ åŒ…æ‹¬ä¸»é¢˜ï¼ˆSubjectï¼‰ã€æ“ä½œï¼ˆActionï¼‰ã€æ•ˆåŠ›ï¼ˆEffectï¼‰ã€èµ„æºï¼ˆResourceï¼‰ä»¥åŠç”Ÿæ•ˆæ¡ä»¶ï¼ˆConditionï¼‰ã€‚å…ƒç´ ä¿ç•™å­—ä»…æ”¯æŒå°å†™ï¼Œå®ƒä»¬åœ¨æè¿°ä¸Šæ²¡æœ‰é¡ºåºè¦æ±‚ã€‚å¯¹äºæ²¡æœ‰ç‰¹å®šçº¦æŸæ¡ä»¶çš„ç­–ç•¥ï¼ŒConditionå…ƒç´ æ˜¯å¯é€‰é¡¹ã€‚ä¸€æ¡ç­–ç•¥åŒ…å«ä¸‹é¢6ä¸ªå…ƒç´ ï¼š</p>
<ul>
<li>ä¸»é¢˜ï¼ˆSubjectï¼‰ï¼Œä¸»é¢˜åæ˜¯å”¯ä¸€çš„ï¼Œä»£è¡¨ä¸€ä¸ªæˆæƒä¸»é¢˜ã€‚ä¾‹å¦‚ï¼Œâ€œkenâ€ or â€œprinter-service.mydomain.comâ€ã€‚</li>
<li>æ“ä½œï¼ˆActionï¼‰ï¼Œæè¿°å…è®¸æˆ–æ‹’ç»çš„æ“ä½œã€‚</li>
<li>æ•ˆåŠ›ï¼ˆEffectï¼‰ï¼Œæè¿°ç­–ç•¥äº§ç”Ÿçš„ç»“æœæ˜¯â€œå…è®¸â€è¿˜æ˜¯â€œæ‹’ç»â€ï¼ŒåŒ…æ‹¬ allowï¼ˆå…è®¸ï¼‰å’Œ denyï¼ˆæ‹’ç»ï¼‰ã€‚</li>
<li>èµ„æºï¼ˆResourceï¼‰ï¼Œæè¿°æˆæƒçš„å…·ä½“æ•°æ®ã€‚</li>
<li>ç”Ÿæ•ˆæ¡ä»¶ï¼ˆConditionï¼‰ï¼Œæè¿°ç­–ç•¥ç”Ÿæ•ˆçš„çº¦æŸæ¡ä»¶ã€‚</li>
<li>æè¿°ï¼ˆDescriptionï¼‰ï¼Œç­–ç•¥çš„æè¿°ã€‚</li>
</ul>
<p>æœ‰äº†æˆæƒç­–ç•¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¼ å…¥è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œç”±Ladonæ¥å†³å®šè¯·æ±‚æ˜¯å¦èƒ½é€šè¿‡æˆæƒã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè¯·æ±‚ç¤ºä¾‹ï¼š</p>
<div class="language-json ext-json line-numbers-mode"><pre v-pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">"subject"</span><span class="token operator">:</span> <span class="token string">"users:peter"</span><span class="token punctuation">,</span>
  <span class="token property">"action"</span> <span class="token operator">:</span> <span class="token string">"delete"</span><span class="token punctuation">,</span>
  <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"resources:articles:ladon-introduction"</span><span class="token punctuation">,</span>
  <span class="token property">"context"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"remoteIP"</span><span class="token operator">:</span> <span class="token string">"192.168.0.5"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <code v-pre>remoteIP=&quot;192.168.0.5&quot;</code> ç”Ÿæ•ˆæ¡ä»¶ï¼ˆConditionï¼‰ä¸‹ï¼Œé’ˆå¯¹ä¸»é¢˜ï¼ˆSubjectï¼‰ <code v-pre>users:peter</code> å¯¹èµ„æºï¼ˆResourceï¼‰ <code v-pre>resources:articles:ladon-introduction</code> çš„ <code v-pre>delete</code> æ“ä½œï¼ˆActionï¼‰ï¼Œæˆæƒç­–ç•¥çš„æ•ˆåŠ›ï¼ˆEffectï¼‰æ˜¯ <code v-pre>allow</code> çš„ã€‚æ‰€ä»¥Ladonä¼šè¿”å›å¦‚ä¸‹ç»“æœï¼š</p>
<div class="language-json ext-json line-numbers-mode"><pre v-pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">"allowed"</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Ladonæ”¯æŒå¾ˆå¤šConditionï¼Œå…·ä½“è§ä¸‹è¡¨ï¼š</p>
<p><img src="https://static001.geekbang.org/resource/image/b8/dd/b84d2a1dc0e9ac07605a867594d734dd.jpg?wh=1920x1521" alt="å›¾ç‰‡"></p>
<p>è‡³äºå¦‚ä½•ä½¿ç”¨è¿™äº›Conditionï¼Œä½ å¯ä»¥å‚è€ƒ <a href="https://github.com/marmotedu/geekbang-go/blob/master/LadonCondition%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B.md" target="_blank" rel="noopener noreferrer">Ladon Conditionä½¿ç”¨ç¤ºä¾‹<ExternalLinkIcon/></a>ã€‚æ­¤å¤–ï¼ŒLadonè¿˜æ”¯æŒè‡ªå®šä¹‰Conditionã€‚</p>
<p>å¦å¤–ï¼ŒLadonè¿˜æ”¯æŒæˆæƒå®¡è®¡ï¼Œç”¨æ¥è®°å½•æˆæƒå†å²ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ladon.Ladonä¸­é™„åŠ ä¸€ä¸ªladon.AuditLoggeræ¥å®ç°ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">"github.com/ory/ladon"</span>
<span class="token keyword">import</span> manager <span class="token string">"github.com/ory/ladon/manager/memory"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    warden <span class="token operator">:=</span> ladon<span class="token punctuation">.</span>Ladon<span class="token punctuation">{</span>
        Manager<span class="token punctuation">:</span> manager<span class="token punctuation">.</span><span class="token function">NewMemoryManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        AuditLogger<span class="token punctuation">:</span> <span class="token operator">&amp;</span>ladon<span class="token punctuation">.</span>AuditLoggerInfo<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æä¾›äº†<code v-pre>ladon.AuditLoggerInfo</code>ï¼Œè¯¥AuditLoggerä¼šåœ¨æˆæƒæ—¶æ‰“å°è°ƒç”¨çš„ç­–ç•¥åˆ°æ ‡å‡†é”™è¯¯ã€‚AuditLoggeræ˜¯ä¸€ä¸ªinterfaceï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// AuditLogger tracks denied and granted authorizations.</span>
<span class="token keyword">type</span> AuditLogger <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">LogRejectedAccessRequest</span><span class="token punctuation">(</span>request <span class="token operator">*</span>Request<span class="token punctuation">,</span> pool Policies<span class="token punctuation">,</span> deciders Policies<span class="token punctuation">)</span>
    <span class="token function">LogGrantedAccessRequest</span><span class="token punctuation">(</span>request <span class="token operator">*</span>Request<span class="token punctuation">,</span> pool Policies<span class="token punctuation">,</span> deciders Policies<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¦å®ç°ä¸€ä¸ªæ–°çš„AuditLoggerï¼Œä½ åªéœ€è¦å®ç°AuditLoggeræ¥å£å°±å¯ä»¥äº†ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªAuditLoggerï¼Œå°†æˆæƒæ—¥å¿—ä¿å­˜åˆ°Redisæˆ–è€…MySQLä¸­ã€‚</p>
<p>Ladonæ”¯æŒè·Ÿè¸ªä¸€äº›æˆæƒæŒ‡æ ‡ï¼Œæ¯”å¦‚ denyã€allowã€not matchã€errorã€‚ä½ å¯ä»¥é€šè¿‡å®ç°<code v-pre>ladon.Metric</code>æ¥å£ï¼Œæ¥å¯¹è¿™äº›æŒ‡æ ‡è¿›è¡Œå¤„ç†ã€‚<code v-pre>ladon.Metric</code>æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// Metric is used to expose metrics about authz</span>
<span class="token keyword">type</span> Metric <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment">// RequestDeniedBy is called when we get explicit deny by policy</span>
    <span class="token function">RequestDeniedBy</span><span class="token punctuation">(</span>Request<span class="token punctuation">,</span> Policy<span class="token punctuation">)</span>
    <span class="token comment">// RequestAllowedBy is called when a matching policy has been found.</span>
    <span class="token function">RequestAllowedBy</span><span class="token punctuation">(</span>Request<span class="token punctuation">,</span> Policies<span class="token punctuation">)</span>
    <span class="token comment">// RequestNoMatch is called when no policy has matched our request</span>
    <span class="token function">RequestNoMatch</span><span class="token punctuation">(</span>Request<span class="token punctuation">)</span>
    <span class="token comment">// RequestProcessingError is called when unexpected error occured</span>
    <span class="token function">RequestProcessingError</span><span class="token punctuation">(</span>Request<span class="token punctuation">,</span> Policy<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¾‹å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„ç¤ºä¾‹ï¼Œå°†è¿™äº›æŒ‡æ ‡æš´éœ²ç»™<code v-pre>prometheus</code>ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> prometheusMetrics <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>mtr <span class="token operator">*</span>prometheusMetrics<span class="token punctuation">)</span> <span class="token function">RequestDeniedBy</span><span class="token punctuation">(</span>r ladon<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> p ladon<span class="token punctuation">.</span>Policy<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>mtr <span class="token operator">*</span>prometheusMetrics<span class="token punctuation">)</span> <span class="token function">RequestAllowedBy</span><span class="token punctuation">(</span>r ladon<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> policies ladon<span class="token punctuation">.</span>Policies<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>mtr <span class="token operator">*</span>prometheusMetrics<span class="token punctuation">)</span> <span class="token function">RequestNoMatch</span><span class="token punctuation">(</span>r ladon<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>mtr <span class="token operator">*</span>prometheusMetrics<span class="token punctuation">)</span> <span class="token function">RequestProcessingError</span><span class="token punctuation">(</span>r ladon<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    warden <span class="token operator">:=</span> ladon<span class="token punctuation">.</span>Ladon<span class="token punctuation">{</span>
        Manager<span class="token punctuation">:</span> manager<span class="token punctuation">.</span><span class="token function">NewMemoryManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Metric<span class="token punctuation">:</span>  <span class="token operator">&amp;</span>prometheusMetrics<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä½¿ç”¨Ladonçš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸¤ä¸ªåœ°æ–¹éœ€è¦ä½ æ³¨æ„ï¼š</p>
<ul>
<li>æ‰€æœ‰æ£€æŸ¥éƒ½åŒºåˆ†å¤§å°å†™ï¼Œå› ä¸ºä¸»é¢˜å€¼å¯èƒ½æ˜¯åŒºåˆ†å¤§å°å†™çš„IDã€‚</li>
<li>å¦‚æœladon.Ladonæ— æ³•å°†ç­–ç•¥ä¸è¯·æ±‚åŒ¹é…ï¼Œä¼šé»˜è®¤æˆæƒç»“æœä¸ºæ‹’ç»ï¼Œå¹¶è¿”å›é”™è¯¯ã€‚</li>
</ul>
<h3 id="iam-authz-serverä½¿ç”¨æ–¹æ³•ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#iam-authz-serverä½¿ç”¨æ–¹æ³•ä»‹ç»" aria-hidden="true">#</a> iam-authz-serverä½¿ç”¨æ–¹æ³•ä»‹ç»</h3>
<p>ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†iam-authz-serverçš„èµ„æºæˆæƒåŠŸèƒ½ï¼Œè¿™é‡Œä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨iam-authz-serverï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•è°ƒç”¨ <code v-pre>/v1/authz</code> æ¥å£å®Œæˆèµ„æºæˆæƒã€‚ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„3å¤§æ­¥éª¤ï¼Œæ¥å®Œæˆèµ„æºæˆæƒè¯·æ±‚ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼Œç™»é™† iam-apiserverï¼Œåˆ›å»ºæˆæƒç­–ç•¥å’Œå¯†é’¥ã€‚</strong></p>
<p>è¿™ä¸€æ­¥åˆåˆ†ä¸º3ä¸ªå°æ­¥éª¤ã€‚</p>
<ol>
<li>ç™»é™†iam-apiserverç³»ç»Ÿï¼Œè·å–è®¿é—®ä»¤ç‰Œï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token assign-left variable">token</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">'Content-Type: application/json'</span> -d<span class="token string">'{"username":"admin","password":"Admin@2021"}'</span> http://127.0.0.1:8080/login <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> .token<span class="token variable">`</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2">
<li>åˆ›å»ºæˆæƒç­–ç•¥ï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">"Content-Type: application/json"</span> -H<span class="token string">"Authorization: Bearer <span class="token variable">$token</span>"</span> -d<span class="token string">'{"metadata":{"name":"authztest"},"policy":{"description":"One policy to rule them all.","subjects":["users:&lt;peter|ken>","users:maria","groups:admins"],"actions":["delete","&lt;create|update>"],"effect":"allow","resources":["resources:articles:&lt;.*>","resources:printer"],"conditions":{"remoteIP":{"type":"CIDRCondition","options":{"cidr":"192.168.0.1/16"}}}}}'</span> http://127.0.0.1:8080/v1/policies
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="3">
<li>åˆ›å»ºå¯†é’¥ï¼Œå¹¶ä»è¯·æ±‚ç»“æœä¸­æå–secretID å’Œ secretKeyï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">"Content-Type: application/json"</span> -H<span class="token string">"Authorization: Bearer <span class="token variable">$token</span>"</span> -d<span class="token string">'{"metadata":{"name":"authztest"},"expires":0,"description":"admin secret"}'</span> http://127.0.0.1:8080/v1/secrets
<span class="token punctuation">{</span><span class="token string">"metadata"</span>:<span class="token punctuation">{</span><span class="token string">"id"</span>:23,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"authztest"</span>,<span class="token string">"createdAt"</span><span class="token builtin class-name">:</span><span class="token string">"2021-04-08T07:24:50.071671422+08:00"</span>,<span class="token string">"updatedAt"</span><span class="token builtin class-name">:</span><span class="token string">"2021-04-08T07:24:50.071671422+08:00"</span><span class="token punctuation">}</span>,<span class="token string">"username"</span><span class="token builtin class-name">:</span><span class="token string">"admin"</span>,<span class="token string">"secretID"</span><span class="token builtin class-name">:</span><span class="token string">"ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox"</span>,<span class="token string">"secretKey"</span><span class="token builtin class-name">:</span><span class="token string">"7Sfa5EfAPIwcTLGCfSvqLf0zZGCjF3l8"</span>,<span class="token string">"expires"</span>:0,<span class="token string">"description"</span><span class="token builtin class-name">:</span><span class="token string">"admin secret"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç¬¬äºŒæ­¥ï¼Œç”Ÿæˆè®¿é—® iam-authz-serverçš„ tokenã€‚</strong></p>
<p>iamctl æä¾›äº† <code v-pre>jwt sigin</code> å­å‘½ä»¤ï¼Œå¯ä»¥æ ¹æ® secretID å’Œ secretKey ç­¾å‘ Tokenï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ iamctl jwt sign ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox 7Sfa5EfAPIwcTLGCfSvqLf0zZGCjF3l8 <span class="token comment"># iamctl jwt sign $secretID $secretKey</span>
eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ å¯ä»¥é€šè¿‡ <code v-pre>iamctl jwt show &lt;token&gt;</code> æ¥æŸ¥çœ‹Tokençš„å†…å®¹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ iamctl jwt show eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ
Header:
<span class="token punctuation">{</span>
    <span class="token string">"alg"</span><span class="token builtin class-name">:</span> <span class="token string">"HS256"</span>,
    <span class="token string">"kid"</span><span class="token builtin class-name">:</span> <span class="token string">"ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox"</span>,
    <span class="token string">"typ"</span><span class="token builtin class-name">:</span> <span class="token string">"JWT"</span>
<span class="token punctuation">}</span>
Claims:
<span class="token punctuation">{</span>
    <span class="token string">"aud"</span><span class="token builtin class-name">:</span> <span class="token string">"iam.authz.marmotedu.com"</span>,
    <span class="token string">"exp"</span><span class="token builtin class-name">:</span> <span class="token number">1617845195</span>,
    <span class="token string">"iat"</span><span class="token builtin class-name">:</span> <span class="token number">1617837995</span>,
    <span class="token string">"iss"</span><span class="token builtin class-name">:</span> <span class="token string">"iamctl"</span>,
    <span class="token string">"nbf"</span><span class="token builtin class-name">:</span> <span class="token number">1617837995</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æˆ‘ä»¬ç”Ÿæˆçš„TokenåŒ…å«äº†ä¸‹é¢è¿™äº›ä¿¡æ¯ï¼š</strong></p>
<p><strong>Header</strong></p>
<ul>
<li><code v-pre>alg</code>ï¼šç”Ÿæˆç­¾åçš„ç®—æ³•ã€‚</li>
<li><code v-pre>kid</code>ï¼šå¯†é’¥IDã€‚</li>
<li><code v-pre>typ</code>ï¼šTokençš„ç±»å‹ï¼Œè¿™é‡Œæ˜¯JWTã€‚</li>
</ul>
<p><strong>Claims</strong></p>
<ul>
<li><code v-pre>aud</code>ï¼šJWT Tokençš„æ¥å—è€…ã€‚</li>
<li><code v-pre>exp</code>ï¼šJWT Tokençš„è¿‡æœŸæ—¶é—´ï¼ˆUNIXæ—¶é—´æ ¼å¼ï¼‰ã€‚</li>
<li><code v-pre>iat</code>ï¼šJWT Tokençš„ç­¾å‘æ—¶é—´ï¼ˆUNIXæ—¶é—´æ ¼å¼ï¼‰ã€‚</li>
<li><code v-pre>iss</code>ï¼šç­¾å‘è€…ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ç”¨ iamctl å·¥å…·ç­¾å‘çš„ï¼Œæ‰€ä»¥è¿™é‡Œçš„ç­¾å‘è€…æ˜¯ iamctlã€‚</li>
<li><code v-pre>nbf</code>ï¼šJWT Tokençš„ç”Ÿæ•ˆæ—¶é—´ï¼ˆUNIXæ—¶é—´æ ¼å¼ï¼‰ï¼Œé»˜è®¤æ˜¯ç­¾å‘æ—¶é—´ã€‚</li>
</ul>
<p><strong>ç¬¬ä¸‰æ­¥ï¼Œè°ƒç”¨ <code v-pre>/v1/authz</code>æ¥å£ï¼Œå®Œæˆèµ„æºæˆæƒè¯·æ±‚ã€‚</strong></p>
<p>è¯·æ±‚æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">'Content-Type: application/json'</span> -H<span class="token string">'Authorization: Bearer eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ'</span> -d<span class="token string">'{"subject":"users:maria","action":"delete","resource":"resources:articles:ladon-introduction","context":{"remoteIP":"192.168.0.5"}}'</span> http://127.0.0.1:9090/v1/authz
<span class="token punctuation">{</span><span class="token string">"allowed"</span>:true<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæˆæƒé€šè¿‡ï¼Œä¼šè¿”å›ï¼š<code v-pre>{&quot;allowed&quot;:true}</code> ã€‚ å¦‚æœæˆæƒå¤±è´¥ï¼Œåˆ™è¿”å›ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token punctuation">{</span><span class="token string">"allowed"</span>:false,<span class="token string">"denied"</span>:true,<span class="token string">"reason"</span><span class="token builtin class-name">:</span><span class="token string">"Request was denied by default"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="iam-authz-serverçš„ä»£ç å®ç°" tabindex="-1"><a class="header-anchor" href="#iam-authz-serverçš„ä»£ç å®ç°" aria-hidden="true">#</a> iam-authz-serverçš„ä»£ç å®ç°</h2>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹iam-authz-serverçš„å…·ä½“å®ç°ï¼Œæˆ‘ä¼šä»é…ç½®å¤„ç†ã€å¯åŠ¨æµç¨‹ã€è¯·æ±‚å¤„ç†æµç¨‹å’Œä»£ç æ¶æ„4ä¸ªæ–¹é¢æ¥è®²è§£ã€‚</p>
<h3 id="iam-authz-serverçš„é…ç½®å¤„ç†" tabindex="-1"><a class="header-anchor" href="#iam-authz-serverçš„é…ç½®å¤„ç†" aria-hidden="true">#</a> iam-authz-serverçš„é…ç½®å¤„ç†</h3>
<p>iam-authz-serveræœåŠ¡çš„mainå‡½æ•°ä½äº<a href="https://github.com/marmotedu/iam/blob/v1.0.4/cmd/iam-authz-server/authzserver.go" target="_blank" rel="noopener noreferrer">authzserver.go<ExternalLinkIcon/></a>æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥è·Ÿè¯»ä»£ç ï¼Œäº†è§£iam-authz-serverçš„ä»£ç å®ç°ã€‚iam-authz-serverçš„æœåŠ¡æ¡†æ¶è®¾è®¡è·Ÿiam-apiserverçš„æœåŠ¡æ¡†æ¶è®¾è®¡ä¿æŒä¸€è‡´ï¼Œä¹Ÿæ˜¯æœ‰3ç§é…ç½®ï¼šOptionsé…ç½®ã€ç»„ä»¶é…ç½®å’ŒHTTPæœåŠ¡é…ç½®ã€‚</p>
<p><strong>Optionsé…ç½®è§<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/options/options.go" target="_blank" rel="noopener noreferrer">options.go<ExternalLinkIcon/></a>æ–‡ä»¶ï¼š</strong></p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">type</span> Options <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    RPCServer               <span class="token builtin">string</span>
    ClientCA                <span class="token builtin">string</span>
    GenericServerRunOptions <span class="token operator">*</span>genericoptions<span class="token punctuation">.</span>ServerRunOptions
    InsecureServing         <span class="token operator">*</span>genericoptions<span class="token punctuation">.</span>InsecureServingOptions
    SecureServing           <span class="token operator">*</span>genericoptions<span class="token punctuation">.</span>SecureServingOptions
    RedisOptions            <span class="token operator">*</span>genericoptions<span class="token punctuation">.</span>RedisOptions
    FeatureOptions          <span class="token operator">*</span>genericoptions<span class="token punctuation">.</span>FeatureOptions
    Log                     <span class="token operator">*</span>log<span class="token punctuation">.</span>Options
    AnalyticsOptions        <span class="token operator">*</span>analytics<span class="token punctuation">.</span>AnalyticsOptions
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å’Œiam-apiserverç›¸æ¯”ï¼Œiam-authz-serverå¤šäº† <code v-pre>AnalyticsOptions</code>ï¼Œç”¨æ¥é…ç½®iam-authz-serverå†…çš„AnalyticsæœåŠ¡ï¼ŒAnalyticsæœåŠ¡ä¼šå°†æˆæƒæ—¥å¿—å¼‚æ­¥å†™å…¥åˆ°Redisä¸­ã€‚</p>
<p>iam-apiserverå’Œiam-authz-serverå…±ç”¨äº†GenericServerRunOptionsã€InsecureServingã€SecureServingã€FeatureOptionsã€RedisOptionsã€Logè¿™äº›é…ç½®ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨ç®€å•çš„å‡ è¡Œä»£ç ï¼Œå°±å¯ä»¥å°†å¾ˆå¤šé…ç½®é¡¹éƒ½å¼•å…¥åˆ°iam-authz-serverçš„å‘½ä»¤è¡Œå‚æ•°ä¸­ï¼Œè¿™ä¹Ÿæ˜¯å‘½ä»¤è¡Œå‚æ•°åˆ†ç»„å¸¦æ¥çš„å¥½å¤„ï¼šæ‰¹é‡å…±äº«ã€‚</p>
<h3 id="iam-authz-serverå¯åŠ¨æµç¨‹è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#iam-authz-serverå¯åŠ¨æµç¨‹è®¾è®¡" aria-hidden="true">#</a> iam-authz-serverå¯åŠ¨æµç¨‹è®¾è®¡</h3>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸‹iam-authz-serverçš„å¯åŠ¨æµç¨‹ã€‚</p>
<p>iam-authz-serverçš„å¯åŠ¨æµç¨‹ä¹Ÿå’Œiam-apiserveråŸºæœ¬ä¿æŒä¸€è‡´ã€‚äºŒè€…æ¯”è¾ƒå¤§çš„ä¸åŒåœ¨äºOptionså‚æ•°é…ç½®å’Œåº”ç”¨åˆå§‹åŒ–å†…å®¹ã€‚å¦å¤–ï¼Œå’Œiam-apiserverç›¸æ¯”ï¼Œiam-authz-serveråªæä¾›äº†REST APIæœåŠ¡ã€‚å¯åŠ¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202303042314376.jpeg" alt="img"></p>
<h3 id="iam-authz-server-çš„-restful-apiè¯·æ±‚å¤„ç†æµç¨‹" tabindex="-1"><a class="header-anchor" href="#iam-authz-server-çš„-restful-apiè¯·æ±‚å¤„ç†æµç¨‹" aria-hidden="true">#</a> iam-authz-server çš„ RESTful APIè¯·æ±‚å¤„ç†æµç¨‹</h3>
<p>iam-authz-serverçš„è¯·æ±‚å¤„ç†æµç¨‹ä¹Ÿæ˜¯æ¸…æ™°ã€è§„èŒƒçš„ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202303042314667.jpeg" alt="img"></p>
<p>**é¦–å…ˆï¼Œ**æˆ‘ä»¬é€šè¿‡APIè°ƒç”¨ï¼ˆ<code v-pre>&lt;HTTP Method&gt; + &lt;HTTP Request Path&gt;</code>ï¼‰è¯·æ±‚iam-authz-serveræä¾›çš„RESTful APIæ¥å£ <code v-pre>POST /v1/authz</code> ã€‚</p>
<p>**æ¥ç€ï¼Œ**Gin Webæ¡†æ¶æ¥æ”¶åˆ°HTTPè¯·æ±‚ä¹‹åï¼Œä¼šé€šè¿‡è®¤è¯ä¸­é—´ä»¶å®Œæˆè¯·æ±‚çš„è®¤è¯ï¼Œiam-authz-serveré‡‡ç”¨äº†Bearerè®¤è¯æ–¹å¼ã€‚</p>
<p>**ç„¶åï¼Œ**è¯·æ±‚ä¼šè¢«æˆ‘ä»¬åŠ è½½çš„ä¸€ç³»åˆ—ä¸­é—´ä»¶æ‰€å¤„ç†ï¼Œä¾‹å¦‚è·¨åŸŸã€RequestIDã€Dumpç­‰ä¸­é—´ä»¶ã€‚</p>
<p>**æœ€åï¼Œ**æ ¹æ®<code v-pre>&lt;HTTP Method&gt; + &lt;HTTP Request Path&gt;</code>è¿›è¡Œè·¯ç”±åŒ¹é…ã€‚</p>
<p>æ¯”å¦‚ï¼Œæˆ‘ä»¬è¯·æ±‚çš„RESTful APIæ˜¯<code v-pre>POST /v1/authz</code>ï¼ŒGin Webæ¡†æ¶ä¼šæ ¹æ® HTTP Method å’Œ HTTP Request Pathï¼ŒæŸ¥æ‰¾æ³¨å†Œçš„Controllersï¼Œæœ€ç»ˆåŒ¹é…åˆ° <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/controller/v1/authorize/authorize.go#L33" target="_blank" rel="noopener noreferrer">authzController.Authorize<ExternalLinkIcon/></a> Controllerã€‚åœ¨ Authorize Controllerä¸­ï¼Œä¼šå…ˆè§£æè¯·æ±‚å‚æ•°ï¼Œæ¥ç€æ ¡éªŒè¯·æ±‚å‚æ•°ã€è°ƒç”¨ä¸šåŠ¡å±‚çš„æ–¹æ³•è¿›è¡Œèµ„æºæˆæƒï¼Œæœ€åå¤„ç†ä¸šåŠ¡å±‚çš„è¿”å›ç»“æœï¼Œè¿”å›æœ€ç»ˆçš„ HTTP è¯·æ±‚ç»“æœã€‚</p>
<h3 id="iam-authz-serverçš„ä»£ç æ¶æ„" tabindex="-1"><a class="header-anchor" href="#iam-authz-serverçš„ä»£ç æ¶æ„" aria-hidden="true">#</a> iam-authz-serverçš„ä»£ç æ¶æ„</h3>
<p>iam-authz-serverçš„ä»£ç è®¾è®¡å’Œiam-apiserverä¸€æ ·ï¼Œéµå¾ªç®€æ´æ¶æ„è®¾è®¡ã€‚</p>
<p>iam-authz-serverçš„ä»£ç æ¶æ„ä¹Ÿåˆ†ä¸º4å±‚ï¼Œåˆ†åˆ«æ˜¯</p>
<ul>
<li>æ¨¡å‹å±‚ï¼ˆModelsï¼‰</li>
<li>æ§åˆ¶å±‚ï¼ˆControllerï¼‰</li>
<li>ä¸šåŠ¡å±‚ ï¼ˆServiceï¼‰</li>
<li>ä»“åº“å±‚ï¼ˆRepositoryï¼‰</li>
</ul>
<p>ä»æ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚åˆ°ä»“åº“å±‚ï¼Œä»å·¦åˆ°å³å±‚çº§ä¾æ¬¡åŠ æ·±ã€‚æ¨¡å‹å±‚ç‹¬ç«‹äºå…¶ä»–å±‚ï¼Œå¯ä¾›å…¶ä»–å±‚å¼•ç”¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202303042315040.jpeg" alt="img"></p>
<p>iam-authz-server å’Œ iam-apiserver çš„ä»£ç æ¶æ„æœ‰è¿™ä¸‰ç‚¹ä¸åŒï¼š</p>
<ul>
<li>iam-authz-server å®¢æˆ·ç«¯ä¸æ”¯æŒå‰ç«¯å’Œå‘½ä»¤è¡Œã€‚</li>
<li>iam-authz-server ä»“åº“å±‚å¯¹æ¥çš„æ˜¯iam-apiserverå¾®æœåŠ¡ï¼Œè€Œéæ•°æ®åº“ã€‚</li>
<li>iam-authz-server ä¸šåŠ¡å±‚çš„ä»£ç å­˜æ”¾åœ¨ç›®å½•<a href="https://github.com/marmotedu/iam/tree/v1.0.4/internal/authzserver/authorization" target="_blank" rel="noopener noreferrer">authorization<ExternalLinkIcon/></a>ä¸­ã€‚</li>
</ul>
<h2 id="iam-authz-serverå…³é”®ä»£ç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#iam-authz-serverå…³é”®ä»£ç åˆ†æ" aria-hidden="true">#</a> iam-authz-serverå…³é”®ä»£ç åˆ†æ</h2>
<p>å’Œ iam-apiserver ä¸€æ ·ï¼Œ<code v-pre>iam-authz-server</code> ä¹ŸåŒ…å«äº†ä¸€äº›ä¼˜ç§€çš„è®¾è®¡æ€è·¯å’Œå…³é”®ä»£ç ï¼Œè¿™é‡Œæˆ‘æ¥ä¸€ä¸€ä»‹ç»ä¸‹ã€‚</p>
<h3 id="èµ„æºæˆæƒ" tabindex="-1"><a class="header-anchor" href="#èµ„æºæˆæƒ" aria-hidden="true">#</a> èµ„æºæˆæƒ</h3>
<p>å…ˆæ¥çœ‹ä¸‹ï¼Œiam-authz-serveræ˜¯å¦‚ä½•å®ç°èµ„æºæˆæƒçš„ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è°ƒç”¨iam-authz-serverçš„ <code v-pre>/v1/authz</code> APIæ¥å£ï¼Œå®ç°èµ„æºçš„è®¿é—®æˆæƒã€‚ <code v-pre>/v1/authz</code> å¯¹åº”çš„controlleræ–¹æ³•æ˜¯<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/controller/v1/authorize/authorize.go#L33" target="_blank" rel="noopener noreferrer">Authorize<ExternalLinkIcon/></a>ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>AuthzController<span class="token punctuation">)</span> <span class="token function">Authorize</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> r ladon<span class="token punctuation">.</span>Request
  <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrBind<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  auth <span class="token operator">:=</span> authorization<span class="token punctuation">.</span><span class="token function">NewAuthorizer</span><span class="token punctuation">(</span>authorizer<span class="token punctuation">.</span><span class="token function">NewAuthorization</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> r<span class="token punctuation">.</span>Context <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    r<span class="token punctuation">.</span>Context <span class="token operator">=</span> ladon<span class="token punctuation">.</span>Context<span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  r<span class="token punctuation">.</span>Context<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
  rsp <span class="token operator">:=</span> auth<span class="token punctuation">.</span><span class="token function">Authorize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token punctuation">)</span>

  core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> rsp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥å‡½æ•°ä½¿ç”¨ <code v-pre>github.com/ory/ladon</code> åŒ…è¿›è¡Œèµ„æºè®¿é—®æˆæƒï¼Œæˆæƒæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202303042316433.jpeg" alt="img"></p>
<p><strong>å…·ä½“åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</strong></p>
<p>ç¬¬ä¸€æ­¥ï¼Œåœ¨Authorizeæ–¹æ³•ä¸­è°ƒç”¨ <code v-pre>c.ShouldBind(&amp;r)</code> ï¼Œå°†APIè¯·æ±‚å‚æ•°è§£æåˆ° <code v-pre>ladon.Request</code> ç±»å‹çš„ç»“æ„ä½“å˜é‡ä¸­ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼Œè°ƒç”¨<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/authorization/authorizer.go#L21" target="_blank" rel="noopener noreferrer">authorization.NewAuthorizer<ExternalLinkIcon/></a>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåˆ›å»ºå¹¶è¿”å›åŒ…å«Managerå’ŒAuditLoggerå­—æ®µçš„<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/authorization/authorizer.go#L16" target="_blank" rel="noopener noreferrer">Authorizer<ExternalLinkIcon/></a>ç±»å‹çš„å˜é‡ã€‚</p>
<p>ManageråŒ…å«ä¸€äº›å‡½æ•°ï¼Œæ¯”å¦‚ Createã€Updateå’ŒFindRequestCandidatesç­‰ï¼Œç”¨æ¥å¯¹æˆæƒç­–ç•¥è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚AuditLoggeråŒ…å« LogRejectedAccessRequest å’Œ LogGrantedAccessRequest å‡½æ•°ï¼Œåˆ†åˆ«ç”¨æ¥è®°å½•è¢«æ‹’ç»çš„æˆæƒè¯·æ±‚å’Œè¢«å…è®¸çš„æˆæƒè¯·æ±‚ï¼Œå°†å…¶ä½œä¸ºå®¡è®¡æ•°æ®ä½¿ç”¨ã€‚</p>
<p>ç¬¬ä¸‰æ­¥ï¼Œè°ƒç”¨<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/authorization/authorizer.go#L31" target="_blank" rel="noopener noreferrer">auth.Authorize<ExternalLinkIcon/></a>å‡½æ•°ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè®¿é—®æˆæƒã€‚auth.Authorizeå‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Authorizer<span class="token punctuation">)</span> <span class="token function">Authorize</span><span class="token punctuation">(</span>request <span class="token operator">*</span>ladon<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token operator">*</span>authzv1<span class="token punctuation">.</span>Response <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"authorize request"</span><span class="token punctuation">,</span> log<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token string">"request"</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span>warden<span class="token punctuation">.</span><span class="token function">IsAllowed</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>authzv1<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
      Denied<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      Reason<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token operator">&amp;</span>authzv1<span class="token punctuation">.</span>Response<span class="token punctuation">{</span>
    Allowed<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥å‡½æ•°ä¼šè°ƒç”¨ <code v-pre>a.warden.IsAllowed(request)</code> å®Œæˆèµ„æºè®¿é—®æˆæƒã€‚IsAllowedå‡½æ•°ä¼šè°ƒç”¨ <code v-pre>FindRequestCandidates(r)</code> æŸ¥è¯¢æ‰€æœ‰çš„ç­–ç•¥åˆ—è¡¨ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œæˆ‘ä»¬åªéœ€è¦æŸ¥è¯¢è¯·æ±‚ç”¨æˆ·çš„policyåˆ—è¡¨ã€‚åœ¨Authorizeå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†usernameå­˜å…¥ladon Requestçš„contextä¸­ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>r<span class="token punctuation">.</span>Context<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">GetHeader</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åœ¨<a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/authorization/manager.go#L54" target="_blank" rel="noopener noreferrer">FindRequestCandidates<ExternalLinkIcon/></a>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä»Requestä¸­å–å‡ºusernameï¼Œå¹¶æ ¹æ®usernameæŸ¥è¯¢ç¼“å­˜ä¸­çš„policyåˆ—è¡¨ï¼ŒFindRequestCandidateså®ç°å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>PolicyManager<span class="token punctuation">)</span> <span class="token function">FindRequestCandidates</span><span class="token punctuation">(</span>r <span class="token operator">*</span>ladon<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span>ladon<span class="token punctuation">.</span>Policies<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    username <span class="token operator">:=</span> <span class="token string">""</span>
  
    <span class="token keyword">if</span> user<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>Context<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
      username <span class="token operator">=</span> user
    <span class="token punctuation">}</span>
  
    policies<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"list policies failed"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  
    ret <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ladon<span class="token punctuation">.</span>Policy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>policies<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> policy <span class="token operator">:=</span> <span class="token keyword">range</span> policies <span class="token punctuation">{</span>
      ret <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> policy<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">return</span> ret<span class="token punctuation">,</span> <span class="token boolean">nil</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>IsAllowedå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Ladon<span class="token punctuation">)</span> <span class="token function">IsAllowed</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    policies<span class="token punctuation">,</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span>Manager<span class="token punctuation">.</span><span class="token function">FindRequestCandidates</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">go</span> l<span class="token punctuation">.</span><span class="token function">metric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RequestProcessingError</span><span class="token punctuation">(</span><span class="token operator">*</span>r<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> l<span class="token punctuation">.</span><span class="token function">DoPoliciesAllow</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> policies<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>IsAllowedä¼šè°ƒç”¨ <code v-pre>DoPoliciesAllow(r, policies)</code> å‡½æ•°è¿›è¡Œæƒé™æ ¡éªŒã€‚å¦‚æœæƒé™æ ¡éªŒä¸é€šè¿‡ï¼ˆè¯·æ±‚åœ¨æŒ‡å®šæ¡ä»¶ä¸‹ä¸èƒ½å¤Ÿå¯¹èµ„æºåšæŒ‡å®šæ“ä½œï¼‰ï¼Œå°±è°ƒç”¨ <code v-pre>LogRejectedAccessRequest</code> å‡½æ•°è®°å½•æ‹’ç»çš„è¯·æ±‚ï¼Œå¹¶è¿”å›å€¼ä¸ºénilçš„errorï¼Œerrorä¸­è®°å½•äº†æˆæƒå¤±è´¥çš„é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœæƒé™æ ¡éªŒé€šè¿‡ï¼Œåˆ™è°ƒç”¨ <code v-pre>LogGrantedAccessRequest</code> å‡½æ•°è®°å½•å…è®¸çš„è¯·æ±‚ï¼Œå¹¶è¿”å›å€¼ä¸ºnilçš„errorã€‚</p>
<p>ä¸ºäº†é™ä½è¯·æ±‚å»¶æ—¶ï¼ŒLogRejectedAccessRequestå’ŒLogGrantedAccessRequestä¼šå°†æˆæƒè®°å½•å­˜å‚¨åœ¨Redisä¸­ï¼Œä¹‹åç”±iam-pumpè¿›ç¨‹è¯»å–Redisï¼Œå¹¶å°†æˆæƒè®°å½•æŒä¹…åŒ–å­˜å‚¨åœ¨MongoDBä¸­ã€‚</p>
<h3 id="ç¼“å­˜è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜è®¾è®¡" aria-hidden="true">#</a> ç¼“å­˜è®¾è®¡</h3>
<p>iam-authz-serverä¸»è¦ç”¨æ¥åšèµ„æºè®¿é—®æˆæƒï¼Œå±äºæ•°æ®æµçš„ç»„ä»¶ï¼Œå¯¹æ¥å£è®¿é—®æ€§èƒ½æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼Œæ‰€ä»¥è¯¥ç»„ä»¶é‡‡ç”¨äº†ç¼“å­˜çš„æœºåˆ¶ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202303042320793.jpeg" alt="img"></p>
<p>iam-authz-serverç»„ä»¶é€šè¿‡<strong>ç¼“å­˜å¯†é’¥å’Œæˆæƒç­–ç•¥ä¿¡æ¯</strong>åˆ°å†…å­˜ä¸­ï¼ŒåŠ å¿«å¯†é’¥å’Œæˆæƒç­–ç•¥çš„æŸ¥è¯¢é€Ÿåº¦ã€‚é€šè¿‡<strong>ç¼“å­˜æˆæƒè®°å½•</strong>åˆ°å†…å­˜ä¸­ï¼Œæé«˜äº†æˆæƒæ•°æ®çš„å†™å…¥é€Ÿåº¦ï¼Œä»è€Œå¤§å¤§é™ä½äº†æˆæƒè¯·æ±‚æ¥å£çš„å»¶æ—¶ã€‚</p>
<p>ä¸Šé¢çš„ç¼“å­˜æœºåˆ¶ç”¨åˆ°äº†Redis key-valueå­˜å‚¨ï¼Œæ‰€ä»¥åœ¨iam-authz-serveråˆå§‹åŒ–é˜¶æ®µï¼Œéœ€è¦å…ˆå»ºç«‹Redisè¿æ¥ï¼ˆä½äº<a href="https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/server.go#L132" target="_blank" rel="noopener noreferrer">initialize<ExternalLinkIcon/></a>å‡½æ•°ä¸­ï¼‰ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">go</span> storage<span class="token punctuation">.</span><span class="token function">ConnectToRedis</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">buildStorageConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™ä¸ªä»£ç ä¼šç»´æŠ¤ä¸€ä¸ªRedisè¿æ¥ï¼Œå¦‚æœRedisè¿æ¥æ–­æ‰ï¼Œä¼šå°è¯•é‡è¿ã€‚è¿™ç§æ–¹å¼å¯ä»¥ä½¿æˆ‘ä»¬åœ¨è°ƒç”¨Redisæ¥å£è¿›è¡Œæ•°æ®è¯»å†™æ—¶ï¼Œä¸ç”¨è€ƒè™‘è¿æ¥æ–­å¼€çš„é—®é¢˜ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥è¯¦ç»†çœ‹çœ‹ï¼Œiam-authz-serveræ˜¯å¦‚ä½•å®ç°ç¼“å­˜æœºåˆ¶çš„ã€‚</p>
<p><strong>å…ˆæ¥çœ‹ä¸‹å¯†é’¥å’Œç­–ç•¥ç¼“å­˜ã€‚</strong></p>
<p>iam-authz-serveré€šè¿‡<a href="https://github.com/marmotedu/iam/tree/v1.0.5/internal/authzserver/load" target="_blank" rel="noopener noreferrer">load<ExternalLinkIcon/></a>åŒ…æ¥å®Œæˆå¯†é’¥å’Œç­–ç•¥çš„ç¼“å­˜ã€‚</p>
<p>åœ¨iam-authz-serverè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œä¼šåˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªLoadæœåŠ¡ï¼ˆä½äº<a href="https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/server.go#L144" target="_blank" rel="noopener noreferrer">initialize<ExternalLinkIcon/></a>å‡½æ•°ä¸­ï¼‰ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>load<span class="token punctuation">.</span><span class="token function">NewLoader</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cacheIns<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>**å…ˆæ¥çœ‹åˆ›å»ºLoadæœåŠ¡ã€‚**åˆ›å»ºLoadæœåŠ¡æ—¶ï¼Œä¼ å…¥äº†cacheInså‚æ•°ï¼ŒcacheInsæ˜¯ä¸€ä¸ªå®ç°äº†<a href="https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/load.go#L16" target="_blank" rel="noopener noreferrer">Loader<ExternalLinkIcon/></a>æ¥å£çš„å®ä¾‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Loader <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**ç„¶åçœ‹å¯åŠ¨LoadæœåŠ¡ã€‚**é€šè¿‡Loadå®ä¾‹çš„ <a href="https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/load.go#L37" target="_blank" rel="noopener noreferrer">Start<ExternalLinkIcon/></a> æ–¹æ³•æ¥å¯åŠ¨LoadæœåŠ¡ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Load<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">go</span> <span class="token function">startPubSubLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> l<span class="token punctuation">.</span><span class="token function">reloadQueueLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> l<span class="token punctuation">.</span><span class="token function">reloadLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    l<span class="token punctuation">.</span><span class="token function">DoReload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Startå‡½æ•°å…ˆå¯åŠ¨äº†3ä¸ªåç¨‹ï¼Œå†è°ƒç”¨ <code v-pre>l.DoReload()</code> å®Œæˆä¸€æ¬¡å¯†é’¥å’Œç­–ç•¥çš„åŒæ­¥ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Load<span class="token punctuation">)</span> <span class="token function">DoReload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    l<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> l<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">Reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"faild to refresh target storage: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"refresh target storage succ"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢æˆ‘ä»¬è¯´äº†ï¼Œåˆ›å»ºLoadæœåŠ¡æ—¶ï¼Œä¼ å…¥çš„cacheInså®ä¾‹æ˜¯ä¸€ä¸ªå®ç°äº†Loaderæ¥å£çš„å®ä¾‹ï¼Œæ‰€ä»¥åœ¨<a href="https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/load.go#L119" target="_blank" rel="noopener noreferrer">DoReload<ExternalLinkIcon/></a>æ–¹æ³•ä¸­ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨Reloadæ–¹æ³•ã€‚cacheInsçš„Reloadæ–¹æ³•ä¼šä»iam-apiserverä¸­åŒæ­¥å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯åˆ°iam-authz-serverç¼“å­˜ä¸­ã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹ä¸‹ï¼ŒstartPubSubLoopã€reloadQueueLoopã€reloadLoop è¿™3ä¸ªGoåç¨‹åˆ†åˆ«å®Œæˆäº†ä»€ä¹ˆåŠŸèƒ½ã€‚</p>
<h4 id="startpubsubloopåç¨‹" tabindex="-1"><a class="header-anchor" href="#startpubsubloopåç¨‹" aria-hidden="true">#</a> startPubSubLoopåç¨‹</h4>
<p><a href="https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/redis_signals.go#L46" target="_blank" rel="noopener noreferrer">startPubSubLoop<ExternalLinkIcon/></a>å‡½æ•°é€šè¿‡<a href="https://github.com/marmotedu/iam/blob/v1.0.5/pkg/storage/redis_cluster.go#L897" target="_blank" rel="noopener noreferrer">StartPubSubHandler<ExternalLinkIcon/></a>å‡½æ•°ï¼Œè®¢é˜…Redisçš„ <code v-pre>iam.cluster.notifications</code> channelï¼Œå¹¶æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleRedisEvent</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/redis_signals.go#L65" target="_blank" rel="noopener noreferrer">handleRedisEvent<ExternalLinkIcon/></a>å‡½æ•°ä¸­ï¼Œä¼šå°†æ¶ˆæ¯è§£æä¸º<a href="https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/redis_signals.go#L32" target="_blank" rel="noopener noreferrer">Notification<ExternalLinkIcon/></a>ç±»å‹çš„æ¶ˆæ¯ï¼Œå¹¶åˆ¤æ–­Commandçš„å€¼ã€‚å¦‚æœæ˜¯NoticePolicyChangedæˆ–NoticeSecretChangedï¼Œå°±ä¼šå‘ <code v-pre>reloadQueue</code> channelä¸­å†™å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚å› ä¸ºæˆ‘ä»¬ä¸éœ€è¦ç”¨å›è°ƒå‡½æ•°åšä»»ä½•äº‹æƒ…ï¼Œæ‰€ä»¥è¿™é‡Œå›è°ƒå‡½æ•°æ˜¯nilã€‚ <code v-pre>reloadQueue</code> ä¸»è¦ç”¨æ¥å‘Šè¯‰ç¨‹åºï¼Œéœ€è¦å®Œæˆä¸€æ¬¡å¯†é’¥å’Œç­–ç•¥çš„åŒæ­¥ã€‚</p>
<h4 id="reloadqueueloopåç¨‹" tabindex="-1"><a class="header-anchor" href="#reloadqueueloopåç¨‹" aria-hidden="true">#</a> reloadQueueLoopåç¨‹</h4>
<p>reloadQueueLoopå‡½æ•°ä¼šç›‘å¬ <code v-pre>reloadQueue</code> ï¼Œå½“å‘ç°æœ‰æ–°çš„æ¶ˆæ¯ï¼ˆè¿™é‡Œæ˜¯å›è°ƒå‡½æ•°ï¼‰å†™å…¥æ—¶ï¼Œä¼šå®æ—¶å°†æ¶ˆæ¯ç¼“å­˜åˆ° <code v-pre>requeue</code> åˆ‡ç‰‡ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Load<span class="token punctuation">)</span> <span class="token function">reloadQueueLoop</span><span class="token punctuation">(</span>cb <span class="token operator">...</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
      <span class="token keyword">select</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token operator">&lt;-</span>l<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>
      <span class="token keyword">case</span> fn <span class="token operator">:=</span> <span class="token operator">&lt;-</span>reloadQueue<span class="token punctuation">:</span>
        requeueLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        requeue <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>requeue<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
        requeueLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Reload queued"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
          cb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="reloadloopåç¨‹" tabindex="-1"><a class="header-anchor" href="#reloadloopåç¨‹" aria-hidden="true">#</a> reloadLoopåç¨‹</h4>
<p>é€šè¿‡<a href="https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/load.go#L81" target="_blank" rel="noopener noreferrer">reloadLoop<ExternalLinkIcon/></a>å‡½æ•°å¯åŠ¨ä¸€ä¸ªtimerå®šæ—¶å™¨ï¼Œæ¯éš”1ç§’ä¼šæ£€æŸ¥ <code v-pre>requeue</code> åˆ‡ç‰‡æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code v-pre>l.DoReload</code> æ–¹æ³•ï¼Œä»<code v-pre>iam-apiserver</code>ä¸­æ‹‰å–å¯†é’¥å’Œç­–ç•¥ï¼Œå¹¶ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚</p>
<p>å¯†é’¥å’Œç­–ç•¥çš„ç¼“å­˜æ¨¡å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202303042324045.jpeg" alt="img"></p>
<p><strong>å¯†é’¥å’Œç­–ç•¥ç¼“å­˜çš„å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</strong></p>
<p>æ¥æ”¶ä¸Šæ¸¸æ¶ˆæ¯ï¼ˆè¿™é‡Œæ˜¯ä»Redisä¸­æ¥æ”¶ï¼‰ï¼Œå°†æ¶ˆæ¯ç¼“å­˜åˆ°åˆ‡ç‰‡æˆ–è€…å¸¦ç¼“å†²çš„channelä¸­ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹åç¨‹å»æ¶ˆè´¹è¿™äº›æ¶ˆæ¯ã€‚è¿™é‡Œçš„æ¶ˆè´¹åç¨‹æ˜¯reloadLoopï¼ŒreloadLoopä¼šæ¯éš”1såˆ¤æ–­ <code v-pre>requeue</code> åˆ‡ç‰‡æ˜¯å¦é•¿åº¦ä¸º0ï¼Œå¦‚æœä¸ä¸º0ï¼Œåˆ™æ‰§è¡Œ <code v-pre>l.DoReload()</code> ç¼“å­˜å¯†é’¥å’Œç­–ç•¥ã€‚</p>
<p><strong>è®²å®Œäº†å¯†é’¥å’Œç­–ç•¥ç¼“å­˜ï¼Œå†æ¥çœ‹ä¸‹æˆæƒæ—¥å¿—ç¼“å­˜ã€‚</strong></p>
<p>åœ¨å¯åŠ¨iam-authz-serveræ—¶ï¼Œè¿˜ä¼šå¯åŠ¨ä¸€ä¸ªAnalyticsæœåŠ¡ï¼Œä»£ç å¦‚ä¸‹ï¼ˆä½äº<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/server.go#L147-L156" target="_blank" rel="noopener noreferrer">internal/authzserver/server.go<ExternalLinkIcon/></a>æ–‡ä»¶ä¸­ï¼‰ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">if</span> s<span class="token punctuation">.</span>analyticsOptions<span class="token punctuation">.</span>Enable <span class="token punctuation">{</span>    
    analyticsStore <span class="token operator">:=</span> storage<span class="token punctuation">.</span>RedisCluster<span class="token punctuation">{</span>KeyPrefix<span class="token punctuation">:</span> RedisKeyPrefix<span class="token punctuation">}</span>    
    analyticsIns <span class="token operator">:=</span> analytics<span class="token punctuation">.</span><span class="token function">NewAnalytics</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>analyticsOptions<span class="token punctuation">,</span> <span class="token operator">&amp;</span>analyticsStore<span class="token punctuation">)</span>    
    analyticsIns<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    
    s<span class="token punctuation">.</span>gs<span class="token punctuation">.</span><span class="token function">AddShutdownCallback</span><span class="token punctuation">(</span>shutdown<span class="token punctuation">.</span><span class="token function">ShutdownFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    
        analyticsIns<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    

        <span class="token keyword">return</span> <span class="token boolean">nil</span>    
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L64-L79" target="_blank" rel="noopener noreferrer">NewAnalytics<ExternalLinkIcon/></a>å‡½æ•°ä¼šæ ¹æ®é…ç½®ï¼Œåˆ›å»ºä¸€ä¸ªAnalyticså®ä¾‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewAnalytics</span><span class="token punctuation">(</span>options <span class="token operator">*</span>AnalyticsOptions<span class="token punctuation">,</span> store storage<span class="token punctuation">.</span>AnalyticsHandler<span class="token punctuation">)</span> <span class="token operator">*</span>Analytics <span class="token punctuation">{</span>
    ps <span class="token operator">:=</span> options<span class="token punctuation">.</span>PoolSize
    recordsBufferSize <span class="token operator">:=</span> options<span class="token punctuation">.</span>RecordsBufferSize
    workerBufferSize <span class="token operator">:=</span> recordsBufferSize <span class="token operator">/</span> <span class="token function">uint64</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Analytics pool worker buffer size"</span><span class="token punctuation">,</span> log<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token string">"workerBufferSize"</span><span class="token punctuation">,</span> workerBufferSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
  
    recordsChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>AnalyticsRecord<span class="token punctuation">,</span> recordsBufferSize<span class="token punctuation">)</span>
  
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Analytics<span class="token punctuation">{</span>
      store<span class="token punctuation">:</span>                      store<span class="token punctuation">,</span>
      poolSize<span class="token punctuation">:</span>                   ps<span class="token punctuation">,</span>
      recordsChan<span class="token punctuation">:</span>                recordsChan<span class="token punctuation">,</span>
      workerBufferSize<span class="token punctuation">:</span>           workerBufferSize<span class="token punctuation">,</span>
      recordsBufferFlushInterval<span class="token punctuation">:</span> options<span class="token punctuation">.</span>FlushInterval<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªå¸¦ç¼“å†²çš„ <code v-pre>recordsChan</code> ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>recordsChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>AnalyticsRecord<span class="token punctuation">,</span> recordsBufferSize<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code v-pre>recordsChan</code> å­˜æ”¾çš„æ•°æ®ç±»å‹ä¸º<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L26-L35" target="_blank" rel="noopener noreferrer">AnalyticsRecord<ExternalLinkIcon/></a>ï¼Œç¼“å†²åŒºçš„å¤§å°ä¸º <code v-pre>recordsBufferSize</code> ï¼ˆé€šè¿‡ <code v-pre>--analytics.records-buffer-size</code> é€‰é¡¹æŒ‡å®šï¼‰ã€‚å¯ä»¥é€šè¿‡<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L115-L126" target="_blank" rel="noopener noreferrer">RecordHit<ExternalLinkIcon/></a>å‡½æ•°ï¼Œå‘<code v-pre>recordsChan</code> ä¸­å†™å…¥ AnalyticsRecord ç±»å‹çš„æ•°æ®ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Analytics<span class="token punctuation">)</span> <span class="token function">RecordHit</span><span class="token punctuation">(</span>record <span class="token operator">*</span>AnalyticsRecord<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>                                                     
    <span class="token comment">// check if we should stop sending records 1st                                                                     </span>
    <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token punctuation">.</span>shouldStop<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>                                                                          
        <span class="token keyword">return</span> <span class="token boolean">nil</span>                                                                                                     
    <span class="token punctuation">}</span>                                                                                                                  
                                                                                                                       
    <span class="token comment">// just send record to channel consumed by pool of workers                                                         </span>
    <span class="token comment">// leave all data crunching and Redis I/O work for pool workers                                                    </span>
    r<span class="token punctuation">.</span>recordsChan <span class="token operator">&lt;-</span> record                                                                                            
                                                                                                                       
    <span class="token keyword">return</span> <span class="token boolean">nil</span>                                                                                                         
<span class="token punctuation">}</span>   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>iam-authz-serveræ˜¯é€šè¿‡è°ƒç”¨ LogGrantedAccessRequest å’Œ LogRejectedAccessRequest å‡½æ•°æ¥è®°å½•æˆæƒæ—¥å¿—çš„ã€‚åœ¨è®°å½•æˆæƒæ—¥å¿—æ—¶ï¼Œä¼šå°†æˆæƒæ—¥å¿—å†™å…¥ <code v-pre>recordsChan</code> channelä¸­ã€‚<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/authorization/authorizer/authorizer.go#L100-L115" target="_blank" rel="noopener noreferrer">LogGrantedAccessRequest<ExternalLinkIcon/></a>å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>auth <span class="token operator">*</span>Authorization<span class="token punctuation">)</span> <span class="token function">LogGrantedAccessRequest</span><span class="token punctuation">(</span>r <span class="token operator">*</span>ladon<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> p ladon<span class="token punctuation">.</span>Policies<span class="token punctuation">,</span> d ladon<span class="token punctuation">.</span>Policies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    conclusion <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"policies %s allow access"</span><span class="token punctuation">,</span> <span class="token function">joinPoliciesNames</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>                               
    rstring<span class="token punctuation">,</span> pstring<span class="token punctuation">,</span> dstring <span class="token operator">:=</span> <span class="token function">convertToString</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> p<span class="token punctuation">,</span> d<span class="token punctuation">)</span>                          
    record <span class="token operator">:=</span> analytics<span class="token punctuation">.</span>AnalyticsRecord<span class="token punctuation">{</span>                     
        TimeStamp<span class="token punctuation">:</span>  time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                              
        Username<span class="token punctuation">:</span>   r<span class="token punctuation">.</span>Context<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                 
        Effect<span class="token punctuation">:</span>     ladon<span class="token punctuation">.</span>AllowAccess<span class="token punctuation">,</span>                       
        Conclusion<span class="token punctuation">:</span> conclusion<span class="token punctuation">,</span>                              
        Request<span class="token punctuation">:</span>    rstring<span class="token punctuation">,</span>       
        Policies<span class="token punctuation">:</span>   pstring<span class="token punctuation">,</span>                                                   
        Deciders<span class="token punctuation">:</span>   dstring<span class="token punctuation">,</span>                                                   
    <span class="token punctuation">}</span>                           
                           
    record<span class="token punctuation">.</span><span class="token function">SetExpiry</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> analytics<span class="token punctuation">.</span><span class="token function">GetAnalytics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RecordHit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>record<span class="token punctuation">)</span>         
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ï¼Œä¼šåˆ›å»ºAnalyticsRecordç±»å‹çš„ç»“æ„ä½“å˜é‡ï¼Œå¹¶è°ƒç”¨RecordHitå°†å˜é‡çš„å€¼å†™å…¥ <code v-pre>recordsChan</code> channelä¸­ã€‚å°†æˆæƒæ—¥å¿—å†™å…¥ <code v-pre>recordsChan</code>  channelä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥å†™å…¥Redisä¸­ï¼Œè¿™å¯ä»¥å¤§å¤§å‡å°‘å†™å…¥å»¶æ—¶ï¼Œå‡å°‘æ¥å£çš„å“åº”å»¶æ—¶ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªworkerè¿›ç¨‹ä»recordsChanä¸­è¯»å–æ•°æ®ï¼Œå¹¶åœ¨æ•°æ®è¾¾åˆ°ä¸€å®šé˜ˆå€¼ä¹‹åï¼Œæ‰¹é‡å†™å…¥Redisä¸­ã€‚åœ¨<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L87-L100" target="_blank" rel="noopener noreferrer">Start<ExternalLinkIcon/></a>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€æ‰¹workerï¼Œworkerä¸ªæ•°å¯ä»¥é€šè¿‡ <code v-pre>--analytics.pool-size</code> æ¥æŒ‡å®š ã€‚Startå‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Analytics<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    analytics <span class="token operator">=</span> r
    r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
    <span class="token comment">// start worker pool</span>
    atomic<span class="token punctuation">.</span><span class="token function">SwapUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token punctuation">.</span>shouldStop<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>poolSize<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
      r<span class="token punctuation">.</span>poolWg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">go</span> r<span class="token punctuation">.</span><span class="token function">recordWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">// stop analytics workers</span>
    <span class="token keyword">go</span> r<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç é€šè¿‡ <code v-pre>go r.recordWorker()</code> åˆ›å»ºäº† ç”±<code v-pre>poolSize</code> æŒ‡å®šä¸ªæ•°çš„<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L128-L173" target="_blank" rel="noopener noreferrer">recordWorker<ExternalLinkIcon/></a>ï¼ˆworkerï¼‰ï¼ŒrecordWorkerå‡½æ•°ä¼šä» <code v-pre>recordsChan</code> ä¸­è¯»å–æˆæƒæ—¥å¿—å¹¶å­˜å…¥recordsBufferä¸­ï¼ŒrecordsBufferçš„å¤§å°ä¸ºworkerBufferSizeï¼ŒworkerBufferSizeè®¡ç®—å…¬å¼ä¸ºï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>ps <span class="token operator">:=</span> options<span class="token punctuation">.</span>PoolSize
recordsBufferSize <span class="token operator">:=</span> options<span class="token punctuation">.</span>RecordsBufferSize
workerBufferSize <span class="token operator">:=</span> recordsBufferSize <span class="token operator">/</span> <span class="token function">uint64</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­ï¼Œoptions.PoolSizeç”±å‘½ä»¤è¡Œå‚æ•° <code v-pre>--analytics.pool-size</code> æŒ‡å®šï¼Œä»£è¡¨worker çš„ä¸ªæ•°ï¼Œé»˜è®¤ 50ï¼›options.RecordsBufferSizeç”±å‘½ä»¤è¡Œå‚æ•° <code v-pre>--analytics.records-buffer-size</code> æŒ‡å®šï¼Œä»£è¡¨ç¼“å­˜çš„æˆæƒæ—¥å¿—æ¶ˆæ¯æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æŠŠç¼“å­˜çš„è®°å½•å¹³å‡åˆ†é…ç»™æ‰€æœ‰çš„workerã€‚</p>
<p>å½“recordsBufferå­˜æ»¡æˆ–è€…è¾¾åˆ°æŠ•é€’æœ€å¤§æ—¶é—´åï¼Œè°ƒç”¨ <code v-pre>r.Store.AppendToSetPipelined(analyticsKeyName, recordsBuffer)</code> å°†è®°å½•æ‰¹é‡å‘é€ç»™Redisï¼Œä¸ºäº†æé«˜ä¼ è¾“é€Ÿç‡ï¼Œè¿™é‡Œå°†æ—¥å¿—å†…å®¹ç¼–ç ä¸ºmsgpackæ ¼å¼åå†ä¼ è¾“ã€‚</p>
<p>ä¸Šé¢çš„ç¼“å­˜æ–¹æ³•å¯ä»¥æŠ½è±¡æˆä¸€ä¸ªç¼“å­˜æ¨¡å‹ï¼Œæ»¡è¶³å®é™…å¼€å‘ä¸­çš„å¤§éƒ¨åˆ†éœ€è¦å¼‚æ­¥è½¬å­˜çš„åœºæ™¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202303042326755.jpeg" alt="img"></p>
<p>Producerå°†æ•°æ®æŠ•é€’åˆ°å¸¦ç¼“å†²çš„channelä¸­ï¼Œåç«¯æœ‰å¤šä¸ªworkeræ¶ˆè´¹channelä¸­çš„æ•°æ®ï¼Œå¹¶è¿›è¡Œæ‰¹é‡æŠ•é€’ã€‚ä½ å¯ä»¥è®¾ç½®æ‰¹é‡æŠ•é€’çš„æ¡ä»¶ï¼Œä¸€èˆ¬è‡³å°‘åŒ…å«<strong>æœ€å¤§æŠ•é€’æ—¥å¿—æ•°</strong>å’Œ<strong>æœ€å¤§æŠ•é€’æ—¶é—´é—´éš”</strong>è¿™ä¸¤ä¸ªã€‚</p>
<p>é€šè¿‡ä»¥ä¸Šç¼“å†²æ¨¡å‹ï¼Œä½ å¯ä»¥å°†æ—¥å¿—è½¬å­˜çš„æ—¶å»¶é™åˆ°æœ€ä½ã€‚</p>
<h3 id="æ•°æ®ä¸€è‡´æ€§" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ä¸€è‡´æ€§" aria-hidden="true">#</a> æ•°æ®ä¸€è‡´æ€§</h3>
<p>ä¸Šé¢ä»‹ç»äº† iam-authz-serverçš„ <code v-pre>/v1/authz</code> æ¥å£ï¼Œä¸ºäº†æœ€å¤§åŒ–åœ°æé«˜æ€§èƒ½ï¼Œé‡‡ç”¨äº†å¤§é‡çš„ç¼“å­˜è®¾è®¡ã€‚å› ä¸ºæ•°æ®ä¼šåˆ†åˆ«åœ¨æŒä¹…åŒ–å­˜å‚¨å’Œå†…å­˜ä¸­éƒ½å­˜å‚¨ä¸€ä»½ï¼Œå°±å¯èƒ½ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¹Ÿè¦ç¡®ä¿ç¼“å­˜ä¸­çš„æ•°æ®å’Œæ•°æ®åº“ä¸­çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚æ•°æ®ä¸€è‡´æ€§æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://sm.nsddd.top/sm202303042326342.jpeg" alt="img"></p>
<p><strong>å¯†é’¥å’Œç­–ç•¥åŒæ­¥æµç¨‹å¦‚ä¸‹ï¼š</strong></p>
<ol>
<li>é€šè¿‡iam-webconsoleè¯·æ±‚iam-apiserveråˆ›å»ºï¼ˆæˆ–æ›´æ–°ã€åˆ é™¤ï¼‰å¯†é’¥ï¼ˆæˆ–ç­–ç•¥ï¼‰ã€‚</li>
<li>iam-apiserveræ”¶åˆ°â€œå†™â€è¯·æ±‚åï¼Œä¼šå‘Redis <code v-pre>iam.cluster.notifications</code> channelå‘é€PolicyChangedæˆ–SecretChangedæ¶ˆæ¯ã€‚</li>
<li>Loaderæ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šè§¦å‘cache loaderå®ä¾‹æ‰§è¡Œ <code v-pre>Reload</code> æ–¹æ³•ï¼Œé‡æ–°ä»iam-apiserverä¸­åŒæ­¥å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯ã€‚</li>
</ol>
<p>Loaderä¸ä¼šå…³å¿ƒ <code v-pre>Reload</code> æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œåªä¼šåœ¨æ”¶åˆ°æŒ‡å®šæ¶ˆæ¯æ—¶ï¼Œæ‰§è¡Œ <code v-pre>Reload</code> æ–¹æ³•ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸åŒçš„ç¼“å­˜ç­–ç•¥ã€‚</p>
<p>åœ¨cacheå®ä¾‹çš„ <code v-pre>Reload</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å…¶å®æ˜¯è°ƒç”¨ä»“åº“å±‚Secretå’ŒPolicyçš„Listæ–¹æ³•æ¥è·å–å¯†é’¥å’Œç­–ç•¥åˆ—è¡¨ã€‚ä»“åº“å±‚åˆæ˜¯é€šè¿‡æ‰§è¡ŒgRPCè¯·æ±‚ï¼Œä»iam-apiserverä¸­è·å–å¯†é’¥å’Œç­–ç•¥åˆ—è¡¨ã€‚</p>
<p>cacheçš„<a href="https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/load/cache/cache.go#L105-L132" target="_blank" rel="noopener noreferrer">Reload<ExternalLinkIcon/></a>æ–¹æ³•ï¼Œä¼šå°†è·å–åˆ°çš„å¯†é’¥å’Œç­–ç•¥åˆ—è¡¨ç¼“å­˜åœ¨<a href="https://github.com/dgraph-io/ristretto" target="_blank" rel="noopener noreferrer">ristretto<ExternalLinkIcon/></a>ç±»å‹çš„Cacheä¸­ï¼Œä¾›ä¸šåŠ¡å±‚è°ƒç”¨ã€‚ä¸šåŠ¡å±‚ä»£ç ä½äº<a href="https://github.com/marmotedu/iam/tree/v1.0.6/internal/authzserver/authorization" target="_blank" rel="noopener noreferrer">internal/authzserver/authorization<ExternalLinkIcon/></a>ç›®å½•ä¸‹ã€‚</p>
<h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2>
<p>è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»‹ç»äº†IAMæ•°æ®æµæœåŠ¡iam-authz-serverçš„è®¾è®¡å’Œå®ç°ã€‚iam-authz-serveræä¾›äº† <code v-pre>/v1/authz</code> RESTful APIæ¥å£ï¼Œä¾›ç¬¬ä¸‰æ–¹ç”¨æˆ·å®Œæˆèµ„æºæˆæƒåŠŸèƒ½ï¼Œå…·ä½“æ˜¯ä½¿ç”¨LadonåŒ…æ¥å®Œæˆèµ„æºæˆæƒçš„ã€‚LadonåŒ…è§£å†³äº†â€œåœ¨ç‰¹å®šçš„æ¡ä»¶ä¸‹ï¼Œè°èƒ½å¤Ÿ/ä¸èƒ½å¤Ÿå¯¹å“ªäº›èµ„æºåšå“ªäº›æ“ä½œâ€çš„é—®é¢˜ã€‚</p>
<p>iam-authz-serverçš„é…ç½®å¤„ç†ã€å¯åŠ¨æµç¨‹å’Œè¯·æ±‚å¤„ç†æµç¨‹è·Ÿiam-apiserverä¿æŒä¸€è‡´ã€‚æ­¤å¤–ï¼Œiam-authz-serverä¹Ÿå®ç°äº†ç®€æ´æ¶æ„ã€‚</p>
<p>iam-authz-serveré€šè¿‡ç¼“å­˜å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯ã€ç¼“å­˜æˆæƒæ—¥å¿—æ¥æé«˜ <code v-pre>/v1/authz</code> æ¥å£çš„æ€§èƒ½ã€‚</p>
<p>åœ¨ç¼“å­˜å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯æ—¶ï¼Œä¸ºäº†å’Œiam-apiserverä¸­çš„å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯ä¿æŒä¸€è‡´ï¼Œä½¿ç”¨äº†Redis Pub/Subæœºåˆ¶ã€‚å½“iam-apiserveræœ‰å¯†é’¥/ç­–ç•¥å˜æ›´æ—¶ï¼Œä¼šå¾€æŒ‡å®šçš„Redis channel Pubä¸€æ¡æ¶ˆæ¯ã€‚iam-authz-serverè®¢é˜…ç›¸åŒçš„channelï¼Œåœ¨æ”¶åˆ°æ–°æ¶ˆæ¯æ—¶ï¼Œä¼šè§£ææ¶ˆæ¯ï¼Œå¹¶é‡æ–°ä»iam-apiserverä¸­è·å–å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯ï¼Œç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚</p>
<p>iam-authz-serveræ‰§è¡Œå®Œèµ„æºæˆæƒä¹‹åï¼Œä¼šå°†æˆæƒæ—¥å¿—å­˜æ”¾åœ¨ä¸€ä¸ªå¸¦ç¼“å†²çš„channelä¸­ã€‚åç«¯æœ‰å¤šä¸ªworkeræ¶ˆè´¹channelä¸­çš„æ•°æ®ï¼Œå¹¶è¿›è¡Œæ‰¹é‡æŠ•é€’ã€‚å¯ä»¥è®¾ç½®æ‰¹é‡æŠ•é€’çš„æ¡ä»¶ï¼Œä¾‹å¦‚æœ€å¤§æŠ•é€’æ—¥å¿—æ•°å’Œæœ€å¤§æŠ•é€’æ—¶é—´é—´éš”ã€‚</p>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ol>
<li>iam-authz-serverå’Œiam-apiserverå…±ç”¨äº†åº”ç”¨æ¡†æ¶ï¼ˆåŒ…æ‹¬ä¸€äº›é…ç½®é¡¹ï¼‰å’ŒHTTPæœåŠ¡æ¡†æ¶å±‚çš„ä»£ç ï¼Œè¯·é˜…è¯»iam-authz-serverä»£ç ï¼Œçœ‹ä¸‹IAMé¡¹ç›®æ˜¯å¦‚ä½•å®ç°ä»£ç å¤ç”¨çš„ã€‚</li>
<li>iam-authz-serverä½¿ç”¨äº†<a href="https://github.com/dgraph-io/ristretto" target="_blank" rel="noopener noreferrer">ristretto<ExternalLinkIcon/></a>æ¥ç¼“å­˜å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯ï¼Œè¯·è°ƒç ”ä¸‹ä¸šç•Œè¿˜æœ‰å“ªäº›ä¼˜ç§€çš„ç¼“å­˜åŒ…å¯ä¾›ä½¿ç”¨ï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ã€‚</li>
</ol>
<ul><li><div><a href = '22.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '24.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/projects/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


