<template><div><ul>
<li><a href="https://github.com/cubxxw/iam" target="_blank" rel="noopener noreferrer">ğŸ”¥ å¼€æºåœ°å€<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬21èŠ‚-æ§åˆ¶æµ-ä¸‹-iam-apiserveræœåŠ¡æ ¸å¿ƒåŠŸèƒ½å®ç°è®²è§£" tabindex="-1"><a class="header-anchor" href="#ç¬¬21èŠ‚-æ§åˆ¶æµ-ä¸‹-iam-apiserveræœåŠ¡æ ¸å¿ƒåŠŸèƒ½å®ç°è®²è§£" aria-hidden="true">#</a> ç¬¬21èŠ‚ æ§åˆ¶æµï¼ˆä¸‹ï¼‰ï¼šiam-apiserveræœåŠ¡æ ¸å¿ƒåŠŸèƒ½å®ç°è®²è§£</h1>
<br>
<div><a href = '20.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '22.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<nav class="table-of-contents"><ul><li><router-link to="#å¼€å§‹">å¼€å§‹</router-link></li><li><router-link to="#åº”ç”¨æ¡†æ¶ç›¸å…³çš„ç‰¹æ€§">åº”ç”¨æ¡†æ¶ç›¸å…³çš„ç‰¹æ€§</router-link><ul><li><router-link to="#ä¼˜é›…å…³åœ">ä¼˜é›…å…³åœ</router-link></li><li><router-link to="#å¥åº·æ£€æŸ¥">å¥åº·æ£€æŸ¥</router-link></li><li><router-link to="#æ’ä»¶åŒ–åŠ è½½ä¸­é—´ä»¶">æ’ä»¶åŒ–åŠ è½½ä¸­é—´ä»¶</router-link></li></ul></li><li><router-link to="#ç¼–ç¨‹è§„èŒƒç›¸å…³çš„ç‰¹æ€§">ç¼–ç¨‹è§„èŒƒç›¸å…³çš„ç‰¹æ€§</router-link><ul><li><router-link to="#api-ç‰ˆæœ¬">API ç‰ˆæœ¬</router-link></li><li><router-link to="#ç»Ÿä¸€çš„èµ„æºå…ƒæ•°æ®">ç»Ÿä¸€çš„èµ„æºå…ƒæ•°æ®</router-link></li><li><router-link to="#ç»Ÿä¸€çš„è¿”å›">ç»Ÿä¸€çš„è¿”å›</router-link></li><li><router-link to="#å¹¶å‘å¤„ç†æ¨¡æ¿">å¹¶å‘å¤„ç†æ¨¡æ¿</router-link></li></ul></li><li><router-link to="#å…¶ä»–ç‰¹æ€§">å…¶ä»–ç‰¹æ€§</router-link><ul><li><router-link to="#æ’ä»¶åŒ–é€‰æ‹©-json-åº“">æ’ä»¶åŒ–é€‰æ‹© JSON åº“</router-link></li><li><router-link to="#è°ƒç”¨é“¾å®ç°">è°ƒç”¨é“¾å®ç°</router-link></li><li><router-link to="#æ•°æ®ä¸€è‡´æ€§">æ•°æ®ä¸€è‡´æ€§</router-link></li></ul></li><li><router-link to="#æ€»ç»“">æ€»ç»“</router-link></li><li><router-link to="#end-é“¾æ¥">END é“¾æ¥</router-link></li></ul></nav>
<p>[TOC]</p>
<h2 id="å¼€å§‹" tabindex="-1"><a class="header-anchor" href="#å¼€å§‹" aria-hidden="true">#</a> å¼€å§‹</h2>
<p>iam-apiserver ä¸­åŒ…å«äº†å¾ˆå¤šä¼˜ç§€çš„è®¾è®¡æ€æƒ³å’Œå®ç°ï¼Œè¿™äº›ç‚¹å¯èƒ½æ¯”è¾ƒé›¶ç¢ï¼Œä½†æˆ‘è§‰å¾—å¾ˆå€¼å¾—åˆ†äº«ç»™ä½ ã€‚æˆ‘å°†è¿™äº›å…³é”®ä»£ç è®¾è®¡åˆ†ä¸º 3 ç±»ï¼Œåˆ†åˆ«æ˜¯åº”ç”¨æ¡†æ¶ç›¸å…³çš„ç‰¹æ€§ã€ç¼–ç¨‹è§„èŒƒç›¸å…³çš„ç‰¹æ€§å’Œå…¶ä»–ç‰¹æ€§ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥è¯¦ç»†çœ‹çœ‹è¿™äº›è®¾è®¡ç‚¹ï¼Œä»¥åŠå®ƒä»¬èƒŒåçš„è®¾è®¡æ€æƒ³ã€‚</p>
<h2 id="åº”ç”¨æ¡†æ¶ç›¸å…³çš„ç‰¹æ€§" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨æ¡†æ¶ç›¸å…³çš„ç‰¹æ€§" aria-hidden="true">#</a> åº”ç”¨æ¡†æ¶ç›¸å…³çš„ç‰¹æ€§</h2>
<p>åº”ç”¨æ¡†æ¶ç›¸å…³çš„ç‰¹æ€§åŒ…æ‹¬ä¸‰ä¸ªï¼Œåˆ†åˆ«æ˜¯ <strong>ä¼˜é›…å…³åœã€å¥åº·æ£€æŸ¥å’Œæ’ä»¶åŒ–åŠ è½½ä¸­é—´ä»¶</strong>ã€‚</p>
<h3 id="ä¼˜é›…å…³åœ" tabindex="-1"><a class="header-anchor" href="#ä¼˜é›…å…³åœ" aria-hidden="true">#</a> ä¼˜é›…å…³åœ</h3>
<p>åœ¨è®²ä¼˜é›…å…³åœä¹‹å‰ï¼Œå…ˆæ¥çœ‹çœ‹ä¸ä¼˜é›…çš„åœæ­¢æœåŠ¡æ–¹å¼æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p>
<p>å½“æˆ‘ä»¬éœ€è¦é‡å¯æœåŠ¡æ—¶ï¼Œé¦–å…ˆéœ€è¦åœæ­¢æœåŠ¡ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ¥åœæ­¢æˆ‘ä»¬çš„æœåŠ¡ï¼š</p>
<ul>
<li>åœ¨ Linux ç»ˆç«¯é”®å…¥ Ctrl + Cï¼ˆå…¶å®æ˜¯å‘é€ SIGINT ä¿¡å·ï¼‰ã€‚</li>
<li>å‘é€ SIGTERM ä¿¡å·ï¼Œä¾‹å¦‚ <code v-pre>kill</code> æˆ–è€… <code v-pre>systemctl stop</code> ç­‰ã€‚</li>
</ul>
<p>å½“æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸Šä¸¤ç§æ–¹å¼åœæ­¢æœåŠ¡æ—¶ï¼Œéƒ½ä¼šäº§ç”Ÿä¸‹é¢ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>æœ‰äº›è¯·æ±‚æ­£åœ¨å¤„ç†ï¼Œå¦‚æœæœåŠ¡ç«¯ç›´æ¥é€€å‡ºï¼Œä¼šé€ æˆå®¢æˆ·ç«¯è¿æ¥ä¸­æ–­ï¼Œè¯·æ±‚å¤±è´¥ã€‚</li>
<li>æˆ‘ä»¬çš„ç¨‹åºå¯èƒ½éœ€è¦åšä¸€äº›æ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚ç­‰å¾…è¿›ç¨‹å†…ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæˆ–è€…æ‹’ç»æ¥å—æ–°çš„æ¶ˆæ¯ç­‰ã€‚</li>
</ul>
<p>è¿™äº›é—®é¢˜éƒ½ä¼šå¯¹ä¸šåŠ¡é€ æˆå½±å“ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§ä¼˜é›…çš„æ–¹å¼æ¥å…³åœæˆ‘ä»¬çš„åº”ç”¨ã€‚åœ¨ Go å¼€å‘ä¸­ï¼Œé€šå¸¸é€šè¿‡æ‹¦æˆª <code v-pre>SIGINT</code> å’Œ <code v-pre>SIGTERM</code> ä¿¡å·ï¼Œæ¥å®ç°ä¼˜é›…å…³åœã€‚å½“æ”¶åˆ°è¿™ä¸¤ä¸ªä¿¡å·æ—¶ï¼Œåº”ç”¨è¿›ç¨‹ä¼šåšä¸€äº›æ¸…ç†å·¥ä½œï¼Œç„¶åç»“æŸé˜»å¡çŠ¶æ€ï¼Œç»§ç»­æ‰§è¡Œä½™ä¸‹çš„ä»£ç ï¼Œæœ€åè‡ªç„¶é€€å‡ºè¿›ç¨‹ã€‚</p>
<p><strong>å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¼˜é›…å…³åœçš„ç¤ºä¾‹ä»£ç ï¼š</strong></p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"log"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"os"</span>
    <span class="token string">"os/signal"</span>
    <span class="token string">"time"</span>

    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"Welcome Gin Server"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    srv <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span>
        Addr<span class="token punctuation">:</span>    <span class="token string">":8080"</span><span class="token punctuation">,</span>
        Handler<span class="token punctuation">:</span> router<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†æœåŠ¡åœ¨ goroutine ä¸­å¯åŠ¨</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> http<span class="token punctuation">.</span>ErrServerClosed <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"listen: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
    signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Interrupt<span class="token punctuation">)</span>
    <span class="token operator">&lt;-</span>quit <span class="token comment">// é˜»å¡ç­‰å¾…æ¥æ”¶ channel æ•°æ®</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Shutdown Server ..."</span><span class="token punctuation">)</span>

    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token comment">// 5s ç¼“å†²æ—¶é—´å¤„ç†å·²æœ‰è¯·æ±‚</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// è°ƒç”¨ net/http åŒ…æä¾›çš„ä¼˜é›…å…³é—­å‡½æ•°ï¼šShutdown</span>
        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Server Shutdown:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Server exiting"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¸Šé¢çš„ä»£ç å®ç°ä¼˜é›…å…³åœçš„æ€è·¯å¦‚ä¸‹ï¼š</strong></p>
<ol>
<li>å°† HTTP æœåŠ¡æ”¾åœ¨ goroutine ä¸­è¿è¡Œï¼Œç¨‹åºä¸é˜»å¡ï¼Œç»§ç»­æ‰§è¡Œã€‚</li>
<li>åˆ›å»ºä¸€ä¸ªæ— ç¼“å†²çš„ channel <code v-pre>quit</code>ï¼Œè°ƒç”¨ <code v-pre>signal.Notify(quit, os.Interrupt)</code>ã€‚é€šè¿‡ signal.Notify å‡½æ•°è°ƒç”¨ï¼Œå¯ä»¥å°†è¿›ç¨‹æ”¶åˆ°çš„ os.Interruptï¼ˆSIGINTï¼‰ä¿¡å·ï¼Œå‘é€ç»™ channel <code v-pre>quit</code>ã€‚</li>
<li><code v-pre>&lt;-quit</code> é˜»å¡å½“å‰ goroutineï¼ˆä¹Ÿå°±æ˜¯ main å‡½æ•°æ‰€åœ¨çš„ goroutineï¼‰ï¼Œç­‰å¾…ä» channel <code v-pre>quit</code> æ¥æ”¶å…³åœä¿¡å·ã€‚é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæˆ‘ä»¬æˆåŠŸå¯åŠ¨äº† HTTP æœåŠ¡ï¼Œå¹¶ä¸” main å‡½æ•°é˜»å¡ï¼Œé˜²æ­¢å¯åŠ¨ HTTP æœåŠ¡çš„ goroutine é€€å‡ºã€‚å½“æˆ‘ä»¬é”®å…¥ <code v-pre>Ctrl + C</code>æ—¶ï¼Œè¿›ç¨‹ä¼šæ”¶åˆ° SIGINT ä¿¡å·ï¼Œå¹¶å°†è¯¥ä¿¡å·å‘é€åˆ° channel <code v-pre>quit</code> ä¸­ï¼Œè¿™æ—¶å€™<code v-pre>&lt;-quit</code>æ”¶åˆ°äº† channel å¦ä¸€ç«¯ä¼ æ¥çš„æ•°æ®ï¼Œç»“æŸé˜»å¡çŠ¶æ€ï¼Œç¨‹åºç»§ç»­æ‰§è¡Œã€‚è¿™é‡Œï¼Œ<code v-pre>&lt;-quit</code>å”¯ä¸€ç›®çš„æ˜¯é˜»å¡å½“å‰çš„ goroutineï¼Œæ‰€ä»¥å¯¹æ”¶åˆ°çš„æ•°æ®ç›´æ¥ä¸¢å¼ƒã€‚</li>
<li>æ‰“å°é€€å‡ºæ¶ˆæ¯ï¼Œæç¤ºå‡†å¤‡é€€å‡ºå½“å‰æœåŠ¡ã€‚</li>
<li>è°ƒç”¨ <code v-pre>net/http</code> åŒ…æä¾›çš„ Shutdown æ–¹æ³•ï¼ŒShutdown æ–¹æ³•ä¼šåœ¨æŒ‡å®šçš„æ—¶é—´å†…å¤„ç†å®Œç°æœ‰è¯·æ±‚ï¼Œå¹¶è¿”å›ã€‚</li>
<li>æœ€åï¼Œç¨‹åºæ‰§è¡Œå®Œ <code v-pre>log.Println(&quot;Server exiting&quot;)</code> ä»£ç åï¼Œé€€å‡º main å‡½æ•°ã€‚</li>
</ol>
<p>**iam-apiserver ä¹Ÿå®ç°äº†ä¼˜é›…å…³åœï¼Œä¼˜é›…å…³åœæ€è·¯è·Ÿä¸Šé¢çš„ä»£ç ç±»ä¼¼ã€‚**å…·ä½“å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<p><strong>ç¬¬ä¸€æ­¥</strong>ï¼Œåˆ›å»º channel ç”¨æ¥æ¥æ”¶ os.Interruptï¼ˆSIGINTï¼‰å’Œ syscall.SIGTERMï¼ˆSIGKILLï¼‰ä¿¡å·ã€‚</p>
<p>ä»£ç è§ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/server/signal.go#L19" target="_blank" rel="noopener noreferrer">internal/pkg/server/signal.go<ExternalLinkIcon/></a> ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">var</span> onlyOneSignalHandler <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> shutdownHandler <span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal

<span class="token keyword">func</span> <span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
    <span class="token function">close</span><span class="token punctuation">(</span>onlyOneSignalHandler<span class="token punctuation">)</span> <span class="token comment">// panics when called twice</span>

    shutdownHandler <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

    stop <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>shutdownHandler<span class="token punctuation">,</span> shutdownSignals<span class="token operator">...</span><span class="token punctuation">)</span>

    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">&lt;-</span>shutdownHandler
        <span class="token function">close</span><span class="token punctuation">(</span>stop<span class="token punctuation">)</span>
        <span class="token operator">&lt;-</span>shutdownHandler
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// second signal. Exit directly.</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> stop
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SetupSignalHandler å‡½æ•°ä¸­ï¼Œé€šè¿‡ <code v-pre>close(onlyOneSignalHandler)</code>æ¥ç¡®ä¿ iam-apiserver ç»„ä»¶çš„ä»£ç åªè°ƒç”¨ä¸€æ¬¡ SetupSignalHandler å‡½æ•°ã€‚å¦åˆ™ï¼Œå¯èƒ½ä¼šå› ä¸ºä¿¡å·ä¼ ç»™äº†ä¸åŒçš„ shutdownHandlerï¼Œè€Œé€ æˆä¿¡å·ä¸¢å¤±ã€‚</p>
<p>SetupSignalHandler å‡½æ•°è¿˜å®ç°äº†ä¸€ä¸ªåŠŸèƒ½ï¼šæ”¶åˆ°ä¸€æ¬¡ SIGINT/ SIGTERM ä¿¡å·ï¼Œç¨‹åºä¼˜é›…å…³é—­ã€‚æ”¶åˆ°ä¸¤æ¬¡ SIGINT/ SIGTERM ä¿¡å·ï¼Œç¨‹åºå¼ºåˆ¶å…³é—­ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">&lt;-</span>shutdownHandler
    <span class="token function">close</span><span class="token punctuation">(</span>stop<span class="token punctuation">)</span>
    <span class="token operator">&lt;-</span>shutdownHandler
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// second signal. Exit directly.</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œè¦æ³¨æ„ï¼š<code v-pre>signal.Notify(c chan&lt;- os.Signal, sig ...os.Signal)</code>å‡½æ•°ä¸ä¼šä¸ºäº†å‘ <code v-pre>c</code> å‘é€ä¿¡æ¯è€Œé˜»å¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå‘é€æ—¶ <code v-pre>c</code> é˜»å¡äº†ï¼Œsignal åŒ…ä¼šç›´æ¥ä¸¢å¼ƒä¿¡å·ã€‚ä¸ºäº†ä¸ä¸¢å¤±ä¿¡å·ï¼Œæˆ‘ä»¬åˆ›å»ºäº†æœ‰ç¼“å†²çš„ channel <code v-pre>shutdownHandler</code>ã€‚</p>
<p>æœ€åï¼ŒSetupSignalHandler å‡½æ•°ä¼šè¿”å› <code v-pre>stop</code>ï¼Œåé¢çš„ä»£ç å¯ä»¥é€šè¿‡å…³é—­ <code v-pre>stop</code> æ¥ç»“æŸä»£ç çš„é˜»å¡çŠ¶æ€ã€‚</p>
<p><strong>ç¬¬äºŒæ­¥</strong>ï¼Œå°† channel <code v-pre>stop</code> ä¼ é€’ç»™å¯åŠ¨ HTTPï¼ˆSï¼‰ã€gRPC æœåŠ¡çš„å‡½æ•°ï¼Œåœ¨å‡½æ•°ä¸­ä»¥ goroutine çš„æ–¹å¼å¯åŠ¨ HTTPï¼ˆSï¼‰ã€gRPC æœåŠ¡ï¼Œç„¶åæ‰§è¡Œ <code v-pre>&lt;-stop</code> é˜»å¡ goroutineã€‚</p>
<p><strong>ç¬¬ä¸‰æ­¥</strong>ï¼Œå½“ iam-apiserver è¿›ç¨‹æ”¶åˆ° SIGINT/SIGTERM ä¿¡å·åï¼Œå…³é—­ <code v-pre>stop</code> channelï¼Œç»§ç»­æ‰§è¡Œ <code v-pre>&lt;-stop</code> åçš„ä»£ç ï¼Œåœ¨åé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸€äº›æ¸…ç†é€»è¾‘ï¼Œæˆ–è€…è°ƒç”¨ <code v-pre>google.golang.org/grpc</code>å’Œ <code v-pre>net/http</code>åŒ…æä¾›çš„ä¼˜é›…å…³åœå‡½æ•° GracefulStop å’Œ Shutdownã€‚ä¾‹å¦‚ä¸‹é¢è¿™ä¸ªä»£ç ï¼ˆä½äº <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/grpc.go#L36" target="_blank" rel="noopener noreferrer">internal/apiserver/grpc.go<ExternalLinkIcon/></a> æ–‡ä»¶ä¸­ï¼‰ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>grpcAPIServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listen<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"failed to listen: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Start grpc server at %s"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>address<span class="token punctuation">)</span>

    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>listen<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"failed to start grpc server: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token operator">&lt;-</span>stopCh

    log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Grpc server on %s stopped"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span><span class="token function">GracefulStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é™¤äº†ä¸Šé¢è¯´çš„æ–¹æ³•ï¼Œiam-apiserver è¿˜é€šè¿‡ <a href="https://github.com/marmotedu/iam/tree/v1.0.4/pkg/shutdown" target="_blank" rel="noopener noreferrer">github.com/marmotedu/iam/pkg/shutdown<ExternalLinkIcon/></a> åŒ…ï¼Œå®ç°äº†å¦å¤–ä¸€ç§ä¼˜é›…å…³åœæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ›´åŠ å‹å¥½ã€æ›´åŠ çµæ´»ã€‚å®ç°ä»£ç è§ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/server.go#L81" target="_blank" rel="noopener noreferrer">PrepareRun<ExternalLinkIcon/></a> å‡½æ•°ã€‚</p>
<p><code v-pre>github.com/marmotedu/iam/pkg/shutdown</code> åŒ…çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">"fmt"</span>
  <span class="token string">"time"</span>
  <span class="token string">"github.com/marmotedu/iam/pkg/shutdown"</span>
  <span class="token string">"github.com/marmotedu/iam/pkg/shutdown/shutdownmanagers/posixsignal"</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// initialize shutdown</span>
  gs <span class="token operator">:=</span> shutdown<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// add posix shutdown manager</span>
  gs<span class="token punctuation">.</span><span class="token function">AddShutdownManager</span><span class="token punctuation">(</span>posixsignal<span class="token punctuation">.</span><span class="token function">NewPosixSignalManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// add your tasks that implement ShutdownCallback</span>
  gs<span class="token punctuation">.</span><span class="token function">AddShutdownCallback</span><span class="token punctuation">(</span>shutdown<span class="token punctuation">.</span><span class="token function">ShutdownFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Shutdown callback start"</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Shutdown callback finished"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// start shutdown managers</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> gs<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Start:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// do other stuff</span>
  time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé€šè¿‡ <code v-pre>gs := shutdown.New()</code> åˆ›å»º shutdown å®ä¾‹ï¼›é€šè¿‡ <code v-pre>AddShutdownManager</code> æ–¹æ³•æ·»åŠ ç›‘å¬çš„ä¿¡å·ï¼›é€šè¿‡ <code v-pre>AddShutdownCallback</code> æ–¹æ³•è®¾ç½®ç›‘å¬åˆ°æŒ‡å®šä¿¡å·æ—¶ï¼Œéœ€è¦æ‰§è¡Œçš„å›è°ƒå‡½æ•°ã€‚è¿™äº›å›è°ƒå‡½æ•°å¯ä»¥æ‰§è¡Œä¸€äº›æ¸…ç†å·¥ä½œã€‚æœ€åï¼Œé€šè¿‡ <code v-pre>Start</code> æ–¹æ³•å¯åŠ¨ shutdown å®ä¾‹ã€‚</p>
<h3 id="å¥åº·æ£€æŸ¥" tabindex="-1"><a class="header-anchor" href="#å¥åº·æ£€æŸ¥" aria-hidden="true">#</a> å¥åº·æ£€æŸ¥</h3>
<p>é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®è¿›ç¨‹æ˜¯å¦å­˜åœ¨æ¥åˆ¤å®š iam-apiserver æ˜¯å¦å¥åº·ï¼Œä¾‹å¦‚æ‰§è¡Œ <code v-pre>ps -ef|grep iam-apiserver</code>ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘å‘ç°æœ‰æ—¶å€™æœåŠ¡è¿›ç¨‹ä»ç„¶å­˜åœ¨ï¼Œä½†æ˜¯ HTTP æœåŠ¡å´ä¸èƒ½æ¥æ”¶å’Œå¤„ç†è¯·æ±‚ï¼Œæ‰€ä»¥æ›´åŠ é è°±çš„æ£€æŸ¥æ–¹æ³•æ˜¯ï¼Œç›´æ¥è¯·æ±‚ iam-apiserver çš„å¥åº·æ£€æŸ¥æ¥å£ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨å¯åŠ¨ iam-apiserver è¿›ç¨‹åï¼Œæ‰‹åŠ¨è°ƒç”¨ iam-apiserver å¥åº·æ£€æŸ¥æ¥å£è¿›è¡Œæ£€æŸ¥ã€‚ä½†è¿˜æœ‰æ›´æ–¹ä¾¿çš„æ–¹æ³•ï¼šå¯åŠ¨æœåŠ¡åè‡ªåŠ¨è°ƒç”¨å¥åº·æ£€æŸ¥æ¥å£ã€‚è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼Œä½ å¯ä»¥æŸ¥çœ‹ GenericAPIServer æä¾›çš„ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/server/genericapiserver.go#L219" target="_blank" rel="noopener noreferrer">ping<ExternalLinkIcon/></a> æ–¹æ³•ã€‚åœ¨ ping æ–¹æ³•ä¸­ï¼Œä½ éœ€è¦æ³¨æ„å‡½æ•°ä¸­çš„å¦‚ä¸‹ä»£ç ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>url <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"http://%s/healthz"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>InsecureServingInfo<span class="token punctuation">.</span>Address<span class="token punctuation">)</span>
<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>InsecureServingInfo<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token string">"0.0.0.0"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    url <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:%s/healthz"</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>InsecureServingInfo<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ HTTP æœåŠ¡ç›‘å¬åœ¨æ‰€æœ‰ç½‘å¡æ—¶ï¼Œè¯·æ±‚ IP ä¸º <code v-pre>127.0.0.1</code>ï¼›å½“ HTTP æœåŠ¡ç›‘å¬åœ¨æŒ‡å®šç½‘å¡æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è¯·æ±‚è¯¥ç½‘å¡çš„ IP åœ°å€ã€‚</p>
<h3 id="æ’ä»¶åŒ–åŠ è½½ä¸­é—´ä»¶" tabindex="-1"><a class="header-anchor" href="#æ’ä»¶åŒ–åŠ è½½ä¸­é—´ä»¶" aria-hidden="true">#</a> æ’ä»¶åŒ–åŠ è½½ä¸­é—´ä»¶</h3>
<p>iam-apiserver æ”¯æŒæ’ä»¶åŒ–åœ°åŠ è½½ Gin ä¸­é—´ä»¶ï¼Œé€šè¿‡è¿™ç§æ’ä»¶æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©ä¸­é—´ä»¶ã€‚</p>
<p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆè¦å°†ä¸­é—´ä»¶åšæˆä¸€ç§æ’ä»¶åŒ–çš„æœºåˆ¶å‘¢ï¼Ÿä¸€æ–¹é¢ï¼Œæ¯ä¸ªä¸­é—´ä»¶éƒ½å®ŒæˆæŸç§åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½ä¸æ˜¯æ‰€æœ‰æƒ…å†µä¸‹éƒ½éœ€è¦çš„ï¼›å¦ä¸€æ–¹é¢ï¼Œä¸­é—´ä»¶æ˜¯è¿½åŠ åœ¨ HTTP è¯·æ±‚é“¾è·¯ä¸Šçš„ä¸€ä¸ªå¤„ç†å‡½æ•°ï¼Œä¼šå½±å“ API æ¥å£çš„æ€§èƒ½ã€‚ä¸ºäº†ä¿è¯ API æ¥å£çš„æ€§èƒ½ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦é€‰æ‹©æ€§åœ°åŠ è½½ä¸­é—´ä»¶ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨æµ‹è¯•ç¯å¢ƒä¸­ä¸ºäº†æ–¹ä¾¿ Debugï¼Œå¯ä»¥é€‰æ‹©åŠ è½½ dump ä¸­é—´ä»¶ã€‚dump ä¸­é—´ä»¶å¯ä»¥æ‰“å°è¯·æ±‚åŒ…å’Œè¿”å›åŒ…ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥ååŠ©æˆ‘ä»¬ Debugã€‚ä½†æ˜¯åœ¨ç°ç½‘ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦ dump ä¸­é—´ä»¶æ¥ååŠ© Debugï¼Œè€Œä¸”å¦‚æœåŠ è½½äº† dump ä¸­é—´ä»¶ï¼Œè¯·æ±‚æ—¶ä¼šæ‰“å°å¤§é‡çš„è¯·æ±‚ä¿¡æ¯ï¼Œä¸¥é‡å½±å“ API æ¥å£çš„æ€§èƒ½ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±æœŸæœ›ä¸­é—´ä»¶èƒ½å¤ŸæŒ‰éœ€åŠ è½½ã€‚</p>
<p>iam-apiserver é€šè¿‡ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/server/genericapiserver.go#L94" target="_blank" rel="noopener noreferrer">InstallMiddlewares<ExternalLinkIcon/></a> å‡½æ•°æ¥å®‰è£… Gin ä¸­é—´ä»¶ï¼Œå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>GenericAPIServer<span class="token punctuation">)</span> <span class="token function">InstallMiddlewares</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// necessary middlewares</span>
    s<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span><span class="token function">RequestID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// install custom middlewares</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> m <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>middlewares <span class="token punctuation">{</span>
        mw<span class="token punctuation">,</span> ok <span class="token operator">:=</span> middleware<span class="token punctuation">.</span>Middlewares<span class="token punctuation">[</span>m<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">"can not find middleware: %s"</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span>

            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>

        log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"install middleware: %s"</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>mw<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå®‰è£…ä¸­é—´ä»¶æ—¶ï¼Œæˆ‘ä»¬ä¸ä»…å®‰è£…äº†ä¸€äº›å¿…å¤‡çš„ä¸­é—´ä»¶ï¼Œè¿˜å®‰è£…äº†ä¸€äº›å¯é…ç½®çš„ä¸­é—´ä»¶ã€‚</p>
<p>ä¸Šè¿°ä»£ç å®‰è£…äº†ä¸¤ä¸ªé»˜è®¤çš„ä¸­é—´ä»¶ï¼š <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/middleware/requestid.go#L22" target="_blank" rel="noopener noreferrer">RequestID<ExternalLinkIcon/></a> å’Œ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/middleware/context.go#L17" target="_blank" rel="noopener noreferrer">Context<ExternalLinkIcon/></a> ã€‚</p>
<p>RequestID ä¸­é—´ä»¶ï¼Œä¸»è¦ç”¨æ¥åœ¨ HTTP è¯·æ±‚å¤´å’Œè¿”å›å¤´ä¸­è®¾ç½® <code v-pre>X-Request-ID</code> Headerã€‚å¦‚æœ HTTP è¯·æ±‚å¤´ä¸­æ²¡æœ‰ <code v-pre>X-Request-ID</code> HTTP å¤´ï¼Œåˆ™åˆ›å»º 64 ä½çš„ UUIDï¼Œå¦‚æœæœ‰å°±å¤ç”¨ã€‚UUID æ˜¯è°ƒç”¨ <code v-pre>github.com/satori/go.uuid</code>åŒ…æä¾›çš„ <code v-pre>NewV4().String()</code>æ–¹æ³•æ¥ç”Ÿæˆçš„ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>rid <span class="token operator">=</span> uuid<span class="token punctuation">.</span><span class="token function">NewV4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¦å¤–ï¼Œè¿™é‡Œæœ‰ä¸ª Go å¸¸é‡çš„è®¾è®¡è§„èŒƒéœ€è¦ä½ æ³¨æ„ï¼šå¸¸é‡è¦è·Ÿè¯¥å¸¸é‡ç›¸å…³çš„åŠŸèƒ½åŒ…æ”¾åœ¨ä¸€èµ·ï¼Œä¸è¦å°†ä¸€ä¸ªé¡¹ç›®çš„å¸¸é‡éƒ½é›†ä¸­æ”¾åœ¨ const è¿™ç±»åŒ…ä¸­ã€‚ä¾‹å¦‚ï¼Œ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/middleware/requestid.go" target="_blank" rel="noopener noreferrer">requestid.go<ExternalLinkIcon/></a> æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº† <code v-pre>XRequestIDKey = &quot;X-Request-ID&quot;</code>å¸¸é‡ï¼Œå…¶ä»–åœ°æ–¹å¦‚æœéœ€è¦ä½¿ç”¨ <code v-pre>XRequestIDKey</code>ï¼Œåªéœ€è¦å¼•å…¥ <code v-pre>XRequestIDKey</code>æ‰€åœ¨çš„åŒ…ï¼Œå¹¶ä½¿ç”¨å³å¯ã€‚</p>
<p>Context ä¸­é—´ä»¶ï¼Œç”¨æ¥åœ¨ gin.Context ä¸­è®¾ç½® <code v-pre>requestID</code>å’Œ <code v-pre>username</code>é”®ï¼Œåœ¨æ‰“å°æ—¥å¿—æ—¶ï¼Œå°† gin.Context ç±»å‹çš„å˜é‡ä¼ é€’ç»™ <code v-pre>log.L()</code> å‡½æ•°ï¼Œ<code v-pre>log.L()</code> å‡½æ•°ä¼šåœ¨æ—¥å¿—è¾“å‡ºä¸­è¾“å‡º <code v-pre>requestID</code>å’Œ <code v-pre>username</code>åŸŸï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token number">2021</span>-07-09 <span class="token number">13</span>:33:21.362 DEBUG   apiserver       v1/user.go:106  get <span class="token number">2</span> <span class="token function">users</span> from backend storage.       <span class="token punctuation">{</span><span class="token string">"requestID"</span><span class="token builtin class-name">:</span> <span class="token string">"f8477cf5-4592-4e47-bdcf-82f7bde2e2d0"</span>, <span class="token string">"username"</span><span class="token builtin class-name">:</span> <span class="token string">"admin"</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code v-pre>requestID</code>å’Œ <code v-pre>username</code>å­—æ®µå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬åæœŸè¿‡æ»¤å¹¶æŸ¥çœ‹æ—¥å¿—ã€‚</p>
<p>é™¤äº†é»˜è®¤çš„ä¸­é—´ä»¶ï¼Œiam-apiserver è¿˜æ”¯æŒä¸€äº›å¯é…ç½®çš„ä¸­é—´ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½® iam-apiserver é…ç½®æ–‡ä»¶ä¸­çš„ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/configs/iam-apiserver.yaml#L11" target="_blank" rel="noopener noreferrer">server.middlewares<ExternalLinkIcon/></a> é…ç½®é¡¹ï¼Œæ¥é…ç½®è¿™äº›è¿™äº›ä¸­é—´ä»¶ã€‚</p>
<p>å¯é…ç½®ä»¥ä¸‹ä¸­é—´ä»¶ï¼š</p>
<ul>
<li>recoveryï¼šæ•è·ä»»ä½• panicï¼Œå¹¶æ¢å¤ã€‚</li>
<li>secureï¼šæ·»åŠ ä¸€äº›å®‰å…¨å’Œèµ„æºè®¿é—®ç›¸å…³çš„ HTTP å¤´ã€‚</li>
<li>nocacheï¼šç¦æ­¢å®¢æˆ·ç«¯ç¼“å­˜ HTTP è¯·æ±‚çš„è¿”å›ç»“æœã€‚</li>
<li>corsï¼šHTTP è¯·æ±‚è·¨åŸŸä¸­é—´ä»¶ã€‚</li>
<li>dumpï¼šæ‰“å°å‡º HTTP è¯·æ±‚åŒ…å’Œè¿”å›åŒ…çš„å†…å®¹ï¼Œæ–¹ä¾¿ debugã€‚æ³¨æ„ï¼Œç”Ÿäº§ç¯å¢ƒç¦æ­¢åŠ è½½è¯¥ä¸­é—´ä»¶ã€‚</li>
</ul>
<p>å½“ç„¶ï¼Œä½ è¿˜å¯ä»¥æ ¹æ®éœ€è¦ï¼Œæ·»åŠ æ›´å¤šçš„ä¸­é—´ä»¶ã€‚æ–¹æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦ç¼–å†™ä¸­é—´ä»¶ï¼Œå¹¶å°†ä¸­é—´ä»¶æ·»åŠ åˆ°ä¸€ä¸ª <code v-pre>map[string]gin.HandlerFunc</code> ç±»å‹çš„å˜é‡ä¸­å³å¯ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">defaultMiddlewares</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>      
    <span class="token keyword">return</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>gin<span class="token punctuation">.</span>HandlerFunc<span class="token punctuation">{</span>                          
        <span class="token string">"recovery"</span><span class="token punctuation">:</span>  gin<span class="token punctuation">.</span><span class="token function">Recovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                            
        <span class="token string">"secure"</span><span class="token punctuation">:</span>    Secure<span class="token punctuation">,</span>                                
        <span class="token string">"options"</span><span class="token punctuation">:</span>   Options<span class="token punctuation">,</span>             
        <span class="token string">"nocache"</span><span class="token punctuation">:</span>   NoCache<span class="token punctuation">,</span>             
        <span class="token string">"cors"</span><span class="token punctuation">:</span>      <span class="token function">Cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                        
        <span class="token string">"requestid"</span><span class="token punctuation">:</span> <span class="token function">RequestID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                       
        <span class="token string">"logger"</span><span class="token punctuation">:</span>    <span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                                           
        <span class="token string">"dump"</span><span class="token punctuation">:</span>      gindump<span class="token punctuation">.</span><span class="token function">Dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                                               
    <span class="token punctuation">}</span>                                                                                              
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°ä»£ç ä½äº <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/middleware/middleware.go#L56" target="_blank" rel="noopener noreferrer">internal/pkg/middleware/middleware.go<ExternalLinkIcon/></a> æ–‡ä»¶ä¸­ã€‚</p>
<h2 id="ç¼–ç¨‹è§„èŒƒç›¸å…³çš„ç‰¹æ€§" tabindex="-1"><a class="header-anchor" href="#ç¼–ç¨‹è§„èŒƒç›¸å…³çš„ç‰¹æ€§" aria-hidden="true">#</a> ç¼–ç¨‹è§„èŒƒç›¸å…³çš„ç‰¹æ€§</h2>
<p>ç¼–ç¨‹è§„èŒƒç›¸å…³çš„ç‰¹æ€§æœ‰å››ä¸ªï¼Œåˆ†åˆ«æ˜¯ API ç‰ˆæœ¬ã€ç»Ÿä¸€çš„èµ„æºå…ƒæ•°æ®ã€ç»Ÿä¸€çš„è¿”å›ã€å¹¶å‘å¤„ç†æ¨¡æ¿ã€‚</p>
<h3 id="api-ç‰ˆæœ¬" tabindex="-1"><a class="header-anchor" href="#api-ç‰ˆæœ¬" aria-hidden="true">#</a> API ç‰ˆæœ¬</h3>
<p>RESTful API ä¸ºäº†æ–¹ä¾¿ä»¥åæ‰©å±•ï¼Œéƒ½éœ€è¦æ”¯æŒ API ç‰ˆæœ¬ï¼Œiam-apiserver é€‰æ‹©äº†å°† API ç‰ˆæœ¬å·æ”¾åœ¨ URL ä¸­ï¼Œä¾‹å¦‚<code v-pre>/v1/secrets</code>ã€‚æ”¾åœ¨ URL ä¸­çš„å¥½å¤„æ˜¯å¾ˆç›´è§‚ï¼Œçœ‹ API è·¯å¾„å°±çŸ¥é“ç‰ˆæœ¬å·ã€‚å¦å¤–ï¼ŒAPI çš„è·¯å¾„ä¹Ÿå¯ä»¥å¾ˆå¥½åœ°è·Ÿæ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚ã€æ¨¡å‹å±‚çš„ä»£ç è·¯å¾„ç›¸æ˜ å°„ã€‚ä¾‹å¦‚ï¼Œå¯†é’¥èµ„æºç›¸å…³çš„ä»£ç å­˜æ”¾ä½ç½®å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>internal/apiserver/controller/v1/secret/  <span class="token comment"># æ§åˆ¶å‡ å±‚ä»£ç å­˜æ”¾ä½ç½®</span>
internal/apiserver/service/v1/secret.go <span class="token comment"># ä¸šåŠ¡å±‚ä»£ç å­˜æ”¾ä½ç½®</span>
github.com/marmotedu/api/apiserver/v1/secret.go <span class="token comment"># æ¨¡å‹å±‚ä»£ç å­˜æ”¾ä½ç½®</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…³äºä»£ç å­˜æ”¾è·¯å¾„ï¼Œæˆ‘è¿˜æœ‰ä¸€äº›åœ°æ–¹æƒ³è·Ÿä½ åˆ†äº«ã€‚å¯¹äº Secret èµ„æºï¼Œé€šå¸¸æˆ‘ä»¬éœ€è¦æä¾› CRUD æ¥å£ã€‚</p>
<ul>
<li>Cï¼šCreateï¼ˆåˆ›å»º Secretï¼‰ã€‚</li>
<li>Rï¼šGetï¼ˆè·å–è¯¦æƒ…ï¼‰ã€Listï¼ˆè·å– Secret èµ„æºåˆ—è¡¨ï¼‰ã€‚</li>
<li>Uï¼šUpdateï¼ˆæ›´æ–° Secretï¼‰ã€‚</li>
<li>Dï¼šDeleteï¼ˆåˆ é™¤æŒ‡å®šçš„ Secretï¼‰ã€DeleteCollectionï¼ˆæ‰¹é‡åˆ é™¤ Secretï¼‰ã€‚</li>
</ul>
<p>æ¯ä¸ªæ¥å£ç›¸äº’ç‹¬ç«‹ï¼Œä¸ºäº†å‡å°‘æ›´æ–° A æ¥å£ä»£ç æ—¶å› ä¸ºè¯¯æ“ä½œå½±å“åˆ° B æ¥å£ä»£ç çš„æƒ…å†µï¼Œè¿™é‡Œå»ºè®® CRUD æ¥å£æ¯ä¸ªæ¥å£ä¸€ä¸ªæ–‡ä»¶ï¼Œä»ç‰©ç†ä¸Šå°†ä¸åŒæ¥å£çš„ä»£ç éš”ç¦»å¼€ã€‚è¿™ç§æ¥å£è¿˜å¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æŸ¥æ‰¾ A æ¥å£çš„ä»£ç æ‰€åœ¨ä½ç½®ã€‚ä¾‹å¦‚ï¼ŒSecret æ§åˆ¶å±‚ç›¸å…³ä»£ç çš„å­˜æ”¾æ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">ls</span> internal/apiserver/controller/v1/secret/
create.go  delete_collection.go  delete.go  doc.go  get.go  list.go  secret.go  update.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸šåŠ¡å±‚å’Œæ¨¡å‹å±‚çš„ä»£ç ä¹Ÿå¯ä»¥è¿™ä¹ˆç»„ç»‡ã€‚iam-apiserver ä¸­ï¼Œå› ä¸º Secret çš„ä¸šåŠ¡å±‚å’Œæ¨¡å‹å±‚ä»£ç æ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥æˆ‘æ”¾åœ¨äº† <code v-pre>internal/apiserver/service/v1/secret.go</code>å’Œ <code v-pre>github.com/marmotedu/api/apiserver/v1/secret.go</code>æ–‡ä»¶ä¸­ã€‚å¦‚æœåæœŸ Secret ä¸šåŠ¡ä»£ç å¢å¤šï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹æˆä¸‹é¢è¿™ç§æ–¹å¼ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code> $ <span class="token function">ls</span> internal/apiserver/service/v1/secret/
 create.go  delete_collection.go  delete.go  doc.go  get.go  list.go  secret.go  update.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œå†è¯´ä¸ªé¢˜å¤–è¯ï¼š<code v-pre>/v1/secret/</code>å’Œ<code v-pre>/secret/v1/</code>è¿™ä¸¤ç§ç›®å½•ç»„ç»‡æ–¹å¼éƒ½å¯ä»¥ï¼Œä½ é€‰æ‹©ä¸€ä¸ªè‡ªå·±å–œæ¬¢çš„å°±è¡Œã€‚</p>
<p>å½“æˆ‘ä»¬éœ€è¦å‡çº§ API ç‰ˆæœ¬æ—¶ï¼Œç›¸å…³ä»£ç å¯ä»¥ç›´æ¥æ”¾åœ¨ <code v-pre>v2</code> ç›®å½•ä¸‹ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>internal/apiserver/controller/v2/secret/ <span class="token comment"># v2 ç‰ˆæœ¬æ§åˆ¶å‡ å±‚ä»£ç å­˜æ”¾ä½ç½®</span>
internal/apiserver/service/v2/secret.go <span class="token comment"># v2 ç‰ˆæœ¬ä¸šåŠ¡å±‚ä»£ç å­˜æ”¾ä½ç½®</span>
github.com/marmotedu/api/apiserver/v2/secret.go <span class="token comment"># v2 ç‰ˆæœ¬æ¨¡å‹å±‚ä»£ç å­˜æ”¾ä½ç½®</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·æ—¢èƒ½å¤Ÿè·Ÿ v1 ç‰ˆæœ¬çš„ä»£ç ç‰©ç†éš”ç¦»å¼€ï¼Œäº’ä¸å½±å“ï¼Œåˆæ–¹ä¾¿æŸ¥æ‰¾ v2 ç‰ˆæœ¬çš„ä»£ç ã€‚</p>
<h3 id="ç»Ÿä¸€çš„èµ„æºå…ƒæ•°æ®" tabindex="-1"><a class="header-anchor" href="#ç»Ÿä¸€çš„èµ„æºå…ƒæ•°æ®" aria-hidden="true">#</a> ç»Ÿä¸€çš„èµ„æºå…ƒæ•°æ®</h3>
<p>iam-apiserver è®¾è®¡çš„ä¸€å¤§äº®ç‚¹æ˜¯ï¼Œ<strong>åƒKubernetes REST èµ„æºä¸€æ ·ï¼Œæ”¯æŒç»Ÿä¸€çš„èµ„æºå…ƒæ•°æ®ã€‚</strong></p>
<p>iam-apiserver ä¸­æ‰€æœ‰çš„èµ„æºéƒ½æ˜¯ REST èµ„æºï¼Œiam-apiserver å°† REST èµ„æºçš„å±æ€§ä¹Ÿè¿›ä¸€æ­¥è§„èŒƒåŒ–äº†ï¼Œè¿™é‡Œçš„è§„èŒƒåŒ–æ˜¯æŒ‡æ‰€æœ‰çš„ REST èµ„æºå‡æ”¯æŒä¸¤ç§å±æ€§ï¼š</p>
<ul>
<li>å…¬å…±å±æ€§ã€‚</li>
<li>èµ„æºè‡ªæœ‰çš„å±æ€§ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼ŒSecret èµ„æºçš„å®šä¹‰æ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Secret <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// May add TypeMeta in the future.</span>
    <span class="token comment">// metav1.TypeMeta `json:",inline"`</span>

    <span class="token comment">// Standard object's metadata.</span>
    metav1<span class="token punctuation">.</span>ObjectMeta <span class="token string">`       json:"metadata,omitempty"`</span>
    Username          <span class="token builtin">string</span> <span class="token string">`json:"username"           gorm:"column:username"  validate:"omitempty"`</span>
    SecretID          <span class="token builtin">string</span> <span class="token string">`json:"secretID"           gorm:"column:secretID"  validate:"omitempty"`</span>
    SecretKey         <span class="token builtin">string</span> <span class="token string">`json:"secretKey"          gorm:"column:secretKey" validate:"omitempty"`</span>

    <span class="token comment">// Required: true</span>
    Expires     <span class="token builtin">int64</span>  <span class="token string">`json:"expires"     gorm:"column:expires"     validate:"omitempty"`</span>
    Description <span class="token builtin">string</span> <span class="token string">`json:"description" gorm:"column:description" validate:"description"`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>èµ„æºè‡ªæœ‰çš„å±æ€§ï¼Œä¼šå› èµ„æºä¸åŒè€Œä¸åŒã€‚è¿™é‡Œï¼Œæˆ‘ä»¬æ¥é‡ç‚¹çœ‹ä¸€ä¸‹å…¬å…±å±æ€§ <a href="https://github.com/marmotedu/component-base/blob/v1.0.1/pkg/meta/v1/types.go#L38" target="_blank" rel="noopener noreferrer">ObjectMeta<ExternalLinkIcon/></a> ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> ObjectMeta <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID <span class="token builtin">uint64</span> <span class="token string">`json:"id,omitempty" gorm:"primary_key;AUTO_INCREMENT;column:id"`</span>
  InstanceID <span class="token builtin">string</span> <span class="token string">`json:"instanceID,omitempty" gorm:"unique;column:instanceID;type:varchar(32);not null"`</span>
  Name <span class="token builtin">string</span> <span class="token string">`json:"name,omitempty" gorm:"column:name;type:varchar(64);not null" validate:"name"`</span>
  Extend Extend <span class="token string">`json:"extend,omitempty" gorm:"-" validate:"omitempty"`</span>
  ExtendShadow <span class="token builtin">string</span> <span class="token string">`json:"-" gorm:"column:extendShadow" validate:"omitempty"`</span>
  CreatedAt time<span class="token punctuation">.</span>Time <span class="token string">`json:"createdAt,omitempty" gorm:"column:createdAt"`</span>
  UpdatedAt time<span class="token punctuation">.</span>Time <span class="token string">`json:"updatedAt,omitempty" gorm:"column:updatedAt"`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥è¯¦ç»†ä»‹ç»å…¬å…±å±æ€§ä¸­æ¯ä¸ªå­—æ®µçš„å«ä¹‰åŠä½œç”¨ã€‚</p>
<p><strong>ID</strong></p>
<p>è¿™é‡Œçš„ IDï¼Œæ˜ å°„ä¸º MariaDB æ•°æ®åº“ä¸­çš„ <code v-pre>id</code> å­—æ®µã€‚<code v-pre>id</code> å­—æ®µåœ¨ä¸€äº›åº”ç”¨ä¸­ï¼Œä¼šä½œä¸ºèµ„æºçš„å”¯ä¸€æ ‡è¯†ã€‚ä½† iam-apiserver ä¸­æ²¡æœ‰ä½¿ç”¨ ID ä½œä¸ºèµ„æºçš„å”¯ä¸€æ ‡è¯†ï¼Œè€Œæ˜¯ä½¿ç”¨äº† InstanceIDã€‚iam-apiserver ä¸­ ID å”¯ä¸€çš„ä½œç”¨æ˜¯è·Ÿæ•°æ®åº“ <code v-pre>id</code> å­—æ®µè¿›è¡Œæ˜ å°„ï¼Œä»£ç ä¸­å¹¶æ²¡æœ‰ä½¿ç”¨åˆ° <code v-pre>ID</code>ã€‚</p>
<p><strong>InstanceID</strong></p>
<p>InstanceID æ˜¯èµ„æºçš„å”¯ä¸€æ ‡è¯†ï¼Œæ ¼å¼ä¸º<code v-pre>&lt;resource identifier&gt;-xxxxxx</code>ã€‚å…¶ä¸­ï¼Œ<code v-pre>&lt;resource identifier&gt;</code>æ˜¯èµ„æºçš„è‹±æ–‡æ ‡è¯†ç¬¦å·ï¼Œ<code v-pre>xxxxxx</code>æ˜¯éšæœºå­—ç¬¦ä¸²ã€‚å­—ç¬¦é›†åˆä¸º <code v-pre>abcdefghijklmnopqrstuvwxyz1234567890</code>ï¼Œé•¿åº¦&gt;=6ï¼Œä¾‹å¦‚ <code v-pre>secret-yj8m30</code>ã€<code v-pre>user-j4lz3g</code>ã€<code v-pre>policy-3v18jq</code>ã€‚</p>
<p>è…¾è®¯äº‘ã€é˜¿é‡Œäº‘ã€åä¸ºäº‘ä¹Ÿéƒ½æ˜¯é‡‡ç”¨è¿™ç§æ ¼å¼çš„å­—ç¬¦ä¸²ä½œä¸ºèµ„æºå”¯ä¸€æ ‡è¯†çš„ã€‚</p>
<p>InstanceID çš„ç”Ÿæˆå’Œæ›´æ–°éƒ½æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œé€šè¿‡ gorm æä¾›çš„ <code v-pre>AfterCreate</code> Hooks åœ¨è®°å½•æ’å…¥æ•°æ®åº“ä¹‹åï¼Œç”Ÿæˆå¹¶æ›´æ–°åˆ°æ•°æ®åº“çš„ <code v-pre>instanceID</code>å­—æ®µï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Secret<span class="token punctuation">)</span> <span class="token function">AfterCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>InstanceID <span class="token operator">=</span> idutil<span class="token punctuation">.</span><span class="token function">GetInstanceID</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">"secret-"</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>Error
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ï¼Œåœ¨ Secret è®°å½•æ’å…¥åˆ° iam æ•°æ®åº“çš„ secret è¡¨ä¹‹åï¼Œè°ƒç”¨ <code v-pre>idutil.GetInstanceID</code>ç”Ÿæˆ InstanceIDï¼Œå¹¶é€šè¿‡ <code v-pre>tx.Save(s)</code>æ›´æ–°åˆ°æ•°æ®åº“ secret è¡¨çš„ <code v-pre>instanceID</code>å­—æ®µã€‚</p>
<p>å› ä¸ºé€šå¸¸æƒ…å†µä¸‹ï¼Œåº”ç”¨ä¸­çš„ REST èµ„æºåªä¼šä¿å­˜åˆ°æ•°æ®åº“ä¸­çš„ä¸€å¼ è¡¨é‡Œï¼Œè¿™æ ·å°±èƒ½ä¿è¯åº”ç”¨ä¸­æ¯ä¸ªèµ„æºçš„æ•°æ®åº“ ID æ˜¯å”¯ä¸€çš„ã€‚æ‰€ä»¥ <code v-pre>GetInstanceID(uid uint64, prefix string) string</code>å‡½æ•°ä½¿ç”¨ <code v-pre>github.com/speps/go-hashids</code>åŒ…æä¾›çš„æ–¹æ³•ï¼Œå¯¹è¿™ä¸ªæ•°æ®åº“ ID è¿›è¡Œå“ˆå¸Œï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªæ•°æ®åº“çº§åˆ«çš„å”¯ä¸€çš„å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ï¼š<code v-pre>3v18jq</code>ï¼‰ï¼Œå¹¶æ ¹æ®ä¼ å…¥çš„ prefixï¼Œå¾—åˆ°èµ„æºçš„ InstanceIDã€‚</p>
<p>ä½¿ç”¨è¿™ç§æ–¹å¼ç”Ÿæˆèµ„æºçš„å”¯ä¸€æ ‡è¯†ï¼Œæœ‰ä¸‹é¢è¿™ä¸¤ä¸ªä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ•°æ®åº“çº§åˆ«å”¯ä¸€ã€‚</li>
<li>InstanceID æ˜¯é•¿åº¦å¯æ§çš„å­—ç¬¦ä¸²ï¼Œé•¿åº¦æœ€å°æ˜¯ 6 ä¸ªå­—ç¬¦ï¼Œä½†ä¼šæ ¹æ®è¡¨ä¸­çš„è®°å½•ä¸ªæ•°åŠ¨æ€å˜é•¿ã€‚æ ¹æ®æˆ‘çš„æµ‹è¯•ï¼Œ2176782336 æ¡è®°å½•ä»¥å†…ç”Ÿæˆçš„ InstanceID é•¿åº¦éƒ½åœ¨ 6 ä¸ªå­—ç¬¦ä»¥å†…ã€‚é•¿åº¦å¯æ§çš„å¦å¤–ä¸€ä¸ªå¥½å¤„æ˜¯æ–¹ä¾¿è®°å¿†å’Œä¼ æ’­ã€‚</li>
</ul>
<p>è¿™é‡Œéœ€è¦ä½ æ³¨æ„ï¼šå¦‚æœåŒä¸€ä¸ªèµ„æºåˆ†åˆ«å­˜æ”¾åœ¨ä¸åŒçš„è¡¨ä¸­ï¼Œé‚£åœ¨ä½¿ç”¨è¿™ç§æ–¹å¼æ—¶ï¼Œç”Ÿæˆçš„ InstanceID å¯èƒ½ç›¸åŒï¼Œä¸è¿‡æ¦‚ç‡å¾ˆå°ï¼Œå‡ ä¹ä¸ºé›¶ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼ ID ç”ŸæˆæŠ€æœ¯ã€‚è¿™åˆæ˜¯å¦å¤–ä¸€ä¸ªè¯é¢˜äº†ï¼Œè¿™é‡Œä¸å†æ‰©å±•è®²è§£ã€‚</p>
<p>åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œä¸å°‘å¼€å‘è€…ä¼šä½¿ç”¨æ•°æ®åº“æ•°å­—æ®µ IDï¼ˆä¾‹å¦‚ <code v-pre>121</code>ï¼‰å’Œ 36/64 ä½çš„ UUIDï¼ˆä¾‹å¦‚ <code v-pre>20cd59d4-08c6-4e86-a9d4-a0e51c420a04</code> ï¼‰æ¥ä½œä¸ºèµ„æºçš„å”¯ä¸€æ ‡è¯†ã€‚ç›¸è¾ƒäºè¿™ä¸¤ç§èµ„æºæ ‡è¯†æ–¹å¼ï¼Œä½¿ç”¨<code v-pre>&lt;resource identifier&gt;-xxxxxx</code>è¿™ç§æ ‡è¯†æ–¹å¼å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p>
<ul>
<li>çœ‹æ ‡è¯†åå°±çŸ¥é“æ˜¯ä»€ä¹ˆç±»å‹çš„èµ„æºï¼Œä¾‹å¦‚ï¼š<code v-pre>secret-yj8m30</code>è¯´æ˜è¯¥èµ„æºæ˜¯ secret ç±»å‹çš„èµ„æºã€‚åœ¨å®é™…çš„æ’éšœè¿‡ç¨‹ä¸­ï¼Œèƒ½å¤Ÿæœ‰æ•ˆå‡å°‘è¯¯æ“ä½œã€‚</li>
<li>é•¿åº¦å¯æ§ï¼Œå ç”¨æ•°æ®åº“ç©ºé—´å°ã€‚iam-apiserver çš„èµ„æºæ ‡è¯†é•¿åº¦åŸºæœ¬å¯ä»¥è®¤ä¸ºæ˜¯ 12 ä¸ªå­—ç¬¦ï¼ˆsecret/policy æ˜¯ 6 ä¸ªå­—ç¬¦ï¼Œå†åŠ  6 ä½éšæœºå­—ç¬¦ï¼‰ã€‚</li>
<li>å¦‚æœä½¿ç”¨ <code v-pre>121</code> è¿™ç±»æ•°å€¼ä½œä¸ºèµ„æºå”¯ä¸€æ ‡è¯†ï¼Œç›¸å½“äºé—´æ¥å‘å‹å•†é€æ¼ç³»ç»Ÿçš„è§„æ¨¡ï¼Œæ˜¯ä¸€å®šè¦ç¦æ­¢çš„ã€‚</li>
</ul>
<p>å¦å¤–ï¼Œè¿˜æœ‰ä¸€äº›ç³»ç»Ÿå¦‚ Kubernetes ä¸­ï¼Œä½¿ç”¨èµ„æºåä½œä¸ºèµ„æºå”¯ä¸€æ ‡è¯†ã€‚è¿™ç§æ–¹å¼æœ‰ä¸ªå¼Šç«¯ï¼Œå°±æ˜¯å½“ç³»ç»Ÿä¸­åŒç±»èµ„æºå¤ªå¤šæ—¶ï¼Œåˆ›å»ºèµ„æºå¾ˆå®¹æ˜“é‡åï¼Œä½ è‡ªå·±æƒ³è¦çš„åå­—å¾€å¾€å¡«ä¸äº†ï¼Œæ‰€ä»¥ iam-apiserver ä¸é‡‡ç”¨è¿™ç§è®¾è®¡æ–¹å¼ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨ instanceID æ¥ä½œä¸ºèµ„æºçš„å”¯ä¸€æ ‡è¯†ï¼Œåœ¨ä»£ç ä¸­ï¼Œå°±ç»å¸¸éœ€è¦æ ¹æ® instanceID æ¥æŸ¥è¯¢èµ„æºã€‚æ‰€ä»¥ï¼Œåœ¨æ•°æ®åº“ä¸­è¦è®¾ç½®è¯¥å­—æ®µä¸ºå”¯ä¸€ç´¢å¼•ï¼Œä¸€æ–¹é¢å¯ä»¥é˜²æ­¢ instanceID ä¸å”¯ä¸€ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿèƒ½åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚</p>
<p><strong>Name:</strong></p>
<p>Name å³èµ„æºçš„åå­—ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå­—å¾ˆå®¹æ˜“åœ°è¾¨åˆ«ä¸€ä¸ªèµ„æºã€‚</p>
<p><strong>Extendã€ExtendShadowï¼š</strong></p>
<p>Extend å’Œ ExtendShadow æ˜¯ iam-apiserver è®¾è®¡çš„åˆä¸€å¤§äº®ç‚¹ã€‚</p>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼šéšç€ä¸šåŠ¡å‘å±•ï¼ŒæŸä¸ªèµ„æºéœ€è¦å¢åŠ ä¸€äº›å±æ€§ï¼Œè¿™æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé€‰æ‹©åœ¨æ•°æ®åº“ä¸­æ–°å¢ä¸€ä¸ªæ•°æ®åº“å­—æ®µã€‚ä½†æ˜¯ï¼Œéšç€ä¸šåŠ¡ç³»ç»Ÿçš„æ¼”è¿›ï¼Œæ•°æ®åº“ä¸­çš„å­—æ®µè¶Šæ¥è¶Šå¤šï¼Œæˆ‘ä»¬çš„ Code ä¹Ÿè¦åšé€‚é…ï¼Œæœ€åå°±ä¼šè¶Šæ¥è¶Šéš¾ç»´æŠ¤ã€‚</p>
<p>æˆ‘ä»¬è¿˜å¯èƒ½é‡åˆ°è¿™ç§æƒ…å†µï¼šæˆ‘ä»¬å°†ä¸Šé¢è¯´çš„å­—æ®µä¿å­˜åœ¨æ•°æ®åº“ä¸­å« <code v-pre>meta</code>çš„å­—æ®µä¸­ï¼Œæ•°æ®åº“ä¸­ <code v-pre>meta</code>å­—æ®µçš„æ•°æ®æ ¼å¼æ˜¯<code v-pre>{&quot;disable&quot;:true,&quot;tag&quot;:&quot;colin&quot;}</code>ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¦‚æœæƒ³åœ¨ä»£ç ä¸­ä½¿ç”¨è¿™äº›å­—æ®µï¼Œéœ€è¦ Unmarshal åˆ°ä¸€ä¸ªç»“æ„ä½“ä¸­ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>metaData <span class="token operator">:=</span> <span class="token string">`{"disable":true,"tag":"colin"}`</span>
meta <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>metaData<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>meta<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†å­˜å…¥æ•°æ®ä¸­æ—¶ï¼Œåˆè¦ Marshal æˆ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>meta <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">"disable"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"tag"</span><span class="token punctuation">:</span> <span class="token string">"colin"</span><span class="token punctuation">}</span>
data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>meta<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§ Unmarshal å’Œ Marshal æ“ä½œæœ‰ç‚¹ç¹çã€‚</p>
<p>å› ä¸ºæ¯ä¸ªèµ„æºéƒ½å¯èƒ½éœ€è¦ç”¨åˆ°æ‰©å±•å­—æ®µï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§é€šç”¨çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿiam-apiserver å°±é€šè¿‡ Extend å’Œ ExtendShadow è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>Extend æ˜¯ Extend ç±»å‹çš„å­—æ®µï¼ŒExtend ç±»å‹å…¶å®æ˜¯ <code v-pre>map[string]interface{}</code>çš„ç±»å‹åˆ«åã€‚åœ¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¼•ç”¨ Extend åŒ…å«çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯ map çš„ keyã€‚Extend å­—æ®µåœ¨ä¿å­˜åˆ°æ•°æ®åº“ä¸­æ—¶ï¼Œä¼šè‡ªåŠ¨ Marshal æˆå­—ç¬¦ä¸²ï¼Œä¿å­˜åœ¨ ExtendShadow å­—æ®µä¸­ã€‚</p>
<p>ExtendShadow æ˜¯ Extend åœ¨æ•°æ®åº“ä¸­çš„å½±å­ã€‚åŒæ ·ï¼Œå½“ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®æ—¶ï¼ŒExtendShadow çš„å€¼ä¼šè‡ªåŠ¨ Unmarshal åˆ° Extend ç±»å‹çš„å˜é‡ä¸­ï¼Œä¾›ç¨‹åºä½¿ç”¨ã€‚</p>
<p>å…·ä½“å®ç°æ–¹å¼å¦‚ä¸‹ï¼š</p>
<ul>
<li>å€ŸåŠ© gorm æä¾›çš„ <code v-pre>BeforeCreate</code>ã€<code v-pre>BeforeUpdate</code> Hooksï¼Œåœ¨æ’å…¥è®°å½•ã€æ›´æ–°è®°å½•æ—¶ï¼Œå°† Extend çš„å€¼è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œä¿å­˜åœ¨ ExtendShadow å­—æ®µä¸­ï¼Œå¹¶æœ€ç»ˆä¿å­˜åœ¨æ•°æ®åº“çš„ ExtendShadow å­—æ®µä¸­ã€‚</li>
<li>å€ŸåŠ© gorm æä¾›çš„ <code v-pre>AfterFind</code> Hooksï¼Œåœ¨æŸ¥è¯¢æ•°æ®åï¼Œå°† ExtendShadow çš„å€¼ Unmarshal åˆ° Extend å­—æ®µä¸­ï¼Œä¹‹åç¨‹åºå°±å¯ä»¥é€šè¿‡ Extend å­—æ®µæ¥ä½¿ç”¨å…¶ä¸­çš„å±æ€§ã€‚</li>
</ul>
<ol>
<li>CreatedAt</li>
</ol>
<p>èµ„æºçš„åˆ›å»ºæ—¶é—´ã€‚æ¯ä¸ªèµ„æºåœ¨åˆ›å»ºæ—¶ï¼Œæˆ‘ä»¬éƒ½åº”è¯¥è®°å½•èµ„æºçš„åˆ›å»ºæ—¶é—´ï¼Œå¯ä»¥å¸®åŠ©åæœŸè¿›è¡Œæ’éšœã€åˆ†æç­‰ã€‚</p>
<ol>
<li>UpdatedAt</li>
</ol>
<p>èµ„æºçš„æ›´æ–°æ—¶é—´ã€‚æ¯ä¸ªèµ„æºåœ¨æ›´æ–°æ—¶ï¼Œæˆ‘ä»¬éƒ½åº”è¯¥è®°å½•èµ„æºçš„æ›´æ–°æ—¶é—´ã€‚èµ„æºæ›´æ–°æ—¶ï¼Œè¯¥å­—æ®µç”± gorm è‡ªåŠ¨æ›´æ–°ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒObjectMeta ç»“æ„ä½“åŒ…å«äº†å¾ˆå¤šå­—æ®µï¼Œæ¯ä¸ªå­—æ®µéƒ½å®Œæˆäº†å¾ˆé…·çš„åŠŸèƒ½ã€‚é‚£ä¹ˆï¼Œå¦‚æœæŠŠ ObjectMeta ä½œä¸ºæ‰€æœ‰èµ„æºçš„å…¬å…±å±æ€§ï¼Œè¿™äº›èµ„æºå°±ä¼šè‡ªå¸¦è¿™äº›èƒ½åŠ›ã€‚</p>
<p>å½“ç„¶ï¼Œæœ‰äº›å¼€å‘è€…å¯èƒ½ä¼šè¯´ï¼ŒUser èµ„æºå…¶å®æ˜¯ä¸éœ€è¦ <code v-pre>user-xxxxxx</code>è¿™ç§èµ„æºæ ‡è¯†çš„ï¼Œæ‰€ä»¥ InstanceID è¿™ä¸ªå­—æ®µå…¶å®æ˜¯æ— ç”¨çš„å­—æ®µã€‚ä½†æ˜¯åœ¨æˆ‘çœ‹æ¥ï¼Œå’ŒåŠŸèƒ½å†—ä½™ç›¸æ¯”ï¼ŒåŠŸèƒ½è§„èŒƒåŒ–ã€ä¸é‡å¤é€ è½®å­ï¼Œä»¥åŠ ObjectMeta çš„å…¶ä»–åŠŸèƒ½æ›´åŠ é‡è¦ã€‚æ‰€ä»¥ï¼Œä¹Ÿå»ºè®®æ‰€æœ‰çš„ REST èµ„æºéƒ½ä½¿ç”¨ç»Ÿä¸€çš„èµ„æºå…ƒæ•°æ®ã€‚</p>
<h3 id="ç»Ÿä¸€çš„è¿”å›" tabindex="-1"><a class="header-anchor" href="#ç»Ÿä¸€çš„è¿”å›" aria-hidden="true">#</a> ç»Ÿä¸€çš„è¿”å›</h3>
<p>åœ¨<a href="https://time.geekbang.org/column/article/391895" target="_blank" rel="noopener noreferrer">18 è®²<ExternalLinkIcon/></a> ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»è¿‡ API çš„æ¥å£è¿”å›æ ¼å¼åº”è¯¥æ˜¯ç»Ÿä¸€çš„ã€‚è¦æƒ³è¿”å›ä¸€ä¸ªå›ºå®šæ ¼å¼çš„æ¶ˆæ¯ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨åŒä¸€ä¸ªè¿”å›å‡½æ•°ã€‚å› ä¸º API æ¥å£éƒ½æ˜¯é€šè¿‡åŒä¸€ä¸ªå‡½æ•°æ¥è¿”å›çš„ï¼Œå…¶è¿”å›æ ¼å¼è‡ªç„¶æ˜¯ç»Ÿä¸€çš„ã€‚</p>
<p>IAM é¡¹ç›®é€šè¿‡ <a href="https://github.com/marmotedu/component-base/tree/master/pkg/core" target="_blank" rel="noopener noreferrer">github.com/marmotedu/component-base/pkg/core<ExternalLinkIcon/></a> åŒ…æä¾›çš„ <a href="https://github.com/marmotedu/component-base/blob/master/pkg/core/core.go#L33" target="_blank" rel="noopener noreferrer">WriteResponse<ExternalLinkIcon/></a> å‡½æ•°æ¥è¿”å›ç»“æœã€‚WriteResponse å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">WriteResponse</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">,</span> data <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%#+v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        coder <span class="token operator">:=</span> errors<span class="token punctuation">.</span><span class="token function">ParseCoder</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>coder<span class="token punctuation">.</span><span class="token function">HTTPStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ErrResponse<span class="token punctuation">{</span>
            Code<span class="token punctuation">:</span>      coder<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Message<span class="token punctuation">:</span>   coder<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Reference<span class="token punctuation">:</span> coder<span class="token punctuation">.</span><span class="token function">Reference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒWriteResponse å‡½æ•°ä¼šåˆ¤æ–­ err æ˜¯å¦ä¸º nilã€‚å¦‚æœä¸ä¸º nilï¼Œåˆ™å°† err è§£æä¸º <code v-pre>github.com/marmotedu/errors</code>åŒ…ä¸­å®šä¹‰çš„ Coder ç±»å‹çš„é”™è¯¯ï¼Œå¹¶è°ƒç”¨ Coder æ¥å£æä¾›çš„ <code v-pre>Code()</code> ã€<code v-pre>String()</code> ã€<code v-pre>Reference()</code> æ–¹æ³•ï¼Œè·å–è¯¥é”™è¯¯çš„ä¸šåŠ¡ç ã€å¯¹å¤–å±•ç¤ºçš„é”™è¯¯ä¿¡æ¯å’Œæ’éšœæ–‡æ¡£ã€‚å¦‚æœ err ä¸º nilï¼Œåˆ™è°ƒç”¨ <code v-pre>c.JSON</code>è¿”å› JSON æ ¼å¼çš„æ•°æ®ã€‚</p>
<h3 id="å¹¶å‘å¤„ç†æ¨¡æ¿" tabindex="-1"><a class="header-anchor" href="#å¹¶å‘å¤„ç†æ¨¡æ¿" aria-hidden="true">#</a> å¹¶å‘å¤„ç†æ¨¡æ¿</h3>
<p>åœ¨ Go é¡¹ç›®å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°è¿™æ ·ä¸€ç§åœºæ™¯ï¼šæŸ¥è¯¢åˆ—è¡¨æ¥å£æ—¶ï¼ŒæŸ¥è¯¢å‡ºäº†å¤šæ¡è®°å½•ï¼Œä½†æ˜¯éœ€è¦é’ˆå¯¹æ¯ä¸€æ¡è®°å½•åšä¸€äº›å…¶ä»–é€»è¾‘å¤„ç†ã€‚å› ä¸ºæ˜¯å¤šæ¡è®°å½•ï¼Œæ¯”å¦‚ 100 æ¡ï¼Œå¤„ç†æ¯æ¡è®°å½•å»¶æ—¶å¦‚æœä¸º X æ¯«ç§’ï¼Œä¸²è¡Œå¤„ç†å®Œ 100 æ¡è®°å½•ï¼Œæ•´ä½“å»¶æ—¶å°±æ˜¯ <code v-pre>100 * X æ¯«ç§’</code>ã€‚å¦‚æœ X æ¯”è¾ƒå¤§ï¼Œé‚£æ•´ä½“å¤„ç†å®Œçš„å»¶æ—¶æ˜¯éå¸¸é«˜çš„ï¼Œä¼šä¸¥é‡å½±å“ API æ¥å£çš„æ€§èƒ½ã€‚</p>
<p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬è‡ªç„¶å°±ä¼šæƒ³åˆ°åˆ©ç”¨ CPU çš„å¤šæ ¸èƒ½åŠ›ï¼Œå¹¶å‘æ¥å¤„ç†è¿™ 100 æ¡è®°å½•ã€‚è¿™ç§åœºæ™¯æˆ‘ä»¬åœ¨å®é™…å¼€å‘ä¸­ç»å¸¸é‡åˆ°ï¼Œæœ‰å¿…è¦æŠ½è±¡æˆä¸€ä¸ªå¹¶å‘å¤„ç†æ¨¡æ¿ï¼Œè¿™æ ·ä»¥ååœ¨æŸ¥è¯¢æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¨¡æ¿äº†ã€‚</p>
<p>ä¾‹å¦‚ï¼Œiam-apiserver ä¸­ï¼ŒæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨æ¥å£ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/service/v1/user.go#L43" target="_blank" rel="noopener noreferrer">List<ExternalLinkIcon/></a> ï¼Œè¿˜éœ€è¦è¿”å›æ¯ä¸ªç”¨æˆ·æ‰€æ‹¥æœ‰çš„ç­–ç•¥ä¸ªæ•°ã€‚è¿™å°±ç”¨åˆ°äº†å¹¶å‘å¤„ç†ã€‚è¿™é‡Œï¼Œæˆ‘è¯•ç€å°†å…¶æŠ½è±¡æˆä¸€ä¸ªæ¨¡æ¿ï¼Œæ¨¡æ¿å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>userService<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>UserList<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  users<span class="token punctuation">,</span> err <span class="token operator">:=</span> u<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">L</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"list users from storage failed: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrDatabase<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span>
  errChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  finished <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token keyword">var</span> m sync<span class="token punctuation">.</span>Map

  <span class="token comment">// Improve query efficiency in parallel</span>
  <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>user <span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment">// some cost time process</span>
      policies<span class="token punctuation">,</span> err <span class="token operator">:=</span> u<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Policies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        errChan <span class="token operator">&lt;-</span> errors<span class="token punctuation">.</span><span class="token function">WithCode</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span>ErrDatabase<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>

      m<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">{</span>
                <span class="token operator">...</span>
        Phone<span class="token punctuation">:</span>       user<span class="token punctuation">.</span>Phone<span class="token punctuation">,</span>
        TotalPolicy<span class="token punctuation">:</span> policies<span class="token punctuation">.</span>TotalCount<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">close</span><span class="token punctuation">(</span>finished<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">select</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token operator">&lt;-</span>finished<span class="token punctuation">:</span>
  <span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>errChan<span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
  <span class="token punctuation">}</span>

  <span class="token comment">// infos := make([]*v1.User, 0)</span>
  infos <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span>Items<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
    info<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
    infos <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>infos<span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  log<span class="token punctuation">.</span><span class="token function">L</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">"get %d users from backend storage."</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>infos<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>UserList<span class="token punctuation">{</span>ListMeta<span class="token punctuation">:</span> users<span class="token punctuation">.</span>ListMeta<span class="token punctuation">,</span> Items<span class="token punctuation">:</span> infos<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„å¹¶å‘æ¨¡æ¿ä¸­ï¼Œæˆ‘å®ç°äº†å¹¶å‘å¤„ç†æŸ¥è¯¢ç»“æœä¸­çš„ä¸‰ä¸ªåŠŸèƒ½ï¼š</p>
<p>**ç¬¬ä¸€ä¸ªåŠŸèƒ½ï¼Œgoroutine æŠ¥é”™å³è¿”å›ã€‚**goroutine ä¸­ä»£ç æ®µæŠ¥é”™æ—¶ï¼Œä¼šå°†é”™è¯¯ä¿¡æ¯å†™å…¥ <code v-pre>errChan</code>ä¸­ã€‚æˆ‘ä»¬é€šè¿‡ List å‡½æ•°ä¸­çš„ select è¯­å¥ï¼Œå®ç°åªè¦æœ‰ä¸€ä¸ª goroutine å‘ç”Ÿé”™è¯¯ï¼Œå³è¿”å›ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">select</span> <span class="token punctuation">{</span>
<span class="token keyword">case</span> <span class="token operator">&lt;-</span>finished<span class="token punctuation">:</span>
<span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>errChan<span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**ç¬¬äºŒä¸ªåŠŸèƒ½ï¼Œä¿æŒæŸ¥è¯¢é¡ºåºã€‚**æˆ‘ä»¬ä»æ•°æ®åº“æŸ¥è¯¢å‡ºçš„åˆ—è¡¨æ˜¯æœ‰é¡ºåºçš„ï¼Œæ¯”å¦‚é»˜è®¤æŒ‰æ•°æ®åº“ ID å­—æ®µå‡åºæ’åˆ—ï¼Œæˆ–è€…æˆ‘ä»¬æŒ‡å®šçš„å…¶ä»–æ’åºæ–¹æ³•ã€‚åœ¨å¹¶å‘å¤„ç†ä¸­ï¼Œè¿™äº›é¡ºåºä¼šè¢«æ‰“æ–­ã€‚ä½†ä¸ºäº†ç¡®ä¿æœ€ç»ˆè¿”å›çš„ç»“æœè·Ÿæˆ‘ä»¬é¢„æœŸçš„æ’åºæ•ˆæœä¸€æ ·ï¼Œåœ¨å¹¶å‘æ¨¡æ¿ä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¿è¯æœ€ç»ˆè¿”å›ç»“æœè·ŸæŸ¥è¯¢ç»“æœä¿æŒä¸€è‡´çš„æ’åºã€‚</p>
<p>ä¸Šé¢çš„æ¨¡æ¿ä¸­ï¼Œæˆ‘ä»¬å°†å¤„ç†åçš„è®°å½•ä¿å­˜åœ¨ map ä¸­ï¼Œmap çš„ key ä¸ºæ•°æ®åº“ IDã€‚å¹¶ä¸”ï¼Œåœ¨æœ€åæŒ‰ç…§æŸ¥è¯¢çš„ ID é¡ºåºï¼Œä¾æ¬¡ä» map ä¸­å–å‡º ID çš„è®°å½•ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">var</span> m sync<span class="token punctuation">.</span>Map
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
      <span class="token operator">...</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>user <span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>
    m<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
  <span class="token operator">...</span>
infos <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span>Items<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
  info<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
  infos <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>infos<span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä¸Šé¢è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ç¡®ä¿æœ€ç»ˆè¿”å›çš„ç»“æœè·Ÿä»æ•°æ®åº“ä¸­æŸ¥è¯¢çš„ç»“æœä¿æŒä¸€è‡´çš„æ’åºã€‚</p>
<p>**ç¬¬ä¸‰ä¸ªåŠŸèƒ½ï¼Œå¹¶å‘å®‰å…¨ã€‚**Go è¯­è¨€ä¸­çš„ map ä¸æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œè¦æƒ³å®ç°å¹¶å‘å®‰å…¨ï¼Œéœ€è¦è‡ªå·±å®ç°ï¼ˆå¦‚åŠ é”ï¼‰ï¼Œæˆ–è€…ä½¿ç”¨ <code v-pre>sync.Map</code>ã€‚ä¸Šé¢çš„æ¨¡æ¿ä½¿ç”¨äº† <code v-pre>sync.Map</code>ã€‚</p>
<p>å½“ç„¶äº†ï¼Œå¦‚æœæœŸæœ› List æ¥å£èƒ½åœ¨æœŸæœ›æ—¶é—´å†…è¿”å›ï¼Œè¿˜å¯ä»¥æ·»åŠ è¶…æ—¶æœºåˆ¶ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>finished<span class="token punctuation">:</span>
    <span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>errChan<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"list users timeout after 30 seconds"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>goroutine è™½ç„¶å¾ˆè½»é‡ï¼Œä½†è¿˜æ˜¯ä¼šæ¶ˆè€—èµ„æºï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å¤„ç†å‡ ç™¾ä¸Šåƒçš„å¹¶å‘ï¼Œå°±éœ€è¦ç”¨åç¨‹æ± æ¥å¤ç”¨åç¨‹ï¼Œè¾¾åˆ°èŠ‚çœèµ„æºçš„ç›®çš„ã€‚æœ‰å¾ˆå¤šä¼˜ç§€çš„åç¨‹åŒ…å¯ä¾›æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ï¼Œæ¯”å¦‚ <a href="https://github.com/panjf2000/ants" target="_blank" rel="noopener noreferrer">ants<ExternalLinkIcon/></a> ã€ <a href="https://github.com/Jeffail/tunny" target="_blank" rel="noopener noreferrer">tunny<ExternalLinkIcon/></a> ç­‰ã€‚</p>
<h2 id="å…¶ä»–ç‰¹æ€§" tabindex="-1"><a class="header-anchor" href="#å…¶ä»–ç‰¹æ€§" aria-hidden="true">#</a> å…¶ä»–ç‰¹æ€§</h2>
<p>é™¤äº†ä¸Šé¢é‚£ä¸¤å¤§ç±»ï¼Œè¿™é‡Œæˆ‘è¿˜æƒ³ç»™ä½ ä»‹ç»ä¸‹å…³é”®ä»£ç è®¾è®¡ä¸­çš„å…¶ä»–ç‰¹æ€§ï¼ŒåŒ…æ‹¬æ’ä»¶åŒ–é€‰æ‹© JSON åº“ã€è°ƒç”¨é“¾å®ç°ã€æ•°æ®ä¸€è‡´æ€§ã€‚</p>
<h3 id="æ’ä»¶åŒ–é€‰æ‹©-json-åº“" tabindex="-1"><a class="header-anchor" href="#æ’ä»¶åŒ–é€‰æ‹©-json-åº“" aria-hidden="true">#</a> æ’ä»¶åŒ–é€‰æ‹© JSON åº“</h3>
<p>Golang æä¾›çš„æ ‡å‡† JSON è§£æåº“ encoding/jsonï¼Œåœ¨å¼€å‘é«˜æ€§èƒ½ã€é«˜å¹¶å‘çš„ç½‘ç»œæœåŠ¡æ—¶ä¼šäº§ç”Ÿæ€§èƒ½é—®é¢˜ã€‚æ‰€ä»¥å¾ˆå¤šå¼€å‘è€…åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œå¾€å¾€ä¼šé€‰ç”¨ç¬¬ä¸‰æ–¹çš„é«˜æ€§èƒ½ JSON è§£æåº“ï¼Œä¾‹å¦‚ <a href="https://github.com/json-iterator/go" target="_blank" rel="noopener noreferrer">jsoniter<ExternalLinkIcon/></a> ã€ <a href="https://github.com/mailru/easyjson" target="_blank" rel="noopener noreferrer">easyjson<ExternalLinkIcon/></a> ã€ <a href="https://github.com/buger/jsonparser" target="_blank" rel="noopener noreferrer">jsonparser<ExternalLinkIcon/></a> ç­‰ã€‚</p>
<p>æˆ‘è§è¿‡çš„å¾ˆå¤šå¼€å‘è€…é€‰æ‹©äº† jsoniterï¼Œä¹Ÿæœ‰ä¸€äº›å¼€å‘è€…ä½¿ç”¨äº† easyjsonã€‚jsoniter çš„æ€§èƒ½ç•¥é«˜äº encoding/jsonã€‚ä½†éšç€ go ç‰ˆæœ¬çš„è¿­ä»£ï¼Œencoding/json åº“çš„æ€§èƒ½ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼Œjsoniter çš„æ€§èƒ½ä¼˜åŠ¿ä¹Ÿè¶Šæ¥è¶Šæœ‰é™ã€‚æ‰€ä»¥ï¼ŒIAM é¡¹ç›®ä½¿ç”¨äº† jsoniter åº“ï¼Œå¹¶å‡†å¤‡éšæ—¶åˆ‡å› encoding/json åº“ã€‚</p>
<p>ä¸ºäº†æ–¹ä¾¿åˆ‡æ¢ä¸åŒçš„ JSON åŒ…ï¼Œiam-apiserver é‡‡ç”¨äº†ä¸€ç§æ’ä»¶åŒ–çš„æœºåˆ¶æ¥ä½¿ç”¨ä¸åŒçš„ JSON åŒ…ã€‚å…·ä½“æ˜¯é€šè¿‡ä½¿ç”¨ go çš„æ ‡ç­¾ç¼–è¯‘é€‰æ‹©è¿è¡Œçš„è§£æåº“æ¥å®ç°çš„ã€‚</p>
<p>æ ‡ç­¾ç¼–è¯‘å°±æ˜¯åœ¨æºä»£ç é‡Œæ·»åŠ æ ‡æ³¨ï¼Œé€šå¸¸ç§°ä¹‹ä¸ºç¼–è¯‘æ ‡ç­¾ï¼ˆbuild tagï¼‰ã€‚ç¼–è¯‘æ ‡ç­¾é€šè¿‡æ³¨é‡Šçš„æ–¹å¼åœ¨é è¿‘æºä»£ç æ–‡ä»¶é¡¶éƒ¨çš„åœ°æ–¹æ·»åŠ ã€‚go build åœ¨æ„å»ºä¸€ä¸ªåŒ…çš„æ—¶å€™ï¼Œä¼šè¯»å–è¿™ä¸ªåŒ…é‡Œçš„æ¯ä¸ªæºæ–‡ä»¶å¹¶ä¸”åˆ†æç¼–è¯‘ä¾¿ç­¾ï¼Œè¿™äº›æ ‡ç­¾å†³å®šäº†è¿™ä¸ªæºæ–‡ä»¶æ˜¯å¦å‚ä¸æœ¬æ¬¡ç¼–è¯‘ã€‚ä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// +build jsoniter</span>

<span class="token keyword">package</span> json

<span class="token keyword">import</span> jsoniter <span class="token string">"github.com/json-iterator/go"</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>+build jsoniter</code>å°±æ˜¯ç¼–è¯‘æ ‡ç­¾ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œä¸€ä¸ªæºæ–‡ä»¶å¯ä»¥æœ‰å¤šä¸ªç¼–è¯‘æ ‡ç­¾ï¼Œå¤šä¸ªç¼–è¯‘æ ‡ç­¾ä¹‹é—´æ˜¯é€»è¾‘â€œä¸â€çš„å…³ç³»ï¼›ä¸€ä¸ªç¼–è¯‘æ ‡ç­¾å¯ä»¥åŒ…æ‹¬ç”±ç©ºæ ¼åˆ†å‰²çš„å¤šä¸ªæ ‡ç­¾ï¼Œè¿™äº›æ ‡ç­¾æ˜¯é€»è¾‘â€œæˆ–â€çš„å…³ç³»ã€‚ä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// +build linux darwin</span>
<span class="token comment">// +build 386</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œè¦æ³¨æ„ï¼Œç¼–è¯‘æ ‡ç­¾å’ŒåŒ…çš„å£°æ˜ä¹‹é—´åº”è¯¥ä½¿ç”¨ç©ºè¡Œéš”å¼€ï¼Œå¦åˆ™ç¼–è¯‘æ ‡ç­¾ä¼šè¢«å½“ä½œåŒ…å£°æ˜çš„æ³¨é‡Šï¼Œè€Œä¸æ˜¯ç¼–è¯‘æ ‡ç­¾ã€‚</p>
<p>é‚£å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬æ˜¯å¦‚ä½•å®ç°æ’ä»¶åŒ–é€‰æ‹© JSON åº“çš„å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆï¼Œæˆ‘è‡ªå®šä¹‰äº†ä¸€ä¸ª <a href="https://github.com/marmotedu/component-base/tree/master/pkg/json" target="_blank" rel="noopener noreferrer">github.com/marmotedu/component-base/pkg/json<ExternalLinkIcon/></a> json åŒ…ï¼Œæ¥é€‚é… encoding/json å’Œ json-iteratorã€‚<code v-pre>github.com/marmotedu/component-base/pkg/json</code> åŒ…ä¸­æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼š</p>
<ul>
<li>**json.goï¼š**æ˜ å°„äº† encoding/json åŒ…çš„ Marshalã€Unmarshalã€MarshalIndentã€NewDecoderã€NewEncoder æ–¹æ³•ã€‚</li>
<li>**jsoniter.goï¼š**æ˜ å°„äº† github.com/json-iterator/go åŒ…çš„ Marshalã€Unmarshalã€MarshalIndentã€NewDecoderã€NewEncoderã€‚</li>
</ul>
<p>json.go å’Œ jsoniter.go é€šè¿‡ç¼–è¯‘æ ‡ç­¾ï¼Œè®© Go ç¼–è¯‘å™¨åœ¨æ„å»ºä»£ç æ—¶é€‰æ‹©ä½¿ç”¨å“ªä¸€ä¸ª json æ–‡ä»¶ã€‚</p>
<p>æ¥ç€ï¼Œé€šè¿‡åœ¨æ‰§è¡Œ <code v-pre>go build</code>æ—¶æŒ‡å®š <a href="https://github.com/marmotedu/iam/blob/master/scripts/make-rules/golang.mk#L19" target="_blank" rel="noopener noreferrer">-tags<ExternalLinkIcon/></a> å‚æ•°ï¼Œæ¥é€‰æ‹©ç¼–è¯‘å“ªä¸ª json æ–‡ä»¶ã€‚</p>
<p><code v-pre>json/json.go</code>ã€<code v-pre>json/jsoniter.go</code> è¿™ä¸¤ä¸ª Go æ–‡ä»¶çš„é¡¶éƒ¨ï¼Œéƒ½æœ‰ä¸€è¡Œæ³¨é‡Šï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// +build !jsoniter</span>

<span class="token comment">// +build jsoniter</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>// +build !jsoniter</code>è¡¨ç¤ºï¼Œtags ä¸æ˜¯ jsoniter çš„æ—¶å€™ç¼–è¯‘è¿™ä¸ª Go æ–‡ä»¶ã€‚<code v-pre>// +build jsoniter</code>è¡¨ç¤ºï¼Œtags æ˜¯ jsoniter çš„æ—¶å€™ç¼–è¯‘è¿™ä¸ª Go æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸¤ç§æ¡ä»¶æ˜¯äº’æ–¥çš„ï¼Œåªæœ‰å½“ tags=jsoniter çš„æ—¶å€™ï¼Œæ‰ä¼šä½¿ç”¨ <code v-pre>json-iterator</code>ï¼Œå…¶ä»–æƒ…å†µä½¿ç”¨ <code v-pre>encoding/json</code>ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨åŒ…ï¼Œå¯ä»¥è¿™ä¹ˆç¼–è¯‘é¡¹ç›®ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>$ <span class="token keyword">go</span> build <span class="token operator">-</span>tags<span class="token operator">=</span>jsoniter
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œ**æˆ‘ä»¬éœ€è¦æ ¹æ®åœºæ™¯æ¥é€‰æ‹©åˆé€‚çš„JSON åº“ã€‚**è¿™é‡Œæˆ‘ç»™ä½ ä¸€äº›å»ºè®®ã€‚</p>
<p>åœºæ™¯ä¸€ï¼šç»“æ„ä½“åºåˆ—åŒ–å’Œååºåˆ—åŒ–åœºæ™¯</p>
<p>åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘ä¸ªäººé¦–æ¨çš„æ˜¯å®˜æ–¹çš„ JSON åº“ã€‚å¯èƒ½ä½ ä¼šæ¯”è¾ƒæ„å¤–ï¼Œé‚£æˆ‘å°±æ¥è¯´è¯´æˆ‘çš„ç†ç”±ï¼š</p>
<p>é¦–å…ˆï¼Œè™½ç„¶ easyjson çš„æ€§èƒ½å‹å€’äº†å…¶ä»–æ‰€æœ‰å¼€æºé¡¹ç›®ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªæœ€å¤§çš„ç¼ºé™·ï¼Œé‚£å°±æ˜¯éœ€è¦é¢å¤–ä½¿ç”¨å·¥å…·æ¥ç”Ÿæˆè¿™æ®µä»£ç ï¼Œè€Œå¯¹é¢å¤–å·¥å…·çš„ç‰ˆæœ¬æ§åˆ¶å°±å¢åŠ äº†è¿ç»´æˆæœ¬ã€‚å½“ç„¶ï¼Œå¦‚æœä½ çš„å›¢é˜Ÿå·²ç»èƒ½å¤Ÿå¾ˆå¥½åœ°å¤„ç† protobuf äº†ï¼Œä¹Ÿæ˜¯å¯ä»¥ç”¨åŒæ ·çš„æ€è·¯æ¥ç®¡ç† easyjson çš„ã€‚</p>
<p>å…¶æ¬¡ï¼Œè™½ç„¶ Go 1.8 ä¹‹å‰ï¼Œå®˜æ–¹ JSON åº“çš„æ€§èƒ½æ€»æ˜¯è¢«å¤§å®¶åæ§½ï¼Œä½†ç°åœ¨ï¼ˆ1.16.3ï¼‰å®˜æ–¹ JSON åº“çš„æ€§èƒ½å·²ä¸å¯åŒæ—¥è€Œè¯­ã€‚æ­¤å¤–ï¼Œä½œä¸ºä½¿ç”¨æœ€ä¸ºå¹¿æ³›ï¼Œè€Œä¸”æ²¡æœ‰ä¹‹ä¸€çš„ JSON åº“ï¼Œå®˜æ–¹åº“çš„ bug æ˜¯æœ€å°‘çš„ï¼Œå…¼å®¹æ€§ä¹Ÿæ˜¯æœ€å¥½çš„</p>
<p>æœ€åï¼Œjsoniter çš„æ€§èƒ½è™½ç„¶ä¾ç„¶ä¼˜äºå®˜æ–¹ï¼Œä½†æ²¡æœ‰è¾¾åˆ°é€†å¤©çš„ç¨‹åº¦ã€‚å¦‚æœä½ è¿½æ±‚çš„æ˜¯æè‡´çš„æ€§èƒ½ï¼Œé‚£ä¹ˆä½ åº”è¯¥é€‰æ‹© easyjson è€Œä¸æ˜¯ jsoniterã€‚jsoniter è¿‘å¹´å·²ç»ä¸æ´»è·ƒäº†ï¼Œæ¯”å¦‚è¯´ï¼Œæˆ‘å‰æ®µæ—¶é—´æäº†ä¸€ä¸ª issue æ²¡äººå›å¤ï¼Œäºæ˜¯å°±ä¸Šå»çœ‹äº†ä¸‹ issue åˆ—è¡¨ï¼Œå‘ç°å±…ç„¶è¿˜é—ç•™ç€ä¸€äº› 2018 å¹´çš„ issueã€‚</p>
<p>åœºæ™¯äºŒï¼šéç»“æ„åŒ–æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–åœºæ™¯</p>
<p>è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬è¦åˆ†é«˜æ•°æ®åˆ©ç”¨ç‡å’Œä½æ•°æ®åˆ©ç”¨ç‡ä¸¤ç§æƒ…å†µæ¥çœ‹ã€‚ä½ å¯èƒ½å¯¹æ•°æ®åˆ©ç”¨ç‡çš„é«˜ä½æ²¡å•¥æ¦‚å¿µï¼Œé‚£æˆ‘ä¸¾ä¸ªä¾‹å­ï¼šJSON æ•°æ®çš„æ­£æ–‡ä¸­ï¼Œå¦‚æœè¯´è¶…è¿‡å››åˆ†ä¹‹ä¸€çš„æ•°æ®éƒ½æ˜¯ä¸šåŠ¡éœ€è¦å…³æ³¨å’Œå¤„ç†çš„ï¼Œé‚£å°±ç®—æ˜¯é«˜æ•°æ®åˆ©ç”¨ç‡ã€‚</p>
<p>åœ¨é«˜æ•°æ®åˆ©ç”¨ç‡çš„æƒ…å†µä¸‹ï¼Œæˆ‘æ¨èä½¿ç”¨ jsonvalueã€‚</p>
<p>è‡³äºä½æ•°æ®åˆ©ç”¨ç‡çš„æƒ…å†µï¼Œè¿˜å¯ä»¥æ ¹æ® **JSON æ•°æ®æ˜¯å¦éœ€è¦é‡æ–°åºåˆ—åŒ–ï¼Œ**åˆ†æˆä¸¤ç§æƒ…å†µã€‚</p>
<p>å¦‚æœæ— éœ€é‡æ–°åºåˆ—åŒ–ï¼Œè¿™ä¸ªæ—¶å€™é€‰æ‹© jsonparser å°±è¡Œäº†ï¼Œå› ä¸ºå®ƒçš„æ€§èƒ½å®åœ¨æ˜¯è€€çœ¼ã€‚</p>
<p>å¦‚æœéœ€è¦é‡æ–°åºåˆ—åŒ–ï¼Œè¿™ç§æƒ…å†µä¸‹ä½ æœ‰ä¸¤ç§é€‰æ‹©ï¼šå¦‚æœå¯¹æ€§èƒ½è¦æ±‚ç›¸å¯¹è¾ƒä½ï¼Œå¯ä»¥ä½¿ç”¨ jsonvalueï¼›å¦‚æœå¯¹æ€§èƒ½çš„è¦æ±‚é«˜ï¼Œå¹¶ä¸”åªéœ€è¦å¾€äºŒè¿›åˆ¶åºåˆ—ä¸­æ’å…¥ä¸€æ¡æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥é‡‡ç”¨ jsoniter çš„ Set æ–¹æ³•ã€‚</p>
<p>å®é™…æ“ä½œä¸­ï¼Œè¶…å¤§ JSON æ•°æ®é‡ï¼Œå¹¶ä¸”åŒæ—¶éœ€è¦é‡æ–°åºåˆ—åŒ–çš„æƒ…å†µéå¸¸å°‘ï¼Œå¾€å¾€æ˜¯åœ¨ä»£ç†æœåŠ¡å™¨ã€ç½‘å…³ã€overlay ä¸­ç»§æœåŠ¡ç­‰ï¼ŒåŒæ—¶åˆéœ€è¦å¾€åŸæ•°æ®ä¸­æ³¨å…¥é¢å¤–ä¿¡æ¯çš„æ—¶å€™ã€‚æ¢å¥è¯è¯´ï¼Œjsoniter çš„é€‚ç”¨åœºæ™¯æ¯”è¾ƒæœ‰é™ã€‚</p>
<p>ä¸‹é¢æ˜¯ä» 10%åˆ° 60%æ•°æ®è¦†ç›–ç‡ä¸‹ï¼Œä¸åŒåº“çš„æ“ä½œæ•ˆç‡å¯¹æ¯”ï¼ˆçºµåæ ‡å•ä½ï¼šÎ¼s/opï¼‰ï¼š</p>
<p><img src="https://static001.geekbang.org/resource/image/fc/a6/fcc79727a26a37345af705df1179c1a6.png?wh=1920x1266" alt="å›¾ç‰‡"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå½“ jsoniter çš„æ•°æ®åˆ©ç”¨ç‡è¾¾åˆ° 25% æ—¶ï¼Œå’Œ jsonvalueã€jsonparser ç›¸æ¯”å°±å·²ç»æ²¡æœ‰ä»»ä½•ä¼˜åŠ¿ï¼›è‡³äº jsonvalueï¼Œç”±äºå¯¹æ•°æ®åšäº†ä¸€æ¬¡æ€§çš„å…¨è§£æï¼Œå› æ­¤è§£æåçš„æ•°æ®å­˜å–è€—æ—¶æå°‘ï¼Œå› æ­¤åœ¨ä¸åŒæ•°æ®è¦†ç›–ç‡ä¸‹çš„è€—æ—¶éƒ½å¾ˆç¨³å®šã€‚</p>
<h3 id="è°ƒç”¨é“¾å®ç°" tabindex="-1"><a class="header-anchor" href="#è°ƒç”¨é“¾å®ç°" aria-hidden="true">#</a> è°ƒç”¨é“¾å®ç°</h3>
<p>è°ƒç”¨é“¾å¯¹æŸ¥æ—¥å¿—ã€æ’éšœå¸®åŠ©éå¸¸å¤§ã€‚æ‰€ä»¥ï¼Œåœ¨ iam-apiserver ä¸­ä¹Ÿå®ç°äº†è°ƒç”¨é“¾ï¼Œé€šè¿‡ <code v-pre>requestID</code>æ¥ä¸²è”æ•´ä¸ªè°ƒç”¨é“¾ã€‚</p>
<p>å…·ä½“æ˜¯é€šè¿‡ä»¥ä¸‹ä¸¤æ­¥æ¥å®ç°çš„ï¼š</p>
<p>ç¬¬ä¸€æ­¥ï¼Œå°† <code v-pre>ctx context.Context</code> ç±»å‹çš„å˜é‡ä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œåœ¨å‡½æ•°è°ƒç”¨æ—¶ä¼ é€’ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼Œä¸åŒå‡½æ•°ä¸­ï¼Œé€šè¿‡ <code v-pre>log.L(ctx context.Context)</code>æ¥è®°å½•æ—¥å¿—ã€‚</p>
<p>åœ¨è¯·æ±‚åˆ°æ¥æ—¶ï¼Œè¯·æ±‚ä¼šé€šè¿‡ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/middleware/context.go#L17" target="_blank" rel="noopener noreferrer">Context<ExternalLinkIcon/></a> ä¸­é—´ä»¶å¤„ç†ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>KeyRequestID<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>XRequestIDKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>KeyUsername<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>UsernameKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ Context ä¸­é—´ä»¶ä¸­ï¼Œä¼šåœ¨ gin.Context ç±»å‹çš„å˜é‡ä¸­è®¾ç½® <code v-pre>log.KeyRequestID</code>é”®ï¼Œå…¶å€¼ä¸º 36 ä½çš„ UUIDã€‚UUID é€šè¿‡ <a href="https://github.com/marmotedu/iam/blob/v1.0.4/internal/pkg/middleware/requestid.go#L22" target="_blank" rel="noopener noreferrer">RequestID<ExternalLinkIcon/></a> ä¸­é—´ä»¶æ¥ç”Ÿæˆï¼Œå¹¶è®¾ç½®åœ¨ gin è¯·æ±‚çš„ Context ä¸­ã€‚</p>
<p>RequestID ä¸­é—´ä»¶åœ¨ Context ä¸­é—´ä»¶ä¹‹å‰è¢«åŠ è½½ï¼Œæ‰€ä»¥åœ¨ Context ä¸­é—´ä»¶è¢«æ‰§è¡Œæ—¶ï¼Œèƒ½å¤Ÿè·å–åˆ° RequestID ç”Ÿæˆçš„ UUIDã€‚</p>
<p><code v-pre>log.L(ctx context.Context)</code>å‡½æ•°åœ¨è®°å½•æ—¥å¿—æ—¶ï¼Œä¼šä»å¤´ ctx ä¸­è·å–åˆ° <code v-pre>log.KeyRequestID</code>ï¼Œå¹¶ä½œä¸ºä¸€ä¸ªé™„åŠ å­—æ®µéšæ—¥å¿—æ‰“å°ã€‚</p>
<p>é€šè¿‡ä»¥ä¸Šæ–¹å¼ï¼Œæˆ‘ä»¬æœ€ç»ˆå¯ä»¥å½¢æˆ iam-apiserver çš„è¯·æ±‚è°ƒç”¨é“¾ï¼Œæ—¥å¿—ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token number">2021</span>-07-19 <span class="token number">19</span>:41:33.472 INFO    apiserver       apiserver/auth.go:205   user <span class="token variable"><span class="token variable">`</span>admin<span class="token variable">`</span></span> is authenticated.  <span class="token punctuation">{</span><span class="token string">"requestID"</span><span class="token builtin class-name">:</span> <span class="token string">"b6c56cd3-d095-4fd5-a928-291a2e33077f"</span>, <span class="token string">"username"</span><span class="token builtin class-name">:</span> <span class="token string">"admin"</span><span class="token punctuation">}</span>
<span class="token number">2021</span>-07-19 <span class="token number">19</span>:41:33.472 INFO    apiserver       policy/create.go:22     create policy <span class="token keyword">function</span> called.  <span class="token punctuation">{</span><span class="token string">"requestID"</span><span class="token builtin class-name">:</span> <span class="token string">"b6c56cd3-d095-4fd5-a928-291a2e33077f"</span>, <span class="token string">"username"</span><span class="token builtin class-name">:</span> <span class="token string">"admin"</span><span class="token punctuation">}</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦å¤–ï¼Œ<code v-pre>ctx context.Context</code>ä½œä¸ºå‡½æ•°/æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯æ–¹ä¾¿åæœŸæ‰©å±•ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä»¥ä¸‹è°ƒç”¨å…³ç³»ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">B</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"name: %s, address: %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> address<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">B</span><span class="token punctuation">(</span><span class="token string">"colin"</span><span class="token punctuation">,</span> <span class="token string">"sz"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç æœ€ç»ˆè°ƒç”¨ <code v-pre>B</code>å‡½æ•°æ‰“å°å‡ºç”¨æˆ·ååŠå…¶åœ°å€ã€‚å¦‚æœéšç€ä¸šåŠ¡çš„å‘å±•ï¼Œå¸Œæœ› A è°ƒç”¨ B æ—¶ï¼Œä¼ å…¥ç”¨æˆ·çš„ç”µè¯ï¼ŒB ä¸­æ‰“å°å‡ºç”¨æˆ·çš„ç”µè¯å·ç ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè€ƒè™‘ç»™ B å‡½æ•°å¢åŠ ä¸€ä¸ªç”µè¯å·å‚æ•°ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">B</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> address<span class="token punctuation">,</span> phone <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"name: %s, address: %s, phone: %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> address<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæˆ‘ä»¬åé¢è¿˜è¦å¢åŠ å¹´é¾„ã€æ€§åˆ«ç­‰å±æ€§å‘¢ï¼ŸæŒ‰è¿™ç§æ–¹å¼ä¸æ–­å¢åŠ  B å‡½æ•°çš„å‚æ•°ï¼Œä¸ä»…éº»çƒ¦ï¼Œè€Œä¸”è¿˜è¦æ”¹åŠ¨æ‰€æœ‰è°ƒç”¨ B çš„å‡½æ•°ï¼Œå·¥ä½œé‡ä¹Ÿå¾ˆå¤§ã€‚è¿™æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡ <code v-pre>ctx context.Context</code> æ¥ä¼ é€’è¿™äº›æ‰©å±•å‚æ•°ï¼Œå®ç°å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">B</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"name: %s, address: %s, phone: %v"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> address<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"phone"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"phone"</span><span class="token punctuation">,</span> <span class="token string">"1812884xxxx"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">B</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"colin"</span><span class="token punctuation">,</span> <span class="token string">"sz"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·ï¼Œæˆ‘ä»¬ä¸‹æ¬¡éœ€è¦æ–°å¢å‚æ•°çš„è¯ï¼Œåªéœ€è¦è°ƒç”¨ context çš„ WithValue æ–¹æ³•ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"sex"</span><span class="token punctuation">,</span> <span class="token string">"male"</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åœ¨ B å‡½æ•°ä¸­ï¼Œé€šè¿‡ <code v-pre>context.Context</code> ç±»å‹çš„å˜é‡æä¾›çš„ <code v-pre>Value</code> æ–¹æ³•ï¼Œä» context ä¸­è·å– <code v-pre>sex</code> key å³å¯ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"name: %s, address: %s, phone: %v, sex: %v"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> address<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"phone"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"sex"</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="æ•°æ®ä¸€è‡´æ€§" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ä¸€è‡´æ€§" aria-hidden="true">#</a> æ•°æ®ä¸€è‡´æ€§</h3>
<p>ä¸ºäº†æé«˜ iam-authz-server çš„å“åº”æ€§èƒ½ï¼Œæˆ‘å°†å¯†é’¥å’Œæˆæƒç­–ç•¥ä¿¡æ¯ç¼“å­˜åœ¨ iam-authz-server éƒ¨ç½²æœºå™¨çš„å†…å­˜ä¸­ã€‚åŒæ—¶ï¼Œä¸ºäº†å®ç°é«˜å¯ç”¨ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯ iam-authz-server å¯åŠ¨çš„å®ä¾‹ä¸ªæ•°è‡³å°‘ä¸ºä¸¤ä¸ªã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šé¢ä¸´æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼šæ‰€æœ‰ iam-authz-server ç¼“å­˜çš„æ•°æ®è¦ä¸€è‡´ï¼Œå¹¶ä¸”è·Ÿ iam-apiserver æ•°æ®åº“ä¸­ä¿å­˜çš„ä¸€è‡´ã€‚iam-apiserver é€šè¿‡å¦‚ä¸‹æ–¹å¼æ¥å®ç°æ•°æ®ä¸€è‡´æ€§ï¼š</p>
<p><img src="http://sm.nsddd.top/sm202302282227080.jpeg" alt="img"></p>
<p><strong>å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</strong></p>
<p>ç¬¬ä¸€æ­¥ï¼Œiam-authz-server å¯åŠ¨æ—¶ï¼Œä¼šé€šè¿‡ grpc è°ƒç”¨ iam-apiserver çš„ GetSecrets å’Œ GetPolicies æ¥å£ï¼Œè·å–æ‰€æœ‰çš„å¯†é’¥å’Œæˆæƒç­–ç•¥ä¿¡æ¯ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼Œå½“æˆ‘ä»¬é€šè¿‡æ§åˆ¶å°è°ƒç”¨ iam-apiserver å¯†é’¥/æˆæƒç­–ç•¥çš„å†™æ¥å£ï¼ˆPOSTã€PUTã€DELETEï¼‰æ—¶ï¼Œä¼šå‘ Redis çš„ <code v-pre>iam.cluster.notifications</code>é€šé“å‘é€ SecretChanged/PolicyChanged æ¶ˆæ¯ã€‚</p>
<p>ç¬¬ä¸‰æ­¥ï¼Œiam-authz-server ä¼šè®¢é˜… <code v-pre>iam.cluster.notifications</code>é€šé“ï¼Œå½“ç›‘å¬åˆ°æœ‰ SecretChanged/PolicyChanged æ¶ˆæ¯æ—¶ï¼Œä¼šè¯·æ±‚ iam-apiserver æ‹‰å–æ‰€æœ‰çš„å¯†é’¥/æˆæƒç­–ç•¥ã€‚</p>
<p>é€šè¿‡ Redis çš„ Sub/Pub æœºåˆ¶ï¼Œä¿è¯æ¯ä¸ª iam-authz-server èŠ‚ç‚¹çš„ç¼“å­˜æ•°æ®è·Ÿ iam-apiserver æ•°æ®åº“ä¸­ä¿å­˜çš„æ•°æ®ä¸€è‡´ã€‚æ‰€æœ‰èŠ‚ç‚¹éƒ½è°ƒç”¨ iam-apiserver çš„åŒä¸€ä¸ªæ¥å£æ¥æ‹‰å–æ•°æ®ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ä¿è¯æ‰€æœ‰ iam-authz-server èŠ‚ç‚¹çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚</p>
<h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2>
<p>ä»Šå¤©ï¼Œæˆ‘å’Œä½ åˆ†äº«äº† iam-apiserver çš„ä¸€äº›å…³é”®åŠŸèƒ½å®ç°ï¼Œå¹¶ä»‹ç»äº†æˆ‘çš„è®¾è®¡æ€è·¯ã€‚è¿™é‡Œæˆ‘å†ç®€è¦æ¢³ç†ä¸‹ã€‚</p>
<ul>
<li>ä¸ºäº†ä¿è¯è¿›ç¨‹å…³åœæ—¶ï¼ŒHTTP è¯·æ±‚æ‰§è¡Œå®Œåå†æ–­å¼€è¿æ¥ï¼Œè¿›ç¨‹ä¸­çš„ä»»åŠ¡æ­£å¸¸å®Œæˆï¼Œiam-apiserver å®ç°äº†ä¼˜é›…å…³åœåŠŸèƒ½ã€‚</li>
<li>ä¸ºäº†é¿å…è¿›ç¨‹å­˜åœ¨ï¼Œä½†æœåŠ¡æ²¡æˆåŠŸå¯åŠ¨çš„å¼‚å¸¸åœºæ™¯ï¼Œiam-apiserver å®ç°äº†å¥åº·æ£€æŸ¥æœºåˆ¶ã€‚</li>
<li>Gin ä¸­é—´ä»¶å¯é€šè¿‡é…ç½®æ–‡ä»¶é…ç½®ï¼Œä»è€Œå®ç°æŒ‰éœ€åŠ è½½çš„ç‰¹æ€§ã€‚</li>
<li>ä¸ºäº†èƒ½å¤Ÿç›´æ¥è¾¨åˆ«å‡º API çš„ç‰ˆæœ¬ï¼Œiam-apiserver å°† API çš„ç‰ˆæœ¬æ ‡è¯†æ”¾åœ¨ URL è·¯å¾„ä¸­ï¼Œä¾‹å¦‚ <code v-pre>/v1/secrets</code>ã€‚</li>
<li>ä¸ºäº†èƒ½å¤Ÿæœ€å¤§åŒ–åœ°å…±äº«åŠŸèƒ½ä»£ç ï¼Œiam-apiserver æŠ½è±¡å‡ºäº†ç»Ÿä¸€çš„å…ƒæ•°æ®ï¼Œæ¯ä¸ª REST èµ„æºéƒ½å…·æœ‰è¿™äº›å…ƒæ•°æ®ã€‚</li>
<li>å› ä¸º API æ¥å£éƒ½æ˜¯é€šè¿‡åŒä¸€ä¸ªå‡½æ•°æ¥è¿”å›çš„ï¼Œå…¶è¿”å›æ ¼å¼è‡ªç„¶æ˜¯ç»Ÿä¸€çš„ã€‚</li>
<li>å› ä¸ºç¨‹åºä¸­ç»å¸¸éœ€è¦å¤„ç†å¹¶å‘é€»è¾‘ï¼Œiam-apiserver æŠ½è±¡å‡ºäº†ä¸€ä¸ªé€šç”¨çš„å¹¶å‘æ¨¡æ¿ã€‚</li>
<li>ä¸ºäº†æ–¹ä¾¿æ ¹æ®éœ€è¦åˆ‡æ¢ JSON åº“ï¼Œæˆ‘ä»¬å®ç°äº†æ’ä»¶åŒ–é€‰æ‹© JSON åº“çš„åŠŸèƒ½ã€‚</li>
<li>ä¸ºäº†å®ç°è°ƒç”¨é“¾åŠŸèƒ½ï¼Œiam-apiserver ä¸åŒå‡½æ•°ä¹‹é—´é€šè¿‡ <code v-pre>ctx context.Context</code> æ¥ä¼ é€’ RequestIDã€‚</li>
<li>iam-apiserver é€šè¿‡ Redis çš„ Sub/Pub æœºåˆ¶æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚</li>
</ul>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '20.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '22.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/projects/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


