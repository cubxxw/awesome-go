+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬7èŠ‚ é«˜è´¨é‡çš„Makefile

<br>

<div><a href = '6.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '8.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]

[TOC]

## ä½è´¨é‡çš„makefile

ä½è´¨é‡çš„ Makefile æ–‡ä»¶æ˜¯ä»€ä¹ˆæ ·çš„;

```makefile

build: clean vet
  @mkdir -p ./Role
  @export GOOS=linux && go build -v .

vet:
  go vet ./...

fmt:
  go fmt ./...

clean:
  rm -rf dashboard
```

ä¸Šé¢è¿™ä¸ª Makefile å­˜åœ¨ä¸å°‘é—®é¢˜ã€‚ä¾‹å¦‚ï¼šåŠŸèƒ½ç®€å•ï¼Œåªèƒ½å®Œæˆæœ€åŸºæœ¬çš„ç¼–è¯‘ã€æ ¼å¼åŒ–ç­‰æ“ä½œï¼Œåƒæ„å»ºé•œåƒã€è‡ªåŠ¨ç”Ÿæˆä»£ç ç­‰ä¸€äº›é«˜é˜¶çš„åŠŸèƒ½éƒ½æ²¡æœ‰ï¼›æ‰©å±•æ€§å·®ï¼Œæ²¡æ³•ç¼–è¯‘å‡ºå¯åœ¨ Mac ä¸‹è¿è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼›æ²¡æœ‰ Help åŠŸèƒ½ï¼Œä½¿ç”¨éš¾åº¦é«˜ï¼›å• Makefile æ–‡ä»¶ï¼Œç»“æ„å•ä¸€ï¼Œä¸é€‚åˆæ·»åŠ ä¸€äº›å¤æ‚çš„ç®¡ç†åŠŸèƒ½ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸å…‰è¦ç¼–å†™ Makefileï¼Œè¿˜è¦ç¼–å†™é«˜è´¨é‡çš„ Makefileã€‚é‚£ä¹ˆå¦‚ä½•ç¼–å†™ä¸€ä¸ªé«˜è´¨é‡çš„ Makefile å‘¢ï¼Ÿæˆ‘è§‰å¾—ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ 4 ä¸ªæ–¹æ³•æ¥å®ç°ï¼š

+ æ‰“å¥½åŸºç¡€ï¼Œä¹Ÿå°±æ˜¯ç†Ÿç»ƒæŒæ¡ Makefile çš„è¯­æ³•ã€‚
+ åšå¥½å‡†å¤‡å·¥ä½œï¼Œä¹Ÿå°±æ˜¯æå‰è§„åˆ’ Makefile è¦å®ç°çš„åŠŸèƒ½ã€‚
+ è¿›è¡Œè§„åˆ’ï¼Œè®¾è®¡ä¸€ä¸ªåˆç†çš„ Makefile ç»“æ„ã€‚
+ æŒæ¡æ–¹æ³•ï¼Œç”¨å¥½ Makefile çš„ç¼–å†™æŠ€å·§ã€‚



## ç†Ÿç»ƒmakefileè¯­æ³•

**IAM é¡¹ç›®çš„ Makefile æ–‡ä»¶ï¼š**

```bash

$ make help

Usage: make <TARGETS> <OPTIONS> ...

Targets:
  # ä»£ç ç”Ÿæˆç±»å‘½ä»¤
  gen                Generate all necessary files, such as error code files.

  # æ ¼å¼åŒ–ç±»å‘½ä»¤
  format             Gofmt (reformat) package sources (exclude vendor dir if existed).

  # é™æ€ä»£ç æ£€æŸ¥
  lint               Check syntax and styling of go sources.

  # æµ‹è¯•ç±»å‘½ä»¤
  test               Run unit test.
  cover              Run unit test and get test coverage.

  # æ„å»ºç±»å‘½ä»¤
  build              Build source code for host platform.
  build.multiarch    Build source code for multiple platforms. See option PLATFORMS.

  # Dockeré•œåƒæ‰“åŒ…ç±»å‘½ä»¤
  image              Build docker images for host arch.
  image.multiarch    Build docker images for multiple platforms. See option PLATFORMS.
  push               Build docker images for host arch and push images to registry.
  push.multiarch     Build docker images for multiple platforms and push images to registry.

  # éƒ¨ç½²ç±»å‘½ä»¤
  deploy             Deploy updated components to development env.

  # æ¸…ç†ç±»å‘½ä»¤
  clean              Remove all files that are created by building.

  # å…¶ä»–å‘½ä»¤ï¼Œä¸åŒé¡¹ç›®ä¼šæœ‰åŒºåˆ«
  release            Release iam
  verify-copyright   Verify the boilerplate headers for all files.
  ca                 Generate CA files for all iam components.
  install            Install iam system with all its components.
  swagger            Generate swagger document.
  tools              install dependent tools.

  # å¸®åŠ©å‘½ä»¤
  help               Show this help info.

# é€‰é¡¹
Options:
  DEBUG        Whether to generate debug symbols. Default is 0.
  BINS         The binaries to build. Default is all of cmd.
               This option is available when using: make build/build.multiarch
               Example: make build BINS="iam-apiserver iam-authz-server"
  ...
```

é€šå¸¸è€Œè¨€ï¼ŒGo é¡¹ç›®çš„ Makefile åº”è¯¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼šæ ¼å¼åŒ–ä»£ç ã€é™æ€ä»£ç æ£€æŸ¥ã€å•å…ƒæµ‹è¯•ã€ä»£ç æ„å»ºã€æ–‡ä»¶æ¸…ç†ã€å¸®åŠ©ç­‰ç­‰ã€‚å¦‚æœé€šè¿‡ docker éƒ¨ç½²ï¼Œè¿˜éœ€è¦æœ‰ docker é•œåƒæ‰“åŒ…åŠŸèƒ½ã€‚å› ä¸º Go æ˜¯è·¨å¹³å°çš„è¯­è¨€ï¼Œæ‰€ä»¥æ„å»ºå’Œ docker æ‰“åŒ…å‘½ä»¤ï¼Œè¿˜è¦èƒ½å¤Ÿæ”¯æŒä¸åŒçš„ CPU æ¶æ„å’Œå¹³å°ã€‚ä¸ºäº†èƒ½å¤Ÿæ›´å¥½åœ°æ§åˆ¶ Makefile å‘½ä»¤çš„è¡Œä¸ºï¼Œè¿˜éœ€è¦æ”¯æŒ Optionsã€‚

**ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹ Makefile é›†æˆäº†å“ªäº›åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦æ”¯æŒ help å‘½ä»¤ã€‚help å‘½ä»¤æœ€å¥½é€šè¿‡è§£æ Makefile æ–‡ä»¶æ¥è¾“å‡ºé›†æˆçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š**

```bash
## help: Show this help info.
.PHONY: help
help: Makefile
  @echo -e "\nUsage: make <TARGETS> <OPTIONS> ...\n\nTargets:"
  @sed -n 's/^##//p' $< | column -t -s ':' | sed -e 's/^/ /'
  @echo "$$USAGE_OPTIONS"
```

ä¸Šé¢çš„ help å‘½ä»¤ï¼Œé€šè¿‡è§£æ Makefile æ–‡ä»¶ä¸­çš„ `##` æ³¨é‡Šï¼Œè·å–æ”¯æŒçš„å‘½ä»¤ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬ä»¥åæ–°åŠ å‘½ä»¤æ—¶ï¼Œå°±ä¸ç”¨å†å¯¹ help å‘½ä»¤è¿›è¡Œä¿®æ”¹äº†ã€‚



## è®¾è®¡Makefileç»“æ„

å¯¹äºå¤§å‹é¡¹ç›®æ¥è¯´ï¼Œéœ€è¦ç®¡ç†çš„å†…å®¹å¾ˆå¤šï¼Œæ‰€æœ‰ç®¡ç†åŠŸèƒ½éƒ½é›†æˆåœ¨ä¸€ä¸ª Makefile ä¸­ï¼Œå¯èƒ½ä¼šå¯¼è‡´ Makefile å¾ˆå¤§ï¼Œéš¾ä»¥é˜…è¯»å’Œç»´æŠ¤ï¼Œæ‰€ä»¥å»ºè®®é‡‡ç”¨åˆ†å±‚çš„è®¾è®¡æ–¹æ³•ï¼Œ**æ ¹ç›®å½•ä¸‹çš„ Makefile èšåˆæ‰€æœ‰çš„ Makefile å‘½ä»¤ï¼Œå…·ä½“å®ç°åˆ™æŒ‰åŠŸèƒ½åˆ†ç±»ï¼Œæ”¾åœ¨å¦å¤–çš„ Makefile ä¸­ã€‚**

æˆ‘ä»¬ç»å¸¸ä¼šåœ¨ Makefile å‘½ä»¤ä¸­é›†æˆ shell è„šæœ¬ï¼Œä½†å¦‚æœ shell è„šæœ¬è¿‡äºå¤æ‚ï¼Œä¹Ÿä¼šå¯¼è‡´ Makefile å†…å®¹è¿‡å¤šï¼Œéš¾ä»¥é˜…è¯»å’Œç»´æŠ¤ã€‚å¹¶ä¸”åœ¨ Makefile ä¸­é›†æˆå¤æ‚çš„ shell è„šæœ¬ï¼Œç¼–å†™ä½“éªŒä¹Ÿå¾ˆå·®ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œ**å¯ä»¥å°†å¤æ‚çš„ shell å‘½ä»¤å°è£…åœ¨ shell è„šæœ¬ä¸­ï¼Œä¾› Makefile ç›´æ¥è°ƒç”¨ï¼Œè€Œä¸€äº›ç®€å•çš„å‘½ä»¤åˆ™å¯ä»¥ç›´æ¥é›†æˆåœ¨ Makefile ä¸­ã€‚**

**æ¨èçš„ Makefile ç»“æ„ï¼š**

![image-20230219153332640](https://sm.nsddd.top/sm202302191533699.png)



åœ¨ä¸Šé¢çš„ Makefile ç»„ç»‡æ–¹å¼ä¸­ï¼Œæ ¹ç›®å½•ä¸‹çš„ Makefile èšåˆäº†é¡¹ç›®æ‰€æœ‰çš„ç®¡ç†åŠŸèƒ½ï¼Œè¿™äº›ç®¡ç†åŠŸèƒ½é€šè¿‡ Makefile ä¼ªç›®æ ‡çš„æ–¹å¼å®ç°ã€‚åŒæ—¶ï¼Œè¿˜å°†è¿™äº›ä¼ªç›®æ ‡è¿›è¡Œåˆ†ç±»ï¼ŒæŠŠç›¸åŒç±»åˆ«çš„ä¼ªç›®æ ‡æ”¾åœ¨åŒä¸€ä¸ª Makefile ä¸­ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾— Makefile æ›´å®¹æ˜“ç»´æŠ¤ã€‚å¯¹äºå¤æ‚çš„å‘½ä»¤ï¼Œåˆ™ç¼–å†™æˆç‹¬ç«‹çš„ shell è„šæœ¬ï¼Œå¹¶åœ¨ Makefile å‘½ä»¤ä¸­è°ƒç”¨è¿™äº› shell è„šæœ¬ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢æ˜¯ IAM é¡¹ç›®çš„ Makefile ç»„ç»‡ç»“æ„ï¼š

```bash

â”œâ”€â”€ Makefile
â”œâ”€â”€ scripts
â”‚   â”œâ”€â”€ gendoc.sh
â”‚   â”œâ”€â”€ make-rules
â”‚   â”‚   â”œâ”€â”€ gen.mk
â”‚   â”‚   â”œâ”€â”€ golang.mk
â”‚   â”‚   â”œâ”€â”€ image.mk
â”‚   â”‚   â””â”€â”€ ...
    â””â”€â”€ ...
â”œâ”€â”€ Makefile
â”œâ”€â”€ scripts
â”‚   â”œâ”€â”€ gendoc.sh
â”‚   â”œâ”€â”€ make-rules
â”‚   â”‚   â”œâ”€â”€ gen.mk
â”‚   â”‚   â”œâ”€â”€ golang.mk
â”‚   â”‚   â”œâ”€â”€ image.mk
â”‚   â”‚   â””â”€â”€ ...
    â””â”€â”€ ...
```

æˆ‘ä»¬å°†ç›¸åŒç±»åˆ«çš„æ“ä½œç»Ÿä¸€æ”¾åœ¨ `scripts/make-rules` ç›®å½•ä¸‹çš„ Makefile æ–‡ä»¶ä¸­ã€‚**Makefile çš„æ–‡ä»¶åå‚è€ƒåˆ†ç±»å‘½å**ï¼Œä¾‹å¦‚ `golang.mk`ã€‚æœ€åï¼Œåœ¨ `/Makefile` ä¸­ include è¿™äº› Makefileã€‚

ä¸ºäº†è·Ÿ Makefile çš„å±‚çº§ç›¸åŒ¹é…ï¼Œ`golang.mk` ä¸­çš„æ‰€æœ‰ç›®æ ‡éƒ½æŒ‰`go.xxx`è¿™ç§æ–¹å¼å‘½åã€‚é€šè¿‡è¿™ç§å‘½åæ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åˆ†è¾¨å‡ºæŸä¸ªç›®æ ‡å®Œæˆä»€ä¹ˆåŠŸèƒ½ï¼Œæ”¾åœ¨ä»€ä¹ˆæ–‡ä»¶é‡Œï¼Œè¿™åœ¨å¤æ‚çš„ Makefile ä¸­å°¤å…¶æœ‰ç”¨ã€‚ä»¥ä¸‹æ˜¯ IAM é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼ŒMakefile çš„å†…å®¹æ‘˜å½•ï¼Œä½ å¯ä»¥çœ‹ä¸€çœ‹ï¼Œä½œä¸ºå‚è€ƒï¼š

```makefile
include scripts/make-rules/golang.mk
include scripts/make-rules/image.mk
include scripts/make-rules/gen.mk
include scripts/make-rules/...

## build: Build source code for host platform.
.PHONY: build
build:
  @$(MAKE) go.build

## build.multiarch: Build source code for multiple platforms. See option PLATFORMS.
.PHONY: build.multiarch
build.multiarch:
  @$(MAKE) go.build.multiarch

## image: Build docker images for host arch.
.PHONY: image
image:
  @$(MAKE) image.build

## push: Build docker images for host arch and push images to registry.
.PHONY: push
push:
  @$(MAKE) image.push

## ca: Generate CA files for all iam components.
.PHONY: ca
ca:
  @$(MAKE) gen.ca
```

å¦å¤–ï¼Œä¸€ä¸ªåˆç†çš„ Makefile ç»“æ„åº”è¯¥å…·æœ‰å‰ç»æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦åœ¨ä¸æ”¹å˜ç°æœ‰ç»“æ„çš„æƒ…å†µä¸‹ï¼Œæ¥çº³åé¢çš„æ–°åŠŸèƒ½ã€‚è¿™å°±éœ€è¦ä½ æ•´ç†å¥½ Makefile å½“å‰è¦å®ç°çš„åŠŸèƒ½ã€å³å°†è¦å®ç°çš„åŠŸèƒ½å’Œæœªæ¥å¯èƒ½ä¼šå®ç°çš„åŠŸèƒ½ï¼Œç„¶ååŸºäºè¿™äº›åŠŸèƒ½ï¼Œåˆ©ç”¨ Makefile ç¼–ç¨‹æŠ€å·§ï¼Œç¼–å†™å¯æ‰©å±•çš„ Makefileã€‚

è¿™é‡Œéœ€è¦ä½ æ³¨æ„ï¼šä¸Šé¢çš„ Makefile é€šè¿‡ `.PHONY` æ ‡è¯†å®šä¹‰äº†å¤§é‡çš„ä¼ªç›®æ ‡ï¼Œå®šä¹‰ä¼ªç›®æ ‡ä¸€å®šè¦åŠ  `.PHONY` æ ‡è¯†ï¼Œå¦åˆ™å½“æœ‰åŒåçš„æ–‡ä»¶æ—¶ï¼Œä¼ªç›®æ ‡å¯èƒ½ä¸ä¼šè¢«æ‰§è¡Œã€‚



## æŒæ¡ Makefile ç¼–å†™æŠ€å·§

### æŠ€å·§ 1ï¼šå–„ç”¨é€šé…ç¬¦å’Œè‡ªåŠ¨å˜é‡

Makefile å…è®¸å¯¹ç›®æ ‡è¿›è¡Œç±»ä¼¼æ­£åˆ™è¿ç®—çš„åŒ¹é…ï¼Œä¸»è¦ç”¨åˆ°çš„é€šé…ç¬¦æ˜¯%ã€‚é€šè¿‡ä½¿ç”¨é€šé…ç¬¦ï¼Œå¯ä»¥ä½¿ä¸åŒçš„ç›®æ ‡ä½¿ç”¨ç›¸åŒçš„è§„åˆ™ï¼Œä»è€Œä½¿ Makefile æ‰©å±•æ€§æ›´å¼ºï¼Œä¹Ÿæ›´ç®€æ´ã€‚

æˆ‘ä»¬çš„ IAM å®æˆ˜é¡¹ç›®ä¸­ï¼Œå°±å¤§é‡ä½¿ç”¨äº†é€šé…ç¬¦`%`ï¼Œä¾‹å¦‚ï¼š`go.build.%`ã€`ca.gen.%`ã€`deploy.run.%`ã€`tools.verify.%`ã€`tools.install.%`ç­‰ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œ`tools.verify.%`ï¼ˆä½äº`scripts/make-rules/tools.mk`æ–‡ä»¶ä¸­ï¼‰å®šä¹‰å¦‚ä¸‹ï¼š

```makefile
tools.verify.%:
  @if ! which $* &>/dev/null; then $(MAKE) tools.install.$*; fi
```

`make tools.verify.swagger`, `make tools.verify.mockgen`ç­‰å‡å¯ä»¥ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„è§„åˆ™ï¼Œ%åˆ†åˆ«ä»£è¡¨äº†`swagger`å’Œ`mockgen`ã€‚

å¦‚æœä¸ä½¿ç”¨%ï¼Œåˆ™æˆ‘ä»¬éœ€è¦åˆ†åˆ«ä¸ºtools.verify.swaggerå’Œtools.verify.mockgenå®šä¹‰è§„åˆ™ï¼Œå¾ˆéº»çƒ¦ï¼Œåé¢ä¿®æ”¹ä¹Ÿå›°éš¾ã€‚

å¦å¤–ï¼Œè¿™é‡Œä¹Ÿèƒ½çœ‹å‡º`tools.verify.%`è¿™ç§å‘½åæ–¹å¼çš„å¥½å¤„ï¼štools è¯´æ˜ä¾èµ–çš„å®šä¹‰ä½äº`scripts/make-rules/tools.mk` Makefile ä¸­ï¼›verifyè¯´æ˜`tools.verify.%`ä¼ªç›®æ ‡å±äº verify åˆ†ç±»ï¼Œä¸»è¦ç”¨æ¥éªŒè¯å·¥å…·æ˜¯å¦å®‰è£…ã€‚é€šè¿‡è¿™ç§å‘½åæ–¹å¼ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°çŸ¥é“ç›®æ ‡ä½äºå“ªä¸ª Makefile æ–‡ä»¶ä¸­ï¼Œä»¥åŠæƒ³è¦å®Œæˆçš„åŠŸèƒ½ã€‚

å¦å¤–ï¼Œä¸Šé¢çš„å®šä¹‰ä¸­è¿˜ç”¨åˆ°äº†è‡ªåŠ¨å˜é‡`$*`ï¼Œç”¨æ¥æŒ‡ä»£è¢«åŒ¹é…çš„å€¼`swagger`ã€`mockgen`ã€‚



### æŠ€å·§ 2ï¼šå–„ç”¨å‡½æ•°

Makefile è‡ªå¸¦çš„å‡½æ•°èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å®ç°å¾ˆå¤šå¼ºå¤§çš„åŠŸèƒ½ã€‚æ‰€ä»¥ï¼Œåœ¨æˆ‘ä»¬ç¼–å†™ Makefile çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰åŠŸèƒ½éœ€æ±‚ï¼Œå¯ä»¥ä¼˜å…ˆä½¿ç”¨è¿™äº›å‡½æ•°ã€‚æˆ‘æŠŠå¸¸ç”¨çš„å‡½æ•°ä»¥åŠå®ƒä»¬å®ç°çš„åŠŸèƒ½æ•´ç†åœ¨äº† [Makefile](https://github.com/marmotedu/geekbang-go/blob/master/makefile/Makefile%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0%E5%88%97%E8%A1%A8.md) å¸¸ç”¨å‡½æ•°åˆ—è¡¨ ä¸­ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹ã€‚

IAM çš„ Makefile æ–‡ä»¶ä¸­å¤§é‡ä½¿ç”¨äº†ä¸Šè¿°å‡½æ•°ï¼Œå¦‚æœä½ æƒ³æŸ¥çœ‹è¿™äº›å‡½æ•°çš„å…·ä½“ä½¿ç”¨æ–¹æ³•å’Œåœºæ™¯ï¼Œå¯ä»¥å‚è€ƒ IAM é¡¹ç›®çš„ Makefile æ–‡ä»¶ make-rulesã€‚

| å‡½æ•°å                      | åŠŸèƒ½æè¿°                                                     |
| --------------------------- | ------------------------------------------------------------ |
| $(origin )                  | å‘Šè¯‰å˜é‡çš„â€œå‡ºç”Ÿæƒ…å†µâ€ï¼Œæœ‰å¦‚ä¸‹è¿”å›å€¼ï¼š undefinedï¼š ä»æ¥æ²¡æœ‰å®šä¹‰è¿‡defaultï¼š æ˜¯ä¸€ä¸ªé»˜è®¤çš„å®šä¹‰environmentï¼š æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡fileï¼š è¿™ä¸ªå˜é‡è¢«å®šä¹‰åœ¨ Makefileä¸­command lineï¼š è¿™ä¸ªå˜é‡æ˜¯è¢«å‘½ä»¤è¡Œå®šä¹‰çš„overrideï¼š æ˜¯è¢« override æŒ‡ç¤ºç¬¦é‡æ–°å®šä¹‰çš„automaticï¼š æ˜¯ä¸€ä¸ªå‘½ä»¤è¿è¡Œä¸­çš„è‡ªåŠ¨åŒ–å˜é‡ |
| $(addsuffix ,<names...>)    | æŠŠåç¼€åŠ åˆ°ä¸­çš„æ¯ä¸ªå•è¯åé¢ï¼Œå¹¶è¿”å›åŠ è¿‡åç¼€çš„æ–‡ä»¶ååºåˆ—ã€‚     |
| $(addprefix ,<names...>)    | æŠŠå‰ç¼€åŠ åˆ°ä¸­çš„æ¯ä¸ªå•è¯å‰é¢ï¼Œå¹¶è¿”å›åŠ è¿‡å‰ç¼€çš„æ–‡ä»¶ååºåˆ—ã€‚     |
| $(wildcard )                | æ‰©å±•é€šé…ç¬¦ï¼Œä¾‹å¦‚ï¼š(wildcard{ROOT_DIR}/build/docker/*)        |
| $(word ,)                   | å–å­—ç¬¦ä¸²ä¸­ç¬¬ä¸ªå•è¯ï¼ˆä»ä¸€å¼€å§‹ï¼‰ï¼Œå¹¶è¿”å›å­—ç¬¦ä¸²ä¸­ç¬¬ä¸ªå•è¯ã€‚å¦‚ æ¯”ä¸­çš„å•è¯æ•°è¦å¤§ï¼Œé‚£ä¹ˆè¿”å›ç©ºå­—ç¬¦ä¸² |
| $(subst ,,)                 | æŠŠå­—ä¸² ä¸­çš„ å­—ç¬¦ä¸²æ›¿æ¢æˆ ï¼Œå¹¶è¿”å›è¢«æ›¿æ¢åçš„å­—ç¬¦ä¸²            |
| $(eval )                    | å°†çš„å†…å®¹å°†ä½œä¸ºmakefileçš„ä¸€éƒ¨åˆ†è€Œè¢«makeè§£æå’Œæ‰§è¡Œã€‚           |
| $(firstword )               | å–å­—ç¬¦ä¸² ä¸­çš„ç¬¬ä¸€ä¸ªå•è¯ï¼Œå¹¶è¿”å›å­—ç¬¦ä¸² çš„ç¬¬ä¸€ä¸ªå•è¯           |
| $(lastword )                | å–å­—ç¬¦ä¸² ä¸­çš„æœ€åä¸€ä¸ªå•è¯ï¼Œå¹¶è¿”å›å­—ç¬¦ä¸² çš„æœ€åä¸€ä¸ªå•è¯       |
| $(abspath )                 | å°†ä¸­çš„å„è·¯å¾„è½¬æ¢æˆç»å¯¹è·¯å¾„ï¼Œå¹¶å°†è½¬æ¢åçš„ç»“æœè¿”å›             |
| $(shell cat foo)            | æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ï¼Œå¹¶è¿”å›æ“ä½œç»“æœ                             |
| $(info <text ...>)          | è¾“å‡ºä¸€æ®µä¿¡æ¯                                                 |
| $(warning <text ...>)       | å‡ºä¸€æ®µè­¦å‘Šä¿¡æ¯ï¼Œè€Œ make ç»§ç»­æ‰§è¡Œ                             |
| $(error <text ...>)         | äº§ç”Ÿä¸€ä¸ªè‡´å‘½çš„é”™è¯¯ï¼Œ<text ...> æ˜¯é”™è¯¯ä¿¡æ¯                    |
| $(filter <pattern...>,)     | ä»¥æ¨¡å¼è¿‡æ»¤å­—ç¬¦ä¸²ä¸­çš„å•è¯ï¼Œä¿ç•™ç¬¦åˆæ¨¡å¼çš„å•è¯ã€‚å¯ä»¥æœ‰å¤šä¸ªæ¨¡å¼ã€‚è¿”å›ç¬¦åˆæ¨¡å¼çš„å­—ä¸² |
| $(filter-out <pattern...>,) | ä»¥æ¨¡å¼è¿‡æ»¤å­—ç¬¦ä¸²ä¸­çš„å•è¯ï¼Œå»é™¤ç¬¦åˆæ¨¡å¼çš„å•è¯ã€‚å¯ä»¥æœ‰å¤šä¸ªæ¨¡å¼ï¼Œå¹¶è¿”å›ä¸ç¬¦åˆæ¨¡å¼çš„å­—ä¸² |
| $(dir <names...>)           | ä»æ–‡ä»¶ååºåˆ—ä¸­å–å‡ºç›®å½•éƒ¨åˆ†ã€‚ç›®å½•éƒ¨åˆ†æ˜¯æŒ‡æœ€åä¸€ä¸ªåæ–œæ ï¼ˆ/ï¼‰ä¹‹å‰çš„éƒ¨åˆ†ã€‚è¿”å›æ–‡ä»¶ååºåˆ—çš„ç›®å½•éƒ¨åˆ†ã€‚ |
| $(notdir <names...>)        | ä»æ–‡ä»¶ååºåˆ—ä¸­å–å‡ºéç›®å½•éƒ¨åˆ†ã€‚éç›®å½•éƒ¨åˆ†æ˜¯æŒ‡æœ€å¾Œä¸€ä¸ªåæ–œæ ï¼ˆ/ï¼‰ä¹‹åçš„éƒ¨åˆ†ã€‚è¿”å›æ–‡ä»¶ååºåˆ—çš„éç›®å½•éƒ¨åˆ†ã€‚ |
| $(strip )                   | å»æ‰å­—ä¸²ä¸­å¼€å¤´å’Œç»“å°¾çš„ç©ºå­—ç¬¦ï¼Œå¹¶è¿”å›å»æ‰ç©ºæ ¼åçš„å­—ç¬¦ä¸²       |
| $(suffix <names...>)        | ä»æ–‡ä»¶ååºåˆ—ä¸­å–å‡ºå„ä¸ªæ–‡ä»¶åçš„åç¼€ã€‚è¿”å›æ–‡ä»¶ååºåˆ—çš„åç¼€åºåˆ—ï¼Œå¦‚æœæ–‡ä»¶æ²¡æœ‰åç¼€ï¼Œåˆ™è¿”å›ç©ºå­—ä¸²ã€‚ |
| $(foreach ,,)               | æŠŠå‚æ•°ä¸­çš„å•è¯é€ä¸€å–å‡ºæ”¾åˆ°å‚æ•°æ‰€æŒ‡å®šçš„å˜é‡ä¸­ï¼Œç„¶åå†æ‰§è¡Œæ‰€åŒ…å«çš„è¡¨è¾¾å¼ã€‚æ¯ä¸€æ¬¡ ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¾ªç¯è¿‡ç¨‹ä¸­çš„æ‰€è¿”å›çš„æ¯ä¸ªå­—ç¬¦ä¸²ä¼šä»¥ç©ºæ ¼åˆ†éš”ï¼Œæœ€åå½“æ•´ä¸ªå¾ªç¯ç»“æŸæ—¶ï¼Œæ‰€è¿”å›çš„æ¯ä¸ªå­—ç¬¦ä¸²æ‰€ç»„æˆçš„æ•´ä¸ªå­—ç¬¦ä¸²ï¼ˆä»¥ç©ºæ ¼åˆ†éš”ï¼‰å°†ä¼šæ˜¯foreachå‡½æ•°çš„è¿”å›å€¼ã€‚ |



### æŠ€å·§ 3ï¼šä¾èµ–éœ€è¦ç”¨åˆ°çš„å·¥å…·

å¦‚æœ Makefile æŸä¸ªç›®æ ‡çš„å‘½ä»¤ä¸­ç”¨åˆ°äº†æŸä¸ªå·¥å…·ï¼Œå¯ä»¥å°†è¯¥å·¥å…·æ”¾åœ¨ç›®æ ‡çš„ä¾èµ–ä¸­ã€‚è¿™æ ·ï¼Œå½“æ‰§è¡Œè¯¥ç›®æ ‡æ—¶ï¼Œå°±å¯ä»¥æŒ‡å®šæ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å®‰è£…è¯¥å·¥å…·ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…åˆ™è‡ªåŠ¨å®‰è£…ï¼Œä»è€Œå®ç°æ›´é«˜ç¨‹åº¦çš„è‡ªåŠ¨åŒ–ã€‚ä¾‹å¦‚ï¼Œ`/Makefile` æ–‡ä»¶ä¸­ï¼Œ`format` ä¼ªç›®æ ‡ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```bash
.PHONY: format
format: tools.verify.golines tools.verify.goimports
  @echo "===========> Formating codes"
  @$(FIND) -type f -name '*.go' | $(XARGS) gofmt -s -w
  @$(FIND) -type f -name '*.go' | $(XARGS) goimports -w -local $(ROOT_PACKAGE)
  @$(FIND) -type f -name '*.go' | $(XARGS) golines -w --max-len=120 --reformat-tags --shorten-comments --ignore-generated .
```

ä½ å¯ä»¥çœ‹åˆ°ï¼Œformat ä¾èµ–`tools.verify.golines tools.verify.goimports`ã€‚æˆ‘ä»¬å†æ¥çœ‹ä¸‹tools.verify.golinesçš„å®šä¹‰ï¼š

```bash
tools.verify.%:
  @if ! which $* &>/dev/null; then $(MAKE) tools.install.$*; fi
```



å†æ¥çœ‹ä¸‹tools.install.$*è§„åˆ™ï¼š

```bash
.PHONY: install.golines
install.golines:
  @$(GO) get -u github.com/segmentio/golines
```

é€šè¿‡tools.verify.%è§„åˆ™å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œtools.verify.%ä¼šå…ˆæ£€æŸ¥å·¥å…·æ˜¯å¦å®‰è£…ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…ï¼Œå°±ä¼šæ‰§è¡Œtools.install.$*æ¥å®‰è£…ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œtools.verify.%ç›®æ ‡æ—¶ï¼Œå¦‚æœç³»ç»Ÿæ²¡æœ‰å®‰è£… golines å‘½ä»¤ï¼Œå°±ä¼šè‡ªåŠ¨è°ƒç”¨go getå®‰è£…ï¼Œæé«˜äº† Makefile çš„è‡ªåŠ¨åŒ–ç¨‹åº¦ã€‚



### æŠ€å·§ 4ï¼šæŠŠå¸¸ç”¨åŠŸèƒ½æ”¾åœ¨ /Makefile ä¸­ï¼Œä¸å¸¸ç”¨çš„æ”¾åœ¨åˆ†ç±» Makefile ä¸­

ä¸€ä¸ªé¡¹ç›®ï¼Œå°¤å…¶æ˜¯å¤§å‹é¡¹ç›®ï¼Œæœ‰å¾ˆå¤šéœ€è¦ç®¡ç†çš„åœ°æ–¹ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†éƒ½å¯ä»¥é€šè¿‡ Makefile å®ç°è‡ªåŠ¨åŒ–æ“ä½œã€‚ä¸è¿‡ï¼Œä¸ºäº†ä¿æŒ `/Makefile` æ–‡ä»¶çš„æ•´æ´æ€§ï¼Œæˆ‘ä»¬ä¸èƒ½æŠŠæ‰€æœ‰çš„å‘½ä»¤éƒ½æ·»åŠ åœ¨ `/Makefile` æ–‡ä»¶ä¸­ã€‚

ä¸€ä¸ªæ¯”è¾ƒå¥½çš„å»ºè®®æ˜¯ï¼Œå°†å¸¸ç”¨åŠŸèƒ½æ”¾åœ¨ /Makefile ä¸­ï¼Œä¸å¸¸ç”¨çš„æ”¾åœ¨åˆ†ç±» Makefile ä¸­ï¼Œå¹¶åœ¨ /Makefile ä¸­ include è¿™äº›åˆ†ç±» Makefileã€‚

ä¾‹å¦‚ï¼ŒIAM é¡¹ç›®çš„ /Makefile é›†æˆäº†formatã€lintã€testã€buildç­‰å¸¸ç”¨å‘½ä»¤ï¼Œè€Œå°†gen.errcode.codeã€gen.errcode.docè¿™ç±»ä¸å¸¸ç”¨çš„åŠŸèƒ½æ”¾åœ¨ scripts/make-rules/gen.mk æ–‡ä»¶ä¸­ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥æ‰§è¡Œ make gen.errcode.codeæ¥æ‰§è¡Œgen.errcode.codeä¼ªç›®æ ‡ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ—¢å¯ä»¥ä¿è¯ /Makefile çš„ç®€æ´ã€æ˜“ç»´æŠ¤ï¼Œåˆå¯ä»¥é€šè¿‡makeå‘½ä»¤æ¥è¿è¡Œä¼ªç›®æ ‡ï¼Œæ›´åŠ çµæ´»ã€‚



### æŠ€å·§ 5ï¼šç¼–å†™å¯æ‰©å±•çš„ Makefile

ä»€ä¹ˆå«å¯æ‰©å±•çš„ Makefile å‘¢ï¼Ÿåœ¨æˆ‘çœ‹æ¥ï¼Œå¯æ‰©å±•çš„ Makefile åŒ…å«ä¸¤å±‚å«ä¹‰ï¼š

+ å¯ä»¥åœ¨ä¸æ”¹å˜ Makefile ç»“æ„çš„æƒ…å†µä¸‹æ·»åŠ æ–°åŠŸèƒ½ã€‚
+ æ‰©å±•é¡¹ç›®æ—¶ï¼Œæ–°åŠŸèƒ½å¯ä»¥è‡ªåŠ¨çº³å…¥åˆ° Makefile ç°æœ‰é€»è¾‘ä¸­ã€‚

å…¶ä¸­çš„ç¬¬ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾è®¡åˆç†çš„ Makefile ç»“æ„æ¥å®ç°ã€‚è¦å®ç°ç¬¬äºŒç‚¹ï¼Œå°±éœ€è¦æˆ‘ä»¬åœ¨ç¼–å†™ Makefile æ—¶é‡‡ç”¨ä¸€å®šçš„æŠ€å·§ï¼Œä¾‹å¦‚å¤šç”¨é€šé…ç¬¦ã€è‡ªåŠ¨å˜é‡ã€å‡½æ•°ç­‰ã€‚è¿™é‡Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå¯ä»¥è®©ä½ æ›´å¥½åœ°ç†è§£ã€‚

åœ¨æˆ‘ä»¬ IAM å®æˆ˜é¡¹ç›®çš„golang.mkä¸­ï¼Œæ‰§è¡Œ `make go.build` æ—¶èƒ½å¤Ÿæ„å»º `cmd/` ç›®å½•ä¸‹çš„æ‰€æœ‰ç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æœ‰æ–°ç»„ä»¶æ·»åŠ æ—¶ï¼Œ `make go.build` ä»ç„¶èƒ½å¤Ÿæ„å»ºæ–°å¢çš„ç»„ä»¶ï¼Œè¿™å°±å®ç°äº†ä¸Šé¢è¯´çš„ç¬¬äºŒç‚¹ã€‚

å…·ä½“å®ç°æ–¹æ³•å¦‚ä¸‹ï¼š

```makefile

COMMANDS ?= $(filter-out %.md, $(wildcard ${ROOT_DIR}/cmd/*))
BINS ?= $(foreach cmd,${COMMANDS},$(notdir ${cmd}))

.PHONY: go.build
go.build: go.build.verify $(addprefix go.build., $(addprefix $(PLATFORM)., $(BINS)))
.PHONY: go.build.%               

go.build.%:             
  $(eval COMMAND := $(word 2,$(subst ., ,$*)))
  $(eval PLATFORM := $(word 1,$(subst ., ,$*)))
  $(eval OS := $(word 1,$(subst _, ,$(PLATFORM))))           
  $(eval ARCH := $(word 2,$(subst _, ,$(PLATFORM))))                         
  @echo "===========> Building binary $(COMMAND) $(VERSION) for $(OS) $(ARCH)"
  @mkdir -p $(OUTPUT_DIR)/platforms/$(OS)/$(ARCH)
  @CGO_ENABLED=0 GOOS=$(OS) GOARCH=$(ARCH) $(GO) build $(GO_BUILD_FLAGS) -o $(OUTPUT_DIR)/platforms/$(OS)/$(ARCH)/$(COMMAND)$(GO_OUT_EXT) $(ROOT_PACKAGE)/cmd/$(COMMAND)
COMMANDS ?= $(filter-out %.md, $(wildcard ${ROOT_DIR}/cmd/*))
BINS ?= $(foreach cmd,${COMMANDS},$(notdir ${cmd}))

.PHONY: go.build
go.build: go.build.verify $(addprefix go.build., $(addprefix $(PLATFORM)., $(BINS)))
.PHONY: go.build.%               

go.build.%:             
  $(eval COMMAND := $(word 2,$(subst ., ,$*)))
  $(eval PLATFORM := $(word 1,$(subst ., ,$*)))
  $(eval OS := $(word 1,$(subst _, ,$(PLATFORM))))           
  $(eval ARCH := $(word 2,$(subst _, ,$(PLATFORM))))                         
  @echo "===========> Building binary $(COMMAND) $(VERSION) for $(OS) $(ARCH)"
  @mkdir -p $(OUTPUT_DIR)/platforms/$(OS)/$(ARCH)
  @CGO_ENABLED=0 GOOS=$(OS) GOARCH=$(ARCH) $(GO) build $(GO_BUILD_FLAGS) -o $(OUTPUT_DIR)/platforms/$(OS)/$(ARCH)/$(COMMAND)$(GO_OUT_EXT) $(ROOT_PACKAGE)/cmd/$(COMMAND)
```

å½“æ‰§è¡Œmake go.build æ—¶ï¼Œä¼šæ‰§è¡Œ go.build çš„ä¾èµ– `$(addprefix go.build., $(addprefix $(PLATFORM)., $(BINS))`) ,`addprefix`å‡½æ•°æœ€ç»ˆè¿”å›å­—ç¬¦ä¸² `go.build.linux_amd64.iamctl go.build.linux_amd64.iam-authz-server go.build.linux_amd64.iam-apiserver ...` ï¼Œè¿™æ—¶å€™å°±ä¼šæ‰§è¡Œ `go.build.%` ä¼ªç›®æ ‡ã€‚

åœ¨ go.build.% ä¼ªç›®æ ‡ä¸­ï¼Œé€šè¿‡ evalã€wordã€subst å‡½æ•°ç»„åˆï¼Œç®—å‡ºäº† COMMAND çš„å€¼ `iamctl/iam-apiserver/iam-authz-server/...`ï¼Œæœ€ç»ˆé€šè¿‡ `$(ROOT_PACKAGE)/cmd/$(COMMAND)` å®šä½åˆ°éœ€è¦æ„å»ºçš„ç»„ä»¶çš„ main å‡½æ•°æ‰€åœ¨ç›®å½•ã€‚

ä¸Šè¿°å®ç°ä¸­æœ‰ä¸¤ä¸ªæŠ€å·§ï¼Œä½ å¯ä»¥æ³¨æ„ä¸‹ã€‚é¦–å…ˆï¼Œé€šè¿‡

```bash
COMMANDS ?= $(filter-out %.md, $(wildcard ${ROOT_DIR}/cmd/*))
BINS ?= $(foreach cmd,${COMMANDS},$(notdir ${cmd}))
```

è·å–åˆ°äº† cmd/ ç›®å½•ä¸‹çš„æ‰€æœ‰ç»„ä»¶åã€‚

æ¥ç€ï¼Œé€šè¿‡ä½¿ç”¨é€šé…ç¬¦å’Œè‡ªåŠ¨å˜é‡ï¼Œè‡ªåŠ¨åŒ¹é…åˆ°go.build.linux_amd64.iam-authz-server è¿™ç±»ä¼ªç›®æ ‡å¹¶æ„å»ºã€‚

å¯ä»¥çœ‹åˆ°ï¼Œæƒ³è¦ç¼–å†™ä¸€ä¸ªå¯æ‰©å±•çš„ Makefileï¼Œç†Ÿç»ƒæŒæ¡ Makefile çš„ç”¨æ³•æ˜¯åŸºç¡€ï¼Œæ›´å¤šçš„æ˜¯éœ€è¦æˆ‘ä»¬åŠ¨è„‘æ€è€ƒå¦‚ä½•å»ç¼–å†™ Makefileã€‚



### æŠ€å·§ 6ï¼šå°†æ‰€æœ‰è¾“å‡ºå­˜æ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œæ–¹ä¾¿æ¸…ç†å’ŒæŸ¥æ‰¾

åœ¨æ‰§è¡Œ Makefile çš„è¿‡ç¨‹ä¸­ï¼Œä¼šè¾“å‡ºå„ç§å„æ ·çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ Go ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€æµ‹è¯•è¦†ç›–ç‡æ•°æ®ç­‰ï¼Œæˆ‘å»ºè®®ä½ æŠŠè¿™äº›æ–‡ä»¶ç»Ÿä¸€æ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œæ–¹ä¾¿åæœŸçš„æ¸…ç†å’ŒæŸ¥æ‰¾ã€‚é€šå¸¸æˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬æ”¾åœ¨`_output`è¿™ç±»ç›®å½•ä¸‹ï¼Œè¿™æ ·æ¸…ç†æ—¶å°±å¾ˆæ–¹ä¾¿ï¼Œåªéœ€è¦æ¸…ç†`_output`æ–‡ä»¶å¤¹å°±å¯ä»¥ï¼Œä¾‹å¦‚ï¼š

```bash
.PHONY: go.clean
go.clean:
  @echo "===========> Cleaning all build output"
  @-rm -vrf $(OUTPUT_DIR)
```

è¿™é‡Œè¦æ³¨æ„ï¼Œè¦ç”¨`-rm`ï¼Œè€Œä¸æ˜¯rmï¼Œé˜²æ­¢åœ¨æ²¡æœ‰`_output`ç›®å½•æ—¶ï¼Œæ‰§è¡Œ`make go.clean`æŠ¥é”™ã€‚



### æŠ€å·§ 7ï¼šä½¿ç”¨å¸¦å±‚çº§çš„å‘½åæ–¹å¼

é€šè¿‡ä½¿ç”¨å¸¦å±‚çº§çš„å‘½åæ–¹å¼ï¼Œä¾‹å¦‚`tools.verify.swagger` ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç›®æ ‡åˆ†ç»„ç®¡ç†ã€‚è¿™æ ·åšçš„å¥½å¤„æœ‰å¾ˆå¤šã€‚é¦–å…ˆï¼Œå½“ Makefile æœ‰å¤§é‡ç›®æ ‡æ—¶ï¼Œé€šè¿‡åˆ†ç»„ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°ç®¡ç†è¿™äº›ç›®æ ‡ã€‚å…¶æ¬¡ï¼Œåˆ†ç»„ä¹Ÿèƒ½æ–¹ä¾¿ç†è§£ï¼Œå¯ä»¥é€šè¿‡ç»„åä¸€çœ¼è¯†åˆ«å‡ºè¯¥ç›®æ ‡çš„åŠŸèƒ½ç±»åˆ«ã€‚æœ€åï¼Œè¿™æ ·åšè¿˜å¯ä»¥å¤§å¤§å‡å°ç›®æ ‡é‡åçš„æ¦‚ç‡ã€‚

ä¾‹å¦‚ï¼ŒIAM é¡¹ç›®çš„ Makefile å°±å¤§é‡é‡‡ç”¨äº†ä¸‹é¢è¿™ç§å‘½åæ–¹å¼ã€‚

```makefile

.PHONY: gen.run
gen.run: gen.clean gen.errcode gen.docgo

.PHONY: gen.errcode
gen.errcode: gen.errcode.code gen.errcode.doc

.PHONY: gen.errcode.code
gen.errcode.code: tools.verify.codegen
    ...
.PHONY: gen.errcode.doc
gen.errcode.doc: tools.verify.codegen
    ...
```



### æŠ€å·§ 8ï¼šåšå¥½ç›®æ ‡æ‹†åˆ†

è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå®ç”¨çš„æŠ€å·§ï¼šæˆ‘ä»¬è¦åˆç†åœ°æ‹†åˆ†ç›®æ ‡ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®‰è£…å·¥å…·æ‹†åˆ†æˆä¸¤ä¸ªç›®æ ‡ï¼šéªŒè¯å·¥å…·æ˜¯å¦å·²å®‰è£…å’Œå®‰è£…å·¥å…·ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ç»™æˆ‘ä»¬çš„ Makefile å¸¦æ¥æ›´å¤§çš„çµæ´»æ€§ã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©æ€§åœ°æ‰§è¡Œå…¶ä¸­ä¸€ä¸ªæ“ä½œï¼Œä¹Ÿå¯ä»¥ä¸¤ä¸ªæ“ä½œä¸€èµ·æ‰§è¡Œã€‚

è¿™é‡Œæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```makefile
gen.errcode.code: tools.verify.codegen

tools.verify.%:    
  @if ! which $* &>/dev/null; then $(MAKE) tools.install.$*; fi  

.PHONY: install.codegen
install.codegen:              
  @$(GO) install ${ROOT_DIR}/tools/codegen/codegen.go
```

ä¸Šé¢çš„ Makefile ä¸­ï¼Œ`gen.errcode.code` ä¾èµ–äº† `tools.verify.codegen`ï¼Œ`tools.verify.codegen` ä¼šå…ˆæ£€æŸ¥ codegen å‘½ä»¤æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå†è°ƒç”¨ install.codegen æ¥å®‰è£… codegen å·¥å…·ã€‚

å¦‚æœæˆ‘ä»¬çš„ Makefile è®¾è®¡æ˜¯ï¼š

```bash
gen.errcode.code: install.codegen
```

é‚£æ¯æ¬¡æ‰§è¡Œ gen.errcode.code éƒ½è¦é‡æ–°å®‰è£… codegen å‘½ä»¤ï¼Œè¿™ç§æ“ä½œæ˜¯ä¸å¿…è¦çš„ï¼Œè¿˜ä¼šå¯¼è‡´ make gen.errcode.code æ‰§è¡Œå¾ˆæ…¢ã€‚



### æŠ€å·§ 9ï¼šè®¾ç½® OPTIONS

ç¼–å†™ Makefile æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠä¸€äº›å¯å˜çš„åŠŸèƒ½é€šè¿‡ OPTIONS æ¥æ§åˆ¶ã€‚ä¸ºäº†å¸®åŠ©ä½ ç†è§£ï¼Œè¿™é‡Œè¿˜æ˜¯æ‹¿ IAM é¡¹ç›®çš„ Makefile æ¥ä¸¾ä¾‹ã€‚

å‡è®¾æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ä¸ªé€‰é¡¹ V ï¼Œæ¥æ§åˆ¶æ˜¯å¦éœ€è¦åœ¨æ‰§è¡Œ Makefile æ—¶æ‰“å°è¯¦ç»†çš„ä¿¡æ¯ã€‚è¿™å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ­¥éª¤æ¥å®ç°ã€‚

é¦–å…ˆï¼Œåœ¨ `/Makefile` ä¸­å®šä¹‰ `USAGE_OPTIONS` ã€‚å®šä¹‰ `USAGE_OPTIONS` å¯ä»¥ä½¿å¼€å‘è€…åœ¨æ‰§è¡Œ make help åæ„ŸçŸ¥åˆ°æ­¤ OPTIONï¼Œå¹¶æ ¹æ®éœ€è¦è¿›è¡Œè®¾ç½®ã€‚

```bash
define USAGE_OPTIONS    
                         
Options:
  ...
  BINS         The binaries to build. Default is all of cmd.
               ...
  ...
  V            Set to 1 enable verbose build. Default is 0.    
endef    
export USAGE_OPTIONS    
```

æ¥ç€ï¼Œåœ¨`scripts/make-rules/common.mk`æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åˆ¤æ–­æœ‰æ²¡æœ‰è®¾ç½® V é€‰é¡¹ï¼Œæ¥é€‰æ‹©ä¸åŒçš„è¡Œä¸ºï¼š

```makefile
ifndef V    
MAKEFLAGS += --no-print-directory    
endif
```

å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹æ³•æ¥ä½¿ç”¨ V ï¼š

```bash
ifeq ($(origin V), undefined)                                
MAKEFLAGS += --no-print-directory              
endif
```

ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº† V OPTIONï¼Œæˆ‘ä»¬åœ¨ Makefile ä¸­é€šè¿‡åˆ¤æ–­æœ‰æ²¡æœ‰å®šä¹‰ V ï¼Œæ¥æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚å…¶å®è¿˜æœ‰ä¸€ç§ OPTIONï¼Œè¿™ç§ OPTION çš„å€¼æˆ‘ä»¬åœ¨ Makefile ä¸­æ˜¯ç›´æ¥ä½¿ç”¨çš„ï¼Œä¾‹å¦‚BINSã€‚é’ˆå¯¹è¿™ç§ OPTIONï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥ä½¿ç”¨ï¼š

```bash

BINS ?= $(foreach cmd,${COMMANDS},$(notdir ${cmd}))
...
go.build: go.build.verify $(addprefix go.build., $(addprefix $(PLATFORM)., $(BINS)))
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡ ?= æ¥åˆ¤æ–­ BINS å˜é‡æœ‰æ²¡æœ‰è¢«èµ‹å€¼ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™èµ‹äºˆç­‰å·åçš„å€¼ã€‚æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥åœ¨ Makefile è§„åˆ™ä¸­ä½¿ç”¨å®ƒã€‚



### æŠ€å·§ 10ï¼šå®šä¹‰ç¯å¢ƒå˜é‡

æˆ‘ä»¬å¯ä»¥åœ¨ Makefile ä¸­å®šä¹‰ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚ï¼š

```makefile
GO := go                                          
GO_SUPPORTED_VERSIONS ?= 1.13|1.14|1.15|1.16|1.17    
GO_LDFLAGS += -X $(VERSION_PACKAGE).GitVersion=$(VERSION) \    
  -X $(VERSION_PACKAGE).GitCommit=$(GIT_COMMIT) \       
  -X $(VERSION_PACKAGE).GitTreeState=$(GIT_TREE_STATE) \                          
  -X $(VERSION_PACKAGE).BuildDate=$(shell date -u +'%Y-%m-%dT%H:%M:%SZ')    
ifneq ($(DLV),)                                                                                                                              
  GO_BUILD_FLAGS += -gcflags "all=-N -l"    
  LDFLAGS = ""      
endif                                                                                   
GO_BUILD_FLAGS += -tags=jsoniter -ldflags "$(GO_LDFLAGS)" 
...
FIND := find . ! -path './third_party/*' ! -path './vendor/*'    
XARGS := xargs --no-run-if-empty 
```

è¿™äº›ç¯å¢ƒå˜é‡å’Œç¼–ç¨‹ä¸­ä½¿ç”¨å®å®šä¹‰çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼šåªè¦ä¿®æ”¹ä¸€å¤„ï¼Œå°±å¯ä»¥ä½¿å¾ˆå¤šåœ°æ–¹åŒæ—¶ç”Ÿæ•ˆï¼Œé¿å…äº†é‡å¤çš„å·¥ä½œã€‚

é€šå¸¸ï¼Œæˆ‘ä»¬å¯ä»¥å°† GOã€GO_BUILD_FLAGSã€FIND è¿™ç±»å˜é‡å®šä¹‰ä¸ºç¯å¢ƒå˜é‡ã€‚



### æŠ€å·§ 11ï¼šè‡ªå·±è°ƒç”¨è‡ªå·±

åœ¨ç¼–å†™ Makefile çš„è¿‡ç¨‹ä¸­ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°è¿™æ ·ä¸€ç§æƒ…å†µï¼šA-Target ç›®æ ‡å‘½ä»¤ä¸­ï¼Œéœ€è¦å®Œæˆæ“ä½œ B-Actionï¼Œè€Œæ“ä½œ B-Action æˆ‘ä»¬å·²ç»é€šè¿‡ä¼ªç›®æ ‡ B-Target å®ç°è¿‡ã€‚ä¸ºäº†è¾¾åˆ°æœ€å¤§çš„ä»£ç å¤ç”¨åº¦ï¼Œè¿™æ—¶å€™æœ€å¥½çš„æ–¹å¼æ˜¯åœ¨ A-Target çš„å‘½ä»¤ä¸­æ‰§è¡Œ B-Targetã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```bash
tools.verify.%:
  @if ! which $* &>/dev/null; then $(MAKE) tools.install.$*; fi
```



è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡ `$(MAKE)` è°ƒç”¨äº†ä¼ªç›®æ ‡ `tools.install.$*` ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒMakefile åœ¨åˆ‡æ¢ç›®å½•æ—¶ä¼šè¾“å‡ºä»¥ä¸‹ä¿¡æ¯ï¼š

```makefile
$ make tools.install.codegen
===========> Installing codegen
make[1]: Entering directory `/home/colin/workspace/golang/src/github.com/marmotedu/iam'
make[1]: Leaving directory `/home/colin/workspace/golang/src/github.com/marmotedu/iam'
```

å¦‚æœè§‰å¾— Entering directory è¿™ç±»ä¿¡æ¯å¾ˆçƒ¦äººï¼Œå¯ä»¥é€šè¿‡è®¾ç½® MAKEFLAGS += --no-print-directory æ¥ç¦æ­¢ Makefile æ‰“å°è¿™äº›ä¿¡æ¯ã€‚



## æ€»ç»“







## END é“¾æ¥

<ul><li><div><a href = '6.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '8.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

