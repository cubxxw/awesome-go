+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬6èŠ‚ API é£æ ¼è®¾è®¡

<br>
<div><a href = '5.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '7.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

## RESTful API

ç»å¤§éƒ¨åˆ†çš„ Go åç«¯æœåŠ¡éœ€è¦ç¼–å†™ API æ¥å£ï¼Œå¯¹å¤–æä¾›æœåŠ¡ã€‚æ‰€ä»¥åœ¨å¼€å‘ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šä¸€ç§ API é£æ ¼ã€‚API é£æ ¼ä¹Ÿå¯ä»¥ç†è§£ä¸º API ç±»å‹ï¼Œç›®å‰ä¸šç•Œå¸¸ç”¨çš„ API é£æ ¼æœ‰ä¸‰ç§ï¼šRESTã€RPC å’Œ GraphQLã€‚æˆ‘ä»¬éœ€è¦æ ¹æ®é¡¹ç›®éœ€æ±‚ï¼Œå¹¶ç»“åˆ API é£æ ¼çš„ç‰¹ç‚¹ï¼Œç¡®å®šä½¿ç”¨å“ªç§ API é£æ ¼ï¼Œè¿™å¯¹ä»¥åçš„ç¼–ç å®ç°ã€é€šä¿¡æ–¹å¼å’Œé€šä¿¡æ•ˆç‡éƒ½æœ‰å¾ˆå¤§çš„å½±å“ã€‚

**åœ¨ Go é¡¹ç›®å¼€å‘ä¸­ï¼Œç”¨å¾—æœ€å¤šçš„æ˜¯ REST å’Œ RPCï¼Œæˆ‘ä»¬åœ¨ IAM å®æˆ˜é¡¹ç›®ä¸­ä¹Ÿä½¿ç”¨äº† REST å’Œ RPC æ¥æ„å»ºç¤ºä¾‹é¡¹ç›®ã€‚**

+ [GraphQL é£æ ¼](https://graphql.cn/)



### æ˜¯ä»€ä¹ˆ

åœ¨å›ç­”â€œRESTful API æ˜¯ä»€ä¹ˆâ€ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ REST æ˜¯ä»€ä¹ˆæ„æ€ï¼šREST ä»£è¡¨çš„æ˜¯è¡¨ç°å±‚çŠ¶æ€è½¬ç§»ï¼ˆREpresentational State Transferï¼‰ï¼Œç”± Roy Fielding åœ¨ä»–çš„è®ºæ–‡[ã€ŠArchitectural Styles and the Design of Network-based Software Architecturesã€‹](https://www.ics.uci.edu/~fielding/pubs/dissertation/top.htm)é‡Œæå‡ºã€‚REST æœ¬èº«å¹¶æ²¡æœ‰åˆ›é€ æ–°çš„æŠ€æœ¯ã€ç»„ä»¶æˆ–æœåŠ¡ï¼Œå®ƒåªæ˜¯ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ï¼Œæ˜¯ä¸€ç»„æ¶æ„çº¦æŸæ¡ä»¶å’ŒåŸåˆ™ï¼Œè€Œä¸æ˜¯æŠ€æœ¯æ¡†æ¶ã€‚

**REST æœ‰ä¸€ç³»åˆ—è§„èŒƒï¼Œæ»¡è¶³è¿™äº›è§„èŒƒçš„ API å‡å¯ç§°ä¸º RESTful API**ã€‚REST è§„èŒƒæŠŠæ‰€æœ‰å†…å®¹éƒ½è§†ä¸ºèµ„æºï¼Œä¹Ÿå°±æ˜¯è¯´ç½‘ç»œä¸Šä¸€åˆ‡çš†èµ„æºã€‚REST æ¶æ„å¯¹èµ„æºçš„æ“ä½œåŒ…æ‹¬è·å–ã€åˆ›å»ºã€ä¿®æ”¹å’Œåˆ é™¤ï¼Œè¿™äº›æ“ä½œæ­£å¥½å¯¹åº” HTTP åè®®æä¾›çš„ GETã€POSTã€PUT å’Œ DELETE æ–¹æ³•ã€‚HTTP åŠ¨è¯ä¸ REST é£æ ¼ CRUD çš„å¯¹åº”å…³ç³»è§ä¸‹è¡¨ï¼š

![image-20230218111227370](http://sm.nsddd.top/sm202302181112478.png)

REST é£æ ¼è™½ç„¶é€‚ç”¨äºå¾ˆå¤šä¼ è¾“åè®®ï¼Œä½†åœ¨å®é™…å¼€å‘ä¸­ï¼Œç”±äº REST å¤©ç”Ÿå’Œ HTTP åè®®ç›¸è¾…ç›¸æˆï¼Œ**å› æ­¤ HTTP åè®®å·²ç»æˆäº†å®ç° RESTful API äº‹å®ä¸Šçš„æ ‡å‡†ã€‚**æ‰€ä»¥ï¼ŒREST å…·æœ‰ä»¥ä¸‹æ ¸å¿ƒç‰¹ç‚¹ï¼š

+ ä»¥èµ„æº (resource) ä¸ºä¸­å¿ƒï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½æŠ½è±¡æˆèµ„æºï¼Œæ‰€æœ‰çš„è¡Œä¸ºéƒ½åº”è¯¥æ˜¯åœ¨èµ„æºä¸Šçš„ CRUD æ“ä½œã€‚
  + èµ„æºå¯¹åº”ç€é¢å‘å¯¹è±¡èŒƒå¼é‡Œçš„å¯¹è±¡ï¼Œé¢å‘å¯¹è±¡èŒƒå¼ä»¥å¯¹è±¡ä¸ºä¸­å¿ƒã€‚
  + èµ„æºä½¿ç”¨ URI æ ‡è¯†ï¼Œæ¯ä¸ªèµ„æºå®ä¾‹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ URI æ ‡è¯†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªç”¨æˆ·ï¼Œç”¨æˆ·åæ˜¯ adminï¼Œé‚£ä¹ˆå®ƒçš„ URI æ ‡è¯†å°±å¯ä»¥æ˜¯ /users/adminã€‚
+ èµ„æºæ˜¯æœ‰çŠ¶æ€çš„ï¼Œä½¿ç”¨ JSON/XML ç­‰åœ¨ HTTP Body é‡Œè¡¨å¾èµ„æºçš„çŠ¶æ€ã€‚
+ å®¢æˆ·ç«¯é€šè¿‡å››ä¸ª HTTP åŠ¨è¯ï¼Œå¯¹æœåŠ¡å™¨ç«¯èµ„æºè¿›è¡Œæ“ä½œï¼Œå®ç°â€œè¡¨ç°å±‚çŠ¶æ€è½¬åŒ–â€ã€‚
+ æ— çŠ¶æ€ï¼Œè¿™é‡Œçš„æ— çŠ¶æ€æ˜¯æŒ‡æ¯ä¸ª RESTful API è¯·æ±‚éƒ½åŒ…å«äº†æ‰€æœ‰è¶³å¤Ÿå®Œæˆæœ¬æ¬¡æ“ä½œçš„ä¿¡æ¯ï¼ŒæœåŠ¡å™¨ç«¯æ— é¡»ä¿æŒ `session`ã€‚æ— çŠ¶æ€å¯¹äºæœåŠ¡ç«¯çš„å¼¹æ€§æ‰©å®¹æ˜¯å¾ˆé‡è¦çš„ã€‚

**REST å’Œ RESTful API çš„åŒºåˆ«ï¼š** REST æ˜¯ä¸€ç§è§„èŒƒï¼Œè€Œ RESTful API åˆ™æ˜¯æ»¡è¶³è¿™ç§è§„èŒƒçš„ API æ¥å£ã€‚



### RESTful API è®¾è®¡åŸåˆ™

**RESTful API è®¾è®¡è®²è¿° ä¸ƒç§ åŸåˆ™ï¼**



#### URI è®¾è®¡

èµ„æºéƒ½æ˜¯ä½¿ç”¨ URI æ ‡è¯†çš„ï¼Œæˆ‘ä»¬åº”è¯¥æŒ‰ç…§ä¸€å®šçš„è§„èŒƒæ¥è®¾è®¡ URIï¼Œé€šè¿‡è§„èŒƒåŒ–å¯ä»¥ä½¿æˆ‘ä»¬çš„ API æ¥å£æ›´åŠ æ˜“è¯»ã€æ˜“ç”¨ã€‚ä»¥ä¸‹æ˜¯ URI è®¾è®¡æ—¶ï¼Œåº”è¯¥éµå¾ªçš„ä¸€äº›è§„èŒƒï¼š

+ èµ„æºåä½¿ç”¨åè¯è€Œä¸æ˜¯åŠ¨è¯ï¼Œ**å¹¶ä¸”ç”¨åè¯å¤æ•°è¡¨ç¤º**ã€‚èµ„æºåˆ†ä¸º Collection å’Œ Member ä¸¤ç§ã€‚

  + **Collection**ï¼šä¸€å †èµ„æºçš„é›†åˆã€‚ä¾‹å¦‚æˆ‘ä»¬ç³»ç»Ÿé‡Œæœ‰å¾ˆå¤šç”¨æˆ·ï¼ˆUserï¼‰, è¿™äº›ç”¨æˆ·çš„é›†åˆå°±æ˜¯ Collectionã€‚Collection çš„ URI æ ‡è¯†åº”è¯¥æ˜¯ `åŸŸå/èµ„æºåå¤æ•°`, ä¾‹å¦‚https://iam.api.marmotedu.com/usersã€‚
  + **Member**ï¼šå•ä¸ªç‰¹å®šèµ„æºã€‚ä¾‹å¦‚ç³»ç»Ÿä¸­ç‰¹å®šåå­—çš„ç”¨æˆ·ï¼Œå°±æ˜¯ Collection é‡Œçš„ä¸€ä¸ª Memberã€‚Member çš„ URI æ ‡è¯†åº”è¯¥æ˜¯ `åŸŸå/èµ„æºåå¤æ•°/èµ„æºåç§°`, ä¾‹å¦‚https://iam.api.marmotedu/users/adminã€‚

+ URI ç»“å°¾ä¸åº”åŒ…å« `/`

+ URI ä¸­ä¸èƒ½å‡ºç°ä¸‹åˆ’çº¿ `_`ï¼Œå¿…é¡»ç”¨ä¸­æ çº¿ `-`ä»£æ›¿ï¼ˆæœ‰äº›äººæ¨èç”¨ `_`ï¼Œæœ‰äº›äººæ¨èç”¨ `-`ï¼Œç»Ÿä¸€ä½¿ç”¨ä¸€ç§æ ¼å¼å³å¯ï¼Œæˆ‘æ¯”è¾ƒæ¨èç”¨ `-`ï¼‰ã€‚

+ URI è·¯å¾„ç”¨å°å†™ï¼Œä¸è¦ç”¨å¤§å†™ã€‚

+ é¿å…å±‚çº§è¿‡æ·±çš„ URIã€‚è¶…è¿‡ 2 å±‚çš„èµ„æºåµŒå¥—ä¼šå¾ˆä¹±ï¼Œå»ºè®®å°†å…¶ä»–èµ„æºè½¬åŒ–ä¸º`?å‚æ•°`ï¼Œæ¯”å¦‚ï¼š

  ```bash
  /schools/tsinghua/classes/rooma/students/zhang # ä¸æ¨è
  /students?school=qinghua&class=rooma # æ¨è
  ```

  è¿™é‡Œæœ‰ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ï¼šåœ¨å®é™…çš„ API å¼€å‘ä¸­ï¼Œå¯èƒ½ä½ ä¼šå‘ç°æœ‰äº›æ“ä½œä¸èƒ½å¾ˆå¥½åœ°æ˜ å°„ä¸ºä¸€ä¸ª REST èµ„æºï¼Œè¿™æ—¶å€™ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„åšæ³•ã€‚

+ å°†ä¸€ä¸ªæ“ä½œå˜æˆèµ„æºçš„ä¸€ä¸ªå±æ€§ï¼Œæ¯”å¦‚æƒ³åœ¨ç³»ç»Ÿä¸­æš‚æ—¶ç¦ç”¨æŸä¸ªç”¨æˆ·ï¼Œå¯ä»¥è¿™ä¹ˆè®¾è®¡ URIï¼š`/users/zhangsan?active=false`ã€‚

+ å°†æ“ä½œå½“ä½œæ˜¯ä¸€ä¸ªèµ„æºçš„åµŒå¥—èµ„æºï¼Œæ¯”å¦‚ä¸€ä¸ª GitHub çš„åŠ æ˜Ÿæ“ä½œï¼š

  ```bash
  PUT /gists/:id/star # github star action
  DELETE /gists/:id/star # github unstar action
  ```

+ å¦‚æœä»¥ä¸Šéƒ½ä¸èƒ½è§£å†³é—®é¢˜ï¼Œæœ‰æ—¶å¯ä»¥æ‰“ç ´è¿™ç±»è§„èŒƒã€‚æ¯”å¦‚ç™»å½•æ“ä½œï¼Œç™»å½•ä¸å±äºä»»ä½•ä¸€ä¸ªèµ„æºï¼ŒURI å¯ä»¥è®¾è®¡ä¸ºï¼š`/login`ã€‚

åœ¨è®¾è®¡ URI æ—¶ï¼Œå¦‚æœä½ é‡åˆ°ä¸€äº›ä¸ç¡®å®šçš„åœ°æ–¹ï¼Œæ¨èä½ å‚è€ƒ [Github REST API](https://docs.github.com/en/rest)



#### REST èµ„æºæ“ä½œæ˜ å°„ä¸º HTTP æ–¹æ³•

åŸºæœ¬ä¸Š RESTful API éƒ½æ˜¯ä½¿ç”¨ HTTP åè®®åŸç”Ÿçš„ GETã€PUTã€POSTã€DELETE æ¥æ ‡è¯†å¯¹èµ„æºçš„ CRUD æ“ä½œçš„ï¼Œå½¢æˆçš„è§„èŒƒå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

![image-20230218113149402](http://sm.nsddd.top/sm202302181131476.png)



**å¯¹èµ„æºçš„æ“ä½œåº”è¯¥æ»¡è¶³å®‰å…¨æ€§å’Œå¹‚ç­‰æ€§ï¼š**

+ å®‰å…¨æ€§ï¼šä¸ä¼šæ”¹å˜èµ„æºçŠ¶æ€ï¼Œå¯ä»¥ç†è§£ä¸ºåªè¯»çš„ã€‚
+ å¹‚ç­‰æ€§ï¼šæ‰§è¡Œ 1 æ¬¡å’Œæ‰§è¡Œ N æ¬¡ï¼Œå¯¹èµ„æºçŠ¶æ€æ”¹å˜çš„æ•ˆæœæ˜¯ç­‰ä»·çš„ã€‚

> å¹‚ç­‰æ€§æ˜¯æŒ‡ä¸€ä¸ªæ“ä½œæˆ–è€…å‡½æ•°ï¼Œæ— è®ºè¢«è°ƒç”¨å¤šå°‘æ¬¡ï¼Œå…¶ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ã€‚ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ªå‡½æ•°å¯ä»¥è¿”å›å½“å‰æ—¥æœŸï¼Œé‚£ä¹ˆä¸ç®¡ä½ è°ƒç”¨å®ƒå¤šå°‘æ¬¡ï¼Œå®ƒéƒ½ä¼šè¿”å›å½“å‰æ—¥æœŸï¼š2023-02-18



**ä½¿ç”¨ä¸åŒ HTTP æ–¹æ³•æ—¶ï¼Œèµ„æºæ“ä½œçš„å®‰å…¨æ€§å’Œå¹‚ç­‰æ€§å¯¹ç…§è§ä¸‹è¡¨ï¼š**

![image-20230218113318572](http://sm.nsddd.top/sm202302181133618.png)

> ğŸ’¡ POSTæ–¹æ³•ä¸æ˜¯å¹‚ç­‰çš„ï¼Œå› ä¸ºå®ƒä¼šåœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºæ–°èµ„æºã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ å¤šæ¬¡å‘é€ç›¸åŒçš„POSTè¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¼šåˆ›å»ºå¤šä¸ªèµ„æºï¼Œå¯¼è‡´æ¯æ¬¡çš„ç»“æœéƒ½ä¸ä¸€æ ·ã€‚



**åœ¨ä½¿ç”¨ HTTP æ–¹æ³•çš„æ—¶å€™ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç‚¹éœ€è¦ä½ æ³¨æ„ï¼š**

+ GET è¿”å›çš„ç»“æœï¼Œè¦å°½é‡å¯ç”¨äº PUTã€POST æ“ä½œä¸­ã€‚ä¾‹å¦‚ï¼Œç”¨ GET æ–¹æ³•è·å¾—äº†ä¸€ä¸ª user çš„ä¿¡æ¯ï¼Œè°ƒç”¨è€…ä¿®æ”¹ user çš„é‚®ä»¶ï¼Œç„¶åå°†æ­¤ç»“æœå†ç”¨ PUT æ–¹æ³•æ›´æ–°ã€‚è¿™è¦æ±‚ GETã€PUTã€POST æ“ä½œçš„èµ„æºå±æ€§æ˜¯ä¸€è‡´çš„ã€‚
+ å¦‚æœå¯¹èµ„æºè¿›è¡Œ **çŠ¶æ€ / å±æ€§** å˜æ›´ï¼Œè¦ç”¨ PUT æ–¹æ³•ï¼ŒPOST æ–¹æ³•ä»…ç”¨æ¥åˆ›å»ºæˆ–è€…æ‰¹é‡åˆ é™¤è¿™ä¸¤ç§åœºæ™¯ã€‚



åœ¨è®¾è®¡ API æ—¶ï¼Œç»å¸¸ä¼šæœ‰æ‰¹é‡åˆ é™¤çš„éœ€æ±‚ï¼Œéœ€è¦åœ¨è¯·æ±‚ä¸­æºå¸¦å¤šä¸ªéœ€è¦åˆ é™¤çš„èµ„æºåï¼Œä½†æ˜¯ HTTP çš„ DELETE æ–¹æ³•ä¸èƒ½æºå¸¦å¤šä¸ªèµ„æºåï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰ç§æ–¹å¼æ¥è§£å†³ï¼š

+ å‘èµ·å¤šä¸ª DELETE è¯·æ±‚ã€‚
+ æ“ä½œè·¯å¾„ä¸­å¸¦å¤šä¸ª idï¼Œid ä¹‹é—´ç”¨åˆ†éš”ç¬¦åˆ†éš”, ä¾‹å¦‚ï¼š`DELETE /users?ids=1,2,3` 
+ ç›´æ¥ä½¿ç”¨ POST æ–¹å¼æ¥æ‰¹é‡åˆ é™¤ï¼Œbody ä¸­ä¼ å…¥éœ€è¦åˆ é™¤çš„èµ„æºåˆ—è¡¨ã€‚

æ¨èç¬¬äºŒç§æ–¹å¼ï¼Œä¸‰ç§æ–¹å¼éƒ½æœ‰è‡ªå·±çš„åœºæ™¯ï¼Œæ ¹æ®è‡ªå·±çš„éœ€è¦é€‰æ‹©ã€‚

**å¦‚æœé€‰æ‹©äº†æŸä¸€ç§æ–¹å¼ï¼Œé‚£ä¹ˆæ•´ä¸ªé¡¹ç›®éƒ½éœ€è¦ç»Ÿä¸€ç”¨è¿™ç§æ–¹å¼ã€‚**



#### ç»Ÿä¸€çš„è¿”å›æ ¼å¼

ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªç³»ç»Ÿçš„ RESTful API ä¼šå‘å¤–ç•Œå¼€æ”¾å¤šä¸ªèµ„æºçš„æ¥å£ï¼Œæ¯ä¸ªæ¥å£çš„è¿”å›æ ¼å¼è¦ä¿æŒä¸€è‡´ã€‚å¦å¤–ï¼Œæ¯ä¸ªæ¥å£éƒ½ä¼šè¿”å›æˆåŠŸå’Œå¤±è´¥ä¸¤ç§æ¶ˆæ¯ï¼Œè¿™ä¸¤ç§æ¶ˆæ¯çš„æ ¼å¼ä¹Ÿè¦ä¿æŒä¸€è‡´ã€‚ä¸ç„¶ï¼Œå®¢æˆ·ç«¯ä»£ç è¦é€‚é…ä¸åŒæ¥å£çš„è¿”å›æ ¼å¼ï¼Œ**æ¯ä¸ªè¿”å›æ ¼å¼åˆè¦é€‚é…æˆåŠŸå’Œå¤±è´¥ä¸¤ç§æ¶ˆæ¯æ ¼å¼ï¼Œä¼šå¤§å¤§å¢åŠ ç”¨æˆ·çš„å­¦ä¹ å’Œä½¿ç”¨æˆæœ¬ã€‚**



#### API ç‰ˆæœ¬ç®¡ç†

éšç€æ—¶é—´çš„æ¨ç§»ã€éœ€æ±‚çš„å˜æ›´ï¼Œä¸€ä¸ª API å¾€å¾€æ»¡è¶³ä¸äº†ç°æœ‰çš„éœ€æ±‚ï¼Œè¿™æ—¶å€™å°±éœ€è¦å¯¹ API è¿›è¡Œä¿®æ”¹ã€‚**å¯¹ API è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¸èƒ½å½±å“å…¶ä»–è°ƒç”¨ç³»ç»Ÿçš„æ­£å¸¸ä½¿ç”¨ï¼Œè¿™å°±è¦æ±‚ API å˜æ›´åšåˆ°å‘ä¸‹å…¼å®¹ï¼Œä¹Ÿå°±æ˜¯æ–°è€ç‰ˆæœ¬å…±å­˜ã€‚**

ä½†åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå¾ˆå¯èƒ½ä¼šå‡ºç°åŒä¸€ä¸ª API æ— æ³•å‘ä¸‹å…¼å®¹çš„æƒ…å†µã€‚è¿™æ—¶å€™æœ€å¥½çš„è§£å†³åŠæ³•æ˜¯ä»ä¸€å¼€å§‹å°±å¼•å…¥ API ç‰ˆæœ¬æœºåˆ¶ï¼Œå½“ä¸èƒ½å‘ä¸‹å…¼å®¹æ—¶ï¼Œå°±å¼•å…¥ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼Œè€çš„ç‰ˆæœ¬åˆ™ä¿ç•™åŸæ ·ã€‚è¿™æ ·æ—¢èƒ½ä¿è¯æœåŠ¡çš„å¯ç”¨æ€§å’Œå®‰å…¨æ€§ï¼ŒåŒæ—¶ä¹Ÿèƒ½æ»¡è¶³æ–°éœ€æ±‚ã€‚

**API ç‰ˆæœ¬æœ‰ä¸åŒçš„æ ‡è¯†æ–¹æ³•ï¼Œåœ¨ RESTful API å¼€å‘ä¸­ï¼Œé€šå¸¸å°†ç‰ˆæœ¬æ ‡è¯†æ”¾åœ¨å¦‚ä¸‹ 3 ä¸ªä½ç½®ï¼š**

+ URL ä¸­ï¼Œæ¯”å¦‚`/v1/users`ã€‚
+ HTTP Header ä¸­ï¼Œæ¯”å¦‚`Accept: vnd.example-com.foo+json; version=1.0`ã€‚
+ Form å‚æ•°ä¸­ï¼Œæ¯”å¦‚`/users?version=v1`ã€‚

æˆ‘ä»¬é€šå¸¸æŠŠç‰ˆæœ¬æ ‡è¯†æ˜¯æ”¾åœ¨ URL ä¸­çš„ï¼Œæ¯”å¦‚ `/v1/users`ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å¾ˆç›´è§‚ï¼ŒGitHubã€Kubernetesã€Etcd ç­‰å¾ˆå¤šä¼˜ç§€çš„ API å‡é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚

> è¿™é‡Œè¦æ³¨æ„ï¼Œæœ‰äº›å¼€å‘äººå‘˜ä¸å»ºè®®å°†ç‰ˆæœ¬æ”¾åœ¨ URL ä¸­ï¼Œå› ä¸ºä»–ä»¬è§‰å¾—ä¸åŒçš„ç‰ˆæœ¬å¯ä»¥ç†è§£æˆåŒä¸€ç§èµ„æºçš„ä¸åŒè¡¨ç°å½¢å¼ï¼Œæ‰€ä»¥åº”è¯¥é‡‡ç”¨åŒä¸€ä¸ª URIã€‚å¯¹äºè¿™ä¸€ç‚¹ï¼Œæ²¡æœ‰ä¸¥æ ¼çš„æ ‡å‡†ï¼Œæ ¹æ®é¡¹ç›®å®é™…éœ€è¦é€‰æ‹©ä¸€ç§æ–¹å¼å³å¯ã€‚



#### API å‘½å

API é€šå¸¸çš„å‘½åæ–¹å¼æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯é©¼å³°å‘½åæ³• (serverAddress)ã€è›‡å½¢å‘½åæ³• (server_address) å’Œè„ŠæŸ±å‘½åæ³• (server-address)ã€‚

é©¼å³°å‘½åæ³•å’Œè›‡å½¢å‘½åæ³•éƒ½éœ€è¦åˆ‡æ¢è¾“å…¥æ³•ï¼Œä¼šå¢åŠ æ“ä½œçš„å¤æ‚æ€§ï¼Œä¹Ÿå®¹æ˜“å‡ºé”™ï¼Œæ‰€ä»¥è¿™é‡Œ**å»ºè®®ç”¨è„ŠæŸ±å‘½åæ³•ã€‚**GitHub API ç”¨çš„å°±æ˜¯è„ŠæŸ±å‘½åæ³•ï¼Œä¾‹å¦‚ `selected-actions`ã€‚

> **é©¼å³°å‘½åæ³•(serverAddress)**
>
> + å­—æ¯é¦–å­—æ¯å¤§å†™
> + http://xxxx/getUser
>
> **è›‡å½¢å‘½åæ³•(server_address)**
>
> + ä¸‹åˆ’çº¿â€œ_â€åˆ†éš”
> + http://xxxx/get_user
>
> **è„ŠæŸ±å‘½åæ³•(server-address)**
>
> + â€œ-â€åˆ†éš”
> + http://xxxx/get-user



#### ç»Ÿä¸€åˆ†é¡µ / è¿‡æ»¤ / æ’åº / æœç´¢åŠŸèƒ½

REST èµ„æºçš„æŸ¥è¯¢æ¥å£ï¼Œé€šå¸¸æƒ…å†µä¸‹éƒ½éœ€è¦å®ç°åˆ†é¡µã€è¿‡æ»¤ã€æ’åºã€æœç´¢åŠŸèƒ½ï¼Œå› ä¸ºè¿™äº›åŠŸèƒ½æ˜¯æ¯ä¸ª REST èµ„æºéƒ½èƒ½ç”¨åˆ°çš„ï¼Œæ‰€ä»¥å¯ä»¥å®ç°ä¸ºä¸€ä¸ªå…¬å…±çš„ API ç»„ä»¶ã€‚ä¸‹é¢æ¥ä»‹ç»ä¸‹è¿™äº›åŠŸèƒ½ã€‚

+ åˆ†é¡µï¼šåœ¨åˆ—å‡ºä¸€ä¸ª Collection ä¸‹æ‰€æœ‰çš„ Member æ—¶ï¼Œåº”è¯¥æä¾›åˆ†é¡µåŠŸèƒ½ï¼Œä¾‹å¦‚`/users?offset=0&limit=20`ï¼ˆlimitï¼ŒæŒ‡å®šè¿”å›è®°å½•çš„æ•°é‡ï¼›offsetï¼ŒæŒ‡å®šè¿”å›è®°å½•çš„å¼€å§‹ä½ç½®ï¼‰ã€‚å¼•å…¥åˆ†é¡µåŠŸèƒ½å¯ä»¥å‡å°‘ API å“åº”çš„å»¶æ—¶ï¼ŒåŒæ—¶å¯ä»¥é¿å…è¿”å›å¤ªå¤šæ¡ç›®ï¼Œå¯¼è‡´æœåŠ¡å™¨ / å®¢æˆ·ç«¯å“åº”ç‰¹åˆ«æ…¢ï¼Œç”šè‡³å¯¼è‡´æœåŠ¡å™¨ / å®¢æˆ·ç«¯ crash çš„æƒ…å†µã€‚
+ è¿‡æ»¤ï¼šå¦‚æœç”¨æˆ·ä¸éœ€è¦ä¸€ä¸ªèµ„æºçš„å…¨éƒ¨çŠ¶æ€å±æ€§ï¼Œå¯ä»¥åœ¨ URI å‚æ•°é‡ŒæŒ‡å®šè¿”å›å“ªäº›å±æ€§ï¼Œä¾‹å¦‚`/users?fields=email,username,address`ã€‚
+ æ’åºï¼šç”¨æˆ·å¾ˆå¤šæ—¶å€™ä¼šæ ¹æ®åˆ›å»ºæ—¶é—´æˆ–è€…å…¶ä»–å› ç´ ï¼Œåˆ—å‡ºä¸€ä¸ª Collection ä¸­å‰ 100 ä¸ª Memberï¼Œè¿™æ—¶å¯ä»¥åœ¨ URI å‚æ•°ä¸­æŒ‡æ˜æ’åºå‚æ•°ï¼Œä¾‹å¦‚`/users?sort=age,desc`ã€‚
+ æœç´¢ï¼šå½“ä¸€ä¸ªèµ„æºçš„ Member å¤ªå¤šæ—¶ï¼Œç”¨æˆ·å¯èƒ½æƒ³é€šè¿‡æœç´¢ï¼Œå¿«é€Ÿæ‰¾åˆ°æ‰€éœ€è¦çš„ Memberï¼Œæˆ–ç€æƒ³æœä¸‹æœ‰æ²¡æœ‰åå­—ä¸º xxx çš„æŸç±»èµ„æºï¼Œè¿™æ—¶å€™å°±éœ€è¦æä¾›æœç´¢åŠŸèƒ½ã€‚æœç´¢å»ºè®®æŒ‰ **æ¨¡ç³ŠåŒ¹é…** æ¥æœç´¢ã€‚



#### åŸŸå

**API çš„åŸŸåè®¾ç½®ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š**

+ https://marmotedu.com/apiï¼Œè¿™ç§æ–¹å¼é€‚åˆ API å°†æ¥ä¸ä¼šæœ‰è¿›ä¸€æ­¥æ‰©å±•çš„æƒ…å†µï¼Œæ¯”å¦‚åˆšå¼€å§‹ marmotedu.com åŸŸåä¸‹åªæœ‰ä¸€å¥— API ç³»ç»Ÿï¼Œæœªæ¥ä¹Ÿåªæœ‰è¿™ä¸€å¥— API ç³»ç»Ÿã€‚
+ https://iam.api.marmotedu.comï¼Œå¦‚æœ marmotedu.com åŸŸåä¸‹æœªæ¥ä¼šæ–°å¢å¦ä¸€ä¸ªç³»ç»Ÿ APIï¼Œè¿™æ—¶å€™æœ€å¥½çš„æ–¹å¼æ˜¯æ¯ä¸ªç³»ç»Ÿçš„ API æ‹¥æœ‰ä¸“æœ‰çš„ API åŸŸåï¼Œæ¯”å¦‚ï¼š`storage.api.marmotedu.com`ï¼Œ`network.api.marmotedu.com`ã€‚è…¾è®¯äº‘çš„åŸŸåå°±æ˜¯é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚



**ä¸åŒå…¬å¸ã€ä¸åŒå›¢é˜Ÿã€ä¸åŒé¡¹ç›®å¯èƒ½é‡‡å–ä¸åŒçš„ REST è®¾è®¡åŸåˆ™ï¼Œä»¥ä¸Šæ‰€åˆ—çš„åŸºæœ¬ä¸Šéƒ½æ˜¯å¤§å®¶å…¬è®¤çš„åŸåˆ™ã€‚**

REST è®¾è®¡åŸåˆ™ä¸­ï¼Œè¿˜æœ‰ä¸€äº›åŸåˆ™å› ä¸ºå†…å®¹æ¯”è¾ƒå¤šï¼Œå¹¶ä¸”å¯ä»¥ç‹¬ç«‹æˆæ¨¡å—ï¼Œæ‰€ä»¥æ”¾åœ¨åé¢æ¥è®²ã€‚æ¯”å¦‚ RESTful API å®‰å…¨æ€§ã€çŠ¶æ€è¿”å›ç å’Œè®¤è¯ç­‰ã€‚



### REST ç¤ºä¾‹

ä¸Šé¢ä»‹ç»äº†ä¸€äº›æ¦‚å¿µå’ŒåŸåˆ™ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªâ€œHello Worldâ€ç¨‹åºï¼Œæ¥æ•™ä½ ç”¨ Go å¿«é€Ÿå¯åŠ¨ä¸€ä¸ª RESTful API æœåŠ¡ï¼Œç¤ºä¾‹ä»£ç å­˜æ”¾åœ¨ [gopractise-demo/apistyle/ping/main.go](https://github.com/marmotedu/gopractise-demo/blob/main/apistyle/ping/main.go)ã€‚

```go
package main

import (
	"log"
	"net/http"
)

func main() {
	http.HandleFunc("/ping", pong)
	log.Println("Starting http server ...")
	log.Fatal(http.ListenAndServe(":50052", nil))
}

func pong(w http.ResponseWriter, r *http.Request) {
	w.Write([]byte("pong"))
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ `http.HandleFunc`ï¼Œå‘ HTTP æœåŠ¡æ³¨å†Œäº†ä¸€ä¸ª pong handlerï¼Œåœ¨ pong handler ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™äº†çœŸå®çš„ä¸šåŠ¡ä»£ç ï¼šè¿”å› pong å­—ç¬¦ä¸²ã€‚

åˆ›å»ºå®Œ main.go æ–‡ä»¶åï¼Œåœ¨å½“å‰ç›®å½•ä¸‹æ‰§è¡Œ `go run main.go` å¯åŠ¨ HTTP æœåŠ¡ï¼Œåœ¨ä¸€ä¸ªæ–°çš„ Linux ç»ˆç«¯ä¸‹å‘é€ HTTP è¯·æ±‚ï¼Œè¿›è¡Œä½¿ç”¨ curl å‘½ä»¤æµ‹è¯•ï¼š

```bash
$ curl http://127.0.0.1:50052/ping
pong
```



### æ€»ç»“

åœ¨ REST è§„èŒƒä¸­ï¼Œèµ„æºé€šè¿‡ URI æ¥æ ‡è¯†ï¼Œèµ„æºåä½¿ç”¨åè¯è€Œä¸æ˜¯åŠ¨è¯ï¼Œå¹¶ä¸”ç”¨åè¯å¤æ•°è¡¨ç¤ºï¼Œèµ„æºéƒ½æ˜¯åˆ†ä¸º Collection å’Œ Member ä¸¤ç§ã€‚RESTful API ä¸­ï¼Œåˆ†åˆ«ä½¿ç”¨ POSTã€DELETEã€PUTã€GET æ¥è¡¨ç¤º REST èµ„æºçš„å¢åˆ æ”¹æŸ¥ï¼ŒHTTP æ–¹æ³•ã€Collectionã€Member ä¸åŒç»„åˆä¼šäº§ç”Ÿä¸åŒçš„æ“ä½œã€‚

ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨å’Œç†è§£ï¼Œæ¯ä¸ª RESTful API çš„è¿”å›æ ¼å¼ã€é”™è¯¯å’Œæ­£ç¡®æ¶ˆæ¯çš„è¿”å›æ ¼å¼ï¼Œéƒ½åº”è¯¥ä¿æŒä¸€è‡´ã€‚RESTful API éœ€è¦æ”¯æŒ API ç‰ˆæœ¬ï¼Œå¹¶ä¸”ç‰ˆæœ¬åº”è¯¥èƒ½å¤Ÿå‘å‰å…¼å®¹ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç‰ˆæœ¬å·æ”¾åœ¨ URL ä¸­ã€HTTP Header ä¸­ã€Form å‚æ•°ä¸­ï¼Œä½†è¿™é‡Œæˆ‘å»ºè®®å°†ç‰ˆæœ¬å·æ”¾åœ¨ URL ä¸­ï¼Œä¾‹å¦‚ `/v1/users`ï¼Œè¿™ç§å½¢å¼æ¯”è¾ƒç›´è§‚ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è„ŠæŸ±å‘½åæ³•æ¥å‘½å API æ¥å£åã€‚å¯¹äºä¸€ä¸ª REST èµ„æºï¼Œå…¶æŸ¥è¯¢æ¥å£è¿˜åº”è¯¥æ”¯æŒåˆ†é¡µ / è¿‡æ»¤ / æ’åº / æœç´¢åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½å¯ä»¥ç”¨åŒä¸€å¥—æœºåˆ¶æ¥å®ç°ã€‚ API çš„åŸŸåå¯ä»¥é‡‡ç”¨ https://marmotedu.com/api å’Œ https://iam.api.marmotedu.com ä¸¤ç§æ ¼å¼ã€‚



## å¦‚ä½•è®¾è®¡åº”ç”¨çš„RPC API é£æ ¼

åœ¨ Go é¡¹ç›®å¼€å‘ä¸­ï¼Œå¦‚æœä¸šåŠ¡å¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¹¶ä¸”éœ€è¦æä¾›ç»™å¤šç§ç¼–ç¨‹è¯­è¨€è°ƒç”¨ï¼Œè¿™æ—¶å€™å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ RPC API æ¥å£ã€‚RPC åœ¨ Go é¡¹ç›®å¼€å‘ä¸­ç”¨å¾—ä¹Ÿéå¸¸å¤šã€‚



### RPC ä»‹ç»

**Wikipediaï¼š**

[åˆ†å¸ƒå¼è®¡ç®—](https://zh.wikipedia.org/wiki/åˆ†å¸ƒå¼è®¡ç®—)ä¸­ï¼Œ**è¿œç¨‹è¿‡ç¨‹è°ƒç”¨**ï¼ˆè‹±è¯­ï¼š**R**emote **P**rocedure **C**allï¼Œ**RPC**ï¼‰æ˜¯ä¸€ä¸ªè®¡ç®—æœºé€šä¿¡[åè®®](https://zh.wikipedia.org/wiki/ç¶²çµ¡å‚³è¼¸å”è­°)ã€‚è¯¥åè®®å…è®¸è¿è¡Œäºä¸€å°è®¡ç®—æœºçš„[ç¨‹åº](https://zh.wikipedia.org/wiki/ç¨‹åº)è°ƒç”¨å¦ä¸€ä¸ª[åœ°å€ç©ºé—´](https://zh.wikipedia.org/wiki/åœ°å€ç©ºé—´)ï¼ˆé€šå¸¸ä¸ºä¸€ä¸ªå¼€æ”¾ç½‘ç»œçš„ä¸€å°è®¡ç®—æœºï¼‰çš„[å­ç¨‹åº](https://zh.wikipedia.org/wiki/å­ç¨‹åº)ï¼Œè€Œç¨‹åºå‘˜å°±åƒè°ƒç”¨æœ¬åœ°ç¨‹åºä¸€æ ·ï¼Œæ— éœ€é¢å¤–åœ°ä¸ºè¿™ä¸ªäº¤äº’ä½œç”¨ç¼–ç¨‹ï¼ˆç¨‹åºå‘˜æ— éœ€å…³æ³¨ç»†èŠ‚ï¼‰ã€‚RPCæ˜¯ä¸€ç§ **æœåŠ¡å™¨-å®¢æˆ·ç«¯**ï¼ˆClient/Serverï¼‰æ¨¡å¼ï¼Œç»å…¸å®ç°æ˜¯ä¸€ä¸ªé€šè¿‡**å‘é€è¯·æ±‚-æ¥å—å›åº”**è¿›è¡Œä¿¡æ¯äº¤äº’çš„ç³»ç»Ÿã€‚

å¦‚æœæ¶‰åŠçš„è½¯ä»¶é‡‡ç”¨[é¢å‘å¯¹è±¡ç¼–ç¨‹](https://zh.wikipedia.org/wiki/é¢å‘å¯¹è±¡ç¼–ç¨‹)ï¼Œé‚£ä¹ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨äº¦å¯ç§°ä½œ**è¿œç¨‹è°ƒç”¨**æˆ–**è¿œç¨‹æ–¹æ³•è°ƒç”¨**ï¼Œä¾‹ï¼š[Java RMI](https://zh.wikipedia.org/wiki/Java_RMI)ã€‚

RPCæ˜¯ä¸€ç§[è¿›ç¨‹é—´é€šä¿¡](https://zh.wikipedia.org/wiki/è¿›ç¨‹é—´é€šä¿¡)çš„æ¨¡å¼ï¼Œç¨‹åºåˆ†å¸ƒåœ¨ä¸åŒçš„[åœ°å€ç©ºé—´](https://zh.wikipedia.org/wiki/åœ°å€ç©ºé—´)é‡Œã€‚å¦‚æœåœ¨åŒä¸€ä¸»æœºé‡Œï¼ŒRPCå¯ä»¥é€šè¿‡ä¸åŒçš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆå³ä¾¿ä½¿ç”¨ç›¸åŒçš„ç‰©ç†åœ°å€ï¼‰è¿›è¡Œé€šè®¯ï¼Œè€Œåœ¨ä¸åŒçš„ä¸»æœºé—´ï¼Œåˆ™é€šè¿‡ä¸åŒçš„ç‰©ç†åœ°å€è¿›è¡Œäº¤äº’ã€‚è®¸å¤šæŠ€æœ¯ï¼ˆé€šå¸¸æ˜¯ä¸å…¼å®¹ï¼‰éƒ½æ˜¯åŸºäºè¿™ç§æ¦‚å¿µè€Œå®ç°çš„ã€‚

é€šä¿—æ¥è®²ï¼Œ**å°±æ˜¯æœåŠ¡ç«¯å®ç°äº†ä¸€ä¸ªå‡½æ•°ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨ RPC æ¡†æ¶æä¾›çš„æ¥å£ï¼Œåƒè°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¹¶è·å–è¿”å›å€¼ã€‚**RPC å±è”½äº†åº•å±‚çš„ç½‘ç»œé€šä¿¡ç»†èŠ‚ï¼Œä½¿å¾—å¼€å‘äººå‘˜æ— éœ€å…³æ³¨ç½‘ç»œç¼–ç¨‹çš„ç»†èŠ‚ï¼Œå¯ä»¥å°†æ›´å¤šçš„æ—¶é—´å’Œç²¾åŠ›æ”¾åœ¨ä¸šåŠ¡é€»è¾‘æœ¬èº«çš„å®ç°ä¸Šï¼Œä»è€Œæé«˜å¼€å‘æ•ˆç‡ã€‚

![image-20230218122118946](http://sm.nsddd.top/sm202302181221040.png)

**RPC è°ƒç”¨å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š**

1. Client é€šè¿‡æœ¬åœ°è°ƒç”¨ï¼Œè°ƒç”¨ Client Stubã€‚
2. Client Stub å°†å‚æ•°æ‰“åŒ…ï¼ˆä¹Ÿå« Marshallingï¼‰æˆä¸€ä¸ªæ¶ˆæ¯ï¼Œç„¶åå‘é€è¿™ä¸ªæ¶ˆæ¯ã€‚
3. Client æ‰€åœ¨çš„ OS å°†æ¶ˆæ¯å‘é€ç»™ Serverã€‚
4. Server ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œå°†æ¶ˆæ¯ä¼ é€’ç»™ Server Stubã€‚
5. Server Stub å°†æ¶ˆæ¯è§£åŒ…ï¼ˆä¹Ÿå« Unmarshallingï¼‰å¾—åˆ°å‚æ•°ã€‚
6. Server Stub è°ƒç”¨æœåŠ¡ç«¯çš„å­ç¨‹åºï¼ˆå‡½æ•°ï¼‰ï¼Œå¤„ç†å®Œåï¼Œå°†æœ€ç»ˆç»“æœæŒ‰ç…§ç›¸åçš„æ­¥éª¤è¿”å›ç»™ Clientã€‚

è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œ**Stub è´Ÿè´£è°ƒç”¨å‚æ•°å’Œè¿”å›å€¼çš„æµåŒ–ï¼ˆserializationï¼‰ã€å‚æ•°çš„æ‰“åŒ…å’Œè§£åŒ…ï¼Œä»¥åŠç½‘ç»œå±‚çš„é€šä¿¡ã€‚Client ç«¯ä¸€èˆ¬å« Stubï¼ŒServer ç«¯ä¸€èˆ¬å« Skeletonã€‚**

ç›®å‰ï¼Œä¸šç•Œæœ‰å¾ˆå¤šä¼˜ç§€çš„ RPC åè®®ï¼Œä¾‹å¦‚è…¾è®¯çš„ Tarsã€é˜¿é‡Œçš„ Dubboã€å¾®åšçš„ Motanã€Facebook çš„ Thriftã€RPCXï¼Œç­‰ç­‰ã€‚ä½†ä½¿ç”¨æœ€å¤šçš„è¿˜æ˜¯ [gRPC](https://github.com/grpc/grpc-go)ã€‚



### gRPC

gRPC æ˜¯ç”± Google å¼€å‘çš„é«˜æ€§èƒ½ã€å¼€æºã€è·¨å¤šç§ç¼–ç¨‹è¯­è¨€çš„é€šç”¨ RPC æ¡†æ¶ï¼ŒåŸºäº HTTP 2.0 åè®®å¼€å‘ï¼Œé»˜è®¤é‡‡ç”¨ Protocol Buffers æ•°æ®åºåˆ—åŒ–åè®®ã€‚gRPC å…·æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š

+ æ”¯æŒå¤šç§è¯­è¨€ï¼Œä¾‹å¦‚ Goã€Javaã€Cã€C++ã€C#ã€Node.jsã€PHPã€Pythonã€Ruby ç­‰ã€‚
+ åŸºäº IDLï¼ˆInterface Definition Languageï¼‰æ–‡ä»¶å®šä¹‰æœåŠ¡ï¼Œé€šè¿‡ proto3 å·¥å…·ç”ŸæˆæŒ‡å®šè¯­è¨€çš„æ•°æ®ç»“æ„ã€æœåŠ¡ç«¯æ¥å£ä»¥åŠå®¢æˆ·ç«¯ Stubã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä¹Ÿå¯ä»¥å°†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è§£è€¦ï¼Œä½¿å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯ä»¥å¹¶è¡Œå¼€å‘ã€‚
+ é€šä¿¡åè®®åŸºäºæ ‡å‡†çš„ HTTP/2 è®¾è®¡ï¼Œæ”¯æŒåŒå‘æµã€æ¶ˆæ¯å¤´å‹ç¼©ã€å• TCP çš„å¤šè·¯å¤ç”¨ã€æœåŠ¡ç«¯æ¨é€ç­‰ç‰¹æ€§ã€‚
+ æ”¯æŒ Protobuf å’Œ JSON åºåˆ—åŒ–æ•°æ®æ ¼å¼ã€‚Protobuf æ˜¯ä¸€ç§è¯­è¨€æ— å…³çš„é«˜æ€§èƒ½åºåˆ—åŒ–æ¡†æ¶ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œä¼ è¾“æµé‡ï¼Œæé«˜é€šä¿¡æ•ˆç‡ã€‚

è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼ŒgRPC çš„å…¨ç§°ä¸æ˜¯ golang Remote Procedure Callï¼Œè€Œæ˜¯ google Remote Procedure Call ğŸ¤”ã€‚

**gRPC çš„è°ƒç”¨å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š**

![image-20230218123040470](http://sm.nsddd.top/sm202302181230536.png)

**åœ¨ gRPC ä¸­ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç›´æ¥è°ƒç”¨éƒ¨ç½²åœ¨ä¸åŒæœºå™¨ä¸Šçš„ gRPC æœåŠ¡æ‰€æä¾›çš„æ–¹æ³•ï¼Œè°ƒç”¨è¿œç«¯çš„ gRPC æ–¹æ³•å°±åƒè°ƒç”¨æœ¬åœ°çš„æ–¹æ³•ä¸€æ ·ï¼Œéå¸¸ç®€å•æ–¹ä¾¿ï¼Œé€šè¿‡ gRPC è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸å®¹æ˜“åœ°æ„å»ºå‡ºä¸€ä¸ªåˆ†å¸ƒå¼åº”ç”¨ã€‚**



### gRPC ç‰¹ç‚¹

åƒå¾ˆå¤šå…¶ä»–çš„ RPC æœåŠ¡ä¸€æ ·ï¼ŒgRPC ä¹Ÿæ˜¯é€šè¿‡ IDL è¯­è¨€ (IDLæ˜¯äº¤äº’å¼æ•°æ®è¯­è¨€çš„ç¼©å†™ï¼Œæ˜¯ä¸€ç§ç”¨äºæ•°æ®åˆ†æçš„ç¼–ç¨‹è¯­è¨€)ï¼Œé¢„å…ˆå®šä¹‰å¥½æ¥å£ï¼ˆæ¥å£çš„åå­—ã€ä¼ å…¥å‚æ•°å’Œè¿”å›å‚æ•°ç­‰ï¼‰ã€‚åœ¨æœåŠ¡ç«¯ï¼ŒgRPC æœåŠ¡å®ç°æˆ‘ä»¬æ‰€å®šä¹‰çš„æ¥å£ã€‚åœ¨å®¢æˆ·ç«¯ï¼ŒgRPC å­˜æ ¹æä¾›äº†è·ŸæœåŠ¡ç«¯ç›¸åŒçš„æ–¹æ³•ã€‚

gRPC æ”¯æŒå¤šç§è¯­è¨€ï¼Œæ¯”å¦‚**æˆ‘ä»¬å¯ä»¥ç”¨ Go è¯­è¨€å®ç° gRPC æœåŠ¡ï¼Œå¹¶é€šè¿‡ Java è¯­è¨€å®¢æˆ·ç«¯è°ƒç”¨ gRPC æœåŠ¡æ‰€æä¾›çš„æ–¹æ³•ã€‚** é€šè¿‡å¤šè¯­è¨€æ”¯æŒï¼Œæˆ‘ä»¬ç¼–å†™çš„ gRPC æœåŠ¡èƒ½æ»¡è¶³å®¢æˆ·ç«¯å¤šè¯­è¨€çš„éœ€æ±‚ã€‚

gRPC API æ¥å£é€šå¸¸ä½¿ç”¨çš„æ•°æ®ä¼ è¾“æ ¼å¼æ˜¯ Protocol Buffersã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä¸€èµ·äº†è§£ä¸‹ Protocol Buffersã€‚



### Protocol Buffers

+ [github project address](https://github.com/protocolbuffers/protobuf)

Protocol Buffersï¼ˆProtocolBuffer/ protobufï¼‰æ˜¯ Google å¼€å‘çš„ä¸€å¥—å¯¹æ•°æ®ç»“æ„è¿›è¡Œåºåˆ—åŒ–çš„æ–¹æ³•ï¼Œå¯ç”¨ä½œï¼ˆæ•°æ®ï¼‰é€šä¿¡åè®®ã€æ•°æ®å­˜å‚¨æ ¼å¼ç­‰ï¼Œä¹Ÿæ˜¯ä¸€ç§æ›´åŠ çµæ´»ã€é«˜æ•ˆçš„æ•°æ®æ ¼å¼ï¼Œä¸ XMLã€JSON ç±»ä¼¼ã€‚å®ƒçš„ä¼ è¾“æ€§èƒ½éå¸¸å¥½ï¼Œæ‰€ä»¥å¸¸è¢«ç”¨åœ¨ä¸€äº›å¯¹æ•°æ®ä¼ è¾“æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜çš„ç³»ç»Ÿä¸­ï¼Œä½œä¸ºæ•°æ®ä¼ è¾“æ ¼å¼ã€‚

> ç»´åŸºç™¾ç§‘ï¼š**Protocol Buffers**ï¼ˆç®€ç§°ï¼šProtoBufï¼‰æ˜¯ä¸€ç§å¼€æºè·¨å¹³å°çš„[åºåˆ—åŒ–](https://zh.wikipedia.org/wiki/åºåˆ—åŒ–)æ•°æ®ç»“æ„çš„åè®®ã€‚å…¶å¯¹äºå­˜å‚¨èµ„æ–™æˆ–åœ¨ç½‘ç»œä¸Šè¿›è¡Œé€šä¿¡çš„ç¨‹åºæ˜¯å¾ˆæœ‰ç”¨çš„ã€‚è¿™ä¸ªæ–¹æ³•åŒ…å«ä¸€ä¸ª[æ¥å£æè¿°è¯­è¨€](https://zh.wikipedia.org/wiki/æ¥å£æè¿°è¯­è¨€)ï¼Œæè¿°ä¸€äº›æ•°æ®ç»“æ„ï¼Œå¹¶æä¾›ç¨‹åºå·¥å…·æ ¹æ®è¿™äº›æè¿°äº§ç”Ÿä»£ç ï¼Œè¿™äº›ä»£ç å°†ç”¨æ¥ç”Ÿæˆæˆ–è§£æä»£è¡¨è¿™äº›æ•°æ®ç»“æ„çš„å­—èŠ‚æµã€‚

Protocol Buffers çš„ä¸»è¦ç‰¹æ€§æœ‰ä¸‹é¢è¿™å‡ ä¸ªã€‚

+ æ›´å¿«çš„æ•°æ®ä¼ è¾“é€Ÿåº¦ï¼šprotobuf åœ¨ä¼ è¾“æ—¶ï¼Œä¼šå°†æ•°æ®åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œå’Œ XMLã€JSON çš„æ–‡æœ¬ä¼ è¾“æ ¼å¼ç›¸æ¯”ï¼Œè¿™å¯ä»¥èŠ‚çœå¤§é‡çš„ IO æ“ä½œï¼ˆæ›´å°‘çš„å†…å­˜ï¼‰ï¼Œä»è€Œæé«˜æ•°æ®ä¼ è¾“é€Ÿåº¦ã€‚
+ è·¨å¹³å°å¤šè¯­è¨€ï¼šprotobuf è‡ªå¸¦çš„ç¼–è¯‘å·¥å…· protoc å¯ä»¥åŸºäº protobuf å®šä¹‰æ–‡ä»¶ï¼Œç¼–è¯‘å‡ºä¸åŒè¯­è¨€çš„å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡ç«¯ï¼Œä¾›ç¨‹åºç›´æ¥è°ƒç”¨ï¼Œå› æ­¤å¯ä»¥æ»¡è¶³å¤šè¯­è¨€éœ€æ±‚çš„åœºæ™¯ã€‚
+ å…·æœ‰éå¸¸å¥½çš„æ‰©å±•æ€§å’Œå…¼å®¹æ€§ï¼Œå¯ä»¥æ›´æ–°å·²æœ‰çš„æ•°æ®ç»“æ„ï¼Œè€Œä¸ç ´åå’Œå½±å“åŸæœ‰çš„ç¨‹åºã€‚
+ åŸºäº IDL æ–‡ä»¶å®šä¹‰æœåŠ¡ï¼Œé€šè¿‡ proto3 å·¥å…·ç”ŸæˆæŒ‡å®šè¯­è¨€çš„æ•°æ®ç»“æ„ã€æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ¥å£ã€‚

**åœ¨ gRPC çš„æ¡†æ¶ä¸­ï¼ŒProtocol Buffers ä¸»è¦æœ‰ä¸‰ä¸ªä½œç”¨ã€‚**

**ç¬¬ä¸€ï¼Œå¯ä»¥ç”¨æ¥å®šä¹‰æ•°æ®ç»“æ„ã€‚**

```protobuf
// SecretInfo contains secret details.
message SecretInfo {
    string name = 1;
    string secret_id  = 2;
    string username   = 3;
    string secret_key = 4;
    int64 expires = 5;
    string description = 6;
    string created_at = 7;
    string updated_at = 8;
}
```

ç¬¬äºŒï¼Œå¯ä»¥ç”¨æ¥å®šä¹‰æœåŠ¡æ¥å£ã€‚ä¸‹é¢çš„ä»£ç å®šä¹‰äº†ä¸€ä¸ª Cache æœåŠ¡ï¼ŒæœåŠ¡åŒ…å«äº† ListSecrets å’Œ ListPolicies ä¸¤ä¸ª API æ¥å£ã€‚

```protobuf
// Cache implements a cache rpc service.
service Cache{
  rpc ListSecrets(ListSecretsRequest) returns (ListSecretsResponse) {}
  rpc ListPolicies(ListPoliciesRequest) returns (ListPoliciesResponse) {}
}
```

ç¬¬ä¸‰ï¼Œå¯ä»¥é€šè¿‡ protobuf åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæå‡ä¼ è¾“æ•ˆç‡ã€‚



### gRPC ç¤ºä¾‹

è¿è¡Œæœ¬ç¤ºä¾‹éœ€è¦åœ¨ Linux æœåŠ¡å™¨ä¸Šå®‰è£… Go ç¼–è¯‘å™¨ã€Protocol buffer ç¼–è¯‘å™¨ï¼ˆprotocï¼Œv3ï¼‰å’Œ protoc çš„ Go è¯­è¨€æ’ä»¶ã€‚

**è¿™ä¸ªç¤ºä¾‹åˆ†ä¸ºä¸‹é¢å‡ ä¸ªæ­¥éª¤ï¼š**

1. å®šä¹‰ gRPC æœåŠ¡ã€‚
2. ç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä»£ç ã€‚
3. å®ç° gRPC æœåŠ¡ã€‚
4. å®ç° gRPC å®¢æˆ·ç«¯ã€‚

**ä½ç½®åœ¨ï¼šhttps://github.com/marmotedu/gopractise-demo/tree/main/apistyle/greeter**

```bash
$ tree
â”œâ”€â”€ client
â”‚   â””â”€â”€ main.go
â”œâ”€â”€ helloworld
â”‚   â”œâ”€â”€ helloworld.pb.go
â”‚   â””â”€â”€ helloworld.proto
â””â”€â”€ server
    â””â”€â”€ main.go
```

client ç›®å½•å­˜æ”¾ Client ç«¯çš„ä»£ç ï¼Œhelloworld ç›®å½•ç”¨æ¥å­˜æ”¾æœåŠ¡çš„ IDL å®šä¹‰ï¼Œserver ç›®å½•ç”¨æ¥å­˜æ”¾ Server ç«¯çš„ä»£ç ã€‚




#### å®šä¹‰ gRPC æœåŠ¡

é¦–å…ˆï¼Œéœ€è¦å®šä¹‰æˆ‘ä»¬çš„æœåŠ¡ã€‚è¿›å…¥ helloworld ç›®å½•ï¼Œæ–°å»ºæ–‡ä»¶ `helloworld.proto`ï¼š

```bash
$ cd helloworld
$ touch helloworld.proto
```

**è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š**

```protobuf
$ cat >> phelloworld.proto <<EOF

syntax = "proto3";

option go_package = "github.com/marmotedu/gopractise-demo/apistyle/greeter/helloworld";

package helloworld;

// The greeting service definition.
service Greeter {
  // Sends a greeting
  rpc SayHello (HelloRequest) returns (HelloReply) {}
}

// The request message containing the user's name.
message HelloRequest {
  string name = 1;
}

// The response message containing the greetings
message HelloReply {
  string message = 1;
}
EOF
```

åœ¨ `helloworld.proto` å®šä¹‰æ–‡ä»¶ä¸­ï¼Œoption å…³é”®å­—ç”¨æ¥å¯¹`.proto` æ–‡ä»¶è¿›è¡Œä¸€äº›è®¾ç½®ï¼Œå…¶ä¸­ `go_package` æ˜¯å¿…éœ€çš„è®¾ç½®ï¼Œè€Œä¸” `go_package` çš„å€¼å¿…é¡»æ˜¯åŒ…å¯¼å…¥çš„è·¯å¾„ã€‚package å…³é”®å­—æŒ‡å®šç”Ÿæˆçš„`.pb.go` æ–‡ä»¶æ‰€åœ¨çš„åŒ…åã€‚æˆ‘ä»¬é€šè¿‡ service å…³é”®å­—å®šä¹‰æœåŠ¡ï¼Œç„¶åå†æŒ‡å®šè¯¥æœåŠ¡æ‹¥æœ‰çš„ RPC æ–¹æ³•ï¼Œå¹¶å®šä¹‰æ–¹æ³•çš„è¯·æ±‚å’Œè¿”å›çš„ç»“æ„ä½“ç±»å‹ï¼š

```protobuf
service Greeter {
  // Sends a greeting
  rpc SayHello (HelloRequest) returns (HelloReply) {}
}
```

gRPC æ”¯æŒå®šä¹‰ 4 ç§ç±»å‹çš„æœåŠ¡æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ç®€å•æ¨¡å¼ã€æœåŠ¡ç«¯æ•°æ®æµæ¨¡å¼ã€å®¢æˆ·ç«¯æ•°æ®æµæ¨¡å¼å’ŒåŒå‘æ•°æ®æµæ¨¡å¼ã€‚

+ ç®€å•æ¨¡å¼ï¼ˆSimple RPCï¼‰ï¼šæ˜¯æœ€ç®€å•çš„ gRPC æ¨¡å¼ã€‚å®¢æˆ·ç«¯å‘èµ·ä¸€æ¬¡è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å“åº”ä¸€ä¸ªæ•°æ®ã€‚å®šä¹‰æ ¼å¼ä¸º `rpc SayHello (HelloRequest) returns (HelloReply) {}`ã€‚
+ æœåŠ¡ç«¯æ•°æ®æµæ¨¡å¼ï¼ˆServer-side streaming RPCï¼‰ï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›æ•°æ®æµå“åº”ï¼Œå®¢æˆ·ç«¯ä»æµä¸­è¯»å–æ•°æ®ç›´åˆ°ä¸ºç©ºã€‚å®šä¹‰æ ¼å¼ä¸º `rpc SayHello (HelloRequest) returns (stream HelloReply) {}`ã€‚
+ å®¢æˆ·ç«¯æ•°æ®æµæ¨¡å¼ï¼ˆClient-side streaming RPCï¼‰ï¼šå®¢æˆ·ç«¯å°†æ¶ˆæ¯ä»¥æµçš„æ–¹å¼å‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å…¨éƒ¨å¤„ç†å®Œæˆä¹‹åè¿”å›ä¸€æ¬¡å“åº”ã€‚å®šä¹‰æ ¼å¼ä¸º rpc SayHello (stream HelloRequest) returns (HelloReply) {}ã€‚
+ åŒå‘æ•°æ®æµæ¨¡å¼ï¼ˆBidirectional streaming RPCï¼‰ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½å¯ä»¥å‘å¯¹æ–¹å‘é€æ•°æ®æµï¼Œè¿™ä¸ªæ—¶å€™åŒæ–¹çš„æ•°æ®å¯ä»¥åŒæ—¶äº’ç›¸å‘é€ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å®ç°å®æ—¶äº¤äº’ RPC æ¡†æ¶åŸç†ã€‚å®šä¹‰æ ¼å¼ä¸º `rpc SayHello (stream HelloRequest) returns (stream HelloReply) {}`ã€‚

æœ¬ç¤ºä¾‹ä½¿ç”¨äº†ç®€å•æ¨¡å¼ã€‚`.proto` æ–‡ä»¶ä¹ŸåŒ…å«äº† Protocol Buffers æ¶ˆæ¯çš„å®šä¹‰ï¼ŒåŒ…æ‹¬è¯·æ±‚æ¶ˆæ¯å’Œè¿”å›æ¶ˆæ¯ã€‚ä¾‹å¦‚è¯·æ±‚æ¶ˆæ¯ï¼š

```protobuf
// The request message containing the user's name.
message HelloRequest {
  string name = 1;
}
```



#### ç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä»£ç 

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ® `.proto` æœåŠ¡å®šä¹‰ç”Ÿæˆ gRPC å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ¥å£ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `protoc` ç¼–è¯‘å·¥å…·ï¼Œå¹¶æŒ‡å®šä½¿ç”¨å…¶ Go è¯­è¨€æ’ä»¶æ¥ç”Ÿæˆï¼š

```bash
$ protoc -I. --go_out=plugins=grpc:$GOPATH/src helloworld.proto
$ ls
helloworld.pb.go  helloworld.proto
```

ä½ å¯ä»¥çœ‹åˆ°ï¼Œæ–°å¢äº†ä¸€ä¸ª `helloworld.pb.go` æ–‡ä»¶ã€‚



#### å®ç° gRPC æœåŠ¡

æ¥ç€ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç° gRPC æœåŠ¡äº†ã€‚è¿›å…¥ server ç›®å½•ï¼Œæ–°å»º main.go æ–‡ä»¶ï¼š

```bash
$ cd ../server
$ vi main.go
```

main.go å†…å®¹å¦‚ä¸‹ï¼š

```go

// Package main implements a server for Greeter service.
package main

import (
  "context"
  "log"
  "net"

  pb "github.com/marmotedu/gopractise-demo/apistyle/greeter/helloworld"
  "google.golang.org/grpc"
)

const (
  port = ":50051"
)

// server is used to implement helloworld.GreeterServer.
type server struct {
  pb.UnimplementedGreeterServer
}

// SayHello implements helloworld.GreeterServer
func (s *server) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) {
  log.Printf("Received: %v", in.GetName())
  return &pb.HelloReply{Message: "Hello " + in.GetName()}, nil
}

func main() {
  lis, err := net.Listen("tcp", port)
  if err != nil {
    log.Fatalf("failed to listen: %v", err)
  }
  s := grpc.NewServer()
  pb.RegisterGreeterServer(s, &server{})
  if err := s.Serve(lis); err != nil {
    log.Fatalf("failed to serve: %v", err)
  }
}
```

ä¸Šé¢çš„ä»£ç å®ç°äº†æˆ‘ä»¬ä¸Šä¸€æ­¥æ ¹æ®æœåŠ¡å®šä¹‰ç”Ÿæˆçš„ Go æ¥å£ã€‚

æˆ‘ä»¬å…ˆå®šä¹‰äº†ä¸€ä¸ª Go ç»“æ„ä½“ serverï¼Œå¹¶ä¸º server ç»“æ„ä½“æ·»åŠ `SayHello(context.Context, pb.HelloRequest) (pb.HelloReply, error)`æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ server æ˜¯ GreeterServer æ¥å£ï¼ˆä½äº `helloworld.pb.go` æ–‡ä»¶ä¸­ï¼‰çš„ä¸€ä¸ªå®ç°ã€‚

åœ¨æˆ‘ä»¬å®ç°äº† gRPC æœåŠ¡æ‰€å®šä¹‰çš„æ–¹æ³•ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡ `net.Listen(...)` æŒ‡å®šç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚çš„ç«¯å£ï¼›æ¥ç€ï¼Œé€šè¿‡ `grpc.NewServer()` åˆ›å»ºä¸€ä¸ª gRPC Server å®ä¾‹ï¼Œå¹¶é€šè¿‡ `pb.RegisterGreeterServer(s, &server{})` å°†è¯¥æœåŠ¡æ³¨å†Œåˆ° gRPC æ¡†æ¶ä¸­ï¼›æœ€åï¼Œé€šè¿‡ `s.Serve(lis)` å¯åŠ¨ gRPC æœåŠ¡ã€‚

åˆ›å»ºå®Œ main.go æ–‡ä»¶åï¼Œåœ¨å½“å‰+ ä¸‹æ‰§è¡Œ `go run main.go` ï¼Œå¯åŠ¨ gRPC æœåŠ¡ã€‚



#### å®ç° gRPC å®¢æˆ·ç«¯

æ‰“å¼€ä¸€ä¸ªæ–°çš„ Linux ç»ˆç«¯ï¼Œè¿›å…¥ client ç›®å½•ï¼Œæ–°å»º main.go æ–‡ä»¶ï¼š

```bash
$ cd ../client
$ vi main.go
$ cd ../client
$ vi main.go
```



main.go å†…å®¹å¦‚ä¸‹ï¼š

```go

// Package main implements a client for Greeter service.
package main

import (
  "context"
  "log"
  "os"
  "time"

  pb "github.com/marmotedu/gopractise-demo/apistyle/greeter/helloworld"
  "google.golang.org/grpc"
)

const (
  address     = "localhost:50051"
  defaultName = "world"
)

func main() {
  // Set up a connection to the server.
  conn, err := grpc.Dial(address, grpc.WithInsecure(), grpc.WithBlock())
  if err != nil {
    log.Fatalf("did not connect: %v", err)
  }
  defer conn.Close()
  c := pb.NewGreeterClient(conn)

  // Contact the server and print out its response.
  name := defaultName
  if len(os.Args) > 1 {
    name = os.Args[1]
  }
  ctx, cancel := context.WithTimeout(context.Background(), time.Second)
  defer cancel()
  r, err := c.SayHello(ctx, &pb.HelloRequest{Name: name})
  if err != nil {
    log.Fatalf("could not greet: %v", err)
  }
  log.Printf("Greeting: %s", r.Message)
}
// Package main implements a client for Greeter service.
package main

import (
  "context"
  "log"
  "os"
  "time"

  pb "github.com/marmotedu/gopractise-demo/apistyle/greeter/helloworld"
  "google.golang.org/grpc"
)

const (
  address     = "localhost:50051"
  defaultName = "world"
)

func main() {
  // Set up a connection to the server.
  conn, err := grpc.Dial(address, grpc.WithInsecure(), grpc.WithBlock())
  if err != nil {
    log.Fatalf("did not connect: %v", err)
  }
  defer conn.Close()
  c := pb.NewGreeterClient(conn)

  // Contact the server and print out its response.
  name := defaultName
  if len(os.Args) > 1 {
    name = os.Args[1]
  }
  ctx, cancel := context.WithTimeout(context.Background(), time.Second)
  defer cancel()
  r, err := c.SayHello(ctx, &pb.HelloRequest{Name: name})
  if err != nil {
    log.Fatalf("could not greet: %v", err)
  }
  log.Printf("Greeting: %s", r.Message)
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å¦‚ä¸‹ä»£ç åˆ›å»ºäº†ä¸€ä¸ª gRPC è¿æ¥ï¼Œç”¨æ¥è·ŸæœåŠ¡ç«¯è¿›è¡Œé€šä¿¡ï¼š

```go

// Set up a connection to the server.
conn, err := grpc.Dial(address, grpc.WithInsecure(), grpc.WithBlock())
if err != nil {
    log.Fatalf("did not connect: %v", err)
}
defer conn.Close()
```

åœ¨åˆ›å»ºè¿æ¥æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸åŒçš„é€‰é¡¹ï¼Œç”¨æ¥æ§åˆ¶åˆ›å»ºè¿æ¥çš„æ–¹å¼ï¼Œä¾‹å¦‚ `grpc.WithInsecure()`ã€`grpc.WithBlock()` ç­‰ã€‚gRPC æ”¯æŒå¾ˆå¤šé€‰é¡¹ï¼Œæ›´å¤šçš„é€‰é¡¹å¯ä»¥å‚è€ƒ grpc ä»“åº“ä¸‹dialoptions.goæ–‡ä»¶ä¸­ä»¥ With å¼€å¤´çš„å‡½æ•°ã€‚

è¿æ¥å»ºç«‹èµ·æ¥ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯ stubï¼Œç”¨æ¥æ‰§è¡Œ RPC è¯·æ±‚`c := pb.NewGreeterClient(conn)`ã€‚åˆ›å»ºå®Œæˆä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åƒè°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·ï¼Œè°ƒç”¨è¿œç¨‹çš„æ–¹æ³•äº†ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢ä¸€æ®µä»£ç é€šè¿‡ c.SayHello è¿™ç§æœ¬åœ°å¼è°ƒç”¨æ–¹å¼è°ƒç”¨äº†è¿œç«¯çš„ SayHello æ¥å£ï¼š

```go
r, err := c.SayHello(ctx, &pb.HelloRequest{Name: name})
if err != nil {
    log.Fatalf("could not greet: %v", err)
}
log.Printf("Greeting: %s", r.Message)
```

ä»ä¸Šé¢çš„è°ƒç”¨æ ¼å¼ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° RPC è°ƒç”¨å…·æœ‰ä¸‹é¢ä¸¤ä¸ªç‰¹ç‚¹ã€‚

+ è°ƒç”¨æ–¹ä¾¿ï¼šRPC å±è”½äº†åº•å±‚çš„ç½‘ç»œé€šä¿¡ç»†èŠ‚ï¼Œä½¿å¾—è°ƒç”¨ RPC å°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·æ–¹ä¾¿ï¼Œè°ƒç”¨æ–¹å¼è·Ÿå¤§å®¶æ‰€ç†ŸçŸ¥çš„è°ƒç”¨ç±»çš„æ–¹æ³•ä¸€è‡´ï¼š`ClassName.ClassFuc(params)`ã€‚
+ ä¸éœ€è¦æ‰“åŒ…å’Œè§£åŒ…ï¼šRPC è°ƒç”¨çš„å…¥å‚å’Œè¿”å›çš„ç»“æœéƒ½æ˜¯ Go çš„ç»“æ„ä½“ï¼Œä¸éœ€è¦å¯¹ä¼ å…¥å‚æ•°è¿›è¡Œæ‰“åŒ…æ“ä½œï¼Œä¹Ÿä¸éœ€è¦å¯¹è¿”å›å‚æ•°è¿›è¡Œè§£åŒ…æ“ä½œï¼Œç®€åŒ–äº†è°ƒç”¨æ­¥éª¤ã€‚

æœ€åï¼Œåˆ›å»ºå®Œ main.go æ–‡ä»¶åï¼Œåœ¨å½“å‰ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ go run main.go å‘èµ· RPC è°ƒç”¨ï¼š

```bash
$ go run main.go
2020/10/17 07:55:00 Greeting: Hello world
```

è‡³æ­¤ï¼Œæˆ‘ä»¬ç”¨å››ä¸ªæ­¥éª¤ï¼Œåˆ›å»ºå¹¶è°ƒç”¨äº†ä¸€ä¸ª gRPC æœåŠ¡ã€‚æ¥ä¸‹æ¥æˆ‘å†ç»™å¤§å®¶è®²è§£ä¸€ä¸ªåœ¨å…·ä½“åœºæ™¯ä¸­çš„æ³¨æ„äº‹é¡¹ã€‚

åœ¨åšæœåŠ¡å¼€å‘æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸€ç§åœºæ™¯ï¼š**å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œæ¥å£ä¼šé€šè¿‡åˆ¤æ–­æ˜¯å¦ä¼ å…¥æŸä¸ªå‚æ•°ï¼Œå†³å®šæ¥å£è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³æä¾›ä¸€ä¸ª GetUser æ¥å£ï¼ŒæœŸæœ› GetUser æ¥å£åœ¨ä¼ å…¥ username å‚æ•°æ—¶ï¼Œæ ¹æ® username æŸ¥è¯¢ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰ä¼ å…¥ usernameï¼Œåˆ™é»˜è®¤æ ¹æ® userId æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ã€‚**

è¿™æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­å®¢æˆ·ç«¯æœ‰æ²¡æœ‰ä¼ å…¥ username å‚æ•°ã€‚æˆ‘ä»¬ä¸èƒ½æ ¹æ® username æ˜¯å¦ä¸ºç©ºå€¼æ¥åˆ¤æ–­ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½åŒºåˆ†å®¢æˆ·ç«¯ä¼ çš„æ˜¯ç©ºå€¼ï¼Œè¿˜æ˜¯æ²¡æœ‰ä¼  username å‚æ•°ã€‚è¿™æ˜¯ç”± Go è¯­è¨€çš„è¯­æ³•ç‰¹æ€§å†³å®šçš„ï¼šå¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰ä¼ å…¥ username å‚æ•°ï¼ŒGo ä¼šé»˜è®¤èµ‹å€¼ä¸ºæ‰€åœ¨ç±»å‹çš„é›¶å€¼ï¼Œè€Œå­—ç¬¦ä¸²ç±»å‹çš„é›¶å€¼å°±æ˜¯ç©ºå­—ç¬¦ä¸²ã€‚

é‚£æˆ‘ä»¬æ€ä¹ˆåˆ¤æ–­å®¢æˆ·ç«¯æœ‰æ²¡æœ‰ä¼ å…¥ username å‚æ•°å‘¢ï¼Ÿæœ€å¥½çš„æ–¹æ³•æ˜¯é€šè¿‡æŒ‡é’ˆæ¥åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ nil æŒ‡é’ˆå°±è¯´æ˜æ²¡æœ‰ä¼ å…¥ï¼Œé nil æŒ‡é’ˆå°±è¯´æ˜ä¼ å…¥ï¼Œå…·ä½“å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š

ç¼–å†™ protobuf å®šä¹‰æ–‡ä»¶ã€‚

**æ–°å»º user.proto æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:**

```protobuf
syntax = "proto3";

package proto;
option go_package = "github.com/marmotedu/gopractise-demo/protobuf/user";

//go:generate protoc -I. --experimental_allow_proto3_optional --go_out=plugins=grpc:.

service User {
  rpc GetUser(GetUserRequest) returns (GetUserResponse) {}
}

message GetUserRequest {
  string class = 1;
  optional string username = 2;
  optional string user_id = 3;
}

message GetUserResponse {
  string class = 1;
  string user_id = 2;
  string username = 3;
  string address = 4;
  string sex = 5;
  string phone = 6;
}
```

ä½ éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨éœ€è¦è®¾ç½®ä¸ºå¯é€‰å­—æ®µçš„å‰é¢æ·»åŠ äº† optional æ ‡è¯†ã€‚



ä½¿ç”¨ protoc å·¥å…·ç¼–è¯‘ protobuf æ–‡ä»¶ã€‚

åœ¨æ‰§è¡Œ protoc å‘½ä»¤æ—¶ï¼Œéœ€è¦ä¼ å…¥`--experimental_allow_proto3_optional`å‚æ•°ä»¥æ‰“å¼€ optional é€‰é¡¹ï¼Œç¼–è¯‘å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
$ protoc --experimental_allow_proto3_optional --go_out=plugins=grpc:. user.proto
```



ä¸Šè¿°ç¼–è¯‘å‘½ä»¤ä¼šç”Ÿæˆ `user.pb.go` æ–‡ä»¶ï¼Œå…¶ä¸­çš„ GetUserRequest ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š

```go

type GetUserRequest struct {
    state         protoimpl.MessageState
    sizeCache     protoimpl.SizeCache
    unknownFields protoimpl.UnknownFields

    Class    string  `protobuf:"bytes,1,opt,name=class,proto3" json:"class,omitempty"`
    Username *string `protobuf:"bytes,2,opt,name=username,proto3,oneof" json:"username,omitempty"`
    UserId   *string `protobuf:"bytes,3,opt,name=user_id,json=userId,proto3,oneof" json:"user_id,omitempty"`
}
```

é€šè¿‡ `optional + --experimental_allow_proto3_optional` ç»„åˆï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªå­—æ®µç¼–è¯‘ä¸ºæŒ‡é’ˆç±»å‹ã€‚



ç¼–å†™ gRPC æ¥å£å®ç°ã€‚

æ–°å»ºä¸€ä¸ª user.go æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```go

package user

import (
    "context"

    pb "github.com/marmotedu/api/proto/apiserver/v1"

    "github.com/marmotedu/iam/internal/apiserver/store"
)

type User struct {
}

func (c *User) GetUser(ctx context.Context, r *pb.GetUserRequest) (*pb.GetUserResponse, error) {
    if r.Username != nil {
        return store.Client().Users().GetUserByName(r.Class, r.Username)
    }

    return store.Client().Users().GetUserByID(r.Class, r.UserId)
}
```

æ€»ä¹‹ï¼Œåœ¨ GetUser æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ¤æ–­ r.Username æ˜¯å¦ä¸º nilï¼Œæ¥åˆ¤æ–­å®¢æˆ·ç«¯æ˜¯å¦ä¼ å…¥äº† Username å‚æ•°ã€‚



### æ‰§è¡Œå‘½ä»¤

åœ¨ç¼–å†™å®Œä¸Šé¢çš„å†…å®¹åï¼Œåœ¨ helloworld/proto ç›®å½•ä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

```bash
protoc --go_out=. helloworld. proto #java : --java_ouot
protoc --go-grpc_out=. helloworld.proto
protoc -I. --go_out=. helloworld.proto
```

![image-20230219140850022](http://sm.nsddd.top/sm202302191408194.png)



### æ¼”ç»ƒ

**æ€»ç»“ä¸€ä¸‹ï¼Œä¸€å…±å°±ä¸¤éƒ¨ï¼š**

å†™ä¸€ä¸ª proto çš„çº¦æŸï¼š

```protobuf
syntax = "proto3";

// go_package è¿™éƒ¨åˆ†çš„å†…å®¹æ˜¯å…³äºæœ€åç”Ÿæˆçš„Goè¯­è¨€ä»£ç çš„åŒ…åå’Œè·¯å¾„çš„è®¾ç½®ï¼Œè¿™é‡Œçš„æ„æ€æ˜¯ç”Ÿæˆçš„Goè¯­è¨€ä»£ç çš„åŒ…åæ˜¯serverï¼Œè·¯å¾„æ˜¯å½“å‰ç›®å½•ã€‚
option go_package = ".;server";

package helloworld;

// The greeting service definition.
// åœ¨è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªæœåŠ¡ Greeterï¼Œè¿™ä¸ªæœåŠ¡æœ‰ä¸€ä¸ªæ–¹æ³• SayHelloï¼Œè¿™ä¸ªæ–¹æ³•çš„è¯·æ±‚å‚æ•°æ˜¯ HelloRequestï¼Œè¿”å›å€¼æ˜¯ HelloReplyã€‚
service Greeter {
  // Sends a greeting
  rpc SayHello (HelloRequest) returns (HelloReply) {}
}

// The request message containing the user's name.
// åœ¨è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªè¯·æ±‚å‚æ•° HelloRequestï¼Œè¿™ä¸ªå‚æ•°åªæœ‰ä¸€ä¸ªå­—æ®µ nameï¼Œç±»å‹æ˜¯ stringï¼Œè¿™ä¸ªå­—æ®µçš„æ ‡å·æ˜¯ 1ã€‚
message HelloRequest {
  string name = 1;
  //int64 age = 2;
}

// The response message containing the greetings
// åœ¨è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªè¿”å›å€¼ HelloReplyï¼Œè¿™ä¸ªå‚æ•°åªæœ‰ä¸€ä¸ªå­—æ®µ messageï¼Œç±»å‹æ˜¯ stringï¼Œè¿™ä¸ªå­—æ®µçš„æ ‡å·æ˜¯ 1ã€‚
message HelloReply {
  string message = 1;
}

```

ä½¿ç”¨å‘½ä»¤ç”Ÿæˆä»£ç ï¼š

```bash
protoc --go_out=. helloworld. proto #java : --java_ouot
protoc -I. --go_out=. helloworld.proto
```

**è¿œç¨‹è¿‡ç¨‹è°ƒç”¨å®ç°ä¸€èˆ¬ä½¿ç”¨çš„æ˜¯ `_grpc. pb. go` æ–‡ä»¶ä¸­çš„ä»£ç ã€‚**



## gRPC åŸç†

### Proto æ–‡ä»¶







## RESTful VS gRPC

![image-20230219000421566](http://sm.nsddd.top/sm202302190004730.png)

å½“ç„¶ï¼Œæ›´å¤šçš„æ—¶å€™ï¼ŒRESTful API å’Œ gRPC API æ˜¯ ä¸€ç§åˆä½œçš„å…³ç³»ï¼Œå¯¹å†…ä¸šåŠ¡ä½¿ç”¨ gRPC APIï¼Œå¯¹å¤–ä¸šåŠ¡ä½¿ç”¨ RESTful APIï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20230219000447320](http://sm.nsddd.top/sm202302190004405.png)





## æ€»ç»“

åœ¨ Go é¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨ RESTful API é£æ ¼å’Œ RPC API é£æ ¼ï¼Œè¿™ä¸¤ç§æœåŠ¡éƒ½ç”¨å¾—å¾ˆå¤šã€‚å…¶ä¸­ï¼ŒRESTful API é£æ ¼å› ä¸ºè§„èŒƒã€æ˜“ç†è§£ã€æ˜“ç”¨ï¼Œæ‰€ä»¥é€‚åˆç”¨åœ¨éœ€è¦å¯¹å¤–æä¾› API æ¥å£çš„åœºæ™¯ä¸­ã€‚è€Œ RPC API å› ä¸ºæ€§èƒ½æ¯”è¾ƒé«˜ã€è°ƒç”¨æ–¹ä¾¿ï¼Œæ›´é€‚åˆç”¨åœ¨å†…éƒ¨ä¸šåŠ¡ä¸­ã€‚

RESTful API ä½¿ç”¨çš„æ˜¯ HTTP åè®®ï¼Œè€Œ RPC API ä½¿ç”¨çš„æ˜¯ RPC åè®®ã€‚ç›®å‰ï¼Œæœ‰å¾ˆå¤š RPC åè®®å¯ä¾›ä½ é€‰æ‹©ï¼Œè€Œæˆ‘æ¨èä½ ä½¿ç”¨ gRPCï¼Œå› ä¸ºå®ƒå¾ˆè½»é‡ï¼ŒåŒæ—¶æ€§èƒ½å¾ˆé«˜ã€å¾ˆç¨³å®šï¼Œæ˜¯ä¸€ä¸ªä¼˜ç§€çš„ RPC æ¡†æ¶ã€‚æ‰€ä»¥ç›®å‰ä¸šç•Œç”¨çš„æœ€å¤šçš„è¿˜æ˜¯ gRPC åè®®ï¼Œè…¾è®¯ã€é˜¿é‡Œç­‰å¤§å‚å†…éƒ¨å¾ˆå¤šæ ¸å¿ƒçš„çº¿ä¸ŠæœåŠ¡ç”¨çš„å°±æ˜¯ gRPCã€‚

é™¤äº†ä½¿ç”¨ gRPC åè®®ï¼Œåœ¨è¿›è¡Œ Go é¡¹ç›®å¼€å‘å‰ï¼Œä½ ä¹Ÿå¯ä»¥äº†è§£ä¸šç•Œä¸€äº›å…¶ä»–çš„ä¼˜ç§€ Go RPC æ¡†æ¶ï¼Œæ¯”å¦‚è…¾è®¯çš„ tars-goã€é˜¿é‡Œçš„ dubbo-goã€Facebook çš„ thriftã€rpcx ç­‰ï¼Œä½ å¯ä»¥åœ¨é¡¹ç›®å¼€å‘ä¹‹å‰ä¸€å¹¶è°ƒç ”ï¼Œæ ¹æ®å®é™…æƒ…å†µè¿›è¡Œé€‰æ‹©ã€‚





## END é“¾æ¥

<ul><li><div><a href = '5.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '7.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 
