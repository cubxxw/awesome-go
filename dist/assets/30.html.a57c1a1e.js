import{_ as l,r as c,o as r,c as u,a as n,b as e,w as o,e as s,d as t}from"./app.bdc458db.js";const d={},m={href:"https://github.com/cubxxw/iam",target:"_blank",rel:"noopener noreferrer"},k=s("\u{1F525} \u5F00\u6E90\u5730\u5740"),v=n("h1",{id:"\u7B2C30\u8282-\u6027\u80FD\u5206\u6790-\u4E0A-\u5982\u4F55\u5206\u6790-go-\u8BED\u8A00\u4EE3\u7801\u7684\u6027\u80FD",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u7B2C30\u8282-\u6027\u80FD\u5206\u6790-\u4E0A-\u5982\u4F55\u5206\u6790-go-\u8BED\u8A00\u4EE3\u7801\u7684\u6027\u80FD","aria-hidden":"true"},"#"),s(" \u7B2C30\u8282 \u6027\u80FD\u5206\u6790\uFF08\u4E0A\uFF09\uFF1A\u5982\u4F55\u5206\u6790 Go \u8BED\u8A00\u4EE3\u7801\u7684\u6027\u80FD\uFF1F")],-1),b=n("br",null,null,-1),h=n("div",null,[n("a",{href:"29.md",style:{float:"left"}},"\u2B06\uFE0F\u4E0A\u4E00\u8282\u{1F517} "),n("a",{href:"31.md",style:{float:"right"}}," \u2B07\uFE0F\u4E0B\u4E00\u8282\u{1F517}")],-1),f=n("br",null,null,-1),g=s("\u2764\uFE0F\u{1F495}\u{1F495}During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:"),_={href:"http://nsddd.top/",target:"_blank",rel:"noopener noreferrer"},x=s("http://nsddd.top"),P=n("hr",null,null,-1),L={class:"table-of-contents"},C=s("\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6"),w=s("\u901A\u8FC7\u547D\u4EE4\u884C\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6"),U=s("\u901A\u8FC7\u4EE3\u7801\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6"),B=s("\u901A\u8FC7net/http/pprof\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6"),S=s("\u6027\u80FD\u5206\u6790"),y=s("pprof\u5DE5\u5177\u4ECB\u7ECD"),T=s("\u751F\u6210\u6027\u80FD\u6570\u636E"),q=s("CPU\u6027\u80FD\u5206\u6790"),G=s("\u5185\u5B58\u6027\u80FD\u5206\u6790"),I=s("\u603B\u7ED3"),E=s("\u8BFE\u540E\u7EC3\u4E60"),A=s("END \u94FE\u63A5"),H=t('<p>[TOC]</p><p>\u4F5C\u4E3A\u5F00\u53D1\u4EBA\u5458\uFF0C\u6211\u4EEC\u4E00\u822C\u90FD\u5C40\u9650\u5728\u529F\u80FD\u4E0A\u7684\u5355\u5143\u6D4B\u8BD5\u4E2D\uFF0C\u5BF9\u4E00\u4E9B\u6027\u80FD\u4E0A\u7684\u7EC6\u8282\u5F80\u5F80\u4E0D\u4F1A\u592A\u5173\u6CE8\u3002\u4F46\u662F\uFF0C\u5982\u679C\u6211\u4EEC\u5728\u4E0A\u7EBF\u7684\u65F6\u5019\u5BF9\u9879\u76EE\u7684\u6574\u4F53\u6027\u80FD\u6CA1\u6709\u4E00\u4E2A\u5168\u9762\u7684\u4E86\u89E3\uFF0C\u968F\u7740\u8BF7\u6C42\u91CF\u8D8A\u6765\u8D8A\u5927\uFF0C\u53EF\u80FD\u4F1A\u51FA\u73B0\u5404\u79CD\u5404\u6837\u7684\u95EE\u9898\uFF0C\u6BD4\u5982CPU\u5360\u7528\u9AD8\u3001\u5185\u5B58\u4F7F\u7528\u7387\u9AD8\u3001\u8BF7\u6C42\u5EF6\u65F6\u9AD8\u7B49\u3002\u4E3A\u4E86\u907F\u514D\u8FD9\u4E9B\u6027\u80FD\u74F6\u9888\uFF0C\u6211\u4EEC\u5728\u5F00\u53D1\u7684\u8FC7\u7A0B\u4E2D\u9700\u8981\u901A\u8FC7\u4E00\u5B9A\u7684\u624B\u6BB5\uFF0C\u6765\u5BF9\u7A0B\u5E8F\u8FDB\u884C\u6027\u80FD\u5206\u6790\u3002</p><p>Go\u8BED\u8A00\u5DF2\u7ECF\u4E3A\u5F00\u53D1\u8005\u5185\u7F6E\u4E86\u5F88\u591A\u6027\u80FD\u8C03\u4F18\u3001\u76D1\u63A7\u7684\u5DE5\u5177\u548C\u65B9\u6CD5\uFF0C\u8FD9\u5927\u5927\u63D0\u5347\u4E86\u6211\u4EECprofile\u5206\u6790\u7684\u6548\u7387\uFF0C\u501F\u52A9\u8FD9\u4E9B\u5DE5\u5177\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5F88\u65B9\u4FBF\u5730\u5BF9Go\u7A0B\u5E8F\u8FDB\u884C\u6027\u80FD\u5206\u6790\u3002\u5728Go\u8BED\u8A00\u5F00\u53D1\u4E2D\uFF0C\u5F00\u53D1\u8005\u57FA\u672C\u90FD\u662F\u901A\u8FC7\u5185\u7F6E\u7684<code>pprof</code>\u5DE5\u5177\u5305\u6765\u8FDB\u884C\u6027\u80FD\u5206\u6790\u7684\u3002</p><p>\u5728\u8FDB\u884C\u6027\u80FD\u5206\u6790\u65F6\uFF0C\u6211\u4EEC\u4F1A\u5148\u501F\u52A9\u4E00\u4E9B\u5DE5\u5177\u548C\u5305\uFF0C\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\uFF0C\u7136\u540E\u518D\u901A\u8FC7<code>pprof</code>\u5DE5\u5177\u5206\u6790\u6027\u80FD\u6570\u636E\u6587\u4EF6\uFF0C\u4ECE\u800C\u5206\u6790\u4EE3\u7801\u7684\u6027\u80FD\u3002\u90A3\u4E48\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u5C31\u5206\u522B\u6765\u770B\u4E0B\u5982\u4F55\u6267\u884C\u8FD9\u4E24\u6B65\u64CD\u4F5C\u3002</p><h2 id="\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6" aria-hidden="true">#</a> \u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6</h2><p>\u8981\u67E5\u770B\u6027\u80FD\u6570\u636E\uFF0C\u9700\u8981\u5148\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\u3002\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\u6709\u4E09\u79CD\u65B9\u6CD5\uFF0C\u5206\u522B\u662F\u901A\u8FC7\u547D\u4EE4\u884C\u3001\u901A\u8FC7\u4EE3\u7801\u548C\u901A\u8FC7<code>net/http/pprof</code>\u5305\u3002\u8FD9\u4E9B\u5DE5\u5177\u548C\u5305\u4F1A\u5206\u522B\u751F\u6210CPU\u548C\u5185\u5B58\u6027\u80FD\u6570\u636E\u3002</p><p>\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u5C31\u6765\u770B\u4E0B\u8FD9\u4E09\u79CD\u65B9\u6CD5\u5206\u522B\u662F\u5982\u4F55\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\u7684\u3002</p><h3 id="\u901A\u8FC7\u547D\u4EE4\u884C\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u901A\u8FC7\u547D\u4EE4\u884C\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6" aria-hidden="true">#</a> \u901A\u8FC7\u547D\u4EE4\u884C\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6</h3>',8),D=s("\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528"),$=n("code",null,"go test -cpuprofile",-1),F=s("\u6765\u751F\u6210\u6027\u80FD\u6D4B\u8BD5\u6570\u636E\u3002\u8FDB\u5165"),N={href:"https://github.com/marmotedu/iam/tree/v1.0.8/internal/apiserver/service/v1",target:"_blank",rel:"noopener noreferrer"},O=s("internal/apiserver/service/v1"),M=s("\u76EE\u5F55\uFF0C\u6267\u884C\u4EE5\u4E0B\u547D\u4EE4\uFF1A"),j=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-bench</span><span class="token operator">=</span><span class="token string">&quot;.*&quot;</span> <span class="token parameter variable">-cpuprofile</span> cpu.profile <span class="token parameter variable">-memprofile</span> mem.profile
goos: linux
goarch: amd64
pkg: github.com/marmotedu/iam/internal/apiserver/service/v1
cpu: AMD EPYC Processor
BenchmarkListUser-8          <span class="token number">280</span>     <span class="token number">4283077</span> ns/op
PASS
ok    github.com/marmotedu/iam/internal/apiserver/service/v1  <span class="token number">1</span>.798s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u9762\u7684\u547D\u4EE4\u4F1A\u5728\u5F53\u524D\u76EE\u5F55\u4E0B\u751F\u62103\u4E2A\u6587\u4EF6\uFF1A</p><ul><li>v1.test\uFF0C\u6D4B\u8BD5\u751F\u6210\u7684\u4E8C\u8FDB\u5236\u6587\u4EF6\uFF0C\u8FDB\u884C\u6027\u80FD\u5206\u6790\u65F6\u53EF\u4EE5\u7528\u6765\u89E3\u6790\u5404\u79CD\u7B26\u53F7\u3002</li><li>cpu.profile\uFF0CCPU\u6027\u80FD\u6570\u636E\u6587\u4EF6\u3002</li><li>mem.profile\uFF0C\u5185\u5B58\u6027\u80FD\u6570\u636E\u6587\u4EF6\u3002</li></ul><h3 id="\u901A\u8FC7\u4EE3\u7801\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u901A\u8FC7\u4EE3\u7801\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6" aria-hidden="true">#</a> \u901A\u8FC7\u4EE3\u7801\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6</h3>`,4),R=s("\u6211\u4EEC\u8FD8\u53EF\u4EE5\u4F7F\u7528\u4EE3\u7801\u6765\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\uFF0C\u4F8B\u5982"),W={href:"https://github.com/marmotedu/gopractise-demo/blob/master/pprof/pprof.go",target:"_blank",rel:"noopener noreferrer"},z=s("pprof.go"),Y=s("\u6587\u4EF6\uFF1A"),V=t(`<div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;os&quot;</span>
  <span class="token string">&quot;runtime/pprof&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cpuOut<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token string">&quot;cpu.out&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> cpuOut<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  pprof<span class="token punctuation">.</span><span class="token function">StartCPUProfile</span><span class="token punctuation">(</span>cpuOut<span class="token punctuation">)</span>
  <span class="token keyword">defer</span> pprof<span class="token punctuation">.</span><span class="token function">StopCPUProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  memOut<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token string">&quot;mem.out&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> memOut<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> pprof<span class="token punctuation">.</span><span class="token function">WriteHeapProfile</span><span class="token punctuation">(</span>memOut<span class="token punctuation">)</span>

  <span class="token function">Sum</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Sum</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD0\u884C<code>pprof.go</code>\u6587\u4EF6\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ go run pprof.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u8FD0\u884C<code>pprof.go</code>\u6587\u4EF6\u540E\uFF0C\u4F1A\u5728\u5F53\u524D\u76EE\u5F55\u751F\u6210<code>cpu.profile</code>\u548C<code>mem.profile</code>\u6027\u80FD\u6570\u636E\u6587\u4EF6\u3002</p><h3 id="\u901A\u8FC7net-http-pprof\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u901A\u8FC7net-http-pprof\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6" aria-hidden="true">#</a> \u901A\u8FC7<code>net/http/pprof</code>\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6</h3><p>\u5982\u679C\u8981\u5206\u6790HTTP Server\u7684\u6027\u80FD\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528<code>net/http/pprof</code>\u5305\u6765\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\u3002</p><p>IAM\u9879\u76EE\u4F7F\u7528Gin\u6846\u67B6\u4F5C\u4E3AHTTP\u5F15\u64CE\uFF0C\u6240\u4EE5IAM\u9879\u76EE\u4F7F\u7528\u4E86<code>github.com/gin-contrib/pprof</code>\u5305\u6765\u542F\u7528HTTP\u6027\u80FD\u5206\u6790\u3002<code>github.com/gin-contrib/pprof</code>\u5305\u662F<code>net/http/pprof</code>\u7684\u4E00\u4E2A\u7B80\u5355\u5C01\u88C5\uFF0C\u901A\u8FC7\u5C01\u88C5\u4F7Fpprof\u7684\u529F\u80FD\u53D8\u6210\u4E86\u4E00\u4E2AGin\u4E2D\u95F4\u4EF6\uFF0C\u8FD9\u6837\u53EF\u4EE5\u6839\u636E\u9700\u8981\u52A0\u8F7Dpprof\u4E2D\u95F4\u4EF6\u3002</p>`,7),J=n("code",null,"github.com/gin-contrib/pprof",-1),K=s("\u5305\u4E2D\u7684"),Q={href:"https://github.com/gin-contrib/pprof/blob/v1.3.0/pprof.go",target:"_blank",rel:"noopener noreferrer"},X=s("pprof.go"),Z=s("\u6587\u4EF6\u4E2D\u6709\u4EE5\u4E0B\u4EE3\u7801\uFF1A"),nn=t(`<div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Register</span><span class="token punctuation">(</span>r <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">,</span> prefixOptions <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    prefix <span class="token operator">:=</span> <span class="token function">getPrefix</span><span class="token punctuation">(</span>prefixOptions<span class="token operator">...</span><span class="token punctuation">)</span>

    prefixRouter <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        prefixRouter<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/profile&quot;</span><span class="token punctuation">,</span> <span class="token function">pprofHandler</span><span class="token punctuation">(</span>pprof<span class="token punctuation">.</span>Profile<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">pprofHandler</span><span class="token punctuation">(</span>h http<span class="token punctuation">.</span>HandlerFunc<span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
    handler <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>\u901A\u8FC7\u4E0A\u9762\u7684\u4EE3\u7801\uFF0C\u4F60\u53EF\u4EE5\u770B\u5230<code>github.com/gin-contrib/pprof</code>\u5305\u5C06<code>net/http/pprof.Profile</code>\u8F6C\u6362\u6210\u4E86<code>gin.HandlerFunc</code>\uFF0C\u4E5F\u5C31\u662FGin\u4E2D\u95F4\u4EF6\u3002</em></p>`,2),sn=s("\u8981\u5F00\u542FHTTP\u6027\u80FD\u5206\u6790\uFF0C\u53EA\u9700\u8981\u5728\u4EE3\u7801\u4E2D\u6CE8\u518Cpprof\u63D0\u4F9B\u7684HTTP Handler\u5373\u53EF\uFF08\u4F4D\u4E8E"),en={href:"https://github.com/marmotedu/iam/blob/v1.0.8/internal/pkg/server/genericapiserver.go#L75-L77",target:"_blank",rel:"noopener noreferrer"},an=s("internal/pkg/server/genericapiserver.go"),on=s("\u6587\u4EF6\u4E2D\uFF09\uFF1A"),pn=t(`<div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// install pprof handler</span>
<span class="token keyword">if</span> s<span class="token punctuation">.</span>enableProfiling <span class="token punctuation">{</span>
    pprof<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Engine<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u9762\u7684\u4EE3\u7801\u6839\u636E\u914D\u7F6E<code>--feature.profiling</code>\u6765\u5224\u65AD\u662F\u5426\u5F00\u542FHTTP\u6027\u80FD\u5206\u6790\u529F\u80FD\u3002\u6211\u4EEC\u5F00\u542F\u5B8CHTTP\u6027\u80FD\u5206\u6790\uFF0C\u542F\u52A8HTTP\u670D\u52A1iam-apiserver\u540E\uFF0C\u5373\u53EF\u8BBF\u95EE<code>http:// x.x.x.x:8080/debug/pprof</code>\uFF08<code>x.x.x.x</code>\u662FLinux\u670D\u52A1\u5668\u7684\u5730\u5740\uFF09\u6765\u67E5\u770Bprofiles\u4FE1\u606F\u3002profiles\u4FE1\u606F\u5982\u4E0B\u56FE\u6240\u793A\uFF1A</p><p><img src="http://sm.nsddd.top/sm202303051108399.png" alt="\u56FE\u7247"></p><p><em>\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u4EE5\u4E0B\u547D\u4EE4\uFF0C\u6765\u83B7\u53D6CPU\u6027\u80FD\u6570\u636E\u6587\u4EF6\uFF1A</em></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> http://127.0.0.1:8080/debug/pprof/profile <span class="token parameter variable">-o</span> cpu.profile
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u6267\u884C\u5B8C\u4E0A\u9762\u7684\u547D\u4EE4\u540E\uFF0C\u9700\u8981\u7B49\u5F8530s\uFF0Cpprof\u4F1A\u91C7\u96C6\u8FD930s\u5185\u7684\u6027\u80FD\u6570\u636E\uFF0C\u6211\u4EEC\u9700\u8981\u5728\u8FD9\u6BB5\u65F6\u95F4\u5185\u5411\u670D\u52A1\u5668\u8FDE\u7EED\u53D1\u9001\u591A\u6B21\u8BF7\u6C42\uFF0C\u8BF7\u6C42\u7684\u9891\u5EA6\u53EF\u4EE5\u6839\u636E\u6211\u4EEC\u7684\u573A\u666F\u6765\u51B3\u5B9A\u300230s\u4E4B\u540E\uFF0C<code>/debug/pprof/profile</code>\u63A5\u53E3\u4F1A\u751F\u6210CPU profile\u6587\u4EF6\uFF0C\u88ABcurl\u547D\u4EE4\u4FDD\u5B58\u5728\u5F53\u524D\u76EE\u5F55\u4E0B\u7684cpu.profile\u6587\u4EF6\u4E2D\u3002</p><p>\u540C\u6837\u7684\uFF0C\u6211\u4EEC\u53EF\u4EE5\u6267\u884C\u4EE5\u4E0B\u547D\u4EE4\u6765\u751F\u6210\u5185\u5B58\u6027\u80FD\u6570\u636E\u6587\u4EF6\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> http://127.0.0.1:8080/debug/pprof/heap <span class="token parameter variable">-o</span> mem.profile
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4E0A\u9762\u7684\u547D\u4EE4\u4F1A\u81EA\u52A8\u4E0B\u8F7Dheap\u6587\u4EF6\uFF0C\u5E76\u88ABcurl\u547D\u4EE4\u4FDD\u5B58\u5728\u5F53\u524D\u76EE\u5F55\u4E0B\u7684mem.profile\u6587\u4EF6\u4E2D\u3002</p><p>\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528<code>go tool pprof [mem|cpu].profile</code>\u547D\u4EE4\u6765\u5206\u6790HTTP\u63A5\u53E3\u7684CPU\u548C\u5185\u5B58\u6027\u80FD\u3002\u6211\u4EEC\u4E5F\u53EF\u4EE5\u4F7F\u7528\u547D\u4EE4<code>go tool pprof http://127.0.0.1:8080/debug/pprof/profile</code>\uFF0C\u6216\u8005<code>go tool pprof http://127.0.0.1:8080/debug/pprof/heap</code>\uFF0C\u6765\u76F4\u63A5\u8FDB\u5165pprof\u5DE5\u5177\u7684\u4EA4\u4E92Shell\u4E2D\u3002<code>go tool pprof</code>\u4F1A\u9996\u5148\u4E0B\u8F7D\u5E76\u4FDD\u5B58CPU\u548C\u5185\u5B58\u6027\u80FD\u6570\u636E\u6587\u4EF6\uFF0C\u7136\u540E\u518D\u5206\u6790\u8FD9\u4E9B\u6587\u4EF6\u3002</p><p>\u901A\u8FC7\u4E0A\u9762\u7684\u4E09\u79CD\u65B9\u6CD5\uFF0C\u6211\u4EEC\u751F\u6210\u4E86cpu.profile\u548Cmem.profile\uFF0C\u63A5\u4E0B\u6765\u6211\u4EEC\u5C31\u53EF\u4EE5\u4F7F\u7528<code>go tool pprof</code>\u6765\u5206\u6790\u8FD9\u4E24\u4E2A\u6027\u80FD\u6570\u636E\u6587\u4EF6\uFF0C\u8FDB\u800C\u5206\u6790\u6211\u4EEC\u7A0B\u5E8F\u7684CPU\u548C\u5185\u5B58\u6027\u80FD\u4E86\u3002\u4E0B\u9762\uFF0C\u6211\u6765\u5177\u4F53\u8BB2\u8BB2\u6027\u80FD\u5206\u6790\u7684\u8FC7\u7A0B\u3002</p><h2 id="\u6027\u80FD\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#\u6027\u80FD\u5206\u6790" aria-hidden="true">#</a> \u6027\u80FD\u5206\u6790</h2><p>\u4F7F\u7528<code>go tool pprof</code>\uFF0C\u6765\u5BF9\u6027\u80FD\u8FDB\u884C\u5206\u6790\u7684\u6D41\u7A0B\uFF0C\u4F60\u53EF\u4EE5\u53C2\u8003\u4E0B\u56FE\uFF1A</p>`,13),tn={href:"https://static001.geekbang.org/resource/image/d4/da/d41d03c41283ea00308682a9yy0400da.jpg?wh=1920x665",target:"_blank",rel:"noopener noreferrer"},cn=n("img",{src:"https://static001.geekbang.org/resource/image/d4/da/d41d03c41283ea00308682a9yy0400da.jpg?wh=1920x665",alt:"\u56FE\u7247"},null,-1),ln=n("p",null,"\u63A5\u4E0B\u6765\uFF0C\u6211\u5148\u7ED9\u4F60\u4ECB\u7ECD\u4E0Bpprof\u5DE5\u5177\uFF0C\u518D\u4ECB\u7ECD\u4E0B\u5982\u4F55\u751F\u6210\u6027\u80FD\u6570\u636E\uFF0C\u6700\u540E\u518D\u5206\u522B\u4ECB\u7ECD\u4E0BCPU\u548C\u5185\u5B58\u6027\u80FD\u5206\u6790\u65B9\u6CD5\u3002",-1),rn=n("h3",{id:"pprof\u5DE5\u5177\u4ECB\u7ECD",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#pprof\u5DE5\u5177\u4ECB\u7ECD","aria-hidden":"true"},"#"),s(" pprof\u5DE5\u5177\u4ECB\u7ECD")],-1),un={href:"https://github.com/google/pprof",target:"_blank",rel:"noopener noreferrer"},dn=s("pprof"),mn=s("\u662F\u4E00\u4E2AGo\u7A0B\u5E8F\u6027\u80FD\u5206\u6790\u5DE5\u5177\uFF0C\u7528\u5B83\u53EF\u4EE5\u8BBF\u95EE\u5E76\u5206\u6790\u6027\u80FD\u6570\u636E\u6587\u4EF6\uFF0C\u5B83\u8FD8\u4F1A\u6839\u636E\u6211\u4EEC\u7684\u8981\u6C42\uFF0C\u63D0\u4F9B\u9AD8\u53EF\u8BFB\u6027\u7684\u8F93\u51FA\u4FE1\u606F\u3002Go\u5728\u8BED\u8A00\u5C42\u9762\u4E0A\u96C6\u6210\u4E86profile\u91C7\u6837\u5DE5\u5177\uFF0C\u53EA\u9700\u5728\u4EE3\u7801\u4E2D\u7B80\u5355\u5730\u5F15\u5165"),kn=n("code",null,"runtime/pprof",-1),vn=s("\u6216\u8005"),bn=n("code",null,"net/http/pprof",-1),hn=s("\u5305\uFF0C\u5373\u53EF\u83B7\u53D6\u7A0B\u5E8F\u7684profile\u6587\u4EF6\uFF0C\u5E76\u901A\u8FC7profile\u6587\u4EF6\u6765\u8FDB\u884C\u6027\u80FD\u5206\u6790\u3002"),fn=n("p",null,[n("code",null,"net/http/pprof"),s("\u57FA\u4E8E"),n("code",null,"runtime/pprof"),s("\u5305\u8FDB\u884C\u5C01\u88C5\uFF0C\u5E76\u5728 HTTP \u7AEF\u53E3\u4E0A\u66B4\u9732\u51FA\u6765\u3002")],-1),gn=n("h3",{id:"\u751F\u6210\u6027\u80FD\u6570\u636E",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u751F\u6210\u6027\u80FD\u6570\u636E","aria-hidden":"true"},"#"),s(" \u751F\u6210\u6027\u80FD\u6570\u636E")],-1),_n=n("p",null,"\u6211\u4EEC\u5728\u505A\u6027\u80FD\u5206\u6790\u65F6\uFF0C\u4E3B\u8981\u662F\u5BF9\u5185\u5B58\u548CCPU\u6027\u80FD\u8FDB\u884C\u5206\u6790\u3002\u4E3A\u4E86\u5206\u6790\u5185\u5B58\u548CCPU\u7684\u6027\u80FD\uFF0C\u6211\u4EEC\u9700\u8981\u5148\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\u3002\u5728 IAM \u6E90\u7801\u4E2D\uFF0C\u4E5F\u6709\u5305\u542B\u6027\u80FD\u6D4B\u8BD5\u7684\u7528\u4F8B\uFF0C\u4E0B\u9762\u6211\u4F1A\u501F\u52A9 IAM \u6E90\u7801\u4E2D\u7684\u6027\u80FD\u6D4B\u8BD5\u7528\u4F8B\uFF0C\u6765\u4ECB\u7ECD\u5982\u4F55\u5206\u6790\u7A0B\u5E8F\u7684\u6027\u80FD\u3002",-1),xn=s("\u8FDB\u5165"),Pn={href:"https://github.com/marmotedu/iam/tree/v1.0.8/internal/apiserver/service/v1",target:"_blank",rel:"noopener noreferrer"},Ln=s("internal/apiserver/service/v1"),Cn=s("\u76EE\u5F55\uFF0Cuser_test.go\u6587\u4EF6\u5305\u542B\u4E86\u6027\u80FD\u6D4B\u8BD5\u51FD\u6570 "),wn={href:"https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go#L27-L41",target:"_blank",rel:"noopener noreferrer"},Un=s("BenchmarkListUser"),Bn=s("\uFF0C\u6267\u884C\u4EE5\u4E0B\u547D\u4EE4\u6765\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\uFF1A"),Sn=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-benchtime</span><span class="token operator">=</span>30s <span class="token parameter variable">-benchmem</span> <span class="token parameter variable">-bench</span><span class="token operator">=</span><span class="token string">&quot;.&quot;</span> <span class="token parameter variable">-cpuprofile</span> cpu.profile <span class="token parameter variable">-memprofile</span> mem.profilegoos: linuxgoarch: amd64pkg: github.com/marmotedu/iam/internal/apiserver/service/v1cpu: AMD EPYC ProcessorBenchmarkListUser-8   	     <span class="token number">175</span>	 <span class="token number">204523677</span> ns/op	   <span class="token number">15331</span> B/op	     <span class="token number">268</span> allocs/opPASSok  	github.com/marmotedu/iam/internal/apiserver/service/v1	<span class="token number">56</span>.514s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4E0A\u9762\u7684\u547D\u4EE4\u4F1A\u5728\u5F53\u524D\u76EE\u5F55\u4E0B\u4EA7\u751F<code>cpu.profile</code>\u3001<code>mem.profile</code>\u6027\u80FD\u6570\u636E\u6587\u4EF6\uFF0C\u4EE5\u53CA<code>v1.test</code>\u4E8C\u8FDB\u5236\u6587\u4EF6\u3002\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u57FA\u4E8E<code>cpu.profile</code>\u3001<code>mem.profile</code>\u3001<code>v1.test</code>\u6587\u4EF6\u6765\u5206\u6790\u4EE3\u7801\u7684CPU\u548C\u5185\u5B58\u6027\u80FD\u3002\u4E3A\u4E86\u83B7\u53D6\u8DB3\u591F\u7684\u91C7\u6837\u6570\u636E\uFF0C\u6211\u4EEC\u5C06benchmark\u65F6\u95F4\u8BBE\u7F6E\u4E3A<code>30s</code>\u3002</p><p>\u5728\u505A\u6027\u80FD\u5206\u6790\u65F6\uFF0C\u6211\u4EEC\u53EF\u4EE5\u91C7\u53D6\u4E0D\u540C\u7684\u624B\u6BB5\u6765\u5206\u6790\u6027\u80FD\uFF0C\u6BD4\u5982\u5206\u6790\u91C7\u6837\u56FE\u3001\u5206\u6790\u706B\u7130\u56FE\uFF0C\u8FD8\u53EF\u4EE5\u4F7F\u7528<code>go tool pprof</code>\u4EA4\u4E92\u6A21\u5F0F\uFF0C\u67E5\u770B\u51FD\u6570CPU\u548C\u5185\u5B58\u6D88\u8017\u6570\u636E\u3002\u4E0B\u9762\u6211\u4F1A\u8FD0\u7528\u8FD9\u4E9B\u65B9\u6CD5\uFF0C\u6765\u5206\u6790CPU\u6027\u80FD\u548C\u5185\u5B58\u6027\u80FD\u3002</p><h3 id="cpu\u6027\u80FD\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#cpu\u6027\u80FD\u5206\u6790" aria-hidden="true">#</a> CPU\u6027\u80FD\u5206\u6790</h3><p>\u5728\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0CGo\u8BED\u8A00\u7684\u8FD0\u884C\u65F6\u7CFB\u7EDF\u4F1A\u4EE5100 Hz\u7684\u7684\u9891\u7387\u5BF9CPU\u4F7F\u7528\u60C5\u51B5\u8FDB\u884C\u91C7\u6837\uFF0C\u4E5F\u5C31\u662F\u8BF4\u6BCF\u79D2\u91C7\u6837100\u6B21\uFF0C\u6BCF10\u6BEB\u79D2\u91C7\u6837\u4E00\u6B21\u3002\u6BCF\u6B21\u91C7\u6837\u65F6\uFF0C\u4F1A\u8BB0\u5F55\u6B63\u5728\u8FD0\u884C\u7684\u51FD\u6570\uFF0C\u5E76\u7EDF\u8BA1\u5176\u8FD0\u884C\u65F6\u95F4\uFF0C\u4ECE\u800C\u751F\u6210CPU\u6027\u80FD\u6570\u636E\u3002</p><p>\u4E0A\u9762\u6211\u4EEC\u5DF2\u7ECF\u751F\u6210\u4E86CPU\u6027\u80FD\u6570\u636E\u6587\u4EF6<code>cpu.profile</code>\uFF0C\u63A5\u4E0B\u6765\u4F1A\u8FD0\u7528\u4E0A\u9762\u63D0\u5230\u7684\u4E09\u79CD\u65B9\u6CD5\u6765\u5206\u6790\u8BE5\u6027\u80FD\u6587\u4EF6\uFF0C\u4F18\u5316\u6027\u80FD\u3002</p><p>\u65B9\u6CD5\u4E00\uFF1A\u5206\u6790\u91C7\u6837\u56FE</p><p>\u8981\u5206\u6790\u6027\u80FD\uFF0C\u6700\u76F4\u89C2\u7684\u65B9\u5F0F\u5F53\u7136\u662F\u770B\u56FE\uFF0C\u6240\u4EE5\u9996\u5148\u6211\u4EEC\u9700\u8981\u751F\u6210\u91C7\u6837\u56FE\uFF0C\u751F\u6210\u8FC7\u7A0B\u53EF\u4EE5\u5206\u4E3A\u4E24\u4E2A\u6B65\u9AA4\u3002</p><p>\u7B2C\u4E00\u6B65\uFF0C\u786E\u4FDD\u7CFB\u7EDF\u5B89\u88C5\u4E86<code>graphviz</code>\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span> graphviz.x86_64
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u7B2C\u4E8C\u6B65\uFF0C\u6267\u884C<code>go tool pprof</code>\u751F\u6210\u8C03\u7528\u56FE\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go tool pprof <span class="token parameter variable">-svg</span> cpu.profile <span class="token operator">&gt;</span> cpu.svg  <span class="token comment"># svg \u683C\u5F0F$ go tool pprof -pdf cpu.profile &gt; cpu.pdf # pdf \u683C\u5F0F$ go tool pprof -png cpu.profile &gt; cpu.png # png \u683C\u5F0F</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4EE5\u4E0A\u547D\u4EE4\u4F1A\u751F\u6210<code>cpu.pdf</code>\u3001<code>cpu.svg</code>\u548C<code>cpu.png</code>\u6587\u4EF6\uFF0C\u6587\u4EF6\u4E2D\u7ED8\u5236\u4E86\u51FD\u6570\u8C03\u7528\u5173\u7CFB\u4EE5\u53CA\u5176\u4ED6\u91C7\u6837\u6570\u636E\u3002\u5982\u4E0B\u56FE\u6240\u793A\uFF1A</p><p><img src="http://sm.nsddd.top/sm202303051111612.png" alt="\u56FE\u7247"></p><p>\u8FD9\u5F20\u56FE\u7247\u7531\u6709\u5411\u7EBF\u6BB5\u548C\u77E9\u5F62\u7EC4\u6210\u3002\u6211\u4EEC\u5148\u6765\u770B\u6709\u5411\u7EBF\u6BB5\u7684\u542B\u4E49\u3002</p><p>\u6709\u5411\u7EBF\u6BB5\u63CF\u8FF0\u4E86\u51FD\u6570\u7684\u8C03\u7528\u5173\u7CFB\uFF0C\u77E9\u5F62\u5305\u542B\u4E86CPU\u91C7\u6837\u6570\u636E\u3002\u4ECE\u56FE\u4E2D\uFF0C\u6211\u4EEC\u770B\u5230\u6CA1\u7BAD\u5934\u7684\u4E00\u7AEF\u8C03\u7528\u4E86\u6709\u7BAD\u5934\u7684\u4E00\u7AEF\uFF0C\u53EF\u4EE5\u77E5\u9053<code>v1.(*userService).List</code>\u51FD\u6570\u8C03\u7528\u4E86<code>fake.(*policies).List</code>\u3002</p><p>\u7EBF\u6BB5\u65C1\u8FB9\u7684\u6570\u5B57<code>90ms</code>\u5219\u8BF4\u660E\uFF0C<code>v1.(*userService).List</code>\u8C03\u7528<code>fake.(*policies).List</code>\u51FD\u6570\uFF0C\u5728\u91C7\u6837\u5468\u671F\u5185\uFF0C\u4E00\u5171\u8017\u7528\u4E86<code>90ms</code>\u3002\u901A\u8FC7\u51FD\u6570\u8C03\u7528\u5173\u7CFB\uFF0C\u6211\u4EEC\u53EF\u4EE5\u77E5\u9053\u67D0\u4E2A\u51FD\u6570\u8C03\u7528\u4E86\u54EA\u4E9B\u51FD\u6570\uFF0C\u5E76\u4E14\u8C03\u7528\u8FD9\u4E9B\u51FD\u6570\u8017\u65F6\u591A\u4E45\u3002</p><p>\u8FD9\u91CC\uFF0C\u6211\u4EEC\u518D\u6B21\u89E3\u8BFB\u4E0B\u56FE\u4E2D\u8C03\u7528\u5173\u7CFB\u4E2D\u7684\u91CD\u8981\u4FE1\u606F\uFF1A</p>`,18),yn={href:"https://static001.geekbang.org/resource/image/70/32/70e964bc6d8f0b28d434cce47c4e1132.png?wh=835x818",target:"_blank",rel:"noopener noreferrer"},Tn=n("img",{src:"https://static001.geekbang.org/resource/image/70/32/70e964bc6d8f0b28d434cce47c4e1132.png?wh=835x818",alt:"\u56FE\u7247"},null,-1),qn=t(`<p><code>runtime.schedule</code>\u7684\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\uFF08140ms\uFF09\u4E2D\uFF0C\u670910ms\u6765\u81EA\u4E8E<code>runtime.goschedImpl</code>\u51FD\u6570\u7684\u76F4\u63A5\u8C03\u7528\uFF0C\u670970ms\u6765\u81EA\u4E8E<code>runtime.park_m</code>\u51FD\u6570\u7684\u76F4\u63A5\u8C03\u7528\u3002\u8FD9\u4E9B\u6570\u636E\u53EF\u4EE5\u8BF4\u660E<code>runtime.schedule</code>\u51FD\u6570\u5206\u522B\u88AB\u54EA\u4E9B\u51FD\u6570\u8C03\u7528\uFF0C\u5E76\u4E14\u8C03\u7528\u9891\u7387\u6709\u591A\u5927\u3002\u4E5F\u56E0\u4E3A\u8FD9\u4E2A\u539F\u56E0\uFF0C\u51FD\u6570<code>runtime.goschedImpl</code>\u5BF9\u51FD\u6570<code>runtime.schedule</code>\u7684\u8C03\u7528\u65F6\u95F4\u5FC5\u5B9A\u5C0F\u4E8E\u7B49\u4E8E\u51FD\u6570<code>runtime.schedule</code>\u7684\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\u3002</p><p>**\u6211\u4EEC\u518D\u6765\u770B\u4E0B\u77E9\u5F62\u91CC\u7684\u91C7\u6837\u6570\u636E\u3002**\u8FD9\u4E9B\u77E9\u5F62\u57FA\u672C\u90FD\u5305\u542B\u4E863\u7C7B\u4FE1\u606F\uFF1A</p><ul><li>\u51FD\u6570\u540D/\u65B9\u6CD5\u540D\uFF0C\u8BE5\u7C7B\u4FE1\u606F\u5305\u542B\u4E86\u5305\u540D\u3001\u7ED3\u6784\u4F53\u540D\u3001\u51FD\u6570\u540D/\u65B9\u6CD5\u540D\uFF0C\u65B9\u4FBF\u6211\u4EEC\u5FEB\u901F\u5B9A\u4F4D\u5230\u51FD\u6570/\u65B9\u6CD5\uFF0C\u4F8B\u5982<code>fake(*policies)List</code>\u8BF4\u660E\u662Ffake\u5305\uFF0Cpolicies\u7ED3\u6784\u4F53\u7684List\u65B9\u6CD5\u3002</li><li>\u672C\u5730\u91C7\u6837\u65F6\u95F4\uFF0C\u4EE5\u53CA\u5B83\u5728\u91C7\u6837\u603B\u6570\u4E2D\u6240\u5360\u7684\u6BD4\u4F8B\u3002\u672C\u5730\u91C7\u6837\u65F6\u95F4\u662F\u6307\u91C7\u6837\u70B9\u843D\u5728\u8BE5\u51FD\u6570\u4E2D\u7684\u603B\u65F6\u95F4\u3002</li><li>\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\uFF0C\u4EE5\u53CA\u5B83\u5728\u91C7\u6837\u603B\u6570\u4E2D\u6240\u5360\u7684\u6BD4\u4F8B\u3002\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\u662F\u6307\u91C7\u6837\u70B9\u843D\u5728\u8BE5\u51FD\u6570\uFF0C\u4EE5\u53CA\u88AB\u5B83\u76F4\u63A5\u6216\u8005\u95F4\u63A5\u8C03\u7528\u7684\u51FD\u6570\u4E2D\u7684\u603B\u65F6\u95F4\u3002</li></ul><p>\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7<code>OutDir</code>\u51FD\u6570\u6765\u89E3\u91CA\u672C\u5730\u91C7\u6837\u65F6\u95F4\u548C\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\u8FD9\u4E24\u4E2A\u6982\u5FF5\u3002<code>OutDir</code>\u51FD\u6570\u5982\u4E0B\u56FE\u6240\u793A\uFF1A</p><p><img src="http://sm.nsddd.top/sm202303051111655.png" alt="\u56FE\u7247"></p><p>\u6574\u4E2A\u51FD\u6570\u7684\u6267\u884C\u8017\u65F6\uFF0C\u6211\u4EEC\u53EF\u4EE5\u8BA4\u4E3A\u662F\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\uFF0C\u5305\u542B\u4E86\u767D\u8272\u90E8\u5206\u7684\u4EE3\u7801\u8017\u65F6\u548C\u7EA2\u8272\u90E8\u5206\u7684\u51FD\u6570\u8C03\u7528\u8017\u65F6\u3002\u767D\u8272\u90E8\u5206\u7684\u4EE3\u7801\u8017\u65F6\uFF0C\u53EF\u4EE5\u8BA4\u4E3A\u662F\u672C\u5730\u91C7\u6837\u65F6\u95F4\u3002</p><p>\u901A\u8FC7\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\uFF0C\u6211\u4EEC\u53EF\u4EE5\u77E5\u9053\u51FD\u6570\u7684\u603B\u8C03\u7528\u65F6\u95F4\uFF0C\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\u8D8A\u5927\uFF0C\u8BF4\u660E\u8C03\u7528\u5B83\u6240\u82B1\u8D39\u7684CPU\u65F6\u95F4\u8D8A\u591A\u3002\u4F46\u4F60\u8981\u6CE8\u610F\uFF0C\u8FD9\u5E76\u4E0D\u4E00\u5B9A\u8BF4\u660E\u8FD9\u4E2A\u51FD\u6570\u672C\u8EAB\u662F\u6709\u95EE\u9898\u7684\uFF0C\u4E5F\u6709\u53EF\u80FD\u662F\u51FD\u6570\u6240\u8C03\u7528\u7684\u51FD\u6570\u6027\u80FD\u6709\u74F6\u9888\uFF0C\u8FD9\u65F6\u5019\u6211\u4EEC\u5E94\u8BE5\u6839\u636E\u51FD\u6570\u8C03\u7528\u5173\u7CFB\u987A\u85E4\u6478\u74DC\uFF0C\u53BB\u5BFB\u627E\u8FD9\u4E2A\u51FD\u6570\u76F4\u63A5\u6216\u95F4\u63A5\u8C03\u7528\u7684\u51FD\u6570\u4E2D\u6700\u8017\u8D39CPU\u65F6\u95F4\u7684\u90A3\u4E9B\u3002</p><p>\u5982\u679C\u51FD\u6570\u7684\u672C\u5730\u91C7\u6837\u65F6\u95F4\u5F88\u5927\uFF0C\u5C31\u8BF4\u660E\u8FD9\u4E2A\u51FD\u6570\u81EA\u8EAB\u8017\u65F6\uFF08\u9664\u53BB\u8C03\u7528\u5176\u4ED6\u51FD\u6570\u7684\u8017\u65F6\uFF09\u5F88\u5927\uFF0C\u8FD9\u65F6\u5019\u9700\u8981\u6211\u4EEC\u5206\u6790\u8FD9\u4E2A\u51FD\u6570\u81EA\u8EAB\u7684\u4EE3\u7801\uFF0C\u800C\u4E0D\u662F\u8FD9\u4E2A\u51FD\u6570\u76F4\u63A5\u6216\u8005\u95F4\u63A5\u8C03\u7528\u51FD\u6570\u7684\u4EE3\u7801\u3002</p><p>\u91C7\u6837\u56FE\u4E2D\uFF0C\u77E9\u5F62\u6846\u9762\u79EF\u8D8A\u5927\uFF0C\u8BF4\u660E\u8FD9\u4E2A\u51FD\u6570\u7684\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\u8D8A\u5927\u3002\u90A3\u4E48\uFF0C\u5982\u679C\u4E00\u4E2A\u51FD\u6570\u5206\u6790\u91C7\u6837\u56FE\u4E2D\u7684\u77E9\u5F62\u6846\u9762\u79EF\u5F88\u5927\uFF0C\u8FD9\u65F6\u5019\u6211\u4EEC\u5C31\u8981\u8BA4\u771F\u5206\u6790\u4E86\uFF0C\u56E0\u4E3A\u5F88\u53EF\u80FD\u8FD9\u4E2A\u51FD\u6570\u5C31\u6709\u9700\u8981\u4F18\u5316\u6027\u80FD\u7684\u5730\u65B9\u3002</p><p><strong>\u65B9\u6CD5\u4E8C\uFF1A\u5206\u6790\u706B\u7130\u56FE</strong></p><p>\u4E0A\u9762\u4ECB\u7ECD\u7684\u91C7\u6837\u56FE\uFF0C\u5176\u5B9E\u5728\u5206\u6790\u6027\u80FD\u7684\u65F6\u5019\u8FD8\u4E0D\u592A\u76F4\u89C2\uFF0C\u8FD9\u91CC\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u751F\u6210\u706B\u7130\u56FE\uFF0C\u6765\u66F4\u76F4\u89C2\u5730\u67E5\u770B\u6027\u80FD\u74F6\u9888\u3002\u706B\u7130\u56FE\u662F\u7531Brendan Gregg\u5927\u5E08\u53D1\u660E\u7684\u4E13\u95E8\u7528\u6765\u628A\u91C7\u6837\u5230\u7684\u5806\u6808\u8F68\u8FF9\uFF08Stack Trace\uFF09\u8F6C\u5316\u4E3A\u76F4\u89C2\u56FE\u7247\u663E\u793A\u7684\u5DE5\u5177\uFF0C\u56E0\u6574\u5F20\u56FE\u770B\u8D77\u6765\u50CF\u4E00\u56E2\u8DF3\u52A8\u7684\u706B\u7130\u800C\u5F97\u540D\u3002</p><p><code>go tool pprof</code>\u63D0\u4F9B\u4E86<code>-http</code>\u53C2\u6570\uFF0C\u53EF\u4EE5\u4F7F\u6211\u4EEC\u901A\u8FC7\u6D4F\u89C8\u5668\u6D4F\u89C8\u91C7\u6837\u56FE\u548C\u706B\u7130\u56FE\u3002\u6267\u884C\u4EE5\u4E0B\u547D\u4EE4\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go tool pprof <span class="token parameter variable">-http</span><span class="token operator">=</span><span class="token string">&quot;0.0.0.0:8081&quot;</span> v1.test cpu.profile
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u7136\u540E\u8BBF\u95EE<code>http://x.x.x.x:8081/</code>\uFF08<code>x.x.x.x</code>\u662F\u6267\u884C<code>go tool pprof</code>\u547D\u4EE4\u6240\u5728\u670D\u52A1\u5668\u7684IP\u5730\u5740\uFF09\uFF0C\u5219\u4F1A\u5728\u6D4F\u89C8\u5668\u663E\u793A\u5404\u7C7B\u91C7\u6837\u89C6\u56FE\u6570\u636E\uFF0C\u5982\u4E0B\u56FE\u6240\u793A\uFF1A</p><p><img src="http://sm.nsddd.top/sm202303051111697.png" alt="\u56FE\u7247"></p><p>\u4E0A\u9762\u7684UI\u9875\u9762\u63D0\u4F9B\u4E86\u4E0D\u540C\u7684\u91C7\u6837\u6570\u636E\u89C6\u56FE\uFF1A</p><ul><li>Top\uFF0C\u7C7B\u4F3C\u4E8E linux top \u7684\u5F62\u5F0F\uFF0C\u4ECE\u9AD8\u5230\u4F4E\u6392\u5E8F\u3002</li><li>Graph\uFF0C\u9ED8\u8BA4\u5F39\u51FA\u6765\u7684\u5C31\u662F\u8BE5\u6A21\u5F0F\uFF0C\u4E5F\u5C31\u662F\u4E0A\u4E00\u4E2A\u56FE\u7684\u90A3\u79CD\u5E26\u6709\u8C03\u7528\u5173\u7CFB\u7684\u56FE\u3002</li><li>Flame Graph\uFF1Approf \u706B\u7130\u56FE\u3002</li><li>Peek\uFF1A\u7C7B\u4F3C\u4E8E Top \u4E5F\u662F\u4ECE\u9AD8\u5230\u5E95\u7684\u6392\u5E8F\u3002</li><li>Source\uFF1A\u548C\u4EA4\u4E92\u547D\u4EE4\u5F0F\u7684\u90A3\u79CD\u4E00\u6837\uFF0C\u5E26\u6709\u6E90\u7801\u6807\u6CE8\u3002</li><li>Disassemble\uFF1A\u663E\u793A\u6240\u6709\u7684\u603B\u91CF\u3002</li></ul><p>\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u4E3B\u8981\u6765\u5206\u6790\u706B\u7130\u56FE\u3002\u5728UI\u754C\u9762\u9009\u62E9<strong>Flame Graph\uFF08VIEW -&gt; Flame Graph\uFF09</strong>\uFF0C\u5C31\u4F1A\u5C55\u793A\u706B\u7130\u56FE\uFF0C\u5982\u4E0B\u56FE\u6240\u793A\uFF1A</p><p><img src="http://sm.nsddd.top/sm202303051111256.png" alt="\u56FE\u7247"></p><p>\u706B\u7130\u56FE\u4E3B\u8981\u6709\u4E0B\u9762\u8FD9\u51E0\u4E2A\u7279\u5F81\uFF1A</p><ul><li>\u6BCF\u4E00\u5217\u4EE3\u8868\u4E00\u4E2A\u8C03\u7528\u6808\uFF0C\u6BCF\u4E00\u4E2A\u683C\u5B50\u4EE3\u8868\u4E00\u4E2A\u51FD\u6570\u3002</li><li>\u7EB5\u8F74\u5C55\u793A\u4E86\u6808\u7684\u6DF1\u5EA6\uFF0C\u6309\u7167\u8C03\u7528\u5173\u7CFB\u4ECE\u4E0A\u5230\u4E0B\u6392\u5217\u3002\u6700\u4E0B\u9762\u7684\u683C\u5B50\u4EE3\u8868\u91C7\u6837\u65F6\uFF0C\u6B63\u5728\u5360\u7528CPU\u7684\u51FD\u6570\u3002</li><li>\u8C03\u7528\u6808\u5728\u6A2A\u5411\u4F1A\u6309\u7167\u5B57\u6BCD\u6392\u5E8F\uFF0C\u5E76\u4E14\u540C\u6837\u7684\u8C03\u7528\u6808\u4F1A\u505A\u5408\u5E76\uFF0C\u6240\u4EE5\u4E00\u4E2A\u683C\u5B50\u7684\u5BBD\u5EA6\u8D8A\u5927\uFF0C\u8BF4\u660E\u8FD9\u4E2A\u51FD\u6570\u8D8A\u53EF\u80FD\u662F\u74F6\u9888\u3002</li><li>\u706B\u7130\u56FE\u683C\u5B50\u7684\u989C\u8272\u662F\u968F\u673A\u7684\u6696\u8272\u8C03\uFF0C\u65B9\u4FBF\u533A\u5206\u5404\u4E2A\u8C03\u7528\u4FE1\u606F\u3002</li></ul><p>\u67E5\u770B\u706B\u7130\u56FE\u65F6\uFF0C\u683C\u5B50\u8D8A\u5BBD\u7684\u51FD\u6570\uFF0C\u5C31\u8D8A\u53EF\u80FD\u5B58\u5728\u6027\u80FD\u95EE\u9898\uFF0C\u8FD9\u65F6\u5019\uFF0C\u6211\u4EEC\u5C31\u53EF\u4EE5\u5206\u6790\u8BE5\u51FD\u6570\u7684\u4EE3\u7801\uFF0C\u627E\u51FA\u95EE\u9898\u6240\u5728\u3002</p><p><strong>\u65B9\u6CD5\u4E09\uFF1A\u7528<code>go tool pprof</code>\u4EA4\u4E92\u6A21\u5F0F\u67E5\u770B\u8BE6\u7EC6\u6570\u636E</strong></p><p>\u6211\u4EEC\u53EF\u4EE5\u6267\u884C<code>go tool pprof</code>\u547D\u4EE4\uFF0C\u6765\u67E5\u770BCPU\u7684\u6027\u80FD\u6570\u636E\u6587\u4EF6\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go tool pprof v1.test cpu.profile
File: v1.test
Type: cpu
Time: Aug <span class="token number">17</span>, <span class="token number">2021</span> at <span class="token number">2</span>:17pm <span class="token punctuation">(</span>CST<span class="token punctuation">)</span>
Duration: <span class="token number">56</span>.48s, Total samples <span class="token operator">=</span> 440ms <span class="token punctuation">(</span> <span class="token number">0.78</span>%<span class="token punctuation">)</span>
Entering interactive mode <span class="token punctuation">(</span>type <span class="token string">&quot;help&quot;</span> <span class="token keyword">for</span> commands, <span class="token string">&quot;o&quot;</span> <span class="token keyword">for</span> options<span class="token punctuation">)</span>
<span class="token punctuation">(</span>pprof<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>go tool pprof</code>\u8F93\u51FA\u4E86\u5F88\u591A\u4FE1\u606F\uFF1A</p><ul><li>File\uFF0C\u4E8C\u8FDB\u5236\u53EF\u6267\u884C\u6587\u4EF6\u540D\u79F0\u3002</li><li>Type\uFF0C\u91C7\u6837\u6587\u4EF6\u7684\u7C7B\u578B\uFF0C\u4F8B\u5982cpu\u3001mem\u7B49\u3002</li><li>Time\uFF0C\u751F\u6210\u91C7\u6837\u6587\u4EF6\u7684\u65F6\u95F4\u3002</li><li>Duration\uFF0C\u7A0B\u5E8F\u6267\u884C\u65F6\u95F4\u3002\u4E0A\u9762\u7684\u4F8B\u5B50\u4E2D\uFF0C\u7A0B\u5E8F\u603B\u6267\u884C\u65F6\u95F4\u4E3A<code>37.43s</code>\uFF0C\u91C7\u6837\u65F6\u95F4\u4E3A<code>42.37s</code>\u3002\u91C7\u6837\u7A0B\u5E8F\u5728\u91C7\u6837\u65F6\uFF0C\u4F1A\u81EA\u52A8\u5206\u914D\u91C7\u6837\u4EFB\u52A1\u7ED9\u591A\u4E2A\u6838\u5FC3\uFF0C\u6240\u4EE5\u603B\u91C7\u6837\u65F6\u95F4\u53EF\u80FD\u4F1A\u5927\u4E8E\u603B\u6267\u884C\u65F6\u95F4\u3002</li><li>(pprof)\uFF0C\u547D\u4EE4\u884C\u63D0\u793A\uFF0C\u8868\u793A\u5F53\u524D\u5728<code>go tool</code>\u7684<code>pprof</code>\u5DE5\u5177\u547D\u4EE4\u884C\u4E2D\uFF0C<code>go tool</code>\u8FD8\u5305\u62EC<code>cgo</code>\u3001<code>doc</code>\u3001<code>pprof</code>\u3001<code>trace</code>\u7B49\u591A\u79CD\u547D\u4EE4\u3002</li></ul><p>\u6267\u884C<code>go tool pprof</code>\u547D\u4EE4\u540E\uFF0C\u4F1A\u8FDB\u5165\u4E00\u4E2A\u4EA4\u4E92shell\u3002\u5728\u8FD9\u4E2A\u4EA4\u4E92shell\u4E2D\uFF0C\u6211\u4EEC\u53EF\u4EE5\u6267\u884C\u591A\u4E2A\u547D\u4EE4\uFF0C\u6700\u5E38\u7528\u7684\u547D\u4EE4\u6709\u4E09\u4E2A\uFF0C\u5982\u4E0B\u8868\u6240\u793A\uFF1A</p><p><img src="http://sm.nsddd.top/sm202303051112473.jpeg" alt="\u56FE\u7247"></p><p>\u6211\u4EEC\u5728\u4EA4\u4E92\u754C\u9762\u4E2D\u6267\u884C<code>top</code>\u547D\u4EE4\uFF0C\u53EF\u4EE5\u67E5\u770B\u6027\u80FD\u6837\u672C\u6570\u636E\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">(</span>pprof<span class="token punctuation">)</span> <span class="token function">top</span>
Showing nodes accounting <span class="token keyword">for</span> 350ms, <span class="token number">79.55</span>% of 440ms total
Showing <span class="token function">top</span> <span class="token number">10</span> nodes out of <span class="token number">47</span>
      flat  flat%   sum%        cum   cum%
     110ms <span class="token number">25.00</span>% <span class="token number">25.00</span>%      110ms <span class="token number">25.00</span>%  runtime.futex
      70ms <span class="token number">15.91</span>% <span class="token number">40.91</span>%       90ms <span class="token number">20.45</span>%  github.com/marmotedu/iam/internal/apiserver/store/fake.<span class="token punctuation">(</span>*policies<span class="token punctuation">)</span>.List
      40ms  <span class="token number">9.09</span>% <span class="token number">50.00</span>%       40ms  <span class="token number">9.09</span>%  runtime.epollwait
      40ms  <span class="token number">9.09</span>% <span class="token number">59.09</span>%      180ms <span class="token number">40.91</span>%  runtime.findrunnable
      30ms  <span class="token number">6.82</span>% <span class="token number">65.91</span>%       30ms  <span class="token number">6.82</span>%  runtime.write1
      20ms  <span class="token number">4.55</span>% <span class="token number">70.45</span>%       30ms  <span class="token number">6.82</span>%  runtime.notesleep
      10ms  <span class="token number">2.27</span>% <span class="token number">72.73</span>%      100ms <span class="token number">22.73</span>%  github.com/marmotedu/iam/internal/apiserver/service/v1.<span class="token punctuation">(</span>*userService<span class="token punctuation">)</span>.List
      10ms  <span class="token number">2.27</span>% <span class="token number">75.00</span>%       10ms  <span class="token number">2.27</span>%  runtime.checkTimers
      10ms  <span class="token number">2.27</span>% <span class="token number">77.27</span>%       10ms  <span class="token number">2.27</span>%  runtime.doaddtimer
      10ms  <span class="token number">2.27</span>% <span class="token number">79.55</span>%       10ms  <span class="token number">2.27</span>%  runtime.mallocgc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u9762\u7684\u8F93\u51FA\u4E2D\uFF0C\u6BCF\u4E00\u884C\u8868\u793A\u4E00\u4E2A\u51FD\u6570\u7684\u4FE1\u606F\u3002pprof\u7A0B\u5E8F\u4E2D\u6700\u91CD\u8981\u7684\u547D\u4EE4\u5C31\u662FtopN\uFF0C\u8FD9\u4E2A\u547D\u4EE4\u7528\u6765\u663E\u793Aprofile\u6587\u4EF6\u4E2D\u6700\u9760\u524D\u7684N\u4E2A\u6837\u672C\uFF08sample\uFF09\uFF0Ctop\u547D\u4EE4\u4F1A\u8F93\u51FA\u591A\u884C\u4FE1\u606F\uFF0C\u6BCF\u4E00\u884C\u4EE3\u8868\u4E00\u4E2A\u51FD\u6570\u7684\u91C7\u6837\u6570\u636E\uFF0C\u9ED8\u8BA4\u6309<code>flat%</code>\u6392\u5E8F\u3002\u8F93\u51FA\u4E2D\uFF0C\u5404\u5217\u542B\u4E49\u5982\u4E0B\uFF1A</p><ul><li>flat\uFF1A\u91C7\u6837\u70B9\u843D\u5728\u8BE5\u51FD\u6570\u4E2D\u7684\u603B\u65F6\u95F4\u3002</li><li>flat%\uFF1A\u91C7\u6837\u70B9\u843D\u5728\u8BE5\u51FD\u6570\u4E2D\u65F6\u95F4\u7684\u767E\u5206\u6BD4\u3002</li><li>sum%\uFF1A\u524D\u9762\u6240\u6709\u884C\u7684flat%\u7684\u7D2F\u52A0\u503C\uFF0C\u4E5F\u5C31\u662F\u4E0A\u4E00\u9879\u7684\u7D2F\u79EF\u767E\u5206\u6BD4\u3002</li><li>cum\uFF1A\u91C7\u6837\u70B9\u843D\u5728\u8BE5\u51FD\u6570\u4E2D\u7684\uFF0C\u4EE5\u53CA\u88AB\u5B83\u8C03\u7528\u7684\u51FD\u6570\u4E2D\u7684\u603B\u65F6\u95F4\u3002</li><li>cum%\uFF1A\u91C7\u6837\u70B9\u843D\u5728\u8BE5\u51FD\u6570\u4E2D\u7684\uFF0C\u4EE5\u53CA\u88AB\u5B83\u8C03\u7528\u7684\u51FD\u6570\u4E2D\u7684\u603B\u6B21\u6570\u767E\u5206\u6BD4\u3002</li><li>\u51FD\u6570\u540D\u3002</li></ul><p>\u4E0A\u9762\u8FD9\u4E9B\u4FE1\u606F\uFF0C\u53EF\u4EE5\u544A\u8BC9\u6211\u4EEC\u51FD\u6570\u6267\u884C\u7684\u65F6\u95F4\u548C\u8017\u65F6\u6392\u540D\uFF0C\u6211\u4EEC\u53EF\u4EE5\u6839\u636E\u8FD9\u4E9B\u4FE1\u606F\uFF0C\u6765\u5224\u65AD\u54EA\u4E9B\u51FD\u6570\u53EF\u80FD\u6709\u6027\u80FD\u95EE\u9898\uFF0C\u6216\u8005\u54EA\u4E9B\u51FD\u6570\u7684\u6027\u80FD\u53EF\u4EE5\u8FDB\u4E00\u6B65\u4F18\u5316\u3002</p><p>\u8FD9\u91CC\u60F3\u63D0\u793A\u4E0B\uFF0C\u5982\u679C\u6267\u884C\u7684\u662F<code>go tool pprof mem.profile</code>\uFF0C\u90A3\u4E48\u4E0A\u9762\u7684\u5404\u5B57\u6BB5\u610F\u4E49\u662F\u7C7B\u4F3C\u7684\uFF0C\u53EA\u4E0D\u8FC7\u8FD9\u6B21\u4E0D\u662F\u65F6\u95F4\u800C\u662F\u5185\u5B58\u5206\u914D\u5927\u5C0F\uFF08\u5B57\u8282\uFF09\u3002</p><p>\u6267\u884C<code>top</code>\u547D\u4EE4\u9ED8\u8BA4\u662F\u6309<code>flat%</code>\u6392\u5E8F\u7684\uFF0C\u5728\u505A\u6027\u80FD\u5206\u6790\u65F6\uFF0C\u6211\u4EEC\u9700\u8981\u5148\u6309\u7167<code>cum</code>\u6765\u6392\u5E8F\uFF0C\u901A\u8FC7<code>cum</code>\uFF0C\u6211\u4EEC\u53EF\u4EE5\u76F4\u89C2\u5730\u770B\u5230\u54EA\u4E2A\u51FD\u6570\u603B\u8017\u65F6\u6700\u591A\uFF0C\u7136\u540E\u518D\u53C2\u8003\u8BE5\u51FD\u6570\u7684\u672C\u5730\u91C7\u6837\u65F6\u95F4\u548C\u8C03\u7528\u5173\u7CFB\uFF0C\u6765\u5224\u65AD\u662F\u8BE5\u51FD\u6570\u6027\u80FD\u8017\u65F6\u591A\uFF0C\u8FD8\u662F\u5B83\u8C03\u7528\u7684\u51FD\u6570\u8017\u65F6\u591A\u3002</p><p>\u6267\u884C<code>top -cum</code>\u8F93\u51FA\u5982\u4E0B\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">(</span>pprof<span class="token punctuation">)</span> top20 <span class="token parameter variable">-cum</span>
Showing nodes accounting <span class="token keyword">for</span> 280ms, <span class="token number">63.64</span>% of 440ms total
Showing <span class="token function">top</span> <span class="token number">20</span> nodes out of <span class="token number">47</span>
      flat  flat%   sum%        cum   cum%
         <span class="token number">0</span>     <span class="token number">0</span>%     <span class="token number">0</span>%      320ms <span class="token number">72.73</span>%  runtime.mcall
         <span class="token number">0</span>     <span class="token number">0</span>%     <span class="token number">0</span>%      320ms <span class="token number">72.73</span>%  runtime.park_m
         <span class="token number">0</span>     <span class="token number">0</span>%     <span class="token number">0</span>%      280ms <span class="token number">63.64</span>%  runtime.schedule
      40ms  <span class="token number">9.09</span>%  <span class="token number">9.09</span>%      180ms <span class="token number">40.91</span>%  runtime.findrunnable
     110ms <span class="token number">25.00</span>% <span class="token number">34.09</span>%      110ms <span class="token number">25.00</span>%  runtime.futex
      10ms  <span class="token number">2.27</span>% <span class="token number">36.36</span>%      100ms <span class="token number">22.73</span>%  github.com/marmotedu/iam/internal/apiserver/service/v1.<span class="token punctuation">(</span>*userService<span class="token punctuation">)</span>.List
         <span class="token number">0</span>     <span class="token number">0</span>% <span class="token number">36.36</span>%      100ms <span class="token number">22.73</span>%  github.com/marmotedu/iam/internal/apiserver/service/v1.BenchmarkListUser
         <span class="token number">0</span>     <span class="token number">0</span>% <span class="token number">36.36</span>%      100ms <span class="token number">22.73</span>%  runtime.futexwakeup
         <span class="token number">0</span>     <span class="token number">0</span>% <span class="token number">36.36</span>%      100ms <span class="token number">22.73</span>%  runtime.notewakeup
         <span class="token number">0</span>     <span class="token number">0</span>% <span class="token number">36.36</span>%      100ms <span class="token number">22.73</span>%  runtime.resetspinning
         <span class="token number">0</span>     <span class="token number">0</span>% <span class="token number">36.36</span>%      100ms <span class="token number">22.73</span>%  runtime.startm
         <span class="token number">0</span>     <span class="token number">0</span>% <span class="token number">36.36</span>%      100ms <span class="token number">22.73</span>%  runtime.wakep
         <span class="token number">0</span>     <span class="token number">0</span>% <span class="token number">36.36</span>%      100ms <span class="token number">22.73</span>%  testing.<span class="token punctuation">(</span>*B<span class="token punctuation">)</span>.launch
         <span class="token number">0</span>     <span class="token number">0</span>% <span class="token number">36.36</span>%      100ms <span class="token number">22.73</span>%  testing.<span class="token punctuation">(</span>*B<span class="token punctuation">)</span>.runN
      70ms <span class="token number">15.91</span>% <span class="token number">52.27</span>%       90ms <span class="token number">20.45</span>%  github.com/marmotedu/iam/internal/apiserver/store/fake.<span class="token punctuation">(</span>*policies<span class="token punctuation">)</span>.List
      10ms  <span class="token number">2.27</span>% <span class="token number">54.55</span>%       50ms <span class="token number">11.36</span>%  runtime.netpoll
      40ms  <span class="token number">9.09</span>% <span class="token number">63.64</span>%       40ms  <span class="token number">9.09</span>%  runtime.epollwait
         <span class="token number">0</span>     <span class="token number">0</span>% <span class="token number">63.64</span>%       40ms  <span class="token number">9.09</span>%  runtime.modtimer
         <span class="token number">0</span>     <span class="token number">0</span>% <span class="token number">63.64</span>%       40ms  <span class="token number">9.09</span>%  runtime.resetForSleep
         <span class="token number">0</span>     <span class="token number">0</span>% <span class="token number">63.64</span>%       40ms  <span class="token number">9.09</span>%  runtime.resettimer <span class="token punctuation">(</span>inline<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4ECE\u4E0A\u9762\u7684\u8F93\u51FA\u53EF\u77E5\uFF0C<code>v1.BenchmarkListUser</code>\u3001<code>testing.(*B).launch</code>\u3001<code>testing.(*B).runN</code>\u7684\u672C\u5730\u91C7\u6837\u65F6\u95F4\u5360\u6BD4\u5206\u522B\u4E3A<code>0%</code>\u3001<code>0%</code>\u3001<code>0%</code>\uFF0C\u4F46\u662F\u4E09\u8005\u7684\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\u5360\u6BD4\u5374\u6BD4\u8F83\u9AD8\uFF0C\u5206\u522B\u4E3A<code>22.73%</code>\u3001<code>22.73%</code>\u3001<code>22.73%</code>\u3002</p><p>\u672C\u5730\u91C7\u6837\u65F6\u95F4\u5360\u6BD4\u5F88\u5C0F\uFF0C\u4F46\u662F\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\u5360\u6BD4\u5F88\u9AD8\uFF0C\u8BF4\u660E\u8FD93\u4E2A\u51FD\u6570\u8017\u65F6\u591A\u662F\u56E0\u4E3A\u8C03\u7528\u4E86\u5176\u4ED6\u51FD\u6570\uFF0C\u5B83\u4EEC\u81EA\u8EAB\u51E0\u4E4E\u6CA1\u6709\u8017\u65F6\u3002\u6839\u636E\u91C7\u6837\u56FE\uFF0C\u6211\u4EEC\u53EF\u4EE5\u770B\u5230\u51FD\u6570\u7684\u8C03\u7528\u5173\u7CFB\uFF0C\u5177\u4F53\u5982\u4E0B\u56FE\u6240\u793A\uFF1A</p><p><img src="http://sm.nsddd.top/sm202303051112424.jpeg" alt="\u56FE\u7247"></p><p>\u4ECE\u91C7\u6837\u56FE\u4E2D\uFF0C\u53EF\u4EE5\u77E5\u9053\u6700\u7EC8<code>v1.BenchmarkListUser</code>\u8C03\u7528\u4E86<code>v1.(*userService).List</code>\u51FD\u6570\u3002<code>v1.(*userService).List</code>\u51FD\u6570\u662F\u6211\u4EEC\u7F16\u5199\u7684\u51FD\u6570\uFF0C\u8BE5\u51FD\u6570\u7684\u672C\u5730\u91C7\u6837\u65F6\u95F4\u5360\u6BD4\u4E3A<code>2.27%</code>\uFF0C\u4F46\u662F\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\u5360\u6BD4\u5374\u9AD8\u8FBE<code>22.73%</code>\uFF0C\u8BF4\u660E<code>v1.(*userService).List</code>\u8C03\u7528\u5176\u4ED6\u51FD\u6570\u8017\u7528\u4E86\u5927\u91CF\u7684CPU\u65F6\u95F4\u3002</p><p>\u518D\u89C2\u5BDF\u91C7\u6837\u56FE\uFF0C\u53EF\u4EE5\u770B\u51FA<code>v1.(*userService).List</code>\u8017\u65F6\u4E45\u662F\u56E0\u4E3A\u8C03\u7528\u4E86<code>fake.(*policies).List</code>\u51FD\u6570\u3002\u6211\u4EEC\u4E5F\u53EF\u4EE5\u901A\u8FC7<code>list</code>\u547D\u4EE4\u67E5\u770B\u51FD\u6570\u5185\u90E8\u7684\u8017\u65F6\u60C5\u51B5\uFF1A</p><p><img src="http://sm.nsddd.top/sm202303051112930.png" alt="\u56FE\u7247"></p><p><code>list userService.*List</code>\u4F1A\u5217\u51FA<code>userService</code>\u7ED3\u6784\u4F53<code>List</code>\u65B9\u6CD5\u5185\u90E8\u4EE3\u7801\u7684\u8017\u65F6\u60C5\u51B5\uFF0C\u4ECE\u4E0A\u56FE\u4E5F\u53EF\u4EE5\u770B\u5230\uFF0C<code>u.store.Policies().List</code>\u8017\u65F6\u6700\u591A\u3002<code>fake.(*policies).List</code>\u7684\u672C\u5730\u91C7\u6837\u65F6\u95F4\u5360\u6BD4\u4E3A<code>15.91%</code>\uFF0C\u8BF4\u660E<code>fake.(*policies).List</code>\u51FD\u6570\u672C\u8EAB\u53EF\u80FD\u5B58\u5728\u74F6\u9888\u3002\u8D70\u8BFB<code>fake.(*policies).List</code>\u4EE3\u7801\u53EF\u77E5\uFF0C\u8BE5\u51FD\u6570\u662F\u67E5\u8BE2\u6570\u636E\u5E93\u7684\u51FD\u6570\uFF0C\u67E5\u8BE2\u6570\u636E\u5E93\u4F1A\u6709\u5EF6\u65F6\u3002\u7EE7\u7EED\u67E5\u770B<code>v1.(*userService).List</code>\u4EE3\u7801\uFF0C\u6211\u4EEC\u53EF\u4EE5\u53D1\u73B0\u4EE5\u4E0B\u8C03\u7528\u903B\u8F91\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>userService<span class="token punctuation">)</span> <span class="token function">ListWithBadPerformance</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> opts metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>UserList<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
        policies<span class="token punctuation">,</span> err <span class="token operator">:=</span> u<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Policies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token operator">...</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u5728<code>for</code>\u5FAA\u73AF\u4E2D\uFF0C\u4E32\u884C\u8C03\u7528\u4E86<code>fake.(*policies).List</code>\u51FD\u6570\uFF0C\u6BCF\u4E00\u6B21\u5FAA\u73AF\u90FD\u4F1A\u8C03\u7528\u6709\u5EF6\u65F6\u7684<code>fake.(*policies).List</code>\u51FD\u6570\u3002\u591A\u6B21\u8C03\u7528\uFF0C<code>v1.(*userService).List</code>\u51FD\u6570\u7684\u8017\u65F6\u81EA\u7136\u4F1A\u7D2F\u52A0\u8D77\u6765\u3002</p>`,47),Gn=s("\u73B0\u5728\u95EE\u9898\u627E\u5230\u4E86\uFF0C\u90A3\u6211\u4EEC\u600E\u4E48\u4F18\u5316\u5462\uFF1F\u4F60\u53EF\u4EE5\u5229\u7528CPU\u591A\u6838\u7279\u6027\uFF0C\u5F00\u542F\u591A\u4E2Agoroutine\uFF0C\u8FD9\u6837\u6211\u4EEC\u7684\u67E5\u8BE2\u8017\u65F6\u5C31\u4E0D\u662F\u4E32\u884C\u7D2F\u52A0\u7684\uFF0C\u800C\u662F\u53D6\u51B3\u4E8E\u6700\u6162\u4E00\u6B21\u7684"),In=n("code",null,"fake.(*policies).List",-1),En=s("\u8C03\u7528\u3002\u4F18\u5316\u540E\u7684"),An=n("code",null,"v1.(*userService).List*",-1),Hn=s("\u51FD\u6570\u4EE3\u7801\u89C1"),Dn={href:"https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user.go#L43-L110",target:"_blank",rel:"noopener noreferrer"},$n=s("internal/apiserver/service/v1/user.go"),Fn=s("\u3002\u7528\u540C\u6837\u7684\u6027\u80FD\u6D4B\u8BD5\u7528\u4F8B\uFF0C\u6D4B\u8BD5\u4F18\u5316\u540E\u7684\u51FD\u6570\uFF0C\u7ED3\u679C\u5982\u4E0B\uFF1A"),Nn=t(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-benchtime</span><span class="token operator">=</span>30s <span class="token parameter variable">-benchmem</span> <span class="token parameter variable">-bench</span><span class="token operator">=</span><span class="token string">&quot;.*&quot;</span> <span class="token parameter variable">-cpuprofile</span> cpu.profile <span class="token parameter variable">-memprofile</span> mem.profile
goos: linux
goarch: amd64
pkg: github.com/marmotedu/iam/internal/apiserver/service/v1
cpu: AMD EPYC Processor
BenchmarkListUser-8         <span class="token number">8330</span>     <span class="token number">4271131</span> ns/op     <span class="token number">26390</span> B/op       <span class="token number">484</span> allocs/op
PASS
ok    github.com/marmotedu/iam/internal/apiserver/service/v1  <span class="token number">36</span>.179s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u9762\u7684\u4EE3\u7801\u4E2D\uFF0Cns/op\u4E3A<code>4271131 ns/op</code>\uFF0C\u53EF\u4EE5\u770B\u5230\u548C\u7B2C\u4E00\u6B21\u7684\u6D4B\u8BD5\u7ED3\u679C<code>204523677 ns/op</code>\u76F8\u6BD4\uFF0C\u6027\u80FD\u63D0\u5347\u4E86<code>97.91%</code>\u3002</p><p>\u8FD9\u91CC\u6CE8\u610F\u4E0B\uFF0C\u4E3A\u4E86\u65B9\u4FBF\u4F60\u5BF9\u7167\uFF0C\u6211\u5C06\u4F18\u5316\u524D\u7684<code>v1.(*userService).List</code>\u51FD\u6570\u91CD\u547D\u540D\u4E3A<code>v1.(*userService).ListWithBadPerformance</code>\u3002</p><h3 id="\u5185\u5B58\u6027\u80FD\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#\u5185\u5B58\u6027\u80FD\u5206\u6790" aria-hidden="true">#</a> \u5185\u5B58\u6027\u80FD\u5206\u6790</h3><p>Go\u8BED\u8A00\u8FD0\u884C\u65F6\uFF0C\u7CFB\u7EDF\u4F1A\u5BF9\u7A0B\u5E8F\u8FD0\u884C\u671F\u95F4\u7684\u6240\u6709\u5806\u5185\u5B58\u5206\u914D\u8FDB\u884C\u8BB0\u5F55\u3002\u4E0D\u7BA1\u5728\u91C7\u6837\u7684\u54EA\u4E00\u65F6\u523B\uFF0C\u4E5F\u4E0D\u7BA1\u5806\u5185\u5B58\u5DF2\u7528\u5B57\u8282\u6570\u662F\u5426\u6709\u589E\u957F\uFF0C\u53EA\u8981\u6709\u5B57\u8282\u88AB\u5206\u914D\u4E14\u6570\u91CF\u8DB3\u591F\uFF0C\u5206\u6790\u5668\u5C31\u4F1A\u5BF9\u5B83\u8FDB\u884C\u91C7\u6837\u3002</p><p>\u5185\u5B58\u6027\u80FD\u5206\u6790\u65B9\u6CD5\u548CCPU\u6027\u80FD\u5206\u6790\u65B9\u6CD5\u6BD4\u8F83\u7C7B\u4F3C\uFF0C\u8FD9\u91CC\u5C31\u4E0D\u518D\u91CD\u590D\u4ECB\u7ECD\u4E86\u3002\u4F60\u53EF\u4EE5\u501F\u52A9\u524D\u9762\u751F\u6210\u7684\u5185\u5B58\u6027\u80FD\u6570\u636E\u6587\u4EF6<code>mem.profile</code>\u81EA\u884C\u5206\u6790\u3002</p>`,6),On=s("\u63A5\u4E0B\u6765\uFF0C\u7ED9\u4F60\u5C55\u793A\u4E0B\u5185\u5B58\u4F18\u5316\u524D\u548C\u4F18\u5316\u540E\u7684\u6548\u679C\u3002\u5728"),Mn=n("code",null,"v1.(*userService).List",-1),jn=s("\u51FD\u6570\uFF08\u4F4D\u4E8E"),Rn={href:"https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user.go#L43-L110",target:"_blank",rel:"noopener noreferrer"},Wn=s("internal/apiserver/service/v1/user.go"),zn=s("\u6587\u4EF6\u4E2D\uFF09\u4E2D\uFF0C\u6709\u4EE5\u4E0B\u4EE3\u7801\uFF1A"),Yn=t(`<div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>infos <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
    info<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
    infos <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>infos<span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u65F6\uFF0C\u6211\u4EEC\u8FD0\u884C<code>go test</code>\u547D\u4EE4\uFF0C\u6D4B\u8BD5\u4E0B\u5185\u5B58\u6027\u80FD\uFF0C\u4F5C\u4E3A\u4F18\u5316\u540E\u7684\u6027\u80FD\u6570\u636E\uFF0C\u8FDB\u884C\u5BF9\u6BD4\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-benchmem</span> <span class="token parameter variable">-bench</span><span class="token operator">=</span><span class="token string">&quot;.*&quot;</span> <span class="token parameter variable">-cpuprofile</span> cpu.profile <span class="token parameter variable">-memprofile</span> mem.profile
goos: linux
goarch: amd64
pkg: github.com/marmotedu/iam/internal/apiserver/service/v1
cpu: AMD EPYC Processor
BenchmarkListUser-8          <span class="token number">278</span>     <span class="token number">4284660</span> ns/op     <span class="token number">27101</span> B/op       <span class="token number">491</span> allocs/op
PASS
ok    github.com/marmotedu/iam/internal/apiserver/service/v1  <span class="token number">1</span>.779s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>B/op</code>\u548C<code>allocs/op</code>\u5206\u522B\u4E3A<code>27101 B/op</code>\u548C<code>491 allocs/op</code>\u3002</p><p>\u6211\u4EEC\u901A\u8FC7\u5206\u6790\u4EE3\u7801\uFF0C\u53D1\u73B0\u53EF\u4EE5\u5C06<code>infos := make([]*v1.User, 0)</code>\u4F18\u5316\u4E3A<code>infos := make([]*v1.User, 0, len(users.Items))</code>\uFF0C\u6765\u51CF\u5C11Go\u5207\u7247\u7684\u5185\u5B58\u91CD\u65B0\u5206\u914D\u7684\u6B21\u6570\u3002\u4F18\u5316\u540E\u7684\u4EE3\u7801\u4E3A\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">//infos := make([]*v1.User, 0)</span>
infos <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span>Items<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
    info<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
    infos <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>infos<span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>\u518D\u6267\u884C<code>go test</code>\u6D4B\u8BD5\u4E0B\u6027\u80FD\uFF1A</em></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-benchmem</span> <span class="token parameter variable">-bench</span><span class="token operator">=</span><span class="token string">&quot;.*&quot;</span> <span class="token parameter variable">-cpuprofile</span> cpu.profile <span class="token parameter variable">-memprofile</span> mem.profile
goos: linux
goarch: amd64
pkg: github.com/marmotedu/iam/internal/apiserver/service/v1
cpu: AMD EPYC Processor
BenchmarkListUser-8          <span class="token number">276</span>     <span class="token number">4318472</span> ns/op     <span class="token number">26457</span> B/op       <span class="token number">484</span> allocs/op
PASS
ok    github.com/marmotedu/iam/internal/apiserver/service/v1  <span class="token number">1</span>.856s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F18\u5316\u540E\u7684<code>B/op</code>\u548C<code>allocs/op</code>\u5206\u522B\u4E3A<code>26457 B/op</code>\u548C<code>484 allocs/op</code>\u3002\u8DDF\u7B2C\u4E00\u6B21\u7684<code>27101 B/op</code>\u548C<code>491 allocs/op</code>\u76F8\u6BD4\uFF0C\u5185\u5B58\u5206\u914D\u6B21\u6570\u66F4\u5C11\uFF0C\u6BCF\u6B21\u5206\u914D\u7684\u5185\u5B58\u4E5F\u66F4\u5C11\u3002</p><p>\u6211\u4EEC\u53EF\u4EE5\u6267\u884C<code>go tool pprof</code>\u547D\u4EE4\uFF0C\u6765\u67E5\u770BCPU\u7684\u6027\u80FD\u6570\u636E\u6587\u4EF6\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go tool pprof v1.test mem.profile
File: v1.test
Type: alloc_space
Time: Aug <span class="token number">17</span>, <span class="token number">2021</span> at <span class="token number">8</span>:33pm <span class="token punctuation">(</span>CST<span class="token punctuation">)</span>
Entering interactive mode <span class="token punctuation">(</span>type <span class="token string">&quot;help&quot;</span> <span class="token keyword">for</span> commands, <span class="token string">&quot;o&quot;</span> <span class="token keyword">for</span> options<span class="token punctuation">)</span>
<span class="token punctuation">(</span>pprof<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8BE5\u547D\u4EE4\u4F1A\u8FDB\u5165\u4E00\u4E2A\u4EA4\u4E92\u754C\u9762\uFF0C\u5728\u4EA4\u4E92\u754C\u9762\u4E2D\u6267\u884Ctop\u547D\u4EE4\uFF0C\u53EF\u4EE5\u67E5\u770B\u6027\u80FD\u6837\u672C\u6570\u636E\uFF0C\u4F8B\u5982\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">(</span>pprof<span class="token punctuation">)</span> <span class="token function">top</span>
Showing nodes accounting <span class="token keyword">for</span> <span class="token number">10347</span>.32kB, <span class="token number">95.28</span>% of <span class="token number">10859</span>.34kB total
Showing <span class="token function">top</span> <span class="token number">10</span> nodes out of <span class="token number">52</span>
      flat  flat%   sum%        cum   cum%
 <span class="token number">3072</span>.56kB <span class="token number">28.29</span>% <span class="token number">28.29</span>%  <span class="token number">4096</span>.64kB <span class="token number">37.72</span>%  github.com/marmotedu/iam/internal/apiserver/service/v1.<span class="token punctuation">(</span>*userService<span class="token punctuation">)</span>.List.func1
 <span class="token number">1762</span>.94kB <span class="token number">16.23</span>% <span class="token number">44.53</span>%  <span class="token number">1762</span>.94kB <span class="token number">16.23</span>%  runtime/pprof.StartCPUProfile
 <span class="token number">1024</span>.52kB  <span class="token number">9.43</span>% <span class="token number">53.96</span>%  <span class="token number">1024</span>.52kB  <span class="token number">9.43</span>%  go.uber.org/zap/buffer.NewPool.func1
 <span class="token number">1024</span>.08kB  <span class="token number">9.43</span>% <span class="token number">63.39</span>%  <span class="token number">1024</span>.08kB  <span class="token number">9.43</span>%  time.Sleep
  <span class="token number">902</span>.59kB  <span class="token number">8.31</span>% <span class="token number">71.70</span>%   <span class="token number">902</span>.59kB  <span class="token number">8.31</span>%  compress/flate.NewWriter
  <span class="token number">512</span>.20kB  <span class="token number">4.72</span>% <span class="token number">76.42</span>%  <span class="token number">1536</span>.72kB <span class="token number">14.15</span>%  github.com/marmotedu/iam/internal/apiserver/service/v1.<span class="token punctuation">(</span>*userService<span class="token punctuation">)</span>.List
  <span class="token number">512</span>.19kB  <span class="token number">4.72</span>% <span class="token number">81.14</span>%   <span class="token number">512</span>.19kB  <span class="token number">4.72</span>%  runtime.malg
  <span class="token number">512</span>.12kB  <span class="token number">4.72</span>% <span class="token number">85.85</span>%   <span class="token number">512</span>.12kB  <span class="token number">4.72</span>%  regexp.makeOnePass
  <span class="token number">512</span>.09kB  <span class="token number">4.72</span>% <span class="token number">90.57</span>%   <span class="token number">512</span>.09kB  <span class="token number">4.72</span>%  github.com/marmotedu/iam/internal/apiserver/store/fake.FakeUsers
  <span class="token number">512</span>.04kB  <span class="token number">4.72</span>% <span class="token number">95.28</span>%   <span class="token number">512</span>.04kB  <span class="token number">4.72</span>%  runtime/pprof.allFrames
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u9762\u7684\u5185\u5B58\u6027\u80FD\u6570\u636E\uFF0C\u5404\u5B57\u6BB5\u7684\u542B\u4E49\u4F9D\u6B21\u662F\uFF1A</p><ul><li>flat\uFF0C\u91C7\u6837\u70B9\u843D\u5728\u8BE5\u51FD\u6570\u4E2D\u7684\u603B\u5185\u5B58\u6D88\u8017\u3002</li><li>flat% \uFF0C\u91C7\u6837\u70B9\u843D\u5728\u8BE5\u51FD\u6570\u4E2D\u7684\u767E\u5206\u6BD4\u3002</li><li>sum% \uFF0C\u4E0A\u4E00\u9879\u7684\u7D2F\u79EF\u767E\u5206\u6BD4\u3002</li><li>cum \uFF0C\u91C7\u6837\u70B9\u843D\u5728\u8BE5\u51FD\u6570\uFF0C\u4EE5\u53CA\u88AB\u5B83\u8C03\u7528\u7684\u51FD\u6570\u4E2D\u7684\u603B\u5185\u5B58\u6D88\u8017\u3002</li><li>cum%\uFF0C\u91C7\u6837\u70B9\u843D\u5728\u8BE5\u51FD\u6570\uFF0C\u4EE5\u53CA\u88AB\u5B83\u8C03\u7528\u7684\u51FD\u6570\u4E2D\u7684\u603B\u6B21\u6570\u767E\u5206\u6BD4\u3002</li><li>\u51FD\u6570\u540D\u3002</li></ul><h2 id="\u603B\u7ED3" tabindex="-1"><a class="header-anchor" href="#\u603B\u7ED3" aria-hidden="true">#</a> \u603B\u7ED3</h2><p>\u5728Go\u9879\u76EE\u5F00\u53D1\u4E2D\uFF0C\u7A0B\u5E8F\u6027\u80FD\u4F4E\u4E0B\u65F6\uFF0C\u6211\u4EEC\u9700\u8981\u5206\u6790\u51FA\u95EE\u9898\u6240\u5728\u7684\u4EE3\u7801\u3002Go\u8BED\u8A00\u63D0\u4F9B\u7684 <code>go tool pprof</code> \u5DE5\u5177\u53EF\u4EE5\u652F\u6301\u6211\u4EEC\u5206\u6790\u4EE3\u7801\u7684\u6027\u80FD\u3002\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u4E24\u6B65\u6765\u5206\u6790\u4EE3\u7801\u7684\u6027\u80FD\uFF0C\u5206\u522B\u662F\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\u548C\u5206\u6790\u6027\u80FD\u6570\u636E\u6587\u4EF6\u3002</p><p>Go\u4E2D\u53EF\u4EE5\u7528\u6765\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\u7684\u65B9\u5F0F\u6709\u4E09\u79CD\uFF1A\u901A\u8FC7\u547D\u4EE4\u884C\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\u3001\u901A\u8FC7\u4EE3\u7801\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\u3001\u901A\u8FC7 <code>net/http/pprof</code> \u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\u3002</p><p>\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6\u4E4B\u540E\uFF0C\u5C31\u53EF\u4EE5\u4F7F\u7528 <code>go tool pprof</code> \u5DE5\u5177\u6765\u5206\u6790\u6027\u80FD\u6570\u636E\u6587\u4EF6\u4E86\u3002\u6211\u4EEC\u53EF\u4EE5\u5206\u522B\u83B7\u53D6\u5230CPU\u548C\u5185\u5B58\u7684\u6027\u80FD\u6570\u636E\uFF0C\u901A\u8FC7\u5206\u6790\u5C31\u53EF\u4EE5\u627E\u5230\u6027\u80FD\u74F6\u9888\u3002\u67093\u79CD\u5206\u6790\u6027\u80FD\u6570\u636E\u6587\u4EF6\u7684\u65B9\u5F0F\uFF0C\u5206\u522B\u662F\u5206\u6790\u91C7\u6837\u56FE\u3001\u5206\u6790\u706B\u7130\u56FE\u548C\u7528 <code>go tool pprof</code> \u4EA4\u4E92\u6A21\u5F0F\u67E5\u770B\u8BE6\u7EC6\u6570\u636E\u3002\u56E0\u4E3A\u706B\u7130\u56FE\u76F4\u89C2\u9AD8\u6548\uFF0C\u6240\u4EE5\u6211\u5EFA\u8BAE\u4F60\u591A\u4F7F\u7528\u706B\u7130\u56FE\u6765\u5206\u6790\u6027\u80FD\u3002</p><h2 id="\u8BFE\u540E\u7EC3\u4E60" tabindex="-1"><a class="header-anchor" href="#\u8BFE\u540E\u7EC3\u4E60" aria-hidden="true">#</a> \u8BFE\u540E\u7EC3\u4E60</h2><ol><li>\u601D\u8003\u4E0B\uFF0C\u4E3A\u4EC0\u4E48\u201C\u51FD\u6570<code>runtime.goschedImpl</code>\u5BF9\u51FD\u6570<code>runtime.schedule</code>\u7684\u8C03\u7528\u65F6\u95F4\u5FC5\u5B9A\u5C0F\u4E8E\u7B49\u4E8E\u51FD\u6570<code>runtime.schedule</code>\u7684\u7D2F\u79EF\u91C7\u6837\u65F6\u95F4\u201D\uFF1F</li><li>\u4F60\u5728Go\u9879\u76EE\u5F00\u53D1\u4E2D\uFF0C\u8FD8\u6709\u54EA\u4E9B\u6BD4\u8F83\u597D\u7684\u6027\u80FD\u5206\u6790\u601D\u8DEF\u548C\u65B9\u6CD5\uFF1F\u6B22\u8FCE\u5728\u7559\u8A00\u533A\u5206\u4EAB\u3002</li></ol><h2 id="end-\u94FE\u63A5" tabindex="-1"><a class="header-anchor" href="#end-\u94FE\u63A5" aria-hidden="true">#</a> END \u94FE\u63A5</h2><ul><li><div><a href="29.md" style="float:left;">\u2B06\uFE0F\u4E0A\u4E00\u8282\u{1F517} </a><a href="31.md" style="float:right;"> \uFE0F\u4E0B\u4E00\u8282\u{1F517}</a></div></li></ul>`,23),Vn=s("\u24C2\uFE0F\u56DE\u5230\u76EE\u5F55\u{1F3E0}"),Jn={href:"https://nsddd.top/archives/contributors",target:"_blank",rel:"noopener noreferrer"},Kn=n("strong",null,"\u{1FAF5}\u53C2\u4E0E\u8D21\u732E\u{1F49E}\u2764\uFE0F\u200D\u{1F525}\u{1F496}",-1),Qn=s(")"),Xn=s("\u2734\uFE0F\u7248\u6743\u58F0\u660E \xA9 \uFF1A\u672C\u4E66\u6240\u6709\u5185\u5BB9\u9075\u5FAA"),Zn={href:"http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC",target:"_blank",rel:"noopener noreferrer"},ns=s("CC-BY-SA 3.0\u534F\u8BAE\uFF08\u7F72\u540D-\u76F8\u540C\u65B9\u5F0F\u5171\u4EAB\uFF09\xA9");function ss(es,as){const a=c("ExternalLinkIcon"),p=c("router-link"),i=c("RouterLink");return r(),u("div",null,[n("ul",null,[n("li",null,[n("a",m,[k,e(a)])])]),v,b,h,f,n("blockquote",null,[n("p",null,[g,n("a",_,[x,e(a)])])]),P,n("nav",L,[n("ul",null,[n("li",null,[e(p,{to:"#\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6"},{default:o(()=>[C]),_:1}),n("ul",null,[n("li",null,[e(p,{to:"#\u901A\u8FC7\u547D\u4EE4\u884C\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6"},{default:o(()=>[w]),_:1})]),n("li",null,[e(p,{to:"#\u901A\u8FC7\u4EE3\u7801\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6"},{default:o(()=>[U]),_:1})]),n("li",null,[e(p,{to:"#\u901A\u8FC7net-http-pprof\u751F\u6210\u6027\u80FD\u6570\u636E\u6587\u4EF6"},{default:o(()=>[B]),_:1})])])]),n("li",null,[e(p,{to:"#\u6027\u80FD\u5206\u6790"},{default:o(()=>[S]),_:1}),n("ul",null,[n("li",null,[e(p,{to:"#pprof\u5DE5\u5177\u4ECB\u7ECD"},{default:o(()=>[y]),_:1})]),n("li",null,[e(p,{to:"#\u751F\u6210\u6027\u80FD\u6570\u636E"},{default:o(()=>[T]),_:1})]),n("li",null,[e(p,{to:"#cpu\u6027\u80FD\u5206\u6790"},{default:o(()=>[q]),_:1})]),n("li",null,[e(p,{to:"#\u5185\u5B58\u6027\u80FD\u5206\u6790"},{default:o(()=>[G]),_:1})])])]),n("li",null,[e(p,{to:"#\u603B\u7ED3"},{default:o(()=>[I]),_:1})]),n("li",null,[e(p,{to:"#\u8BFE\u540E\u7EC3\u4E60"},{default:o(()=>[E]),_:1})]),n("li",null,[e(p,{to:"#end-\u94FE\u63A5"},{default:o(()=>[A]),_:1})])])]),H,n("p",null,[D,$,F,n("a",N,[O,e(a)]),M]),j,n("p",null,[R,n("a",W,[z,e(a)]),Y]),V,n("p",null,[J,K,n("a",Q,[X,e(a)]),Z]),nn,n("p",null,[n("em",null,[sn,n("a",en,[an,e(a)]),on])]),pn,n("p",null,[n("a",tn,[cn,e(a)])]),ln,rn,n("p",null,[n("a",un,[dn,e(a)]),mn,kn,vn,bn,hn]),fn,gn,_n,n("p",null,[xn,n("a",Pn,[Ln,e(a)]),Cn,n("a",wn,[Un,e(a)]),Bn]),Sn,n("p",null,[n("a",yn,[Tn,e(a)])]),qn,n("p",null,[Gn,In,En,An,Hn,n("a",Dn,[$n,e(a)]),Fn]),Nn,n("p",null,[On,Mn,jn,n("a",Rn,[Wn,e(a)]),zn]),Yn,n("ul",null,[n("li",null,[n("p",null,[e(i,{to:"/projects/"},{default:o(()=>[Vn]),_:1})])]),n("li",null,[n("p",null,[n("a",Jn,[Kn,e(a)]),Qn])]),n("li",null,[n("p",null,[Xn,n("a",Zn,[ns,e(a)])])])])])}const ps=l(d,[["render",ss],["__file","30.html.vue"]]);export{ps as default};
